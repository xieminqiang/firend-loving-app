{"version":3,"file":"page.js","sources":["pages/tabbar/page/page.vue","pages/tabbar/page/page.vue?type=page"],"sourcesContent":["<template>\n\t<view class=\"home-container\">\n\t\t<!-- 使用v-show避免组件重新创建，保持数据状态 -->\n\t\t<view v-show=\"currentTab === 'home'\" class=\"home-tab-content\">\n\t\t\t<!-- 引入真正的home组件，使用懒加载 -->\n\t\t\t<HomeComponent ref=\"homeRef\" v-if=\"visitedTabs.has('home')\" />\n\t\t</view>\n   \n\t\n                \n\t\t<view v-show=\"currentTab === 'profile'\" class=\"profile-tab-content\">\n\t\t\t<!-- 引入个人中心组件，使用懒加载 -->\n\t\t\t<ProfileComponent ref=\"profileRef\" v-if=\"visitedTabs.has('profile')\" />\n\t\t</view>\n\n\t\t<!-- 底部Tabbar -->\n\t\t<MqTabbar\n\t\t\t:currentTab=\"currentTab\" \n\t\t\t@tabChange=\"handleTabChange\"\n\t\t/>\n  </view>\n</template>\n\n<script setup>\nimport { ref, reactive, onMounted, getCurrentInstance, nextTick } from 'vue'\nimport { onPullDownRefresh, onHide, onShow } from '@dcloudio/uni-app'\nimport MqTabbar from '@/components/mq-tabbar/mq-tabbar.vue'\nimport HomeComponent from './components/home.vue'\nimport { uploadFile, getUploadResult } from '@/api/file.js'\nimport ProfileComponent from './components/profile.vue'\n\n// 当前选中的tab\nconst currentTab = ref('home')\n\n// 记录已访问过的tab，用于懒加载\nconst visitedTabs = reactive(new Set(['home']))\n\n// 刷新状态管理\nconst isRefreshing = ref(false)\n\n// 处理tab切换\nconst handleTabChange = (tabName) => {\n\t// 记录访问过的tab\n\tvisitedTabs.add(tabName)\n\t\n\t// 切换tab\n\tcurrentTab.value = tabName\n\t\n\tconsole.log(`切换到 ${tabName} tab，已访问的tab:`, Array.from(visitedTabs))\n}\n\n// 页面挂载时初始化\nonMounted(() => {\n\tconsole.log('页面挂载完成，当前tab:', currentTab.value)\n\tconsole.log('已访问的tab:', Array.from(visitedTabs))\n})\n\n// 页面级下拉刷新处理\nonPullDownRefresh(async () => {\n\t// 防止重复刷新\n\tif (isRefreshing.value) {\n\t\tconsole.log('刷新操作正在进行中，忽略重复请求')\n\t\tuni.stopPullDownRefresh()\n\t\treturn\n\t}\n\t\n\tisRefreshing.value = true\n\tconsole.log('页面级下拉刷新触发，当前tab:', currentTab.value)\n\t\n\t// 设置超时保护\n\tconst timeoutPromise = new Promise((_, reject) => {\n\t\tsetTimeout(() => reject(new Error('刷新超时')), 10000) // 10秒超时\n\t})\n\t\n\ttry {\n\t\t// 根据当前tab调用相应的刷新方法\n\t\tconst refreshPromise = (async () => {\n\t\t\tif (currentTab.value === 'home') {\n\t\t\t\t// 如果home组件已加载，调用其刷新方法\n\t\t\t\tif (visitedTabs.has('home')) {\n\t\t\t\t\t// 通过ref调用子组件的刷新方法\n\t\t\t\t\tconst homeRef = getCurrentInstance()?.refs?.homeRef\n\t\t\t\t\tif (homeRef && homeRef.refreshCurrentTab) {\n\t\t\t\t\t\tawait homeRef.refreshCurrentTab()\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (currentTab.value === 'profile') {\n\t\t\t\t// 如果profile组件已加载，调用其刷新方法\n\t\t\t\tif (visitedTabs.has('profile')) {\n\t\t\t\t\tconst profileRef = getCurrentInstance()?.refs?.profileRef\n\t\t\t\t\tif (profileRef && profileRef.refreshCurrentTab) {\n\t\t\t\t\t\tawait profileRef.refreshCurrentTab()\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t})()\n\t\t\n\t\t// 等待刷新完成或超时\n\t\tawait Promise.race([refreshPromise, timeoutPromise])\n\t\t\n\t\t// 模拟加载时间，确保用户能看到刷新动画\n\t\tawait new Promise(resolve => setTimeout(resolve, 300))\n\t\t\n\t\t// 显示刷新成功提示\n\t\tuni.showToast({\n\t\t\ttitle: '刷新成功',\n\t\t\ticon: 'success',\n\t\t\tduration: 1500\n\t\t})\n\t} catch (error) {\n\t\tconsole.error('页面级下拉刷新失败:', error)\n\t\tuni.showToast({\n\t\t\ttitle: error.message === '刷新超时' ? '刷新超时，请重试' : '刷新失败，请重试',\n\t\t\ticon: 'error',\n\t\t\tduration: 2000\n\t\t})\n\t} finally {\n\t\t// 确保在所有操作完成后停止下拉刷新动画\n\t\t// 使用 nextTick 确保 DOM 更新完成\n\t\tawait nextTick()\n\t\t// 添加小延迟确保异步操作完全结束\n\t\tsetTimeout(() => {\n\t\t\tuni.stopPullDownRefresh()\n\t\t\tisRefreshing.value = false\n\t\t\tconsole.log('下拉刷新已停止')\n\t\t}, 100)\n\t}\n})\n\n// 页面显示时（从其他页面返回时）\nonShow(() => {\n\tconsole.log('页面显示，当前tab:', currentTab.value)\n\t// 如果刷新状态异常，强制重置\n\tif (isRefreshing.value) {\n\t\tconsole.log('检测到异常刷新状态，强制重置')\n\t\tforceStopRefresh()\n\t}\n})\n\n// 页面隐藏时\nonHide(() => {\n\tconsole.log('页面隐藏')\n\t// 页面隐藏时强制停止刷新\n\tforceStopRefresh()\n})\n\n// 暴露一些方法供外部使用（可选）\nconst refreshCurrentTab = () => {\n\tconsole.log('手动刷新当前tab:', currentTab.value)\n\t// 这里可以触发当前tab的数据刷新\n}\n\nconst getVisitedTabs = () => {\n\treturn Array.from(visitedTabs)\n}\n\n// 强制停止刷新状态（安全措施）\nconst forceStopRefresh = () => {\n\tif (isRefreshing.value) {\n\t\tuni.stopPullDownRefresh()\n\t\tisRefreshing.value = false\n\t\tconsole.log('强制停止刷新状态')\n\t}\n}\n\ndefineExpose({\n\trefreshCurrentTab,\n\tgetVisitedTabs,\n\tcurrentTab,\n\tforceStopRefresh\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.home-container {\n\tmin-height: 100vh;\n\tbackground: #f8f8f8;\n\tpadding-bottom: 120rpx; // 为底部tabbar留出空间\n}\n\n// 为不同tab内容添加不同的样式\n.home-tab-content {\n\t/* home组件有自己的完整样式，不需要额外包装 */\n\theight: 100vh;\n\toverflow: hidden;\n}\n\n.friends-tab-content {\n\t/* friends组件有自己的完整样式，不需要额外包装 */\n\theight: 100vh;\n\toverflow: hidden;\n}\n\n.discover-tab-content {\n\t/* discover组件有自己的完整样式，不需要额外包装 */\n\theight: 100vh;\n\toverflow: hidden;\n}\n\n.profile-tab-content {\n\t/* profile组件有自己的完整样式，不需要额外包装 */\n\theight: 100vh;\n\toverflow: hidden;\n}\n\n@keyframes fadeIn {\n\tfrom {\n\t\topacity: 0;\n\t\ttransform: translateY(20rpx);\n\t}\n\tto {\n\t\topacity: 1;\n\t\ttransform: translateY(0);\n\t}\n}\n</style> ","import MiniProgramPage from '/Users/xiaoqiang/Documents/friemd/firend-loving-app/pages/tabbar/page/page.vue'\nwx.createPage(MiniProgramPage)"],"names":["MqTabbar","HomeComponent","ProfileComponent","currentTab","ref","visitedTabs","reactive","isRefreshing","handleTabChange","tabName","uni","onMounted","onPullDownRefresh","timeoutPromise","_","reject","refreshPromise","homeRef","getCurrentInstance","profileRef","resolve","error","nextTick","onShow","forceStopRefresh","onHide","refreshCurrentTab","getVisitedTabs","__expose","MiniProgramPage"],"mappings":"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"}
{"version":3,"file":"Withdraw.js","sources":["subPackages/balance/Withdraw.vue","subPackages/balance/Withdraw.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"withdraw-container\">\n    <!-- 提现记录按钮 -->\n    <view class=\"withdraw-record-btn\" @click=\"goToWithdrawRecord\">\n      <image src=\"@/static/icons/profile/mxi.png\" class=\"record-icon\" mode=\"aspectFit\" />\n      <text class=\"record-text\">提现记录</text>\n    </view>\n    \n    <!-- 提现金额标题 -->\n    <view class=\"title\">提现金额</view>\n    \n    <!-- 金额显示 -->\n    <view class=\"amount-section\">\n      <view class=\"amount\">\n        <text class=\"currency-symbol\">¥</text>\n        <view>\n            <input \n          type=\"number\" \n          v-model=\"withdrawAmount\" \n          placeholder=\"\" \n          class=\"amount-input\"\n          :focus=\"inputFocus\"\n          @focus=\"onInputFocus\"\n          @blur=\"onInputBlur\"\n          confirm-type=\"done\"\n          cursor-spacing=\"20\"\n        />\n        </view>\n      </view>\n     \n    </view>\n    <view class=\"divider\"></view>\n    <!-- 余额信息 -->\n    <view class=\"balance-info\">\n      当前余额{{ formatBalance(balanceInfo.available_balance) }}元,<text class=\"withdraw-all\" @click=\"withdrawAll\">全部提现</text>\n    </view>\n    \n    <!-- 确认按钮 -->\n    <view class=\"flex-between\"> \n       <view></view>\n      <view class=\"confirm-button\" @click=\"handleConfirm\">\n      确定\n    </view>\n    </view>\n\n    <!-- 提现成功弹框 -->\n    <u-modal\n      title=\"提现已提交成功\"\n      :show=\"showWithdraw\"\n      content=\"您的提现请求已成功提交。提现状态会在后台处理后更新，请稍后查看账户余额或联系客服确认。\"\n      closeOnClickOverlay\n      showCancelButton\n      @close=\"() => showWithdraw = false\"\n    >\n      <template #confirmButton>\n        <u-button\n          text=\"确定\"\n          type=\"success\"\n          shape=\"circle\"\n          @click=\"handleWithdrawConfirm\"\n        ></u-button>\n      </template>\n    </u-modal>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted } from 'vue'\nimport { companionWithdraw } from '@/api/user.js'\nimport { getCompanionBalanceDetail } from '@/api/order.js'\n\n// 响应式数据\nconst withdrawAmount = ref('')\nconst inputFocus = ref(false)\nconst balanceInfo = ref({\n  balance: 0,\n  available_balance: 0,\n  frozen_balance: 0\n})\n\n// 提现成功弹框状态\nconst showWithdraw = ref(false)\n\n// 输入框获得焦点\nconst onInputFocus = () => {\n  inputFocus.value = true\n}\n\n// 输入框失去焦点\nconst onInputBlur = () => {\n  inputFocus.value = false\n}\n\n// 获取余额详情\nconst fetchBalanceDetail = async () => {\n  try {\n    const result = await getCompanionBalanceDetail({})\n    if (result.data && result.data.code === 0) {\n      balanceInfo.value = result.data.data || {\n        balance: 0,\n        available_balance: 0,\n        frozen_balance: 0\n      }\n    }\n  } catch (error) {\n    console.error('获取余额详情失败:', error)\n  }\n}\n\n// 确认提现\n  const handleConfirm = async () => {\n \n    const amount = parseFloat(withdrawAmount.value)\n    \n    if (!amount || amount <= 0) {\n      uni.showToast({\n        title: '请输入有效的提现金额',\n        icon: 'none'\n      })\n      return\n    }\n  \n  // 将可用余额从分转换为元进行比较\n  const availableBalanceYuan = balanceInfo.value.available_balance / 100\n  \n  if (amount > availableBalanceYuan) {\n    uni.showToast({\n      title: `提现金额不能超过可用余额${formatBalance(balanceInfo.value.available_balance)}元`,\n      icon: 'none'\n    })\n    return\n  }\n  \n  try {\n    uni.showLoading({\n      title: '提现中...'\n    })\n    \n    // 转换为分\n    const withdrawAmountInCents = Math.round(amount * 100)\n    \n    const result = await companionWithdraw({\n      withdraw_amount: withdrawAmountInCents\n    })\n    \n    uni.hideLoading()\n    \n    if (result.data && result.data.code === 0) {\n      uni.showToast({\n        title: '提现申请成功',\n        icon: 'success'\n      })\n      \n      // 清空输入框\n      withdrawAmount.value = ''\n      \n      // 刷新余额信息\n      await fetchBalanceDetail()\n      callWechatTransfer(result.data)\n   \n   \n    } else {\n      uni.showToast({\n        title: result.message || '提现失败',\n        icon: 'none'\n      })\n    }\n  } catch (error) {\n    uni.hideLoading()\n    console.error('提现失败:', error)\n    // uni.showToast({\n    //   title: '提现失败，请重试',\n    //   icon: 'none'\n    // })\n  }\n}\n\n\n// 调用微信商户转账\nconst callWechatTransfer = (result) => {\n\n  // #ifdef MP-WEIXIN\n  if (wx.canIUse('requestMerchantTransfer')) {\n    wx.requestMerchantTransfer({\n      mchId: '1724024386',\n      appId: wx.getAccountInfoSync().miniProgram.appId,\n      package: result.data.wx_package_info,\n      success: (res) => {\n        // res.err_msg将在页面展示成功后返回应用时返回ok，并不代表付款成功\n        console.log('微信转账成功:', res); \n        showWithdraw.value = true\n        // 微信转账成功后，提现成功弹框已经显示，无需额外处理\n      },\n      fail: (res) => {\n        console.log('微信转账失败:', res);\n        // uni.showToast({\n        //   title: '转账发起失败',\n        //   icon: 'none'\n        // })\n        uni.navigateBack({\n              delta: 1\n         })\n      },\n    });\n  } else {\n    wx.showModal({\n      content: '你的微信版本过低，请更新至最新版本。',\n      showCancel: false,\n    });\n  }\n  // #endif\n  \n  // #ifndef MP-WEIXIN\n  console.log('非微信小程序环境，跳过微信转账调用')\n  // #endif\n}\n\n\n// 格式化余额显示（分转元，保持精度）\nconst formatBalance = (balanceInCents) => {\n  if (!balanceInCents && balanceInCents !== 0) return '0.00'\n  // 使用字符串操作避免浮点数精度问题\n  const balanceStr = balanceInCents.toString()\n  const yuan = Math.floor(balanceInCents / 100)\n  const fen = balanceInCents % 100\n  \n  if (fen === 0) {\n    return yuan + '.00'\n  } else if (fen < 10) {\n    return yuan + '.0' + fen\n  } else {\n    return yuan + '.' + fen\n  }\n}\n\n// 全部提现\nconst withdrawAll = () => {\n  const availableBalanceYuan = balanceInfo.value.available_balance / 100\n  withdrawAmount.value = availableBalanceYuan.toFixed(2)\n}\n\n// 提现成功弹框确认\nconst handleWithdrawConfirm = () => {\n  showWithdraw.value = false\n  uni.navigateBack({\n    delta: 1\n  })\n}\n\n// 跳转到提现记录页面\nconst goToWithdrawRecord = () => {\n  uni.navigateTo({\n    url: '/subPackages/balance/record'\n  })\n}\n\n// 组件挂载时获取余额信息\nonMounted(() => {\n  fetchBalanceDetail()\n  // 延迟一下确保页面渲染完成后再聚焦输入框\n  setTimeout(() => {\n    inputFocus.value = true\n  }, 300)\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.withdraw-container {\n  height: 100vh;\n  background-color: #ffffff;\n  padding: 40rpx;\n  display: flex;\n  flex-direction: column; \n  box-sizing: border-box;\n}\n\n.withdraw-record-btn {\n  position: absolute;\n  top: 0rpx;\n  right: 20rpx;\n  display: flex;\n  align-items: center;\n\n  cursor: pointer;\n  transition: all 0.2s ease;\n  z-index: 10;\n}\n\n.withdraw-record-btn:active {\n  transform: scale(0.96);\n  background-color: #06a050;\n}\n\n.record-icon {\n  width: 32rpx;\n  height: 32rpx;\n  margin-right: 10rpx;\n}\n\n.record-text {\n  font-size: 28rpx;\n  color: #1a1a1a;\n  font-weight: 500;\n}\n\n.title { \n  margin-top: 40rpx;\n  font-size: 36rpx;\n  color: #000000;\n  text-align: left;\n  margin-bottom: 60rpx;\n  font-weight: 500;\n}\n\n.amount-section {\n  display: flex;\n  flex-direction: column;\n\n}\n\n.amount {\n  display: flex;\n  align-items: center;\n  margin-bottom: 20rpx;\n}\n\n.currency-symbol {\n  font-size: 50rpx;\n  font-weight:700;\n  color: #1a1a1a;\n  margin-right: 20rpx;\n}\n\n.amount-input {\n  font-size: 60rpx;\n  font-weight:700;\n  color: #1a1a1a;\n  text-align: left;\n  min-width: 200rpx;\n  height: 90rpx;\n  border: none;\n  outline: none;\n  background: transparent;\n  caret-color: #07c160;\n  /* 确保输入框稳定，不会抖动 */\n  box-sizing: border-box;\n  padding: 0;\n  margin: 0;\n  /* 禁用默认的输入框动画 */\n  -webkit-appearance: none;\n  appearance: none;\n}\n\n.divider {\n  width: 100%;\n  margin-top: 10rpx;\n  margin-bottom: 40rpx;\n  height: 2rpx;\n  background-color: #e0e0e0;\n}\n\n.balance-info {\n  font-size: 28rpx;\n  color: #000000;\n  text-align: left;\n  margin-bottom: 80rpx;\n}\n\n.withdraw-all {\n  color: #007aff;\n  font-weight: 500;\n  cursor: pointer;\n}\n\n.confirm-button { \n  display: flex;\n  justify-content: center;\n \n   margin-top: 60rpx;\n  background-color: #07c160;\n  color: #ffffff;\n  padding: 24rpx 0rpx;\n  border-radius:8rpx;\n  font-size: 32rpx;\n  font-weight: 500;\n  width: 160rpx;\n  box-sizing: border-box;\n}\n</style>","import MiniProgramPage from '/Users/xiaoqiang/Documents/friemd/firend-loving-app/subPackages/balance/Withdraw.vue'\nwx.createPage(MiniProgramPage)"],"names":["withdrawAmount","ref","inputFocus","balanceInfo","showWithdraw","onInputFocus","onInputBlur","fetchBalanceDetail","result","getCompanionBalanceDetail","error","uni","handleConfirm","amount","availableBalanceYuan","formatBalance","withdrawAmountInCents","companionWithdraw","callWechatTransfer","wx","res","balanceInCents","yuan","fen","withdrawAll","handleWithdrawConfirm","goToWithdrawRecord","onMounted","MiniProgramPage"],"mappings":"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"}
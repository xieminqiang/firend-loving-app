{"version":3,"file":"index.js","sources":["subPackages/balance/index.vue","subPackages/balance/index.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"balance-container\">\n    <!-- 余额明细按钮 -->\n    <view class=\"balance-details-btn\" @click=\"goToBalanceDetails\">\n      <image src=\"@/static/icons/profile/mxi.png\" class=\"details-icon\" mode=\"aspectFit\" />\n      <text class=\"details-text\">余额明细</text>\n    </view>\n    \n    <image src=\"@/static/icons/profile/yue.png\" class=\"balance-icon\" mode=\"aspectFit\" />\n    <view class=\"balance-text\">我的余额</view>\n    <view class=\"balance-amount\">\n      <text class=\"currency-symbol\">¥</text>\n      <text class=\"amount-number\">{{ formatBalance(balanceInfo.available_balance) }}</text>\n    </view>\n    \n    <!-- 提现按钮 -->\n    <view class=\"withdraw-button\" @click=\"goToWithdraw\">\n      提现\n    </view>\n  </view>\n\n  <!-- 待确认提现弹框 -->\n  <u-popup\n    :show=\"showPendingWithdraw\"\n    mode=\"bottom\"\n    :round=\"20\"\n    :closeOnClickOverlay=\"true\"\n    @close=\"closePendingWithdraw\"\n  >\n    <view class=\"pending-withdraw-popup\">\n      <view class=\"popup-header\">\n        <text class=\"popup-title\">待确认收款</text>\n        <text class=\"popup-close\" @click=\"closePendingWithdraw\">×</text>\n      </view>\n      \n      <view class=\"withdraw-list\">\n        <view \n          v-for=\"item in pendingWithdrawList\" \n          :key=\"item.id\" \n          class=\"withdraw-item\"\n        >\n          <view class=\"withdraw-info\">\n            <view class=\"withdraw-time\">{{ formatTime(item.created_at) }}</view>\n            <view class=\"withdraw-amount\">¥{{ formatAmount(item.amount) }}</view>\n          </view>\n          <view class=\"withdraw-actions\">\n            <view class=\"confirm-btn\" @click=\"confirmReceipt(item)\">\n              确认收款\n            </view>\n          </view>\n        </view>\n      </view>\n    </view>\n  </u-popup>\n\n  <!-- 提现成功弹框 -->\n  <u-modal\n    title=\"提现已提交成功\"\n    :show=\"showWithdrawSuccess\"\n    content=\"您的提现请求已成功提交。提现状态会在后台处理后更新，请稍后查看账户余额或联系客服确认。\"\n    closeOnClickOverlay\n    showCancelButton\n    @close=\"() => showWithdrawSuccess = false\"\n  >\n    <template #confirmButton>\n      <u-button\n        text=\"确定\"\n        type=\"success\"\n        shape=\"circle\"\n        @click=\"handleWithdrawSuccessConfirm\"\n      ></u-button>\n    </template>\n  </u-modal>\n</template>\n\n<script setup>\nimport { ref, onMounted } from 'vue' \nimport {\n\tonShow,\n\tonLoad\n} from '@dcloudio/uni-app';\nimport { getCompanionBalanceDetail } from '@/api/order.js'\nimport { getPendingWithdrawList } from '@/api/user.js'\n\n// 响应式数据\nconst balanceInfo = ref({\n  balance: 0,\n  available_balance: 0,\n  frozen_balance: 0\n})\n\n// 待确认提现弹框状态\nconst showPendingWithdraw = ref(false)\nconst pendingWithdrawList = ref([])\n\n// 提现成功弹框状态\nconst showWithdrawSuccess = ref(false)\n\n// 获取余额详情\nconst fetchBalanceDetail = async () => {\n  try {\n    const result = await getCompanionBalanceDetail({})\n    if (result.data && result.data.code === 0) {\n      balanceInfo.value = result.data.data || {\n        balance: 0,\n        available_balance: 0,\n        frozen_balance: 0\n      }\n      console.log('余额信息:', balanceInfo.value)\n    }\n  } catch (error) {\n    console.error('获取余额详情失败:', error)\n  }\n}\n\n// 格式化余额显示（分转元，保持精度）\nconst formatBalance = (balanceInCents) => {\n  if (!balanceInCents && balanceInCents !== 0) return '0.00'\n  // 使用字符串操作避免浮点数精度问题\n  const yuan = Math.floor(balanceInCents / 100)\n  const fen = balanceInCents % 100\n  \n  if (fen === 0) {\n    return yuan + '.00'\n  } else if (fen < 10) {\n    return yuan + '.0' + fen\n  } else {\n    return yuan + '.' + fen\n  }\n}\n\n// 格式化金额（分转元）\nconst formatAmount = (amountInCents) => {\n  if (!amountInCents && amountInCents !== 0) return '0.00'\n  return (amountInCents / 100).toFixed(2)\n}\n\n// 格式化时间\nconst formatTime = (timeStr) => {\n  if (!timeStr) return ''\n  const date = new Date(timeStr)\n  const month = (date.getMonth() + 1).toString().padStart(2, '0')\n  const day = date.getDate().toString().padStart(2, '0')\n  const hour = date.getHours().toString().padStart(2, '0')\n  const minute = date.getMinutes().toString().padStart(2, '0')\n  return `${month}-${day} ${hour}:${minute}`\n}\n\n// 跳转到提现页面\nconst goToWithdraw = () => {\n  // 检查是否有待确认的提现记录\n  if (pendingWithdrawList.value.length > 0) {\n    // 如果有待确认记录，显示弹框\n      showPendingWithdraw.value = true\n  } else {\n    // 没有待确认记录，直接跳转到提现页面\n    uni.navigateTo({\n      url: '/subPackages/balance/Withdraw'\n    })\n  } \n  \n}\n\n// 跳转到余额明细页面\nconst goToBalanceDetails = () => {\n  uni.navigateTo({\n    url: '/subPackages/balance/detail'\n  })\n}\n\n// 关闭待确认提现弹框\nconst closePendingWithdraw = () => {\n  showPendingWithdraw.value = false\n  \n\n}\n\n// 确认收款\nconst confirmReceipt = (item) => {\n  console.log('确认收款:', item)\n  callWechatTransferConfirm(item)\n}\n\n// 调用微信商户转账确认\nconst callWechatTransferConfirm = (item) => {\n  // #ifdef MP-WEIXIN\n  if (wx.canIUse('requestMerchantTransfer')) {\n    wx.requestMerchantTransfer({\n      mchId: '1724024386',\n      appId: wx.getAccountInfoSync().miniProgram.appId,\n      package: item.package_info, // 使用转账单号\n      success: (res) => {\n        // res.err_msg将在页面展示成功后返回应用时返回ok，并不代表付款成功\n        console.log('微信转账确认成功:', res);\n        \n        // 从列表中移除已确认的项目\n        const index = pendingWithdrawList.value.findIndex(i => i.id === item.id)\n        if (index > -1) {\n            pendingWithdrawList.value.splice(index, 1)\n        }\n        \n        // 显示提现成功弹框\n        showWithdrawSuccess.value = true\n        \n        // 如果没有更多待确认项目，关闭待确认弹框\n        if (pendingWithdrawList.value.length === 0) {\n          closePendingWithdraw()\n        }\n      },\n      fail: (res) => {\n        console.log('微信转账确认失败:', res);\n        // uni.showToast({\n        //   title: '确认收款失败',\n        //   icon: 'none'\n        // })\n      },\n    });\n  } else {\n    wx.showModal({\n      content: '你的微信版本过低，请更新至最新版本。',\n      showCancel: false,\n    });\n  }\n  // #endif\n  \n  // #ifndef MP-WEIXIN\n  console.log('非微信小程序环境，跳过微信转账确认调用')\n  // 模拟成功处理（用于非微信环境测试）\n  \n  // 从列表中移除已确认的项目\n  const index = pendingWithdrawList.value.findIndex(i => i.id === item.id)\n  if (index > -1) {\n    pendingWithdrawList.value.splice(index, 1)\n  }\n  \n  // 显示提现成功弹框\n  showWithdrawSuccess.value = true\n  \n  // 如果没有更多待确认项目，关闭弹框\n  if (pendingWithdrawList.value.length === 0) {\n    closePendingWithdraw()\n  }\n  // #endif\n}\n\n// 提现成功弹框确认\nconst handleWithdrawSuccessConfirm = () => {\n  showWithdrawSuccess.value = false\n}\n\n// 获取待确认提现列表\nconst fetchPendingWithdrawList = async () => {\n  try {\n    const result = await getPendingWithdrawList()\n    if (result.data && result.data.code === 0) {\n      console.log('待确认提现列表:', result.data.data)\n      pendingWithdrawList.value = result.data.data.list || []\n      \n      // 如果有待确认的提现，显示弹框\n      if (pendingWithdrawList.value.length > 0) {\n        showPendingWithdraw.value = true\n      }\n    }\n  } catch (error) {\n    console.error('获取待确认提现列表失败:', error)\n  }\n}\n\n// 组件挂载时获取余额信息\nonMounted(() => {\n\n  \n}) \n\nonShow(() => {\n\n  setTimeout(() => {\n    fetchPendingWithdrawList() \n  }, 1000)\n  fetchBalanceDetail()\n})\n\n\n</script>\n\n<style lang=\"scss\" scoped>\n.balance-container {\n  display: flex;\n  flex-direction: column;\n\n  align-items: center;\n  background: #ffffff;\n  height: 100vh; \n}\n\n.balance-icon {\n  margin-top: 100rpx;\n  width: 120rpx;\n  height: 120rpx;\n  margin-bottom: 40rpx;\n}\n\n.balance-text {\n  font-size: 32rpx;\n  color: #1a1a1a;\n  margin-bottom: 20rpx;\n  font-weight: 500;\n}\n\n.balance-amount {\n  display: flex;\n  align-items: baseline;\n  justify-content: center;\n}\n\n.currency-symbol {\n  font-size: 36rpx;\n  font-weight: 600;\n  color: #1a1a1a;\n  margin-right: 8rpx;\n}\n\n.amount-number {\n  font-size: 60rpx;\n  font-weight: 700;\n  color: #1a1a1a;\n}\n\n.withdraw-button {\n  display: flex;\n  justify-content: center;\n  margin-top: 100rpx;\n  background-color: #F8F8F8;\n  color: #1a1a1a;\n  padding: 20rpx 0rpx;\n  border-radius: 8rpx;\n  font-size: 32rpx;\n  font-weight: 500;\n  width: 260rpx;\n  box-sizing: border-box;\n  cursor: pointer;\n  transition: all 0.2s ease;\n}\n\n.withdraw-button:active {\n  transform: scale(0.96);\n  background-color: #06a050;\n}\n\n/* 待确认提现弹框样式 */\n.pending-withdraw-popup {\n  background: #ffffff;\n  border-radius: 20rpx 20rpx 0 0;\n  padding: 20rpx;\n  max-height: 70vh;\n}\n\n.popup-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n\n  padding-bottom: 20rpx;\n  border-bottom: 1rpx solid #f0f0f0;\n}\n\n.popup-title {\n  font-size: 36rpx;\n  font-weight: 600;\n  color: #1a1a1a;\n}\n\n.popup-close {\n  font-size: 48rpx;\n  color: #000000;\n  cursor: pointer;\n  padding: 10rpx;\n}\n\n.withdraw-list {\n  max-height: 50vh;\n  overflow-y: auto;\n}\n\n.withdraw-item {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 20rpx 0;\n  border-bottom: 1rpx solid #f8f8f8;\n}\n\n.withdraw-item:last-child {\n  border-bottom: none;\n}\n\n.withdraw-info {\n  flex: 1;\n}\n\n.withdraw-time {\n  font-size: 28rpx;\n  color: #666;\n  margin-bottom: 8rpx;\n}\n\n.withdraw-amount {\n  font-size: 32rpx;\n  font-weight: 600;\n  color: #f43f5e;\n}\n\n.withdraw-actions {\n  margin-left: 20rpx;\n}\n\n.confirm-btn {\n  background: #07c160;\n  color: #ffffff;\n  padding: 10rpx 28rpx;\n  border-radius: 10rpx;\n  font-size: 28rpx;\n  font-weight: 500;\n  cursor: pointer;\n  transition: all 0.2s ease;\n}\n\n.confirm-btn:active {\n  transform: scale(0.96);\n  background: #06a050;\n}\n\n/* 余额明细按钮样式 */\n.balance-details-btn {\n  position: absolute;\n  top: 0rpx; /* Adjust as needed */\n  right: 20rpx; /* Adjust as needed */\n  display: flex;\n  align-items: center;\n\n  cursor: pointer;\n  transition: all 0.2s ease;\n}\n\n.balance-details-btn:active {\n  transform: scale(0.96);\n  background-color: #06a050;\n}\n\n.details-icon {\n  width: 32rpx;\n  height: 32rpx;\n  margin-right: 10rpx;\n}\n\n.details-text {\n  font-size: 28rpx;\n  color: #1a1a1a;\n  font-weight: 500;\n}\n</style>","import MiniProgramPage from '/Users/xiaoqiang/Documents/friemd/firend-loving-app/subPackages/balance/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["balanceInfo","ref","showPendingWithdraw","pendingWithdrawList","showWithdrawSuccess","fetchBalanceDetail","result","getCompanionBalanceDetail","uni","error","formatBalance","balanceInCents","yuan","fen","formatAmount","amountInCents","formatTime","timeStr","date","month","day","hour","minute","goToWithdraw","goToBalanceDetails","closePendingWithdraw","confirmReceipt","item","callWechatTransferConfirm","wx","res","index","i","handleWithdrawSuccessConfirm","fetchPendingWithdrawList","getPendingWithdrawList","onMounted","onShow","MiniProgramPage"],"mappings":"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"}
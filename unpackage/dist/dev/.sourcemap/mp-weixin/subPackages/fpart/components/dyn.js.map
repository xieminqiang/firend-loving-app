{"version":3,"file":"dyn.js","sources":["subPackages/fpart/components/dyn.vue","subPackages/fpart/components/dyn.vue?type=page"],"sourcesContent":["<template>\n  <scroll-view \n    class=\"dyn-container\" \n    scroll-y=\"true\"\n    @scrolltolower=\"onScrollToLower\"\n    :refresher-enabled=\"true\"\n    :refresher-triggered=\"refreshing\"\n    @refresherrefresh=\"onRefresh\"\n    :lower-threshold=\"100\">\n    <!-- 动态列表 -->\n    <view v-if=\"momentsLoading && momentsList.length === 0\" class=\"loading-state\">\n      <text class=\"loading-text\">加载中...</text>\n    </view>\n    <view v-else-if=\"momentsList.length > 0\" class=\"moments-list\">\n      <view v-for=\"(item, index) in momentsList\" :key=\"index\" class=\"moment-item\">\n        <view class=\"moment-left\">\n          <view class=\"moment-day\">{{ item.moments_info?.time_date }}</view>\n          <view class=\"moment-time\">{{ item.moments_info?.time_time }}</view>\n        </view>\n        <view class=\"moment-right\">\n          <!-- 文案 -->\n          <view class=\"copywriting\">\n            <view>{{ item.moments_info?.content }}</view>\n            \n            <!-- 照片 -->\n            <view>\n              <PictureDisplay v-if=\"item.moments_info?.file_list\" :list=\"item.moments_info?.file_list\"\n                :topicList=\"item.moments_info?.topic_list\" @playVideo=\"handlePlayVideo\"></PictureDisplay>\n            </view>\n          </view>\n          \n          <!-- 底部 -->\n          <view class=\"foot\">\n            <view class=\"foot-right\">\n              <!-- 点赞 -->\n              <view class=\"icon-item\">\n                <image v-if=\"!item.moments_info?.is_praised\" src=\"@/static/square/love.png\" mode=\"\"\n                  class=\"foot-image\" @tap=\"handlePraise(item)\">\n                </image>\n                <image v-if=\"item.moments_info?.is_praised\" src=\"@/static/square/active-love.png\" mode=\"\"\n                  class=\"foot-image\" @tap=\"handlePraise(item)\">\n                </image>\n                <view class=\"icon-title\">{{ item.moments_info?.praise_num || 0 }}</view>\n              </view>\n              <!-- 评论 -->\n              <view class=\"icon-item icon-item-center\" @tap=\"toRecord(item)\">\n                <image src=\"@/static/square/message.png\" mode=\"\" class=\"foot-image\"></image>\n                <view class=\"icon-title\">{{ item.moments_info?.comments_num || 0 }}</view>\n              </view>\n            </view>\n          </view>\n        </view>\n      </view>\n      \n      <!-- 加载更多状态 -->\n      <view v-if=\"loadingMore\" class=\"load-more-state\">\n        <text class=\"load-more-text\">加载中...</text>\n      </view>\n      <view v-else-if=\"noMoreData && momentsList.length > 0\" class=\"no-more-state\">\n        <text class=\"no-more-text\">~ 没有更多了 ~</text>\n      </view>\n    </view>\n    <view v-else class=\"empty-state-profile\">\n      <image src=\"/static/images/empty.png\" class=\"empty-icon\" mode=\"aspectFit\" />\n      <text class=\"empty-text-profile\">~暂无发布内容~</text>\n    </view>\n\n    <!-- 视频播放弹框 -->\n    <u-popup :show=\"popupShow\" mode=\"center\" :safeAreaInsetBottom=\"false\">\n      <view class=\"video-popup-content\">\n        <video \n          class=\"video-player\" \n          :src=\"currentVideoPath\" \n          :controls=\"false\" \n          :show-center-play-btn=\"false\"\n          :show-fullscreen-btn=\"false\"\n          :show-progress=\"true\"\n          :enable-progress-gesture=\"true\"\n          autoplay>\n        </video>\n        <!-- 关闭按钮 -->\n        <view class=\"close-btn\" @tap=\"closeVideoPopup\">\n          <image src=\"/static/find/close2.png\" mode=\"widthFix\" class=\"close-icon\"></image>\n        </view>\n      </view>\n    </u-popup>\n  </scroll-view>\n</template>\n\n<script setup>\nimport { ref, onMounted, getCurrentInstance } from 'vue'\nimport { getMomentsByCompanion, praiseMoment } from '@/api/discover.js'\nimport PictureDisplay from '@/components/common/PictureDisplay.vue'\n\n// 获取页面参数\nconst params = ref({})\n\n// 获取当前实例以访问全局属性\nconst { proxy } = getCurrentInstance()\n\n// 动态列表数据\nconst momentsList = ref([])\nconst momentsLoading = ref(false)\n\n// 分页相关状态\nconst currentPage = ref(1)\nconst pageSize = ref(20)\nconst loadingMore = ref(false)\nconst noMoreData = ref(false)\nconst refreshing = ref(false)\n\n// 视频播放弹框相关状态\nconst popupShow = ref(false)\nconst currentVideoPath = ref('')\n\n// 获取友伴师动态列表\nconst getMomentsData = async (isRefresh = false) => {\n  if (!params.value.companion_id) return\n  \n  try {\n    if (isRefresh) {\n      refreshing.value = true\n      currentPage.value = 1\n      noMoreData.value = false\n    } else if (currentPage.value === 1) {\n      momentsLoading.value = true\n    } else {\n      loadingMore.value = true\n    }\n    \n    const requestParams = {\n      companion_id: parseInt(params.value.companion_id),\n      page: currentPage.value,\n      page_size: pageSize.value\n    }\n    \n    const response = await getMomentsByCompanion(requestParams)\n    console.log('动态列表响应:', response)\n    \n    if (response.data && response.data.code === 0) {\n      const data = response.data.data\n      if (data && data.moments_list) {\n        if (isRefresh || currentPage.value === 1) {\n          // 刷新或首次加载，替换数据\n          momentsList.value = data.moments_list\n        } else {\n          // 加载更多，追加数据\n          momentsList.value = [...momentsList.value, ...data.moments_list]\n        }\n        \n        // 判断是否还有更多数据\n        if (data.moments_list.length < pageSize.value) {\n          noMoreData.value = true\n        }\n        \n        console.log('动态列表数据:', momentsList.value)\n      }\n    } else {\n      console.error('获取动态列表失败:', response.data?.message || '未知错误')\n      if (!isRefresh && currentPage.value > 1) {\n        // 加载更多失败时，回退页码\n        currentPage.value--\n      }\n    }\n  } catch (error) {\n    console.error('获取动态列表异常:', error)\n    if (!isRefresh && currentPage.value > 1) {\n      // 加载更多失败时，回退页码\n      currentPage.value--\n    }\n  } finally {\n    momentsLoading.value = false\n    loadingMore.value = false\n    refreshing.value = false\n  }\n}\n\n// 处理视频播放\nconst handlePlayVideo = (videoPath) => { \n  console.log('播放视频:', videoPath)\n  currentVideoPath.value = videoPath\n  popupShow.value = true\n}\n\n// 关闭视频弹框\nconst closeVideoPopup = () => {\n  popupShow.value = false\n  currentVideoPath.value = ''\n}\n\n// 点赞处理\nconst handlePraise = async (val) => {\n  try {\n    // 先更新本地状态，提供即时反馈\n    const wasPraised = val.moments_info.is_praised\n    val.moments_info.is_praised = !wasPraised\n    \n    if (val.moments_info.is_praised) {\n      val.moments_info.praise_num = parseInt(val.moments_info.praise_num) + 1\n    } else {\n      val.moments_info.praise_num = Math.max(0, parseInt(val.moments_info.praise_num) - 1)\n    }\n    \n    // 调用API接口\n    const response = await praiseMoment({\n      target_id: val.moments_info.moments_id\n    })\n    \n    if (response.data && response.data.code === 0) {\n      // API调用成功，本地状态已经更新\n      console.log('点赞成功')\n    } else {\n      // API调用失败，回滚本地状态\n      val.moments_info.is_praised = wasPraised\n      if (wasPraised) {\n        val.moments_info.praise_num = parseInt(val.moments_info.praise_num) + 1\n      } else {\n        val.moments_info.praise_num = Math.max(0, parseInt(val.moments_info.praise_num) - 1)\n      }\n      \n      uni.showToast({\n        title: '点赞失败，请重试',\n        icon: 'none'\n      })\n    }\n  } catch (error) {\n    console.error('点赞失败:', error)\n    // 发生错误，回滚本地状态\n    const wasPraised = val.moments_info.is_praised\n    val.moments_info.is_praised = !wasPraised\n    if (wasPraised) {\n      val.moments_info.praise_num = parseInt(val.moments_info.praise_num) + 1\n    } else {\n      val.moments_info.praise_num = Math.max(0, parseInt(val.moments_info.praise_num) - 1)\n    }\n    \n    uni.showToast({\n      title: '网络错误，请重试',\n      icon: 'none'\n    })\n  }\n}\n\n// 去评论\nconst toRecord = (item) => {\n  uni.navigateTo({\n    url: '/subPackages/record/comment',\n    success(res) {\n      // 通过eventChannel向被打开页面传送数据\n      res.eventChannel.emit('getRecord', {\n        data: item\n      })\n    }\n  })\n}\n\n// 上拉加载更多\nconst onScrollToLower = () => {\n  console.log('触发上拉加载')\n  if (loadingMore.value || noMoreData.value) {\n    return\n  }\n  \n  currentPage.value++\n  getMomentsData()\n}\n\n// 下拉刷新\nconst onRefresh = () => {\n  console.log('触发下拉刷新')\n  getMomentsData(true)\n}\n\n\nonMounted(async () => {\n  // 获取页面参数\n  const pages = getCurrentPages()\n  const currentPage = pages[pages.length - 1]\n  params.value = currentPage.options || {}\n  \n  console.log('页面参数:', params.value)\n  \n  // 调用动态列表接口\n  if (params.value.companion_id) {\n    getMomentsData()\n  }\n})\n</script>\n\n<style scoped>\n.dyn-container {\n  background: #fff;\n  height: 100vh;\n  font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;\n}\n\n\n/* 动态列表样式 */\n.loading-state {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  padding: 60rpx 0;\n}\n\n.loading-text {\n  font-size: 28rpx;\n  color: #999;\n}\n\n.moments-list {\n  padding: 0 24rpx;\n}\n\n.moment-item {\n  display: flex;\n  padding: 20rpx 0 20rpx 0rpx;\n  border-bottom: 1rpx solid #f0f0f0;\n}\n\n.moment-item:last-child {\n  border-bottom: none;\n}\n\n.moment-left {\n  display: flex;\n  flex-direction: column;\n  margin-right: 24rpx;\n  min-width: 120rpx;\n}\n\n.moment-day {\n  font-size: 32rpx;\n  font-weight: 400;\n  color: #b3b3b3;\n  margin-bottom: 4rpx;\n}\n\n.moment-time {\n  font-size: 20rpx;\n  font-weight: 300;\n  color: #b3b3b3;\n}\n\n.moment-right {\n  flex: 1;\n  min-width: 0;\n}\n\n.copywriting {\n  padding-left: 0;\n  padding-top: 20rpx;\n  padding-right: 20rpx;\n  font-size: 24rpx;\n  color: rgba(26, 26, 26, 1);\n  box-sizing: border-box;\n  overflow: hidden;\n}\n\n.foot {\n  margin-top: 20rpx;\n  display: flex;\n  justify-content: flex-end;\n  align-items: center;\n  margin-left: 0;\n}\n\n.foot-image {\n  width: 44rpx;\n  height: 44rpx;\n}\n\n.foot-right {\n  display: flex;\n}\n\n.icon-item {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.icon-title {\n  margin-left: 12rpx;\n  font-size: 20rpx;\n  font-weight: 500;\n  color: rgba(153, 153, 153, 1);\n}\n\n.icon-item-center {\n  margin-left: 50rpx;\n  margin-right: 20rpx;\n}\n\n.empty-state-profile {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  padding: 120rpx 60rpx;\n  text-align: center;\n}\n\n.empty-icon {\n  width: 200rpx;\n  height: 200rpx;\n  margin-bottom: 32rpx;\n  opacity: 0.6;\n}\n\n.empty-text-profile {\n  font-size: 28rpx;\n  color: #9999;\n  font-weight: 600;\n  margin-bottom: 16rpx;\n}\n\n/* 加载更多状态样式 */\n.load-more-state {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  padding: 40rpx 0;\n}\n\n.load-more-text {\n  font-size: 24rpx;\n  color: #999;\n}\n\n.no-more-state {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  padding: 40rpx 0;\n}\n\n.no-more-text {\n  font-size: 24rpx;\n  color: #ccc;\n}\n\n/* 视频播放弹框样式 */\n.video-popup-content {\n  width: 100vw;\n  background: transparent;\n  padding: 0;\n  margin: 0;\n}\n\n.video-player {\n  width: 100vw;\n  height: 100vh;\n  background: transparent;\n  border: none;\n  outline: none;\n  display: block;\n}\n\n.close-btn {\n  position: absolute;\n  bottom: 40rpx;\n  left: 50%;\n  transform: translateX(-50%);\n  z-index: 1000;\n  width: 80rpx;\n  height: 80rpx;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  background: rgba(255, 255, 255, 1);\n  border-radius: 50%;\n}\n\n.close-icon {\n  width: 40rpx;\n  height: 40rpx;\n}\n\n/* 确保u-popup没有默认样式 */\n:deep(.u-popup__content) {\n  background-color: transparent !important;\n  padding: 0 !important;\n  margin: 0 !important;\n  border: none !important;\n}\n\n/* 确保视频元素没有默认样式 */\n:deep(video) {\n  background-color: transparent !important;\n  border: none !important;\n  outline: none !important;\n  vertical-align: top !important;\n}\n</style>\n","import MiniProgramPage from '/Users/xiaoqiang/Documents/friemd/firend-loving-app/subPackages/fpart/components/dyn.vue'\nwx.createPage(MiniProgramPage)"],"names":["PictureDisplay","params","ref","momentsList","momentsLoading","currentPage","pageSize","loadingMore","noMoreData","refreshing","popupShow","currentVideoPath","getMomentsData","isRefresh","requestParams","response","getMomentsByCompanion","uni","data","_a","error","handlePlayVideo","videoPath","closeVideoPopup","handlePraise","val","wasPraised","praiseMoment","toRecord","item","res","onScrollToLower","onRefresh","onMounted","pages","MiniProgramPage"],"mappings":"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"}
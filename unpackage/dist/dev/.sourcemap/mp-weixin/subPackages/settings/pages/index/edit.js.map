{"version":3,"file":"edit.js","sources":["subPackages/settings/pages/index/edit.vue","subPackages/settings/pages/index/edit.vue?type=page"],"sourcesContent":["<template>\n\t<view class=\"container\">\n\t\t<!-- 主要内容区域 -->\n\t\t<view class=\"content\">\n\t\t\t<!-- 头像编辑区域 -->\n\t\t\t<view class=\"avatar-section\">\n\t\t\t\t<view class=\"avatar-container\" @click=\"chooseAvatar\">\n\t\t\t\t\t<image v-if=\"tempUserInfo.head_img\" \n\t\t\t\t\t\t:src=\"tempUserInfo.head_img.startsWith('http') ? tempUserInfo.head_img : $imgBaseUrl + tempUserInfo.head_img\"\n\t\t\t\t\t\tclass=\"avatar-image\" \n\t\t\t\t\t\tmode=\"aspectFill\" />\n\t\t\t\t\t<view v-else class=\"avatar-placeholder\">\n\t\t\t\t\t\t<text class=\"placeholder-text\">头</text>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<text class=\"avatar-tip\">点击头像更换</text>\n\t\t\t</view>\n\t\t\t\n\t\t\t<!-- 昵称编辑区域 -->\n\t\t\t<view class=\"nickname-section\">\n\t\t\t\t<view class=\"input-group\">\n\t\t\t\t\t<text class=\"input-label\">昵称</text>\n\t\t\t\t\t<input \n\t\t\t\t\t\tclass=\"nickname-input\"\n\t\t\t\t\t\tv-model=\"tempUserInfo.nick_name\"\n\t\t\t\t\t\tplaceholder=\"请输入昵称\"\n\t\t\t\t\t\tmaxlength=\"20\"\n\t\t\t\t\t\t@input=\"onNicknameInput\"\n\t\t\t\t\t/>\n\t\t\t\t\t<text class=\"char-count\">{{ tempUserInfo.nick_name.length }}/20</text>\n\t\t\t\t</view>\n\t\t\t\t\n\t\t\t\n\t\t\t</view> \n            \t<!-- 保存按钮 -->\n\t\t\t\t<view class=\"save-section\">\n\t\t\t\t\t<button class=\"save-btn\" @click=\"saveChanges\">\n\t\t\t\t\t\t<text class=\"save-text\">保存</text>\n\t\t\t\t\t</button>\n\t\t\t\t</view>\n\t\t</view>\n\t</view>\n</template>\n\n<script setup>\nimport { ref, reactive, computed } from 'vue'\nimport { onLoad } from '@dcloudio/uni-app'\nimport { useUserStore } from '@/stores/user.js'\nimport { updateUserBasicInfo } from '@/api/user.js'\nimport { uploadFile, getUploadResult } from '@/api/file.js'\n\nconst userStore = useUserStore()\n\n// 获取用户信息\nconst userInfo = computed(() => userStore.userInfo || {})\n\n// 临时用户信息，用于编辑\nconst tempUserInfo = reactive({\n\thead_img: '',\n\tnick_name: ''\n})\n\n// 原始用户信息，用于比较是否有变化\nconst originalUserInfo = ref({})\n\n// 是否有变化\nconst hasChanges = computed(() => {\n\treturn tempUserInfo.head_img !== originalUserInfo.value.head_img ||\n\t\t   tempUserInfo.nick_name !== originalUserInfo.value.nick_name\n})\n\nonLoad(() => {\n\t// 获取当前用户信息\n\tconst currentUserInfo = userStore.userInfo || {}\n\toriginalUserInfo.value = { ...currentUserInfo }\n\t\n\t// 初始化临时数据 - 确保头像路径正确\n\ttempUserInfo.head_img = currentUserInfo.head_img || ''\n\ttempUserInfo.nick_name = currentUserInfo.nick_name || ''\n\t\n\tconsole.log('当前用户头像:', currentUserInfo.head_img)\n\tconsole.log('临时头像数据:', tempUserInfo.head_img)\n})\n\n// 返回上一页\nconst goBack = () => {\n\tif (hasChanges.value) {\n\t\tuni.showModal({\n\t\t\ttitle: '提示',\n\t\t\tcontent: '有未保存的更改，确定要离开吗？',\n\t\t\tsuccess: (res) => {\n\t\t\t\tif (res.confirm) {\n\t\t\t\t\tuni.navigateBack()\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t} else {\n\t\tuni.navigateBack()\n\t}\n}\n\n// 头像选择处理\nconst chooseAvatar = () => {\n\tuni.chooseImage({\n\t\tcount: 1, // 只选择1张图片\n\t\tsizeType: ['compressed'],\n\t\tsourceType: ['album', 'camera'],\n\t\tsuccess: async (res) => {\n\t\t\tconst filePath = res.tempFilePaths[0]\n\t\t\tconsole.log('选择的头像:', filePath)\n\t\t\t\n\t\t\t// 显示上传进度\n\t\t\tuni.showLoading({\n\t\t\t\ttitle: '上传中...',\n\t\t\t\tmask: true\n\t\t\t})\n\t\t\t\n\t\t\ttry {\n\t\t\t\t// 获取文件信息\n\t\t\t\tconst fileInfo = await getFileInfo(filePath)\n\t\t\t\tconsole.log(\"fileInfo\", fileInfo)\n\t\t\t\tconsole.log(\"filePath\", filePath)\n\t\t\t\t\n\t\t\t\tif (!fileInfo || !fileInfo.extension) {\n\t\t\t\t\tthrow new Error('无法获取文件信息')\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// 上传文件\n\t\t\t\tconst uploadResult = await uploadFile({\n\t\t\t\t\tfilePath: filePath,\n\t\t\t\t\tname: `avatar_${Date.now()}.${fileInfo.extension}`\n\t\t\t\t})\n\t\t\t\t\n\t\t\t\t// 解析上传结果\n\t\t\t\tconst fileData = getUploadResult(uploadResult)\n\t\t\t\tif (!fileData || !fileData.url) {\n\t\t\t\t\tthrow new Error('上传结果解析失败')\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// 更新临时头像为上传后的URL\n\t\t\t\ttempUserInfo.head_img = fileData.url\n\t\t\t\t\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '头像上传成功',\n\t\t\t\t\ticon: 'success'\n\t\t\t\t})\n\t\t\t\t\n\t\t\t} catch (uploadError) {\n\t\t\t\tconsole.error('头像上传失败:', uploadError)\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '头像上传失败，请重试',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t})\n\t\t\t} finally {\n\t\t\t\tuni.hideLoading()\n\t\t\t}\n\t\t},\n\t\tfail: (error) => {\n\t\t\tconsole.error('选择头像失败:', error)\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '选择头像失败',\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t}\n\t})\n}\n\n// 获取文件信息\nconst getFileInfo = (filePath) => {\n\treturn new Promise((resolve, reject) => {\n\t\tuni.getFileInfo({\n\t\t\tfilePath: filePath,\n\t\t\tsuccess: (res) => {\n\t\t\t\t// 从文件路径中提取扩展名\n\t\t\t\tconst extension = filePath.split('.').pop().toLowerCase()\n\t\t\t\tresolve({\n\t\t\t\t\tsize: res.size,\n\t\t\t\t\textension: extension\n\t\t\t\t})\n\t\t\t},\n\t\t\tfail: (error) => {\n\t\t\t\tconsole.error('获取文件信息失败:', error)\n\t\t\t\t// 如果获取文件信息失败，使用默认扩展名\n\t\t\t\tconst extension = filePath.split('.').pop().toLowerCase() || 'jpg'\n\t\t\t\tresolve({\n\t\t\t\t\tsize: 0,\n\t\t\t\t\textension: extension\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\t})\n}\n\n// 昵称输入处理\nconst onNicknameInput = (e) => {\n\tconst value = e.detail.value\n\t// 过滤特殊字符，只允许中文、英文、数字\n\ttempUserInfo.nick_name = value.replace(/[^\\u4e00-\\u9fa5a-zA-Z0-9]/g, '')\n}\n\n// 保存更改\nconst saveChanges = async () => {\n\tif (!hasChanges.value) {\n\t\tuni.showToast({\n\t\t\ttitle: '没有更改需要保存',\n\t\t\ticon: 'none'\n\t\t})\n\t\treturn\n\t}\n\t\n\t// 验证昵称\n\tif (!tempUserInfo.nick_name.trim()) {\n\t\tuni.showToast({\n\t\t\ttitle: '请输入昵称',\n\t\t\ticon: 'none'\n\t\t})\n\t\treturn\n\t}\n\t\n\tif (tempUserInfo.nick_name.trim().length < 2) {\n\t\tuni.showToast({\n\t\t\ttitle: '昵称至少2个字符',\n\t\t\ticon: 'none'\n\t\t})\n\t\treturn\n\t}\n\t\n\ttry {\n\t\tuni.showLoading({\n\t\t\ttitle: '保存中...'\n\t\t})\n\t\t\n\t\t// 准备更新的数据\n\t\tconst updateData = {}\n\t\tif (tempUserInfo.head_img !== originalUserInfo.value.head_img) {\n\t\t\tupdateData.head_img = tempUserInfo.head_img\n\t\t}\n\t\tif (tempUserInfo.nick_name !== originalUserInfo.value.nick_name) {\n\t\t\tupdateData.nick_name = tempUserInfo.nick_name\n\t\t}\n\t\t\n\t\t// 调用接口更新用户信息\n\t\tconst result = await updateUserBasicInfo(updateData)\n\t\tconsole.log('保存结果:', result.data)\n\t\tif (result.data.code === 0) {\n\t\t\t// 更新本地用户信息\n\t\t\tuserStore.setUserInfo({\n\t\t\t\t...userStore.userInfo,\n\t\t\t\t...updateData\n\t\t\t})\n\t\t\t\n\t\t\t// 更新原始数据\n\t\t\toriginalUserInfo.value = { ...userStore.userInfo }\n\t\t\t\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '保存成功',\n\t\t\t\ticon: 'success'\n\t\t\t})\n\t\t\t\n\t\t\t// 延迟返回上一页\n\t\t\tsetTimeout(() => {\n\t\t\t\tuni.navigateBack()\n\t\t\t}, 1500)\n\t\t} else { \n            //报错1\n\t\t\tuni.showToast({\n\t\t\t\ttitle: result.data.msg || \"保存失败或者与其他用户同名了\",\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t}\n\t\t} catch (error) { \n           //报错2\n\t\tconsole.error('保存失败:', error)\n\t\t\n\t\t// 处理业务错误（如昵称重复）\n\t\tif (error && error.data && error.data.code === 400) {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: error.data.msg || \"保存失败或者与其他用户同名了\",\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t} else {\n\t\t\t// 处理其他错误\n\t\t\tuni.showToast({\n\t\t\t\ttitle: \"保存失败，请重试\",\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t}\n\t} finally {\n\t\tuni.hideLoading()\n\t}\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.container {\n\twidth: 100vw;\n\tmin-height: 100vh;\n\tbackground-color: #f8f8f8;\n}\n\n.content {\n\tmargin-top: 32rpx;\n\tpadding: 32rpx;\n}\n\n\n\n.avatar-section {\n\n\tmargin-bottom: 32rpx;\n\ttext-align: center;\n}\n\n.avatar-container {\n\tposition: relative;\n\twidth: 120rpx;\n\theight: 120rpx;\n\tborder-radius: 50%;\n\tmargin: 0 auto 32rpx;\n\toverflow: hidden;\n\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n}\n\n.avatar-image {\n\twidth: 100%;\n\theight: 100%;\n\tborder-radius: 50%;\n}\n\n.avatar-placeholder {\n\twidth: 100%;\n\theight: 100%;\n\tborder-radius: 50%;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tbackground: linear-gradient(135deg, rgba(115, 99, 255, 0.1) 0%, rgba(255, 105, 222, 0.1) 100%);\n}\n\n.placeholder-text {\n\tcolor: #999999;\n\tfont-size: 40rpx;\n\tfont-weight: 500;\n}\n\n\n\n.avatar-tip {\n\tcolor: #999999;\n\tfont-size: 28rpx;\n}\n\n.nickname-section {\n\tbackground-color: #ffffff;\n\tborder-radius: 16rpx;\n\tpadding: 32rpx;\n\n}\n\n.input-group {\n\tposition: relative;\n}\n\n.input-label {\n\tdisplay: block;\n\tcolor: #333333;\n\tfont-size: 32rpx;\n\tfont-weight: 500;\n\tmargin-bottom: 32rpx;\n}\n\n.nickname-input {\n\twidth: 100%;\n\theight: 80rpx;\n\tbackground-color: #f8f8f8;\n\tborder-radius: 12rpx;\n\tpadding: 0 32rpx;\n\tcolor: #333333;\n\tfont-size: 32rpx;\n\tbox-sizing: border-box;\n}\n\n.char-count {\n\tposition: absolute;\n\tright: 32rpx;\n\tbottom: 32rpx;\n\tcolor: #999999;\n\tfont-size: 28rpx;\n}\n\n.save-section {\n\tmargin-top: 48rpx;\n}\n\n.save-btn {\n\twidth: 100%;\n\theight: 88rpx;\n\tbackground: linear-gradient(135deg, #7363FF 0%, #FF69DE 100%);\n\tborder-radius: 16rpx;\n\tborder: none;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\t\n\t&::after {\n\t\tborder: none;\n\t}\n}\n\n.save-text {\n\tcolor: #ffffff;\n\tfont-size: 32rpx;\n\tfont-weight: 500;\n}\n</style>","import MiniProgramPage from '/Users/xiaoqiang/Documents/friemd/firend-loving-app/subPackages/settings/pages/index/edit.vue'\nwx.createPage(MiniProgramPage)"],"names":["userStore","useUserStore","computed","tempUserInfo","reactive","originalUserInfo","ref","hasChanges","onLoad","currentUserInfo","uni","chooseAvatar","res","filePath","fileInfo","getFileInfo","uploadResult","uploadFile","fileData","getUploadResult","uploadError","error","resolve","reject","extension","onNicknameInput","e","value","saveChanges","updateData","result","updateUserBasicInfo","MiniProgramPage"],"mappings":"yMAmDA,MAAMA,EAAYC,EAAAA,aAAc,EAGfC,EAAAA,SAAS,IAAMF,EAAU,UAAY,EAAE,EAGxD,MAAMG,EAAeC,EAAAA,SAAS,CAC7B,SAAU,GACV,UAAW,EACZ,CAAC,EAGKC,EAAmBC,EAAG,IAAC,EAAE,EAGzBC,EAAaL,EAAQ,SAAC,IACpBC,EAAa,WAAaE,EAAiB,MAAM,UACpDF,EAAa,YAAcE,EAAiB,MAAM,SACtD,EAEDG,EAAAA,OAAO,IAAM,CAEZ,MAAMC,EAAkBT,EAAU,UAAY,CAAE,EAChDK,EAAiB,MAAQ,CAAE,GAAGI,CAAiB,EAG/CN,EAAa,SAAWM,EAAgB,UAAY,GACpDN,EAAa,UAAYM,EAAgB,WAAa,GAEtDC,sEAAY,UAAWD,EAAgB,QAAQ,EAC/CC,EAAY,MAAA,MAAA,MAAA,kDAAA,UAAWP,EAAa,QAAQ,CAC7C,CAAC,EAoBD,MAAMQ,EAAe,IAAM,CAC1BD,EAAAA,MAAI,YAAY,CACf,MAAO,EACP,SAAU,CAAC,YAAY,EACvB,WAAY,CAAC,QAAS,QAAQ,EAC9B,QAAS,MAAOE,GAAQ,CACvB,MAAMC,EAAWD,EAAI,cAAc,CAAC,EACpCF,EAAAA,MAAY,MAAA,MAAA,mDAAA,SAAUG,CAAQ,EAG9BH,EAAAA,MAAI,YAAY,CACf,MAAO,SACP,KAAM,EACV,CAAI,EAED,GAAI,CAEH,MAAMI,EAAW,MAAMC,EAAYF,CAAQ,EAI3C,GAHAH,EAAAA,MAAY,MAAA,MAAA,mDAAA,WAAYI,CAAQ,EAChCJ,EAAAA,MAAY,MAAA,MAAA,mDAAA,WAAYG,CAAQ,EAE5B,CAACC,GAAY,CAACA,EAAS,UAC1B,MAAM,IAAI,MAAM,UAAU,EAI3B,MAAME,EAAe,MAAMC,aAAW,CACrC,SAAUJ,EACV,KAAM,UAAU,KAAK,IAAK,CAAA,IAAIC,EAAS,SAAS,EACrD,CAAK,EAGKI,EAAWC,EAAe,gBAACH,CAAY,EAC7C,GAAI,CAACE,GAAY,CAACA,EAAS,IAC1B,MAAM,IAAI,MAAM,UAAU,EAI3Bf,EAAa,SAAWe,EAAS,IAEjCR,EAAAA,MAAI,UAAU,CACb,MAAO,SACP,KAAM,SACX,CAAK,CAED,OAAQU,EAAa,CACrBV,EAAAA,MAAc,MAAA,QAAA,mDAAA,UAAWU,CAAW,EACpCV,EAAAA,MAAI,UAAU,CACb,MAAO,aACP,KAAM,MACX,CAAK,CACL,QAAa,CACTA,EAAAA,MAAI,YAAa,CACjB,CACD,EACD,KAAOW,GAAU,CAChBX,EAAAA,MAAA,MAAA,QAAA,mDAAc,UAAWW,CAAK,EAC9BX,EAAAA,MAAI,UAAU,CACb,MAAO,SACP,KAAM,MACV,CAAI,CACD,CACH,CAAE,CACF,EAGMK,EAAeF,GACb,IAAI,QAAQ,CAACS,EAASC,IAAW,CACvCb,EAAAA,MAAI,YAAY,CACf,SAAUG,EACV,QAAUD,GAAQ,CAEjB,MAAMY,EAAYX,EAAS,MAAM,GAAG,EAAE,IAAK,EAAC,YAAa,EACzDS,EAAQ,CACP,KAAMV,EAAI,KACV,UAAWY,CAChB,CAAK,CACD,EACD,KAAOH,GAAU,CAChBX,EAAAA,MAAA,MAAA,QAAA,mDAAc,YAAaW,CAAK,EAEhC,MAAMG,EAAYX,EAAS,MAAM,GAAG,EAAE,IAAK,EAAC,YAAW,GAAM,MAC7DS,EAAQ,CACP,KAAM,EACN,UAAWE,CAChB,CAAK,CACD,CACJ,CAAG,CACH,CAAE,EAIIC,EAAmBC,GAAM,CAC9B,MAAMC,EAAQD,EAAE,OAAO,MAEvBvB,EAAa,UAAYwB,EAAM,QAAQ,6BAA8B,EAAE,CACxE,EAGMC,EAAc,SAAY,CAC/B,GAAI,CAACrB,EAAW,MAAO,CACtBG,EAAAA,MAAI,UAAU,CACb,MAAO,WACP,KAAM,MACT,CAAG,EACD,MACA,CAGD,GAAI,CAACP,EAAa,UAAU,OAAQ,CACnCO,EAAAA,MAAI,UAAU,CACb,MAAO,QACP,KAAM,MACT,CAAG,EACD,MACA,CAED,GAAIP,EAAa,UAAU,KAAI,EAAG,OAAS,EAAG,CAC7CO,EAAAA,MAAI,UAAU,CACb,MAAO,WACP,KAAM,MACT,CAAG,EACD,MACA,CAED,GAAI,CACHA,EAAAA,MAAI,YAAY,CACf,MAAO,QACV,CAAG,EAGD,MAAMmB,EAAa,CAAE,EACjB1B,EAAa,WAAaE,EAAiB,MAAM,WACpDwB,EAAW,SAAW1B,EAAa,UAEhCA,EAAa,YAAcE,EAAiB,MAAM,YACrDwB,EAAW,UAAY1B,EAAa,WAIrC,MAAM2B,EAAS,MAAMC,EAAmB,oBAACF,CAAU,EACnDnB,uEAAY,QAASoB,EAAO,IAAI,EAC5BA,EAAO,KAAK,OAAS,GAExB9B,EAAU,YAAY,CACrB,GAAGA,EAAU,SACb,GAAG6B,CACP,CAAI,EAGDxB,EAAiB,MAAQ,CAAE,GAAGL,EAAU,QAAU,EAElDU,EAAAA,MAAI,UAAU,CACb,MAAO,OACP,KAAM,SACV,CAAI,EAGD,WAAW,IAAM,CAChBA,EAAAA,MAAI,aAAc,CAClB,EAAE,IAAI,GAGPA,EAAAA,MAAI,UAAU,CACb,MAAOoB,EAAO,KAAK,KAAO,iBAC1B,KAAM,MACV,CAAI,CAED,OAAQT,EAAO,CAEhBX,EAAAA,MAAc,MAAA,QAAA,mDAAA,QAASW,CAAK,EAGxBA,GAASA,EAAM,MAAQA,EAAM,KAAK,OAAS,IAC9CX,EAAAA,MAAI,UAAU,CACb,MAAOW,EAAM,KAAK,KAAO,iBACzB,KAAM,MACV,CAAI,EAGDX,EAAAA,MAAI,UAAU,CACb,MAAO,WACP,KAAM,MACV,CAAI,CAEJ,QAAW,CACTA,EAAAA,MAAI,YAAa,CACjB,CACF,mRCjSA,GAAG,WAAWsB,CAAe"}
"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),C=require("../../../stores/user.js"),h=require("../../../api/user.js"),U=require("../../../api/order.js"),q={__name:"index",setup(A){const i=C.useUserStore(),p=e.ref(0),c=e.ref(!1),f=e.ref(null),I=e.ref(""),s=e.computed(()=>i.userInfo&&Object.keys(i.userInfo).length>0),r=e.computed(()=>{if(s.value)return i.userInfo}),o=e.ref({pending:0,inProgress:0}),v=a=>{e.index.__f__("log","at pages/tabbar/profile/index.vue:211","收到登录成功事件:",a),l(),g()},x=()=>{e.index.__f__("log","at pages/tabbar/profile/index.vue:220","收到退出登录事件"),o.value={pending:0,inProgress:0},f.value=null,I.value=""},b=a=>{e.index.__f__("log","at pages/tabbar/profile/index.vue:233","收到申请状态变化事件:",a),m()};e.onMounted(()=>{const a=e.index.getSystemInfoSync();p.value=a.statusBarHeight||0,l(),e.index.$on("loginSuccess",v),e.index.$on("logoutSuccess",x),e.index.$on("applicationStatusChanged",b)}),e.onShow(()=>{s.value&&g()}),e.onUnmounted(()=>{e.index.$off("loginSuccess",v),e.index.$off("logoutSuccess",x),e.index.$off("applicationStatusChanged",b)});const l=async()=>{var a;if(e.index.__f__("log","at pages/tabbar/profile/index.vue:279","开始加载用户数据 - isLoggedIn:",s.value),e.index.__f__("log","at pages/tabbar/profile/index.vue:280","当前用户状态:",i.userInfo),s.value){try{e.index.__f__("log","at pages/tabbar/profile/index.vue:285","用户已登录，开始请求用户信息");const n=await h.getUserInfo();if(e.index.__f__("log","at pages/tabbar/profile/index.vue:287","用户信息请求成功:",n),n.data&&n.data.code===0){const u=n.data.data;e.index.__f__("log","at pages/tabbar/profile/index.vue:292","解析用户数据:",u);const _={...u,access_token:i.userInfo.access_token||"",refresh_token:i.userInfo.refresh_token||""};i.setUserInfo(_)}else e.index.__f__("warn","at pages/tabbar/profile/index.vue:308","获取用户信息失败:",((a=n.data)==null?void 0:a.msg)||"未知错误")}catch(n){e.index.__f__("error","at pages/tabbar/profile/index.vue:311","获取用户信息失败:",n)}await m(),await g()}else e.index.__f__("log","at pages/tabbar/profile/index.vue:319","用户未登录，跳过获取用户信息")},m=async()=>{try{e.index.__f__("log","at pages/tabbar/profile/index.vue:326","开始请求申请信息");const a=await h.getApplicatioInfo();e.index.__f__("log","at pages/tabbar/profile/index.vue:328","申请信息请求成功:",a),a.data&&a.data.code===0&&(f.value=a.data.data)}catch{}},g=async()=>{try{e.index.__f__("log","at pages/tabbar/profile/index.vue:342","开始请求订单数量统计");const a=await U.getOrderCount();if(e.index.__f__("log","at pages/tabbar/profile/index.vue:344","订单数量统计请求成功:",a),a.data&&a.data.code===0){const n=a.data.data;e.index.__f__("log","at pages/tabbar/profile/index.vue:348","待服务订单数:",n.pending_service_count),e.index.__f__("log","at pages/tabbar/profile/index.vue:349","待付款订单数:",n.pending_payment_count),e.index.__f__("log","at pages/tabbar/profile/index.vue:350","进行中订单数:",n.in_service_count),o.value={pending:n.pending_payment_count||0,pending_service:n.pending_service_count||0,inProgress:n.in_service_count||0}}}catch(a){e.index.__f__("error","at pages/tabbar/profile/index.vue:360","获取订单数量失败:",a)}},S=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},$=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},d=a=>{e.index.__f__("log","at pages/tabbar/profile/index.vue:383","跳转到订单页面，状态:",a);const n=encodeURIComponent(a);e.index.navigateTo({url:`/subPackages/order/index?status=${n}`})},y=()=>{e.index.navigateTo({url:"/subPackages/profile/customer-service/index"})},P=()=>{e.index.navigateTo({url:"/subPackages/settings/pages/index/index"})},k=async()=>{e.index.__f__("log","at pages/tabbar/profile/index.vue:429","开始下拉刷新"),c.value=!0;try{await l(),await new Promise(a=>setTimeout(a,800))}catch(a){e.index.__f__("error","at pages/tabbar/profile/index.vue:440","刷新失败:",a),e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}finally{c.value=!1}},w=()=>{e.index.__f__("log","at pages/tabbar/profile/index.vue:452","刷新动画结束"),c.value=!1},T=a=>a?a.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"未绑定手机号";return(a,n)=>{var u;return e.e({a:s.value},s.value?e.e({b:r.value.head_img},r.value.head_img?{c:a.$imgBaseUrl+r.value.head_img}:{d:e.t(((u=r.value.nickname)==null?void 0:u.charAt(0))||"用")},{e:e.t(r.value.nick_name||""),f:e.t(T(r.value.phone)||"未绑定手机号"),g:e.o($)}):{h:t._imports_0$1,i:t._imports_1$1,j:t._imports_2$1,k:e.o(S)},{l:p.value+"px",m:t._imports_0,n:e.o(_=>d("all")),o:t._imports_4$2,p:o.value.pending>0},o.value.pending>0?{q:e.t(o.value.pending)}:{},{r:e.o(_=>d("pending_payment")),s:t._imports_5,t:o.value.pending_service>0},o.value.pending_service>0?{v:e.t(o.value.pending_service)}:{},{w:e.o(_=>d("pending_service")),x:t._imports_6,y:o.value.inProgress>0},o.value.inProgress>0?{z:e.t(o.value.inProgress)}:{},{A:e.o(_=>d("in_service")),B:t._imports_7,C:e.o(_=>d("completed")),D:t._imports_8,E:t._imports_0,F:e.o(()=>{}),G:e.o(y),H:t._imports_9,I:t._imports_0,J:e.o(P),K:c.value,L:e.o(k),M:e.o(w)})}}},L=e._export_sfc(q,[["__scopeId","data-v-4cb51321"]]);wx.createPage(L);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/pages/tabbar/profile/index.js.map

"use strict";const e=require("../../../../common/vendor.js"),i=require("../../../../common/assets.js"),G=require("../../../../api/friends.js");require("../../../../config/http.js");const ue=require("../../../../stores/level.js"),ce=require("../../../../stores/city.js"),ve=require("../../../../stores/user.js");Array||e.resolveComponent("uni-popup")();const de=()=>"../../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(fe+_e+de)();const fe=()=>"../../../../components/common/CitySelector.js",_e=()=>"../../../../components/common/CityPicker.js",ge={__name:"friends",setup(R){const b=ve.useUserStore(),A=e.computed(()=>b.userInfo&&Object.keys(b.userInfo).length>0);e.computed(()=>{if(A.value)return b.userInfo});const W=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},D=e.ref(0);e.ref(null);const U=e.ref(0),y=e.ref(""),$=e.ref(!1),P=e.ref(!1),p=e.computed(()=>{var a;return((a=l.userLocation)==null?void 0:a.latitude)||null}),m=e.computed(()=>{var a;return((a=l.userLocation)==null?void 0:a.longitude)||null});e.ref(!1);const l=ce.useCityStore();e.computed(()=>l.cityList),e.computed(()=>l.currentCity);const u=e.ref(""),d=e.ref("all"),x=e.ref("all"),c=e.ref("all"),k=e.ref("recommend"),z=e.ref(1),_=e.ref([]),S=e.ref(0),L=e.ref(1),H=e.ref(20),h=e.ref(!1),J=e.ref(!0),T=e.ref(!1),I=ue.useLevelStore(),w=e.computed(function(){return _.value.map(function(a){const n=a.tags?a.tags.slice(0,3):[],t=a.tags&&a.tags.length>3?a.tags.length-3:0;return{...a,visibleTags:n,extraTags:t}})}),E=e.computed(()=>({all:"性别",female:"女生",male:"男生"})[d.value]||"性别");e.computed(()=>({all:"距离","1km":"1km内","3km":"3km内","5km":"5km内","10km":"10km内"})[x.value]||"距离");const K=e.computed(()=>{if(c.value==="all")return"级别";const a=I.sortedServiceLevels.find(n=>n.level_order.toString()===c.value);return a?a.level_name:"级别"});e.computed(()=>({distance:"距离",rating:"评分",new:"最新"})[k.value]||"排序");const Q=e.computed(function(){return{gender:"选择性别",distance:"选择距离",level:"选择级别",sort:"排序方式"}[u.value]||""}),Y=e.computed(function(){return{gender:[{value:"all",label:"不限性别"},{value:"female",label:"女生",icon:"/static/icons/friend/female.png"},{value:"male",label:"男生",icon:"/static/icons/friend/male.png"}],level:[{value:"all",label:"不限级别"},...I.sortedServiceLevels.map(n=>({value:n.level_order.toString(),label:`${n.level_name}`,icon:n.icon_url||"/static/icons/friend/star.png"}))]}[u.value]||[]}),F=a=>({gender:d,distance:x,level:c,sort:k})[u.value].value===a,V=a=>{const n={gender:d,distance:x,level:c,sort:k};n[u.value].value=a},N=a=>{u.value=a},M=()=>{u.value=""},X=()=>{const a={gender:d,distance:x,level:c,sort:k};a[u.value].value="all"},Z=()=>{e.index.__f__("log","at pages/tabbar/home/components/friends.vue:384","应用筛选:",{gender:d.value,distance:x.value,level:c.value,sort:k.value}),M(),f(!0)},ee=()=>{e.index.__f__("log","at pages/tabbar/home/components/friends.vue:397","刷新推荐，清除筛选条件"),d.value="all",c.value="all",f(!0)},q=e.ref(null),g=e.ref([]),B=e.ref(null),te=e.ref(0),ae=async a=>{B.value=a;try{const n={city_code:l.currentCityCode,application_id:a.id};p.value&&m.value&&(n.latitude=parseFloat(p.value),n.longitude=parseFloat(m.value));const t=await G.getCityServices(n);if(t.data&&t.data.code===0){const o=t.data.data;o&&o.services&&o.services.length>0?(g.value=o.services,z.value=o.level_order):g.value=[]}else g.value=[]}catch(n){e.index.__f__("error","at pages/tabbar/home/components/friends.vue:442","获取服务信息失败:",n),g.value=[]}q.value.open()},O=()=>{q.value.close()},ne=a=>{if(e.index.__f__("log","at pages/tabbar/home/components/friends.vue:456","选择服务:",a),O(),!A.value){e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),W();return}e.index.navigateTo({url:`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${B.value.id}&level_order=${z.value||""}&nickname=${B.value.name}`})},oe=a=>{let n="/subPackages/friend/detail?id="+a+"&city_code="+l.currentCityCode;p.value&&m.value&&(n+="&latitude="+p.value+"&longitude="+m.value),e.index.navigateTo({url:n})},f=async(a=!1)=>{var n;if(!h.value){h.value=!0;try{const t={page:a?1:L.value,page_size:H.value};l.currentCityCode&&(t.city_code=l.currentCityCode),y.value&&y.value.trim()&&(t.nickname=y.value.trim()),p.value&&m.value&&(t.latitude=p.value,t.longitude=m.value),d.value!=="all"&&(t.gender=d.value==="female"?"女":"男"),c.value!=="all"&&(t.level_order=parseInt(c.value)),e.index.__f__("log","at pages/tabbar/home/components/friends.vue:576","搜索参数:",t);const o=await G.searchCompanions(t);if(e.index.__f__("log","at pages/tabbar/home/components/friends.vue:580","API完整响应:",o),o.data&&o.data.code===0){const v=o.data.data;if(v&&v.list){const r=v.list.map(s=>({id:s.id,name:s.nickname,gender:s.gender,age:s.age,height:s.height,weight:s.weight,distance:s.distance,tags:s.tags||[],services:(()=>{if(typeof s.services=="string")try{return JSON.parse(s.services)}catch(j){return e.index.__f__("error","at pages/tabbar/home/components/friends.vue:599","解析services JSON失败:",j),[]}return s.services||[]})(),avatar:s.avatar,online:s.is_online===1,bookable:s.can_accept_orders==="Y"}));a?(_.value=r,L.value=1):(_.value=[..._.value,...r],L.value++),S.value=v.total||0,J.value=r.length===H.value,e.index.__f__("log","at pages/tabbar/home/components/friends.vue:621","搜索成功，共获取",r.length,"条数据，总数:",S.value),r.length}else e.index.__f__("log","at pages/tabbar/home/components/friends.vue:632","API返回数据为空"),a&&(_.value=[],S.value=0)}else{e.index.__f__("error","at pages/tabbar/home/components/friends.vue:640","API返回错误:",o.data);const v=((n=o.data)==null?void 0:n.message)||"搜索失败";e.index.showToast({title:v,icon:"none",duration:2e3}),a&&(_.value=[],S.value=0)}}catch(t){e.index.__f__("error","at pages/tabbar/home/components/friends.vue:654","搜索伴友师失败:",t),e.index.__f__("error","at pages/tabbar/home/components/friends.vue:655","错误详情:",t.response||t);let o="搜索失败，请重试";t.response&&t.response.data&&(o=t.response.data.message||o),e.index.showToast({title:o,icon:"none",duration:2e3}),a&&(_.value=[],S.value=0)}finally{h.value=!1,T.value=!0}}},se=()=>{!h.value&&J.value&&f(!1)},re=async()=>{$.value=!0,await f(!0),await new Promise(a=>setTimeout(a,800)),$.value=!1},le=()=>{clearTimeout(C),C=setTimeout(()=>{f(!0)},500)};let C=null;e.watch(()=>l.currentCityCode,async(a,n)=>{a&&a!==n&&(e.index.__f__("log","at pages/tabbar/home/components/friends.vue:709","城市发生变化，自动刷新数据:",a),await f(!0))});const ie=async a=>{e.index.vibrateShort({type:"light"}),await f(!0)};return e.onMounted(async()=>{const a=e.index.getSystemInfoSync();D.value=a.statusBarHeight;const n=e.index.getMenuButtonBoundingClientRect();n.value=n;const t=a.screenWidth,o=n.right;U.value=t-o+24,await I.fetchServiceLevels(),l.cityList.length===0?await l.initCityData():await l.getUserLocation(),await f(!0)}),e.onUnmounted(()=>{C&&clearTimeout(C)}),(a,n)=>e.e({a:e.unref(b).switch===1},e.unref(b).switch===1?e.e({b:e.o(t=>P.value=!0),c:i._imports_0$9,d:e.o([t=>y.value=t.detail.value,le]),e:y.value,f:U.value+"px",g:i._imports_1$4,h:e.o(ee),i:e.t(E.value),j:i._imports_1$5,k:e.o(t=>N("gender")),l:e.t(K.value),m:i._imports_1$5,n:e.o(t=>N("level")),o:D.value+"px",p:h.value&&!T.value},h.value&&!T.value?{}:w.value.length>0?{r:e.f(w.value,(t,o,v)=>e.e({a:a.$imgBaseUrl+t.avatar,b:t.online},t.online?{}:{},{c:e.t(t.name),d:t.gender==="女"},t.gender==="女"?{e:i._imports_3$2}:{f:i._imports_4$2},{g:e.t(t.age),h:e.t(t.height),i:e.t(t.weight),j:e.t(t.distance),k:e.f(t.visibleTags,(r,s,j)=>({a:e.t(r),b:s})),l:t.extraTags>0},t.extraTags>0?{m:e.t(t.extraTags)}:{},{n:e.o(r=>ae(t),t.id),o:t.id,p:e.o(r=>oe(t.id),t.id)})),s:i._imports_5}:T.value&&w.value.length===0?{v:i._imports_3}:{},{q:w.value.length>0,t:T.value&&w.value.length===0,w:e.o(se),x:$.value,y:e.o(re),z:u.value},u.value?{A:e.t(Q.value),B:i._imports_7,C:e.o(M),D:e.f(Y.value,(t,o,v)=>e.e({a:t.icon},t.icon?{b:t.icon}:{},{c:e.t(t.label),d:F(t.value)},F(t.value)?{e:i._imports_8}:{},{f:t.value,g:e.n({selected:F(t.value)}),h:e.o(r=>V(t.value),t.value)})),E:e.o(X),F:e.o(Z),G:e.o(()=>{}),H:e.o(M)}:{},{I:e.o(ie),J:e.o(t=>P.value=t),K:e.p({visible:P.value}),L:i._imports_7,M:e.o(O),N:g.value.length>0},g.value.length>0?{O:e.f(g.value,(t,o,v)=>({a:a.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,(r,s,j)=>({a:e.t(r),b:r})),d:e.t(t.price),e:e.t(t.unit||"小时"),f:e.o(r=>ne(t),t.title),g:t.title}))}:{P:i._imports_3},{Q:te.value,R:e.sr(q,"abe137f2-2",{k:"servicePopup"}),S:e.o(O),T:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})}):{})}},pe=e._export_sfc(ge,[["__scopeId","data-v-abe137f2"]]);wx.createComponent(pe);
//# sourceMappingURL=../../../../../.sourcemap/mp-weixin/pages/tabbar/home/components/friends.js.map

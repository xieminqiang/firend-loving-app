"use strict";const e=require("../../../../common/vendor.js"),l=require("../../../../common/assets.js"),G=require("../../../../api/friends.js");require("../../../../config/http.js");const ce=require("../../../../stores/level.js"),ve=require("../../../../stores/city.js"),de=require("../../../../stores/user.js");Array||e.resolveComponent("uni-popup")();const _e=()=>"../../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(fe+ge+_e)();const fe=()=>"../../../../components/common/CitySelector.js",ge=()=>"../../../../components/common/CityPicker.js",pe={__name:"friends",setup(R){const y=de.useUserStore(),A=e.computed(()=>y.userInfo&&Object.keys(y.userInfo).length>0);e.computed(()=>{if(A.value)return y.userInfo});const W=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},D=e.ref(0);e.ref(null);const U=e.ref(0),x=e.ref(""),P=e.ref(!1),L=e.ref(!1),m=e.computed(()=>{var a;return((a=r.userLocation)==null?void 0:a.latitude)||null}),h=e.computed(()=>{var a;return((a=r.userLocation)==null?void 0:a.longitude)||null});e.ref(!1);const r=ve.useCityStore();e.computed(()=>r.cityList),e.computed(()=>r.currentCity);const c=e.ref(""),_=e.ref("all"),k=e.ref("all"),v=e.ref("all"),S=e.ref("recommend"),z=e.ref(1),g=e.ref([]),T=e.ref(0),I=e.ref(1),H=e.ref(20),b=e.ref(!1),J=e.ref(!0),C=e.ref(!1),F=ce.useLevelStore(),w=e.computed(function(){return g.value.map(function(a){const n=a.tags?a.tags.slice(0,3):[],t=a.tags&&a.tags.length>3?a.tags.length-3:0;return{...a,visibleTags:n,extraTags:t}})}),E=e.computed(()=>({all:"性别",female:"女生",male:"男生"})[_.value]||"性别");e.computed(()=>({all:"距离","1km":"1km内","3km":"3km内","5km":"5km内","10km":"10km内"})[k.value]||"距离");const K=e.computed(()=>{if(v.value==="all")return"级别";const a=F.sortedServiceLevels.find(n=>n.level_order.toString()===v.value);return a?a.level_name:"级别"});e.computed(()=>({distance:"距离",rating:"评分",new:"最新"})[S.value]||"排序");const Q=e.computed(function(){return{gender:"选择性别",distance:"选择距离",level:"选择级别",sort:"排序方式"}[c.value]||""}),Y=e.computed(function(){return{gender:[{value:"all",label:"不限性别"},{value:"female",label:"女生",icon:"/static/icons/friend/female.png"},{value:"male",label:"男生",icon:"/static/icons/friend/male.png"}],level:[{value:"all",label:"不限级别"},...F.sortedServiceLevels.map(n=>({value:n.level_order.toString(),label:`${n.level_name}`,icon:n.icon_url||"/static/icons/friend/star.png"}))]}[c.value]||[]}),M=a=>({gender:_,distance:k,level:v,sort:S})[c.value].value===a,V=a=>{const n={gender:_,distance:k,level:v,sort:S};n[c.value].value=a},N=a=>{c.value=a},q=()=>{c.value=""},X=()=>{const a={gender:_,distance:k,level:v,sort:S};a[c.value].value="all"},Z=()=>{e.index.__f__("log","at pages/tabbar/home/components/friends.vue:384","应用筛选:",{gender:_.value,distance:k.value,level:v.value,sort:S.value}),q(),f(!0)},ee=()=>{e.index.__f__("log","at pages/tabbar/home/components/friends.vue:397","刷新推荐，清除筛选条件"),_.value="all",v.value="all",f(!0)},B=e.ref(null),p=e.ref([]),O=e.ref(null),te=e.ref(0),ae=async a=>{O.value=a;try{const n={city_code:r.currentCityCode,application_id:a.id};m.value&&h.value&&(n.latitude=parseFloat(m.value),n.longitude=parseFloat(h.value));const t=await G.getCityServices(n);if(t.data&&t.data.code===0){const o=t.data.data;o&&o.services&&o.services.length>0?(p.value=o.services,z.value=o.level_order):p.value=[]}else p.value=[]}catch(n){e.index.__f__("error","at pages/tabbar/home/components/friends.vue:442","获取服务信息失败:",n),p.value=[]}B.value.open()},j=()=>{B.value.close()},ne=a=>{if(e.index.__f__("log","at pages/tabbar/home/components/friends.vue:456","选择服务:",a),j(),!A.value){e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),W();return}e.index.navigateTo({url:`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${O.value.id}&level_order=${z.value||""}&nickname=${O.value.name}`})},oe=a=>{let n="/subPackages/py/detail?id="+a+"&city_code="+r.currentCityCode;m.value&&h.value&&(n+="&latitude="+m.value+"&longitude="+h.value),e.index.navigateTo({url:n})},f=async(a=!1)=>{var n;if(!b.value){b.value=!0;try{const t={page:a?1:I.value,page_size:H.value};r.currentCityCode&&(t.city_code=r.currentCityCode),x.value&&x.value.trim()&&(t.nickname=x.value.trim()),m.value&&h.value&&(t.latitude=m.value,t.longitude=h.value),_.value!=="all"&&(t.gender=_.value==="female"?"女":"男"),v.value!=="all"&&(t.level_order=parseInt(v.value)),e.index.__f__("log","at pages/tabbar/home/components/friends.vue:576","搜索参数:",t);const o=await G.searchCompanions(t);if(e.index.__f__("log","at pages/tabbar/home/components/friends.vue:580","API完整响应:",o),o.data&&o.data.code===0){const i=o.data.data;if(i&&i.list){const u=i.list.length,d=i.list.filter(s=>s.id!==15).map(s=>({id:s.id,name:s.nickname,gender:s.gender,age:s.age,height:s.height,weight:s.weight,distance:s.distance,tags:s.tags||[],services:(()=>{if(typeof s.services=="string")try{return JSON.parse(s.services)}catch(ue){return e.index.__f__("error","at pages/tabbar/home/components/friends.vue:603","解析services JSON失败:",ue),[]}return s.services||[]})(),avatar:s.avatar,online:s.is_online===1,bookable:s.can_accept_orders==="Y"}));e.index.__f__("log","at pages/tabbar/home/components/friends.vue:614",`友伴数据过滤: 原始${u}条，过滤后${d.length}条`),a?(g.value=d,I.value=1):(g.value=[...g.value,...d],I.value++),T.value=i.total||0,J.value=d.length===H.value,e.index.__f__("log","at pages/tabbar/home/components/friends.vue:627","搜索成功，共获取",d.length,"条数据，总数:",T.value),d.length}else e.index.__f__("log","at pages/tabbar/home/components/friends.vue:638","API返回数据为空"),a&&(g.value=[],T.value=0)}else{e.index.__f__("error","at pages/tabbar/home/components/friends.vue:646","API返回错误:",o.data);const i=((n=o.data)==null?void 0:n.message)||"搜索失败";e.index.showToast({title:i,icon:"none",duration:2e3}),a&&(g.value=[],T.value=0)}}catch(t){e.index.__f__("error","at pages/tabbar/home/components/friends.vue:660","搜索伴友师失败:",t),e.index.__f__("error","at pages/tabbar/home/components/friends.vue:661","错误详情:",t.response||t);let o="搜索失败，请重试";t.response&&t.response.data&&(o=t.response.data.message||o),e.index.showToast({title:o,icon:"none",duration:2e3}),a&&(g.value=[],T.value=0)}finally{b.value=!1,C.value=!0}}},se=()=>{!b.value&&J.value&&f(!1)},re=async()=>{P.value=!0,await f(!0),await new Promise(a=>setTimeout(a,800)),P.value=!1},le=()=>{clearTimeout($),$=setTimeout(()=>{f(!0)},500)};let $=null;e.watch(()=>r.currentCityCode,async(a,n)=>{a&&a!==n&&(e.index.__f__("log","at pages/tabbar/home/components/friends.vue:715","城市发生变化，自动刷新数据:",a),await f(!0))});const ie=async a=>{e.index.vibrateShort({type:"light"}),await f(!0)};return e.onMounted(async()=>{const a=e.index.getSystemInfoSync();D.value=a.statusBarHeight;const n=e.index.getMenuButtonBoundingClientRect();n.value=n;const t=a.screenWidth,o=n.right;U.value=t-o+24,await F.fetchServiceLevels(),r.cityList.length===0?await r.initCityData():await r.getUserLocation(),await f(!0)}),e.onUnmounted(()=>{$&&clearTimeout($)}),(a,n)=>e.e({a:e.unref(y).switch===1},e.unref(y).switch===1?e.e({b:e.o(t=>L.value=!0),c:l._imports_0$8,d:e.o([t=>x.value=t.detail.value,le]),e:x.value,f:U.value+"px",g:l._imports_1$4,h:e.o(ee),i:e.t(E.value),j:l._imports_1$5,k:e.o(t=>N("gender")),l:e.t(K.value),m:l._imports_1$5,n:e.o(t=>N("level")),o:D.value+"px",p:b.value&&!C.value},b.value&&!C.value?{}:w.value.length>0?{r:e.f(w.value,(t,o,i)=>e.e({a:a.$imgBaseUrl+t.avatar,b:t.online},t.online?{}:{},{c:e.t(t.name),d:t.gender==="女"},t.gender==="女"?{e:l._imports_3$2}:{f:l._imports_4},{g:e.t(t.age),h:e.t(t.height),i:e.t(t.weight),j:e.t(t.distance),k:e.f(t.visibleTags,(u,d,s)=>({a:e.t(u),b:d})),l:t.extraTags>0},t.extraTags>0?{m:e.t(t.extraTags)}:{},{n:e.o(u=>ae(t),t.id),o:t.id,p:e.o(u=>oe(t.id),t.id)})),s:l._imports_5}:C.value&&w.value.length===0?{v:l._imports_3}:{},{q:w.value.length>0,t:C.value&&w.value.length===0,w:e.o(se),x:P.value,y:e.o(re),z:c.value},c.value?{A:e.t(Q.value),B:l._imports_7,C:e.o(q),D:e.f(Y.value,(t,o,i)=>e.e({a:t.icon},t.icon?{b:t.icon}:{},{c:e.t(t.label),d:M(t.value)},M(t.value)?{e:l._imports_8$1}:{},{f:t.value,g:e.n({selected:M(t.value)}),h:e.o(u=>V(t.value),t.value)})),E:e.o(X),F:e.o(Z),G:e.o(()=>{}),H:e.o(q)}:{},{I:e.o(ie),J:e.o(t=>L.value=t),K:e.p({visible:L.value}),L:l._imports_7,M:e.o(j),N:p.value.length>0},p.value.length>0?{O:e.f(p.value,(t,o,i)=>({a:a.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,(u,d,s)=>({a:e.t(u),b:u})),d:e.t(t.price),e:e.t(t.unit||"小时"),f:e.o(u=>ne(t),t.title),g:t.title}))}:{P:l._imports_3},{Q:te.value,R:e.sr(B,"abe137f2-2",{k:"servicePopup"}),S:e.o(j),T:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})}):{})}},me=e._export_sfc(pe,[["__scopeId","data-v-abe137f2"]]);wx.createComponent(me);
//# sourceMappingURL=../../../../../.sourcemap/mp-weixin/pages/tabbar/home/components/friends.js.map

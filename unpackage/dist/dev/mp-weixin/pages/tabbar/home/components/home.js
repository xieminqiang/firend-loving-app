"use strict";const a=require("../../../../common/vendor.js"),F=require("../../../../common/assets.js"),q=require("../../../../api/home.js"),O=require("../../../../stores/city.js"),E=require("../../../../stores/user.js");Array||a.resolveComponent("u-tabs")();const N=()=>"../../../../uni_modules/uview-plus/components/u-tabs/u-tabs.js";Math||(G+N+J)();const G=()=>"../../../../components/common/CitySelector.js",J=()=>"../../../../components/common/CityPicker.js",K={__name:"home",setup(D){const S=E.useUserStore(),M=a.ref(0),k=a.ref(44);a.onMounted(async()=>{a.index.__f__("log","at pages/tabbar/home/components/home.vue:160","home组件挂载完成");const e=a.index.getSystemInfoSync();M.value=e.statusBarHeight||0,k.value=44,await l.initCityData(),await d(u.value)});const l=O.useCityStore();a.computed(()=>l.currentCity);const b=a.computed(()=>l.currentCityCode);a.computed(()=>l.cityList),a.computed(()=>l.cityIndex);const u=a.ref("娱乐"),g=["服务","娱乐","运动"],L=a.computed(()=>g.map(e=>({name:e})));a.onUnmounted(()=>{f&&clearTimeout(f)});const m=a.ref({服务:[],娱乐:[],运动:[]}),_=a.ref({服务:!1,娱乐:!1,运动:!1}),v=a.ref({服务:!1,娱乐:!1,运动:!1}),n=a.ref({服务:{page:1,hasMore:!0},娱乐:{page:1,hasMore:!0},运动:{page:1,hasMore:!0}}),h=a.ref({服务:!1,娱乐:!1,运动:!1}),d=async(e,t=!1)=>{if(!e){a.index.__f__("error","at pages/tabbar/home/components/home.vue:260","loadSingleTabData: tab parameter is required");return}if(n.value[e]||(a.index.__f__("log","at pages/tabbar/home/components/home.vue:266",`初始化 ${e} 的分页状态`),n.value[e]={page:1,hasMore:!0}),_.value[e]&&!v.value[e]&&!t){a.index.__f__("log","at pages/tabbar/home/components/home.vue:272",`${e}数据已缓存，跳过加载`);return}t&&(_.value[e]=!1,a.index.__f__("log","at pages/tabbar/home/components/home.vue:279",`强制刷新${e}，清除缓存状态`)),v.value[e]=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:283",`开始加载${e}服务数据，当前城市代码:`,b.value,t?"(强制刷新)":"");try{const o={category:I(e),page_size:10,city_code:b.value,page:n.value[e].page};a.index.__f__("log","at pages/tabbar/home/components/home.vue:293",`${e}服务请求参数:`,o);const r=await q.getHotRecommendServices(o);if(r.data&&r.data.code===0&&r.data.data&&r.data.data.list){const c=r.data.data.list.map(s=>({id:s.id,name:s.name,desc:s.description,tags:s.tags||[],img:s.image_url||"/static/images/service-default.png",min_price:s.min_price||0,unit:s.unit||"次",price_template_id:s.price_template_id}));t?(a.index.__f__("log","at pages/tabbar/home/components/home.vue:312",`${e}强制刷新前页码: ${n.value[e].page}`),m.value[e]=c,n.value[e].page=1,n.value[e].hasMore=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:316",`${e}服务数据强制刷新成功，共${c.length}条，重置后页码: ${n.value[e].page}`)):(m.value[e]=c,n.value[e].hasMore=c.length===10,a.index.__f__("log","at pages/tabbar/home/components/home.vue:321",`${e}服务数据初始加载成功，共${c.length}条`))}else t?(m.value[e]=[],n.value[e].page=1,n.value[e].hasMore=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:329",`${e}服务数据强制刷新为空`)):a.index.__f__("log","at pages/tabbar/home/components/home.vue:331",`${e}服务数据为空，保留现有数据`);_.value[e]=!0}catch(o){a.index.__f__("error","at pages/tabbar/home/components/home.vue:336",`获取${e}服务数据失败:`,o),t?(m.value[e]=[],n.value[e].page=1,n.value[e].hasMore=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:342",`${e}强制刷新失败，清空数据`)):a.index.__f__("log","at pages/tabbar/home/components/home.vue:344",`${e}数据加载失败，保留现有数据`),_.value[e]=!0}finally{v.value[e]=!1}},j=async e=>{if(!e){a.index.__f__("error","at pages/tabbar/home/components/home.vue:356","loadMoreData: tab parameter is required");return}if(n.value[e]||(a.index.__f__("log","at pages/tabbar/home/components/home.vue:362",`初始化 ${e} 的分页状态`),n.value[e]={page:1,hasMore:!0}),!n.value[e].hasMore||h.value[e]||v.value[e]){a.index.__f__("log","at pages/tabbar/home/components/home.vue:368",`${e}没有更多数据或正在加载中，跳过加载`);return}h.value[e]=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:373",`开始加载更多${e}数据，当前页码: ${n.value[e].page}`);try{const t={category:I(e),page_size:10,city_code:b.value,page:n.value[e].page+1};a.index.__f__("log","at pages/tabbar/home/components/home.vue:383",`${e}加载更多请求参数:`,t);const o=await q.getHotRecommendServices(t);if(o.data&&o.data.code===0&&o.data.data&&o.data.data.list){const r=o.data.data.list.map(i=>({id:i.id,name:i.name,desc:i.description,tags:i.tags||[],img:i.image_url||"/static/images/service-default.png",min_price:i.min_price||0,unit:i.unit||"次",price_template_id:i.price_template_id})),c=new Set(m.value[e].map(i=>i.id)),s=r.filter(i=>!c.has(i.id));s.length>0?(m.value[e]=[...m.value[e],...s],n.value[e].page++,n.value[e].hasMore=r.length===10,a.index.__f__("log","at pages/tabbar/home/components/home.vue:407",`${e}加载更多成功，新增${s.length}条，当前页码: ${n.value[e].page}`)):(n.value[e].hasMore=!1,a.index.__f__("log","at pages/tabbar/home/components/home.vue:411",`${e}没有更多新数据`))}else n.value[e].hasMore=!1,a.index.__f__("log","at pages/tabbar/home/components/home.vue:416",`${e}加载更多返回空数据`)}catch(t){a.index.__f__("error","at pages/tabbar/home/components/home.vue:419",`加载更多${e}数据失败:`,t)}finally{h.value[e]=!1}},C=async()=>{a.index.__f__("log","at pages/tabbar/home/components/home.vue:427","重新加载所有选项卡数据"),Object.keys(_.value).forEach(e=>{_.value[e]=!1,n.value[e]||(n.value[e]={page:1,hasMore:!0}),n.value[e].page=1,n.value[e].hasMore=!0}),await d(u.value)},I=e=>{switch(e){case"服务":return 1;case"娱乐":return 2;case"运动":return 3;default:return 0}},y=a.ref(1);let f=null;const P=async e=>{const t=u.value,o=e;u.value=o,y.value=g.indexOf(o),t!==o&&!_.value[o]&&await d(o)},H=async e=>{let t,o;if(typeof e=="object"&&e!==null)t=e.index,o=e.name;else if(typeof e=="number")t=e,o=g[t];else{a.index.__f__("error","at pages/tabbar/home/components/home.vue:487","Invalid tab change item:",e);return}if(t<0||t>=g.length){a.index.__f__("error","at pages/tabbar/home/components/home.vue:493","Invalid tab index:",t);return}if(!o){a.index.__f__("error","at pages/tabbar/home/components/home.vue:498","Tab not found for index:",t,"item:",e);return}a.index.__f__("log","at pages/tabbar/home/components/home.vue:502","Tab changed to:",o,"index:",t),await P(o)},A=async e=>{const t=e.detail.current,o=g[t],r=u.value;y.value=t,u.value=o,f&&clearTimeout(f),r!==o&&!_.value[o]&&(f=setTimeout(async()=>{await d(o)},300))},p=e=>m.value[e]||[];function z(e){a.index.__f__("log","at pages/tabbar/home/components/home.vue:537","跳转到服务详情页, ID:",e);const o=p(u.value).find(c=>c.id===e);let r=`/subPackages/home/detail?id=${e}`;o&&o.price_template_id&&(r+=`&price_template_id=${o.price_template_id}`),a.index.__f__("log","at pages/tabbar/home/components/home.vue:549","跳转URL:",r),a.index.navigateTo({url:r})}const $=a.ref(!1),x=a.ref(!1),B=async e=>{if(a.index.__f__("log","at pages/tabbar/home/components/home.vue:570",`下拉刷新触发，当前tab: ${e}, 当前serviceTab: ${u.value}`),!e){a.index.__f__("error","at pages/tabbar/home/components/home.vue:574","onRefresh: tab parameter is required");return}if(n.value[e]||(a.index.__f__("log","at pages/tabbar/home/components/home.vue:580",`初始化 ${e} 的分页状态`),n.value[e]={page:1,hasMore:!0}),x.value||e!==u.value){a.index.__f__("log","at pages/tabbar/home/components/home.vue:586",`刷新被阻止: isRefreshing=${x.value}, tab不匹配=${e!==u.value}`);return}x.value=!0,$.value=!0;try{l.cityList.length===0&&(a.index.__f__("log","at pages/tabbar/home/components/home.vue:596","城市列表为空，重新加载城市列表"),await l.loadCityList()),a.index.__f__("log","at pages/tabbar/home/components/home.vue:601",`下拉刷新${e}选项卡数据，刷新前页码: ${n.value[e].page}`),n.value[e].page=1,a.index.__f__("log","at pages/tabbar/home/components/home.vue:605",`手动重置页码为1: ${n.value[e].page}`),await d(e,!0),a.index.__f__("log","at pages/tabbar/home/components/home.vue:608",`下拉刷新${e}选项卡数据完成，刷新后页码: ${n.value[e].page}`),n.value[e].page!==1&&(a.index.__f__("warn","at pages/tabbar/home/components/home.vue:612","页码重置失败，手动强制设置为1"),n.value[e].page=1),await new Promise(t=>setTimeout(t,800))}catch(t){a.index.__f__("error","at pages/tabbar/home/components/home.vue:619","刷新失败:",t)}finally{$.value=!1,x.value=!1}},R=()=>{$.value=!1,x.value=!1},U=async e=>{a.index.__f__("log","at pages/tabbar/home/components/home.vue:635",`上拉加载触发，当前tab: ${e}`),await j(e)};a.watch(()=>l.currentCityCode,async(e,t)=>{e&&e!==t&&(a.index.__f__("log","at pages/tabbar/home/components/home.vue:643","城市发生变化，自动刷新数据:",e),C())});const w=a.ref(!1);function W(e){l.cityIndex!==e&&(a.index.__f__("log","at pages/tabbar/home/components/home.vue:656",`手动选择城市: ${l.cityList[e].name}`),C())}return(e,t)=>a.e({a:a.unref(S).switch===1},a.unref(S).switch===1?{b:a.o(o=>w.value=!0),c:M.value+"px",d:a.o(H),e:a.p({list:L.value,current:y.value,lineWidth:"20",lineHeight:"2",lineColor:"linear-gradient(90deg, rgba(115, 99, 255, 1) 0%, rgba(255, 105, 222, 1) 100%)",activeStyle:{color:"#7363FF",fontWeight:"500",fontSize:"28rpx"},inactiveStyle:{color:"#1A1A1A",fontWeight:"400",fontSize:"28rpx"},itemStyle:"padding: 16rpx 50rpx; height: auto; border-radius: 30rpx;"}),f:a.f(g,(o,r,c)=>a.e({a:p(o).length>0},p(o).length>0?a.e({b:a.f(p(o),(s,i,V)=>({a:e.$imgBaseUrl+s.img,b:a.t(s.name),c:a.f(s.tags,(T,X,Y)=>({a:a.t(T),b:T})),d:a.t(s.min_price||0),e:a.t(s.unit),f:s.id,g:a.o(T=>z(s.id),s.id)})),c:n.value[o].hasMore},n.value[o].hasMore?a.e({d:h.value[o]},h.value[o]?{}:{}):{}):_.value[o]&&p(o).length===0?{f:F._imports_3,g:a.t(o)}:v.value[o]&&p(o).length===0?{}:{},{e:_.value[o]&&p(o).length===0,h:v.value[o]&&p(o).length===0,i:a.o(s=>B(o),o),j:a.o(R,o),k:a.o(s=>U(o),o),l:o})),g:$.value,h:y.value,i:a.o(A),j:a.o(W),k:a.o(o=>w.value=o),l:a.p({visible:w.value})}:{})}},Q=a._export_sfc(K,[["__scopeId","data-v-c9647468"]]);wx.createComponent(Q);
//# sourceMappingURL=../../../../../.sourcemap/mp-weixin/pages/tabbar/home/components/home.js.map

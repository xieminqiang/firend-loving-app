"use strict";const a=require("../../../../common/vendor.js"),O=require("../../../../common/assets.js"),q=require("../../../../api/home.js"),E=require("../../../../stores/city.js"),N=require("../../../../stores/user.js");Array||a.resolveComponent("u-tabs")();const G=()=>"../../../../uni_modules/uview-plus/components/u-tabs/u-tabs.js";Math||(J+G+K)();const J=()=>"../../../../components/common/CitySelector.js",K=()=>"../../../../components/common/CityPicker.js",Q={__name:"home",setup(D){const S=N.useUserStore(),M=a.ref(0),k=a.ref(44);a.onMounted(async()=>{a.index.__f__("log","at pages/tabbar/home/components/home.vue:160","home组件挂载完成");const e=a.index.getSystemInfoSync();M.value=e.statusBarHeight||0,k.value=44,await c.initCityData(),await f(u.value)});const c=E.useCityStore();a.computed(()=>c.currentCity);const b=a.computed(()=>c.currentCityCode);a.computed(()=>c.cityList),a.computed(()=>c.cityIndex);const u=a.ref("娱乐"),v=["服务","娱乐","运动"],L=a.computed(()=>v.map(e=>({name:e})));a.onUnmounted(()=>{x&&clearTimeout(x)});const m=a.ref({服务:[],娱乐:[],运动:[]}),_=a.ref({服务:!1,娱乐:!1,运动:!1}),d=a.ref({服务:!1,娱乐:!1,运动:!1}),n=a.ref({服务:{page:1,hasMore:!0},娱乐:{page:1,hasMore:!0},运动:{page:1,hasMore:!0}}),h=a.ref({服务:!1,娱乐:!1,运动:!1}),f=async(e,t=!1)=>{if(!e){a.index.__f__("error","at pages/tabbar/home/components/home.vue:260","loadSingleTabData: tab parameter is required");return}if(n.value[e]||(a.index.__f__("log","at pages/tabbar/home/components/home.vue:266",`初始化 ${e} 的分页状态`),n.value[e]={page:1,hasMore:!0}),_.value[e]&&!d.value[e]&&!t){a.index.__f__("log","at pages/tabbar/home/components/home.vue:272",`${e}数据已缓存，跳过加载`);return}t&&(_.value[e]=!1,a.index.__f__("log","at pages/tabbar/home/components/home.vue:279",`强制刷新${e}，清除缓存状态`)),d.value[e]=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:283",`开始加载${e}服务数据，当前城市代码:`,b.value,t?"(强制刷新)":"");try{const o={category:I(e),page_size:10,city_code:b.value,page:n.value[e].page};a.index.__f__("log","at pages/tabbar/home/components/home.vue:293",`${e}服务请求参数:`,o);const l=await q.getHotRecommendServices(o);if(l.data&&l.data.code===0&&l.data.data&&l.data.data.list){const g=l.data.data.list.length,s=l.data.data.list.filter(r=>r.id!==3&&r.id!==5).map(r=>({id:r.id,name:r.name,desc:r.description,tags:r.tags||[],img:r.image_url||"/static/images/service-default.png",min_price:r.min_price||0,unit:r.unit||"次",price_template_id:r.price_template_id}));a.index.__f__("log","at pages/tabbar/home/components/home.vue:313",`${e}服务数据过滤: 原始${g}条，过滤后${s.length}条`),t?(a.index.__f__("log","at pages/tabbar/home/components/home.vue:317",`${e}强制刷新前页码: ${n.value[e].page}`),m.value[e]=s,n.value[e].page=1,n.value[e].hasMore=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:321",`${e}服务数据强制刷新成功，共${s.length}条，重置后页码: ${n.value[e].page}`)):(m.value[e]=s,n.value[e].hasMore=s.length===10,a.index.__f__("log","at pages/tabbar/home/components/home.vue:326",`${e}服务数据初始加载成功，共${s.length}条`))}else t?(m.value[e]=[],n.value[e].page=1,n.value[e].hasMore=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:334",`${e}服务数据强制刷新为空`)):a.index.__f__("log","at pages/tabbar/home/components/home.vue:336",`${e}服务数据为空，保留现有数据`);_.value[e]=!0}catch(o){a.index.__f__("error","at pages/tabbar/home/components/home.vue:341",`获取${e}服务数据失败:`,o),t?(m.value[e]=[],n.value[e].page=1,n.value[e].hasMore=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:347",`${e}强制刷新失败，清空数据`)):a.index.__f__("log","at pages/tabbar/home/components/home.vue:349",`${e}数据加载失败，保留现有数据`),_.value[e]=!0}finally{d.value[e]=!1}},j=async e=>{if(!e){a.index.__f__("error","at pages/tabbar/home/components/home.vue:361","loadMoreData: tab parameter is required");return}if(n.value[e]||(a.index.__f__("log","at pages/tabbar/home/components/home.vue:367",`初始化 ${e} 的分页状态`),n.value[e]={page:1,hasMore:!0}),!n.value[e].hasMore||h.value[e]||d.value[e]){a.index.__f__("log","at pages/tabbar/home/components/home.vue:373",`${e}没有更多数据或正在加载中，跳过加载`);return}h.value[e]=!0,a.index.__f__("log","at pages/tabbar/home/components/home.vue:378",`开始加载更多${e}数据，当前页码: ${n.value[e].page}`);try{const t={category:I(e),page_size:10,city_code:b.value,page:n.value[e].page+1};a.index.__f__("log","at pages/tabbar/home/components/home.vue:388",`${e}加载更多请求参数:`,t);const o=await q.getHotRecommendServices(t);if(o.data&&o.data.code===0&&o.data.data&&o.data.data.list){const l=o.data.data.list.length,g=o.data.data.list.filter(i=>i.id!==3&&i.id!==5).map(i=>({id:i.id,name:i.name,desc:i.description,tags:i.tags||[],img:i.image_url||"/static/images/service-default.png",min_price:i.min_price||0,unit:i.unit||"次",price_template_id:i.price_template_id}));a.index.__f__("log","at pages/tabbar/home/components/home.vue:408",`${e}加载更多数据过滤: 原始${l}条，过滤后${g.length}条`);const s=new Set(m.value[e].map(i=>i.id)),r=g.filter(i=>!s.has(i.id));r.length>0?(m.value[e]=[...m.value[e],...r],n.value[e].page++,n.value[e].hasMore=g.length===10,a.index.__f__("log","at pages/tabbar/home/components/home.vue:418",`${e}加载更多成功，新增${r.length}条，当前页码: ${n.value[e].page}`)):(n.value[e].hasMore=!1,a.index.__f__("log","at pages/tabbar/home/components/home.vue:422",`${e}没有更多新数据`))}else n.value[e].hasMore=!1,a.index.__f__("log","at pages/tabbar/home/components/home.vue:427",`${e}加载更多返回空数据`)}catch(t){a.index.__f__("error","at pages/tabbar/home/components/home.vue:430",`加载更多${e}数据失败:`,t)}finally{h.value[e]=!1}},P=async()=>{a.index.__f__("log","at pages/tabbar/home/components/home.vue:438","重新加载所有选项卡数据"),Object.keys(_.value).forEach(e=>{_.value[e]=!1,n.value[e]||(n.value[e]={page:1,hasMore:!0}),n.value[e].page=1,n.value[e].hasMore=!0}),await f(u.value)},I=e=>{switch(e){case"服务":return 1;case"娱乐":return 2;case"运动":return 3;default:return 0}},$=a.ref(1);let x=null;const H=async e=>{const t=u.value,o=e;u.value=o,$.value=v.indexOf(o),t!==o&&!_.value[o]&&await f(o)},A=async e=>{let t,o;if(typeof e=="object"&&e!==null)t=e.index,o=e.name;else if(typeof e=="number")t=e,o=v[t];else{a.index.__f__("error","at pages/tabbar/home/components/home.vue:498","Invalid tab change item:",e);return}if(t<0||t>=v.length){a.index.__f__("error","at pages/tabbar/home/components/home.vue:504","Invalid tab index:",t);return}if(!o){a.index.__f__("error","at pages/tabbar/home/components/home.vue:509","Tab not found for index:",t,"item:",e);return}a.index.__f__("log","at pages/tabbar/home/components/home.vue:513","Tab changed to:",o,"index:",t),await H(o)},z=async e=>{const t=e.detail.current,o=v[t],l=u.value;$.value=t,u.value=o,x&&clearTimeout(x),l!==o&&!_.value[o]&&(x=setTimeout(async()=>{await f(o)},300))},p=e=>m.value[e]||[];function B(e){a.index.__f__("log","at pages/tabbar/home/components/home.vue:548","跳转到服务详情页, ID:",e);const o=p(u.value).find(g=>g.id===e);let l=`/subPackages/home/detail?id=${e}`;o&&o.price_template_id&&(l+=`&price_template_id=${o.price_template_id}`),a.index.__f__("log","at pages/tabbar/home/components/home.vue:560","跳转URL:",l),a.index.navigateTo({url:l})}const w=a.ref(!1),y=a.ref(!1),R=async e=>{if(a.index.__f__("log","at pages/tabbar/home/components/home.vue:581",`下拉刷新触发，当前tab: ${e}, 当前serviceTab: ${u.value}`),!e){a.index.__f__("error","at pages/tabbar/home/components/home.vue:585","onRefresh: tab parameter is required");return}if(n.value[e]||(a.index.__f__("log","at pages/tabbar/home/components/home.vue:591",`初始化 ${e} 的分页状态`),n.value[e]={page:1,hasMore:!0}),y.value||e!==u.value){a.index.__f__("log","at pages/tabbar/home/components/home.vue:597",`刷新被阻止: isRefreshing=${y.value}, tab不匹配=${e!==u.value}`);return}y.value=!0,w.value=!0;try{c.cityList.length===0&&(a.index.__f__("log","at pages/tabbar/home/components/home.vue:607","城市列表为空，重新加载城市列表"),await c.loadCityList()),a.index.__f__("log","at pages/tabbar/home/components/home.vue:612",`下拉刷新${e}选项卡数据，刷新前页码: ${n.value[e].page}`),n.value[e].page=1,a.index.__f__("log","at pages/tabbar/home/components/home.vue:616",`手动重置页码为1: ${n.value[e].page}`),await f(e,!0),a.index.__f__("log","at pages/tabbar/home/components/home.vue:619",`下拉刷新${e}选项卡数据完成，刷新后页码: ${n.value[e].page}`),n.value[e].page!==1&&(a.index.__f__("warn","at pages/tabbar/home/components/home.vue:623","页码重置失败，手动强制设置为1"),n.value[e].page=1),await new Promise(t=>setTimeout(t,800))}catch(t){a.index.__f__("error","at pages/tabbar/home/components/home.vue:630","刷新失败:",t)}finally{w.value=!1,y.value=!1}},U=()=>{w.value=!1,y.value=!1},W=async e=>{a.index.__f__("log","at pages/tabbar/home/components/home.vue:646",`上拉加载触发，当前tab: ${e}`),await j(e)},T=a.ref(!1);function F(e){c.cityIndex!==e&&(a.index.__f__("log","at pages/tabbar/home/components/home.vue:658",`手动选择城市: ${c.cityList[e].name}`),P())}return(e,t)=>a.e({a:a.unref(S).switch===1},a.unref(S).switch===1?{b:a.o(o=>T.value=!0),c:M.value+"px",d:a.o(A),e:a.p({list:L.value,current:$.value,lineWidth:"20",lineHeight:"2",lineColor:"linear-gradient(90deg, rgba(115, 99, 255, 1) 0%, rgba(255, 105, 222, 1) 100%)",activeStyle:{color:"#7363FF",fontWeight:"500",fontSize:"28rpx"},inactiveStyle:{color:"#1A1A1A",fontWeight:"400",fontSize:"28rpx"},itemStyle:"padding: 16rpx 50rpx; height: auto; border-radius: 30rpx;"}),f:a.f(v,(o,l,g)=>a.e({a:p(o).length>0},p(o).length>0?a.e({b:a.f(p(o),(s,r,i)=>({a:e.$imgBaseUrl+s.img,b:a.t(s.name),c:a.f(s.tags,(C,X,Y)=>({a:a.t(C),b:C})),d:a.t(s.min_price||0),e:a.t(s.unit),f:s.id,g:a.o(C=>B(s.id),s.id)})),c:n.value[o].hasMore},n.value[o].hasMore?a.e({d:h.value[o]},h.value[o]?{}:{}):{}):_.value[o]&&p(o).length===0?{f:O._imports_3,g:a.t(o)}:d.value[o]&&p(o).length===0?{}:{},{e:_.value[o]&&p(o).length===0,h:d.value[o]&&p(o).length===0,i:a.o(s=>R(o),o),j:a.o(U,o),k:a.o(s=>W(o),o),l:o})),g:w.value,h:$.value,i:a.o(z),j:a.o(F),k:a.o(o=>T.value=o),l:a.p({visible:T.value})}:{})}},V=a._export_sfc(Q,[["__scopeId","data-v-c9647468"]]);wx.createComponent(V);
//# sourceMappingURL=../../../../../.sourcemap/mp-weixin/pages/tabbar/home/components/home.js.map

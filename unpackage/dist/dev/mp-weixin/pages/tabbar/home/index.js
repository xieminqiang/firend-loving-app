"use strict";const e=require("../../../common/vendor.js"),D=require("../../../common/assets.js"),R=require("../../../api/home.js"),B=require("../../../stores/city.js");Array||e.resolveComponent("hm-tabbar")();const H=()=>"../../../components/hm-tabbar/hm-tabbar.js";Math||(M+U+H)();const M=()=>"../../../components/common/CitySelector.js",U=()=>"../../../components/common/CityPicker.js",A={__name:"index",setup(C){const b=e.ref(0),w=e.ref(44);e.onMounted(async()=>{const t=e.index.getSystemInfoSync();b.value=t.statusBarHeight||0,w.value=44,await c.initCityData(),await v(s.value)});const c=B.useCityStore();e.computed(()=>c.currentCity);const T=e.computed(()=>c.currentCityCode);e.computed(()=>c.cityList),e.computed(()=>c.cityIndex);const s=e.ref("服务"),m=["服务","娱乐","运动"];e.onUnmounted(()=>{f&&clearTimeout(f)});const _=e.ref({服务:[],娱乐:[],运动:[]}),l=e.ref({服务:!1,娱乐:!1,运动:!1}),d=e.ref({服务:!1,娱乐:!1,运动:!1}),v=async(t,n=!1)=>{if(l.value[t]&&!d.value[t]&&!n){e.index.__f__("log","at pages/tabbar/home/index.vue:208",`${t}数据已缓存，跳过加载`);return}d.value[t]=!0,e.index.__f__("log","at pages/tabbar/home/index.vue:213",`开始加载${t}服务数据，当前城市代码:`,T.value,n?"(强制刷新)":"");try{const a={category:S(t),page_size:10,city_code:T.value};e.index.__f__("log","at pages/tabbar/home/index.vue:222",`${t}服务请求参数:`,a);const i=await R.getHotRecommendServices(a);i.data&&i.data.code===0&&i.data.data&&i.data.data.list?(_.value[t]=i.data.data.list.map(r=>({id:r.id,name:r.name,desc:r.description,tags:r.tags||[],img:r.image_url||"/static/images/service-default.png",min_price:r.min_price||0,unit:r.unit||"次",price_template_id:r.price_template_id})),e.index.__f__("log","at pages/tabbar/home/index.vue:239",`${t}服务数据加载成功，共${_.value[t].length}条`)):(_.value[t]=[],e.index.__f__("log","at pages/tabbar/home/index.vue:243",`${t}服务数据为空`)),l.value[t]=!0}catch(a){e.index.__f__("error","at pages/tabbar/home/index.vue:247",`获取${t}服务数据失败:`,a),_.value[t]=[],l.value[t]=!0}finally{d.value[t]=!1}},$=async()=>{e.index.__f__("log","at pages/tabbar/home/index.vue:258","重新加载所有选项卡数据"),Object.keys(l.value).forEach(t=>{l.value[t]=!1}),await v(s.value)},S=t=>{switch(t){case"服务":return 1;case"娱乐":return 2;case"运动":return 3;default:return 0}},h=e.ref(0);let f=null;const I=async t=>{const n=s.value,a=t;s.value=a,h.value=m.indexOf(a),n!==a&&!l.value[a]&&await v(a)},k=async t=>{const n=t.detail.current,a=m[n],i=s.value;h.value=n,s.value=a,f&&clearTimeout(f),i!==a&&!l.value[a]&&(f=setTimeout(async()=>{await v(a)},300))},u=t=>_.value[t]||[];function P(t){e.index.__f__("log","at pages/tabbar/home/index.vue:329","跳转到服务详情页, ID:",t);const a=u(s.value).find(r=>r.id===t);let i=`/subPackages/home/detail?id=${t}`;a&&a.price_template_id&&(i+=`&price_template_id=${a.price_template_id}`),e.index.__f__("log","at pages/tabbar/home/index.vue:341","跳转URL:",i),e.index.navigateTo({url:i})}const g=e.ref(!1),p=e.ref(!1),L=async t=>{if(!(p.value||t!==s.value)){p.value=!0,g.value=!0;try{c.cityList.length===0&&(e.index.__f__("log","at pages/tabbar/home/index.vue:373","城市列表为空，重新加载城市列表"),await c.loadCityList()),e.index.__f__("log","at pages/tabbar/home/index.vue:378",`下拉刷新${t}选项卡数据`),await v(t,!1),await new Promise(n=>setTimeout(n,800))}catch(n){e.index.__f__("error","at pages/tabbar/home/index.vue:383","刷新失败:",n)}finally{g.value=!1,p.value=!1}}},j=()=>{g.value=!1,p.value=!1},y=e.ref(!1);function q(t){c.cityIndex!==t&&(e.index.__f__("log","at pages/tabbar/home/index.vue:405",`手动选择城市: ${c.cityList[t].name}`),$())}return(t,n)=>({a:e.o(a=>y.value=!0),b:b.value+"px",c:e.f(m,(a,i,r)=>e.e({a:e.t(a),b:s.value===a},s.value===a?{}:{},{c:a,d:e.n({active:s.value===a}),e:e.o(o=>I(a),a)})),d:e.f(m,(a,i,r)=>e.e({a:d.value[a]},d.value[a]?{}:u(a).length>0?{c:e.f(u(a),(o,z,E)=>({a:t.$imgBaseUrl+o.img,b:e.t(o.name),c:e.f(o.tags,(x,F,G)=>({a:e.t(x),b:x})),d:e.t(o.min_price||0),e:e.t(o.unit),f:o.id,g:e.o(x=>P(o.id),o.id)}))}:l.value[a]&&u(a).length===0?{e:D._imports_3,f:e.t(a)}:{},{b:u(a).length>0,d:l.value[a]&&u(a).length===0,g:e.o(o=>L(a),a),h:e.o(j,a),i:a})),e:g.value,f:h.value,g:e.o(k),h:e.o(q),i:e.o(a=>y.value=a),j:e.p({visible:y.value}),k:e.p({currentTab:"home"})})}},O=e._export_sfc(A,[["__scopeId","data-v-30d82312"]]);wx.createPage(O);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/pages/tabbar/home/index.js.map

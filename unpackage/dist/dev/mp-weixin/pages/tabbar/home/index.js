"use strict";const e=require("../../../common/vendor.js"),D=require("../../../common/assets.js"),R=require("../../../api/home.js"),j=require("../../../stores/city.js");Math||(B+H)();const B=()=>"../../../components/common/CitySelector.js",H=()=>"../../../components/common/CityPicker.js",M={__name:"index",setup(O){const T=e.ref(0),w=e.ref(44);e.onMounted(async()=>{const t=e.index.getSystemInfoSync();T.value=t.statusBarHeight||0,w.value=44,await c.initCityData(),await v(r.value)});const c=j.useCityStore();e.computed(()=>c.currentCity);const C=e.computed(()=>c.currentCityCode);e.computed(()=>c.cityList),e.computed(()=>c.cityIndex);const r=e.ref("服务"),g=["服务"];e.onUnmounted(()=>{f&&clearTimeout(f)});const d=e.ref({服务:[],娱乐:[],运动:[]}),l=e.ref({服务:!1,娱乐:!1,运动:!1}),_=e.ref({服务:!1,娱乐:!1,运动:!1}),v=async(t,n=!1)=>{if(l.value[t]&&!_.value[t]&&!n){e.index.__f__("log","at pages/tabbar/home/index.vue:207",`${t}数据已缓存，跳过加载`);return}_.value[t]=!0,e.index.__f__("log","at pages/tabbar/home/index.vue:212",`开始加载${t}服务数据，当前城市代码:`,C.value,n?"(强制刷新)":"");try{const a={category:S(t),page_size:10,city_code:C.value};e.index.__f__("log","at pages/tabbar/home/index.vue:221",`${t}服务请求参数:`,a);const i=await R.getHotRecommendServices(a);i.data&&i.data.code===0&&i.data.data&&i.data.data.list?(d.value[t]=i.data.data.list.map(s=>({id:s.id,name:s.name,desc:s.description,tags:s.tags||[],img:s.image_url||"/static/images/service-default.png",min_price:s.min_price||0,unit:s.unit||"次",price_template_id:s.price_template_id})),e.index.__f__("log","at pages/tabbar/home/index.vue:238",`${t}服务数据加载成功，共${d.value[t].length}条`)):(d.value[t]=[],e.index.__f__("log","at pages/tabbar/home/index.vue:242",`${t}服务数据为空`)),l.value[t]=!0}catch(a){e.index.__f__("error","at pages/tabbar/home/index.vue:246",`获取${t}服务数据失败:`,a),d.value[t]=[],l.value[t]=!0}finally{_.value[t]=!1}},$=async()=>{e.index.__f__("log","at pages/tabbar/home/index.vue:257","重新加载所有选项卡数据"),Object.keys(l.value).forEach(t=>{l.value[t]=!1}),await v(r.value)},S=t=>{switch(t){case"服务":return 1;case"娱乐":return 2;case"运动":return 3;default:return 0}},h=e.ref(0);let f=null;const I=async t=>{const n=r.value,a=t;r.value=a,h.value=g.indexOf(a),n!==a&&!l.value[a]&&await v(a)},b=async t=>{const n=t.detail.current,a=g[n],i=r.value;h.value=n,r.value=a,f&&clearTimeout(f),i!==a&&!l.value[a]&&(f=setTimeout(async()=>{await v(a)},300))},u=t=>d.value[t]||[];function k(t){e.index.__f__("log","at pages/tabbar/home/index.vue:328","跳转到服务详情页, ID:",t);const a=u(r.value).find(s=>s.id===t);let i=`/subPackages/home/detail?id=${t}`;a&&a.price_template_id&&(i+=`&price_template_id=${a.price_template_id}`),e.index.__f__("log","at pages/tabbar/home/index.vue:340","跳转URL:",i),e.index.navigateTo({url:i})}const m=e.ref(!1),p=e.ref(!1),P=async t=>{if(!(p.value||t!==r.value)){p.value=!0,m.value=!0;try{c.cityList.length===0&&(e.index.__f__("log","at pages/tabbar/home/index.vue:372","城市列表为空，重新加载城市列表"),await c.loadCityList()),e.index.__f__("log","at pages/tabbar/home/index.vue:377",`下拉刷新${t}选项卡数据`),await v(t,!1),await new Promise(n=>setTimeout(n,800))}catch(n){e.index.__f__("error","at pages/tabbar/home/index.vue:382","刷新失败:",n)}finally{m.value=!1,p.value=!1}}},L=()=>{m.value=!1,p.value=!1},y=e.ref(!1);function q(t){c.cityIndex!==t&&(e.index.__f__("log","at pages/tabbar/home/index.vue:404",`手动选择城市: ${c.cityList[t].name}`),$())}return(t,n)=>({a:e.o(a=>y.value=!0),b:T.value+"px",c:e.f(g,(a,i,s)=>e.e({a:e.t(a),b:r.value===a},r.value===a?{}:{},{c:a,d:e.n({active:r.value===a}),e:e.o(o=>I(a),a)})),d:e.f(g,(a,i,s)=>e.e({a:_.value[a]},_.value[a]?{}:u(a).length>0?{c:e.f(u(a),(o,z,A)=>({a:t.$imgBaseUrl+o.img,b:e.t(o.name),c:e.f(o.tags,(x,E,F)=>({a:e.t(x),b:x})),d:e.t(o.min_price||0),e:e.t(o.unit),f:o.id,g:e.o(x=>k(o.id),o.id)}))}:l.value[a]&&u(a).length===0?{e:D._imports_3,f:e.t(a)}:{},{b:u(a).length>0,d:l.value[a]&&u(a).length===0,g:e.o(o=>P(a),a),h:e.o(L,a),i:a})),e:m.value,f:h.value,g:e.o(b),h:e.o(q),i:e.o(a=>y.value=a),j:e.p({visible:y.value})})}},U=e._export_sfc(M,[["__scopeId","data-v-30d82312"]]);wx.createPage(U);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/pages/tabbar/home/index.js.map

"use strict";const e=require("../../../common/vendor.js"),_=require("../../../common/assets.js"),J=require("../../../api/friends.js");require("../../../config/http.js");const ae=require("../../../stores/level.js"),ne=require("../../../stores/city.js");Array||e.resolveComponent("uni-popup")();const le=()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(re+se+le)();const re=()=>"../../../components/common/CitySelector.js",se=()=>"../../../components/common/CityPicker.js",oe={__name:"index",setup(N){const A=e.ref(0);e.ref(null);const D=e.ref(0),x=e.ref(""),w=e.ref(!1),T=e.ref(!1),g=e.computed(()=>{var a;return((a=o.userLocation)==null?void 0:a.latitude)||null}),p=e.computed(()=>{var a;return((a=o.userLocation)==null?void 0:a.longitude)||null});e.ref(!1);const o=ne.useCityStore();e.computed(()=>o.cityList),e.computed(()=>o.currentCity);const u=e.ref(""),v=e.ref("all"),h=e.ref("all"),c=e.ref("all"),y=e.ref("recommend"),O=e.ref(1),d=e.ref([]),k=e.ref(0),$=e.ref(1),j=e.ref(20),m=e.ref(!1),z=e.ref(!0),S=e.ref(!1),L=ae.useLevelStore(),C=e.computed(function(){return d.value.map(function(a){const n=a.tags?a.tags.slice(0,3):[],t=a.tags&&a.tags.length>3?a.tags.length-3:0;return{...a,visibleTags:n,extraTags:t}})});e.computed(()=>({all:"性别",female:"女生",male:"男生"})[v.value]||"性别"),e.computed(()=>({all:"距离","1km":"1km内","3km":"3km内","5km":"5km内","10km":"10km内"})[h.value]||"距离"),e.computed(()=>{if(c.value==="all")return"级别";const a=L.sortedServiceLevels.find(n=>n.level_order.toString()===c.value);return a?a.level_name:"级别"}),e.computed(()=>({distance:"距离",rating:"评分",new:"最新"})[y.value]||"排序");const U=e.computed(function(){return{gender:"选择性别",distance:"选择距离",level:"选择级别",sort:"排序方式"}[u.value]||""}),W=e.computed(function(){return{gender:[{value:"all",label:"不限性别"},{value:"female",label:"女生",icon:"/static/icons/friend/female.png"},{value:"male",label:"男生",icon:"/static/icons/friend/male.png"}],level:[{value:"all",label:"不限级别"},...L.sortedServiceLevels.map(n=>({value:n.level_order.toString(),label:`${n.level_name}`,icon:n.icon_url||"/static/icons/friend/star.png"}))]}[u.value]||[]}),M=a=>({gender:v,distance:h,level:c,sort:y})[u.value].value===a,E=a=>{const n={gender:v,distance:h,level:c,sort:y};n[u.value].value=a},F=()=>{u.value=""},G=()=>{const a={gender:v,distance:h,level:c,sort:y};a[u.value].value="all"},K=()=>{e.index.__f__("log","at pages/tabbar/friends/index.vue:361","应用筛选:",{gender:v.value,distance:h.value,level:c.value,sort:y.value}),F(),b(!0)},I=e.ref(null),f=e.ref([]),q=e.ref(null),Y=e.ref(0),Q=async a=>{q.value=a;try{const n={city_code:o.currentCityCode,application_id:a.id};g.value&&p.value&&(n.latitude=parseFloat(g.value),n.longitude=parseFloat(p.value));const t=await J.getCityServices(n);if(t.data&&t.data.code===0){const l=t.data.data;l&&l.services&&l.services.length>0?(f.value=l.services,O.value=l.level_order):f.value=[]}else f.value=[]}catch(n){e.index.__f__("error","at pages/tabbar/friends/index.vue:419","获取服务信息失败:",n),f.value=[]}I.value.open()},B=()=>{I.value.close()},R=a=>{e.index.__f__("log","at pages/tabbar/friends/index.vue:433","选择服务:",a),B(),e.index.navigateTo({url:`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${q.value.id}&level_order=${O.value||""}&nickname=${q.value.name}`})},V=a=>{let n="/subPackages/friend/detail?id="+a+"&city_code="+o.currentCityCode;g.value&&p.value&&(n+="&latitude="+g.value+"&longitude="+p.value),e.index.navigateTo({url:n})},b=async(a=!1)=>{var n;if(!m.value){m.value=!0;try{const t={page:a?1:$.value,page_size:j.value};o.currentCityCode&&(t.city_code=o.currentCityCode),x.value&&x.value.trim()&&(t.nickname=x.value.trim()),g.value&&p.value&&(t.latitude=g.value,t.longitude=p.value),v.value!=="all"&&(t.gender=v.value==="female"?"女":"男"),c.value!=="all"&&(t.level_order=parseInt(c.value)),e.index.__f__("log","at pages/tabbar/friends/index.vue:542","搜索参数:",t);const l=await J.searchCompanions(t);if(e.index.__f__("log","at pages/tabbar/friends/index.vue:546","API完整响应:",l),l.data&&l.data.code===0){const i=l.data.data;if(i&&i.list){const s=i.list.map(r=>({id:r.id,name:r.nickname,gender:r.gender,age:r.age,height:r.height,weight:r.weight,distance:r.distance,tags:r.tags||[],services:(()=>{if(typeof r.services=="string")try{return JSON.parse(r.services)}catch(H){return e.index.__f__("error","at pages/tabbar/friends/index.vue:565","解析services JSON失败:",H),[]}return r.services||[]})(),avatar:r.avatar,online:r.is_online===1,bookable:r.can_accept_orders==="Y"}));a?(d.value=s,$.value=1):(d.value=[...d.value,...s],$.value++),k.value=i.total||0,z.value=s.length===j.value,e.index.__f__("log","at pages/tabbar/friends/index.vue:587","搜索成功，共获取",s.length,"条数据，总数:",k.value),s.length}else e.index.__f__("log","at pages/tabbar/friends/index.vue:598","API返回数据为空"),a&&(d.value=[],k.value=0)}else{e.index.__f__("error","at pages/tabbar/friends/index.vue:606","API返回错误:",l.data);const i=((n=l.data)==null?void 0:n.message)||"搜索失败";e.index.showToast({title:i,icon:"none",duration:2e3}),a&&(d.value=[],k.value=0)}}catch(t){e.index.__f__("error","at pages/tabbar/friends/index.vue:620","搜索伴友师失败:",t),e.index.__f__("error","at pages/tabbar/friends/index.vue:621","错误详情:",t.response||t);let l="搜索失败，请重试";t.response&&t.response.data&&(l=t.response.data.message||l),e.index.showToast({title:l,icon:"none",duration:2e3}),a&&(d.value=[],k.value=0)}finally{m.value=!1,S.value=!0}}},X=()=>{!m.value&&z.value&&b(!1)},Z=async()=>{w.value=!0,await b(!0),await new Promise(a=>setTimeout(a,800)),w.value=!1},ee=()=>{clearTimeout(P),P=setTimeout(()=>{b(!0)},500)};let P=null;const te=async a=>{e.index.vibrateShort({type:"light"}),await b(!0)};return e.onMounted(async()=>{const a=e.index.getSystemInfoSync();A.value=a.statusBarHeight;const n=e.index.getMenuButtonBoundingClientRect();n.value=n;const t=a.screenWidth,l=n.right;D.value=t-l+24,await L.fetchServiceLevels(),await o.initCityData(),await b(!0)}),e.onUnmounted(()=>{P&&clearTimeout(P)}),(a,n)=>e.e({a:e.o(t=>T.value=!0),b:_._imports_1,c:e.o([t=>x.value=t.detail.value,ee]),d:x.value,e:D.value+"px",f:A.value+"px",g:m.value&&!S.value},m.value&&!S.value?{}:C.value.length>0?{i:e.f(C.value,(t,l,i)=>e.e({a:t.avatar,b:t.online},t.online?{}:{},{c:e.t(t.name),d:e.t(t.distance),e:e.o(s=>Q(t),t.id),f:t.id,g:e.o(s=>V(t.id),t.id)})),j:_._imports_2}:S.value&&C.value.length===0?{l:_._imports_3}:{},{h:C.value.length>0,k:S.value&&C.value.length===0,m:e.o(X),n:w.value,o:e.o(Z),p:u.value},u.value?{q:e.t(U.value),r:_._imports_4,s:e.o(F),t:e.f(W.value,(t,l,i)=>e.e({a:t.icon},t.icon?{b:t.icon}:{},{c:e.t(t.label),d:M(t.value)},M(t.value)?{e:_._imports_4$1}:{},{f:t.value,g:e.n({selected:M(t.value)}),h:e.o(s=>E(t.value),t.value)})),v:e.o(G),w:e.o(K),x:e.o(()=>{}),y:e.o(F)}:{},{z:e.o(te),A:e.o(t=>T.value=t),B:e.p({visible:T.value}),C:_._imports_4,D:e.o(B),E:f.value.length>0},f.value.length>0?{F:e.f(f.value,(t,l,i)=>({a:a.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,(s,r,H)=>({a:e.t(s),b:s})),d:e.t(t.price),e:e.t(t.unit||"小时"),f:e.o(s=>R(t),t.title),g:t.title}))}:{G:_._imports_3},{H:Y.value,I:e.sr(I,"5e09aaad-2",{k:"servicePopup"}),J:e.o(B),K:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})})}},ie=e._export_sfc(oe,[["__scopeId","data-v-5e09aaad"]]);wx.createPage(ie);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/pages/tabbar/friends/index.js.map

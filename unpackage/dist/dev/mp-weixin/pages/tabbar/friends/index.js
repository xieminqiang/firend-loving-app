"use strict";const e=require("../../../common/vendor.js"),u=require("../../../common/assets.js"),N=require("../../../api/friends.js");require("../../../config/http.js");const ae=require("../../../stores/level.js"),ne=require("../../../stores/city.js");if(!Array){const D=e.resolveComponent("uni-popup"),P=e.resolveComponent("hm-tabbar");(D+P)()}const re=()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js",se=()=>"../../../components/hm-tabbar/hm-tabbar.js";Math||(le+oe+re+se)();const le=()=>"../../../components/common/CitySelector.js",oe=()=>"../../../components/common/CityPicker.js",ie={__name:"index",setup(D){const P=e.ref(0);e.ref(null);const O=e.ref(0),h=e.ref(""),w=e.ref(!1),$=e.ref(!1),g=e.computed(()=>{var a;return((a=o.userLocation)==null?void 0:a.latitude)||null}),p=e.computed(()=>{var a;return((a=o.userLocation)==null?void 0:a.longitude)||null});e.ref(!1);const o=ne.useCityStore();e.computed(()=>o.cityList),e.computed(()=>o.currentCity);const c=e.ref(""),d=e.ref("all"),x=e.ref("all"),v=e.ref("all"),y=e.ref("recommend"),z=e.ref(1),_=e.ref([]),k=e.ref(0),L=e.ref(1),H=e.ref(20),m=e.ref(!1),J=e.ref(!0),S=e.ref(!1),M=ae.useLevelStore(),C=e.computed(function(){return _.value.map(function(a){const n=a.tags?a.tags.slice(0,3):[],t=a.tags&&a.tags.length>3?a.tags.length-3:0;return{...a,visibleTags:n,extraTags:t}})});e.computed(()=>({all:"性别",female:"女生",male:"男生"})[d.value]||"性别"),e.computed(()=>({all:"距离","1km":"1km内","3km":"3km内","5km":"5km内","10km":"10km内"})[x.value]||"距离"),e.computed(()=>{if(v.value==="all")return"级别";const a=M.sortedServiceLevels.find(n=>n.level_order.toString()===v.value);return a?a.level_name:"级别"}),e.computed(()=>({distance:"距离",rating:"评分",new:"最新"})[y.value]||"排序");const U=e.computed(function(){return{gender:"选择性别",distance:"选择距离",level:"选择级别",sort:"排序方式"}[c.value]||""}),W=e.computed(function(){return{gender:[{value:"all",label:"不限性别"},{value:"female",label:"女生",icon:"/static/icons/friend/female.png"},{value:"male",label:"男生",icon:"/static/icons/friend/male.png"}],level:[{value:"all",label:"不限级别"},...M.sortedServiceLevels.map(n=>({value:n.level_order.toString(),label:`${n.level_name}`,icon:n.icon_url||"/static/icons/friend/star.png"}))]}[c.value]||[]}),F=a=>({gender:d,distance:x,level:v,sort:y})[c.value].value===a,E=a=>{const n={gender:d,distance:x,level:v,sort:y};n[c.value].value=a},I=()=>{c.value=""},G=()=>{const a={gender:d,distance:x,level:v,sort:y};a[c.value].value="all"},K=()=>{e.index.__f__("log","at pages/tabbar/friends/index.vue:362","应用筛选:",{gender:d.value,distance:x.value,level:v.value,sort:y.value}),I(),b(!0)},q=e.ref(null),f=e.ref([]),B=e.ref(null),Y=e.ref(0),Q=async a=>{B.value=a;try{const n={city_code:o.currentCityCode,application_id:a.id};g.value&&p.value&&(n.latitude=parseFloat(g.value),n.longitude=parseFloat(p.value));const t=await N.getCityServices(n);if(t.data&&t.data.code===0){const r=t.data.data;r&&r.services&&r.services.length>0?(f.value=r.services,z.value=r.level_order):f.value=[]}else f.value=[]}catch(n){e.index.__f__("error","at pages/tabbar/friends/index.vue:420","获取服务信息失败:",n),f.value=[]}q.value.open()},j=()=>{q.value.close()},R=a=>{e.index.__f__("log","at pages/tabbar/friends/index.vue:434","选择服务:",a),j(),e.index.navigateTo({url:`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${B.value.id}&level_order=${z.value||""}&nickname=${B.value.name}`})},V=a=>{let n="/subPackages/friend/detail?id="+a+"&city_code="+o.currentCityCode;g.value&&p.value&&(n+="&latitude="+g.value+"&longitude="+p.value),e.index.navigateTo({url:n})},b=async(a=!1)=>{var n;if(!m.value){m.value=!0;try{const t={page:a?1:L.value,page_size:H.value};o.currentCityCode&&(t.city_code=o.currentCityCode),h.value&&h.value.trim()&&(t.nickname=h.value.trim()),g.value&&p.value&&(t.latitude=g.value,t.longitude=p.value),d.value!=="all"&&(t.gender=d.value==="female"?"女":"男"),v.value!=="all"&&(t.level_order=parseInt(v.value)),e.index.__f__("log","at pages/tabbar/friends/index.vue:543","搜索参数:",t);const r=await N.searchCompanions(t);if(e.index.__f__("log","at pages/tabbar/friends/index.vue:547","API完整响应:",r),r.data&&r.data.code===0){const i=r.data.data;if(i&&i.list){const l=i.list.map(s=>({id:s.id,name:s.nickname,gender:s.gender,age:s.age,height:s.height,weight:s.weight,distance:s.distance,tags:s.tags||[],services:(()=>{if(typeof s.services=="string")try{return JSON.parse(s.services)}catch(A){return e.index.__f__("error","at pages/tabbar/friends/index.vue:566","解析services JSON失败:",A),[]}return s.services||[]})(),avatar:s.avatar,online:s.is_online===1,bookable:s.can_accept_orders==="Y"}));a?(_.value=l,L.value=1):(_.value=[..._.value,...l],L.value++),k.value=i.total||0,J.value=l.length===H.value,e.index.__f__("log","at pages/tabbar/friends/index.vue:588","搜索成功，共获取",l.length,"条数据，总数:",k.value),l.length}else e.index.__f__("log","at pages/tabbar/friends/index.vue:599","API返回数据为空"),a&&(_.value=[],k.value=0)}else{e.index.__f__("error","at pages/tabbar/friends/index.vue:607","API返回错误:",r.data);const i=((n=r.data)==null?void 0:n.message)||"搜索失败";e.index.showToast({title:i,icon:"none",duration:2e3}),a&&(_.value=[],k.value=0)}}catch(t){e.index.__f__("error","at pages/tabbar/friends/index.vue:621","搜索伴友师失败:",t),e.index.__f__("error","at pages/tabbar/friends/index.vue:622","错误详情:",t.response||t);let r="搜索失败，请重试";t.response&&t.response.data&&(r=t.response.data.message||r),e.index.showToast({title:r,icon:"none",duration:2e3}),a&&(_.value=[],k.value=0)}finally{m.value=!1,S.value=!0}}},X=()=>{!m.value&&J.value&&b(!1)},Z=async()=>{w.value=!0,await b(!0),await new Promise(a=>setTimeout(a,800)),w.value=!1},ee=()=>{clearTimeout(T),T=setTimeout(()=>{b(!0)},500)};let T=null;const te=async a=>{e.index.vibrateShort({type:"light"}),await b(!0)};return e.onMounted(async()=>{const a=e.index.getSystemInfoSync();P.value=a.statusBarHeight;const n=e.index.getMenuButtonBoundingClientRect();n.value=n;const t=a.screenWidth,r=n.right;O.value=t-r+24,await M.fetchServiceLevels(),await o.initCityData(),await b(!0)}),e.onUnmounted(()=>{T&&clearTimeout(T)}),(a,n)=>e.e({a:e.o(t=>$.value=!0),b:u._imports_1,c:e.o([t=>h.value=t.detail.value,ee]),d:h.value,e:O.value+"px",f:P.value+"px",g:m.value&&!S.value},m.value&&!S.value?{}:C.value.length>0?{i:e.f(C.value,(t,r,i)=>e.e({a:t.avatar,b:t.online},t.online?{}:{},{c:e.t(t.name),d:t.gender==="女"},t.gender==="女"?{e:u._imports_1$1}:{f:u._imports_0},{g:e.t(t.age),h:e.t(t.height),i:e.t(t.weight),j:e.t(t.distance),k:e.f(t.visibleTags,(l,s,A)=>({a:e.t(l),b:s})),l:t.extraTags>0},t.extraTags>0?{m:e.t(t.extraTags)}:{},{n:e.o(l=>Q(t),t.id),o:t.id,p:e.o(l=>V(t.id),t.id)})),j:u._imports_2}:S.value&&C.value.length===0?{l:u._imports_3}:{},{h:C.value.length>0,k:S.value&&C.value.length===0,m:e.o(X),n:w.value,o:e.o(Z),p:c.value},c.value?{q:e.t(U.value),r:u._imports_4,s:e.o(I),t:e.f(W.value,(t,r,i)=>e.e({a:t.icon},t.icon?{b:t.icon}:{},{c:e.t(t.label),d:F(t.value)},F(t.value)?{e:u._imports_6}:{},{f:t.value,g:e.n({selected:F(t.value)}),h:e.o(l=>E(t.value),t.value)})),v:e.o(G),w:e.o(K),x:e.o(()=>{}),y:e.o(I)}:{},{z:e.o(te),A:e.o(t=>$.value=t),B:e.p({visible:$.value}),C:u._imports_4,D:e.o(j),E:f.value.length>0},f.value.length>0?{F:e.f(f.value,(t,r,i)=>({a:a.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,(l,s,A)=>({a:e.t(l),b:l})),d:e.t(t.price),e:e.t(t.unit||"小时"),f:e.o(l=>R(t),t.title),g:t.title}))}:{G:u._imports_3},{H:Y.value,I:e.sr(q,"5e09aaad-2",{k:"servicePopup"}),J:e.o(j),K:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1}),L:e.p({currentTab:"friends"})})}},ue=e._export_sfc(ie,[["__scopeId","data-v-5e09aaad"]]);wx.createPage(ue);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/pages/tabbar/friends/index.js.map

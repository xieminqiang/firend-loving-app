"use strict";const e=require("../../../../common/vendor.js"),w=require("../../../../common/assets.js"),$=require("../../../../api/friends.js"),k=require("../../../../stores/city.js"),I=require("../../../../stores/user.js");Math||(S+L)();const S=()=>"../../../../components/common/CitySelector.js",L=()=>"../../../../components/common/CityPicker.js",R={__name:"home",setup(P,{expose:m}){I.useUserStore();const d=e.ref(0),h=e.ref(44);e.onMounted(async()=>{const a=e.index.getSystemInfoSync();d.value=a.statusBarHeight||0,h.value=44,await n.initCityData(),await l()});const n=k.useCityStore();e.computed(()=>n.currentCity);const f=e.computed(()=>n.currentCityCode);e.computed(()=>n.cityList),e.computed(()=>n.cityIndex);const r=e.ref([]),i=e.ref({}),c=e.ref(!1),_=e.ref(!1);e.onUnmounted(()=>{});const l=async()=>{var a;try{_.value=!0,e.index.__f__("log","at pages/tabbar/page/components/home.vue:159","开始加载城市服务数据，当前城市代码:",f.value);const s={city_code:f.value,application_id:15};e.index.__f__("log","at pages/tabbar/page/components/home.vue:166","城市服务请求参数:",s);const t=await $.getCityServices(s);if(t.data&&t.data.code===0&&t.data.data){const o=t.data.data;e.index.__f__("log","at pages/tabbar/page/components/home.vue:172","城市服务数据:",o),o&&(i.value={avatar:o.avatar,nickname:o.nickname||"未知用户",verified:!0,age:o.age,weight:o.weight,height:o.height,distance:o.distance,tags:o.tags||[],level_order:o.level_order,levelIcon:"",gender:o.gender||"",application_id:o.application_id||15}),o.services&&o.services.length>0?(r.value=o.services,e.index.__f__("log","at pages/tabbar/page/components/home.vue:195","服务数据加载成功，共",r.value.length,"条")):(r.value=[],e.index.__f__("log","at pages/tabbar/page/components/home.vue:198","服务数据为空"))}else e.index.__f__("error","at pages/tabbar/page/components/home.vue:201","获取城市服务失败:",((a=t.data)==null?void 0:a.message)||"未知错误"),r.value=[];c.value=!0}catch(s){e.index.__f__("error","at pages/tabbar/page/components/home.vue:206","获取城市服务异常:",s),r.value=[],c.value=!0}finally{_.value=!1}},b=a=>{e.index.__f__("log","at pages/tabbar/page/components/home.vue:216","跳转到服务详情页面，服务信息:",a),e.index.navigateTo({url:`/subPackages/friend/fr_detail?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${i.value.application_id||15}&level_order=${i.value.level_order||""}&nickname=${i.value.nickname||""}&service_name=${encodeURIComponent(a.service_name)}&service_image_url=${encodeURIComponent(a.service_image_url)}&price=${a.price||0}&unit=${a.unit||"小时"}&service_tags=${encodeURIComponent(JSON.stringify(a.service_tags||[]))}`})},v=e.ref(!1),u=e.ref(!1),y=async()=>{if(!u.value){u.value=!0,v.value=!0;try{n.cityList.length===0&&(e.index.__f__("log","at pages/tabbar/page/components/home.vue:239","城市列表为空，重新加载城市列表"),await n.loadCityList()),e.index.__f__("log","at pages/tabbar/page/components/home.vue:244","下拉刷新服务数据"),await l(),await new Promise(a=>setTimeout(a,800))}catch(a){e.index.__f__("error","at pages/tabbar/page/components/home.vue:249","刷新失败:",a)}finally{v.value=!1,u.value=!1}}},C=()=>{v.value=!1,u.value=!1},p=e.ref(!1);function x(a){n.cityIndex!==a&&(e.index.__f__("log","at pages/tabbar/page/components/home.vue:271",`手动选择城市: ${n.cityList[a].name}`),l())}return m({refreshCurrentTab:async()=>{e.index.__f__("log","at pages/tabbar/page/components/home.vue:278","Home组件刷新方法被调用");try{return n.cityList.length===0&&(e.index.__f__("log","at pages/tabbar/page/components/home.vue:283","城市列表为空，重新加载城市列表"),await n.loadCityList()),e.index.__f__("log","at pages/tabbar/page/components/home.vue:288","刷新服务数据"),await l(),!0}catch(a){throw e.index.__f__("error","at pages/tabbar/page/components/home.vue:293","Home组件刷新失败:",a),a}}}),(a,s)=>e.e({a:e.o(t=>p.value=!0),b:d.value+"px",c:_.value},_.value?{}:r.value.length>0?{e:e.f(r.value,(t,o,H)=>({a:a.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,(g,T,B)=>({a:e.t(g),b:g})),d:e.t(t.price||0),e:e.t(t.unit||"小时"),f:t.service_id,g:e.o(g=>b(t),t.service_id)}))}:c.value&&r.value.length===0?{g:w._imports_3}:{},{d:r.value.length>0,f:c.value&&r.value.length===0,h:e.o(y),i:e.o(C),j:e.o(x),k:e.o(t=>p.value=t),l:e.p({visible:p.value})})}},q=e._export_sfc(R,[["__scopeId","data-v-53c08f20"]]);wx.createComponent(q);
//# sourceMappingURL=../../../../../.sourcemap/mp-weixin/pages/tabbar/page/components/home.js.map

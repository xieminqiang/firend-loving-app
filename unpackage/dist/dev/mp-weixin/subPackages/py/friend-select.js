"use strict";const e=require("../../common/vendor.js"),l=require("../../common/assets.js"),A=require("../../api/friends.js");require("../../config/http.js");const K=require("../../stores/level.js"),Q=require("../../stores/city.js"),R=require("../../stores/user.js");Array||e.resolveComponent("uni-popup")();const V=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(X+Z+V)();const X=()=>"../../components/common/CitySelector.js",Z=()=>"../../components/common/CityPicker.js",ee={__name:"friend-select",setup(D){const B=e.ref(0);e.ref(null);const L=e.ref(0),p=e.ref(""),C=e.ref(!1),S=e.ref(!1),d=e.ref(""),_=e.computed(()=>{var a;return((a=u.userLocation)==null?void 0:a.latitude)||null}),g=e.computed(()=>{var a;return((a=u.userLocation)==null?void 0:a.longitude)||null});e.ref(!1);const u=Q.useCityStore(),y=R.useUserStore(),q=e.computed(()=>y.userInfo&&Object.keys(y.userInfo).length>0);e.computed(()=>{if(q.value)return y.userInfo});const z=()=>{e.index.navigateTo({url:"/subPackages/login/index"})};e.computed(()=>u.cityList),e.computed(()=>u.currentCity);const c=e.ref([]),m=e.ref(0),w=e.ref(1),M=e.ref(20),f=e.ref(!1),j=e.ref(!0),h=e.ref(!1),O=K.useLevelStore(),P=e.computed(function(){return c.value.map(function(a){const o=a.tags?a.tags.slice(0,3):[],t=a.tags&&a.tags.length>3?a.tags.length-3:0;return{...a,visibleTags:o,extraTags:t}})}),T=e.ref(null),v=e.ref([]),x=e.ref(null),U=e.ref(0),F=async a=>{x.value=a;try{const o={city_code:u.currentCityCode,application_id:a.id};_.value&&g.value&&(o.latitude=parseFloat(_.value),o.longitude=parseFloat(g.value));const t=await A.getCityServices(o);if(t.data&&t.data.code===0){const s=t.data.data;s&&s.services&&s.services.length>0?v.value=s.services:v.value=[]}else v.value=[]}catch(o){e.index.__f__("error","at subPackages/py/friend-select.vue:259","获取服务信息失败:",o),v.value=[]}T.value.open()},I=()=>{T.value.close()},H=a=>{if(e.index.__f__("log","at subPackages/py/friend-select.vue:273","选择服务:",a),I(),!q.value){e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),z();return}let o=`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${x.value.id}&level_order=${x.value.level_order||""}&nickname=${x.value.name}`;d.value&&(o+=`&original_service_id=${d.value}`),e.index.navigateTo({url:o})},J=a=>{let o="/subPackages/py/detail?id="+a+"&city_code="+u.currentCityCode;_.value&&g.value&&(o+="&latitude="+_.value+"&longitude="+g.value),e.index.navigateTo({url:o})},k=async(a=!1)=>{var o;if(!f.value){f.value=!0;try{const t={page:a?1:w.value,page_size:M.value};u.currentCityCode&&(t.city_code=u.currentCityCode),p.value&&p.value.trim()&&(t.nickname=p.value.trim()),_.value&&g.value&&(t.latitude=_.value,t.longitude=g.value),d.value&&(t.service_id=d.value),e.index.__f__("log","at subPackages/py/friend-select.vue:397","搜索参数:",t);const s=await A.searchCompanions(t);if(e.index.__f__("log","at subPackages/py/friend-select.vue:401","API完整响应:",s),s.data&&s.data.code===0){const i=s.data.data;if(i&&i.list){const r=i.list.map(n=>({id:n.id,name:n.nickname,gender:n.gender,age:n.age,height:n.height,weight:n.weight,distance:n.distance,tags:n.tags||[],services:(()=>{if(typeof n.services=="string")try{return JSON.parse(n.services)}catch($){return e.index.__f__("error","at subPackages/py/friend-select.vue:420","解析services JSON失败:",$),[]}return n.services||[]})(),avatar:n.avatar,online:n.is_online===1,bookable:n.can_accept_orders==="Y"}));a?(c.value=r,w.value=1):(c.value=[...c.value,...r],w.value++),m.value=i.total||0,j.value=r.length===M.value,e.index.__f__("log","at subPackages/py/friend-select.vue:442","搜索成功，共获取",r.length,"条数据，总数:",m.value),r.length}else e.index.__f__("log","at subPackages/py/friend-select.vue:453","API返回数据为空"),a&&(c.value=[],m.value=0)}else{e.index.__f__("error","at subPackages/py/friend-select.vue:461","API返回错误:",s.data);const i=((o=s.data)==null?void 0:o.message)||"搜索失败";e.index.showToast({title:i,icon:"none",duration:2e3}),a&&(c.value=[],m.value=0)}}catch(t){e.index.__f__("error","at subPackages/py/friend-select.vue:475","搜索伴友师失败:",t),e.index.__f__("error","at subPackages/py/friend-select.vue:476","错误详情:",t.response||t);let s="搜索失败，请重试";t.response&&t.response.data&&(s=t.response.data.message||s),e.index.showToast({title:s,icon:"none",duration:2e3}),a&&(c.value=[],m.value=0)}finally{f.value=!1,h.value=!0}}},N=()=>{!f.value&&j.value&&k(!1)},W=async()=>{C.value=!0,await k(!0),await new Promise(a=>setTimeout(a,800)),C.value=!1},E=()=>{clearTimeout(b),b=setTimeout(()=>{k(!0)},500)};let b=null;const Y=()=>{e.index.navigateBack({delta:1})},G=async a=>{e.index.vibrateShort({type:"light"}),await k(!0)};return e.onMounted(async()=>{const a=getCurrentPages(),t=a[a.length-1].options||{};t.service_id&&(d.value=t.service_id,e.index.__f__("log","at subPackages/py/friend-select.vue:556","接收到的服务ID:",d.value));const s=e.index.getSystemInfoSync();B.value=s.statusBarHeight;const i=e.index.getMenuButtonBoundingClientRect();i.value=i;const r=s.screenWidth,n=i.right;L.value=r-n+24,await O.fetchServiceLevels(),await u.initCityData(),await k(!0)}),e.onUnmounted(()=>{b&&clearTimeout(b)}),(a,o)=>e.e({a:e.unref(y).switch==1},e.unref(y).switch==1?e.e({b:l._imports_0$7,c:e.o(Y),d:e.o(t=>S.value=!0),e:l._imports_0$8,f:e.o([t=>p.value=t.detail.value,E]),g:p.value,h:L.value+"px",i:B.value+"px",j:f.value&&!h.value},f.value&&!h.value?{}:P.value.length>0?{l:e.f(P.value,(t,s,i)=>e.e({a:t.avatar,b:t.online},t.online?{}:{},{c:e.t(t.name),d:t.gender==="女"},t.gender==="女"?{e:l._imports_3$2}:{f:l._imports_4},{g:e.t(t.age),h:e.t(t.height),i:e.t(t.weight),j:e.t(t.distance),k:e.f(t.visibleTags,(r,n,$)=>({a:e.t(r),b:n})),l:t.extraTags>0},t.extraTags>0?{m:e.t(t.extraTags)}:{},{n:e.o(r=>F(t),t.id),o:t.id,p:e.o(r=>J(t.id),t.id)})),m:l._imports_5}:h.value&&P.value.length===0?{o:l._imports_3}:{},{k:P.value.length>0,n:h.value&&P.value.length===0,p:e.o(N),q:C.value,r:e.o(W),s:e.o(G),t:e.o(t=>S.value=t),v:e.p({visible:S.value}),w:l._imports_7,x:e.o(I),y:v.value.length>0},v.value.length>0?{z:e.f(v.value,(t,s,i)=>({a:a.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,(r,n,$)=>({a:e.t(r),b:r})),d:e.t(t.price),e:e.t(t.unit||"小时"),f:e.o(r=>H(t),t.title),g:t.title}))}:{A:l._imports_3},{B:U.value,C:e.sr(T,"8ed11476-2",{k:"servicePopup"}),D:e.o(I),E:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})}):{})}},te=e._export_sfc(ee,[["__scopeId","data-v-8ed11476"]]);wx.createPage(te);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/py/friend-select.js.map

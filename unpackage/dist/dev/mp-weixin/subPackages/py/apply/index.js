"use strict";const e=require("../../../common/vendor.js"),I=require("../../../common/assets.js"),M=require("../../../api/user.js"),ge=require("../../../api/home.js"),E=require("../../../api/file.js"),pe=require("../../../stores/user.js"),O=5*60*1e3,fe={__name:"index",setup(he){const j=pe.useUserStore(),{proxy:L}=e.getCurrentInstance();e.ref(!1);const w=e.ref(!1),_=e.ref(!1),l=e.reactive({nickname:"",gender:"",age:"",height:"",weight:"",city:"深圳市"}),b=e.ref(!1),o=e.ref([]),r=e.ref([]),h=e.ref([]),P=e.ref(!1),v=e.ref([]),x=e.ref([]),y=e.ref([]),T=e.ref(!1),g=e.ref([]),c=e.ref([]),k=e.ref(!1),d=e.ref([]),p=e.ref(!1),z=e.ref(4),m=e.ref([]),$=e.ref(new Map),B=e.ref(new Map),N=e.ref([{type:4,name:"个性特质"},{type:5,name:"我的爱好"},{type:6,name:"外貌风格"},{type:7,name:"专业技能"},{type:8,name:"热门推荐"}]),R=async()=>{if(o.value.length===0){x.value=[],g.value=[];return}T.value=!0;try{const t=o.value.map(a=>{const s=h.value.find(i=>i.name===a);return s?s.code:null}).filter(a=>a!==null);if(t.length===0){e.index.__f__("warn","at subPackages/py/apply/index.vue:511","未找到有效的城市代码"),x.value=[],g.value=[];return}const n=await M.getServicesByCities(t);n.data&&n.data.code===0&&n.data.data?(x.value=n.data.data,G(),e.index.__f__("log","at subPackages/py/apply/index.vue:525","服务技能列表加载成功:",x.value),e.index.__f__("log","at subPackages/py/apply/index.vue:526","服务技能分组:",g.value)):(e.index.__f__("warn","at subPackages/py/apply/index.vue:528","获取服务技能列表失败"),x.value=[],g.value=[])}catch(t){e.index.__f__("error","at subPackages/py/apply/index.vue:533","获取服务技能列表失败:",t),x.value=[],g.value=[]}finally{T.value=!1}},G=()=>{const t={};x.value.forEach(n=>{const a=n.category,s=n.category_name||"其他";t[a]||(t[a]={id:a,name:s,services:[]}),t[a].services.push(n)}),g.value=Object.values(t).sort((n,a)=>n.id-a.id)},V=async()=>{P.value=!0;try{const t=await ge.getCityList();t.data&&t.data.code===0&&t.data.data?(h.value=t.data.data.map(n=>({name:n.name,code:n.city_code})),e.index.__f__("log","at subPackages/py/apply/index.vue:578","申请页面区域列表加载成功:",h.value)):(e.index.__f__("warn","at subPackages/py/apply/index.vue:580","获取区域列表失败"),h.value=[])}catch(t){e.index.__f__("error","at subPackages/py/apply/index.vue:584","获取区域列表失败:",t),h.value=[]}finally{P.value=!1}},A=t=>{l.gender=t},H=()=>{r.value=[...o.value],b.value=!0},q=()=>{r.value=[],b.value=!1},J=t=>{const n=r.value.indexOf(t);n>-1?r.value.splice(n,1):r.value.push(t),e.index.vibrateShort({type:"light"})},K=t=>{const n=o.value.indexOf(t);n>-1&&(o.value.splice(n,1),e.index.vibrateShort({type:"light"}))},Q=async()=>{if(r.value.length===0){e.index.showToast({title:"请至少选择一个服务区域",icon:"none"});return}o.value=[...r.value],l.city=o.value[0],b.value=!1,r.value=[],y.value=[],g.value=[],await R()},W=()=>{const t=6-v.value.length;if(t<=0){e.index.showToast({title:"最多只能上传6张照片",icon:"none"});return}e.index.chooseImage({count:t,sizeType:["compressed"],sourceType:["album","camera"],success:async n=>{e.index.showLoading({title:"上传中...",mask:!0});try{const a=n.tempFilePaths.map(async(i,u)=>{try{const f=await X(i);if(e.index.__f__("log","at subPackages/py/apply/index.vue:699","fileInfo",f),e.index.__f__("log","at subPackages/py/apply/index.vue:700","filePath",i),!f||!f.extension)throw new Error("无法获取文件信息");const U=await E.uploadFile({filePath:i,name:`photo_${Date.now()}_${u}.${f.extension}`}),S=E.getUploadResult(U);if(!S||!S.url)throw new Error("上传结果解析失败");return S.url}catch(f){throw e.index.__f__("error","at subPackages/py/apply/index.vue:719",`第${u+1}张照片上传失败:`,f),f}}),s=await Promise.all(a);v.value.push(...s),e.index.showToast({title:`成功上传${s.length}张照片`,icon:"success"})}catch(a){e.index.__f__("error","at subPackages/py/apply/index.vue:736","照片上传失败:",a),e.index.showToast({title:"照片上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:n=>{e.index.__f__("error","at subPackages/py/apply/index.vue:746","选择照片失败:",n),e.index.showToast({title:"选择照片失败",icon:"none"})}})},X=t=>new Promise((n,a)=>{e.index.getFileInfo({filePath:t,success:s=>{const i=t.split(".").pop().toLowerCase();n({size:s.size,extension:i})},fail:s=>{e.index.__f__("error","at subPackages/py/apply/index.vue:769","获取文件信息失败:",s);const i=t.split(".").pop().toLowerCase()||"jpg";n({size:0,extension:i})}})}),Y=t=>{e.index.previewImage({urls:v.value.map(n=>L.$imgBaseUrl+n),current:L.$imgBaseUrl+v.value[t],indicator:"number",loop:!0,show:!0,success:function(n){e.index.__f__("log","at subPackages/py/apply/index.vue:790","图片预览成功",n)},fail:function(n){e.index.__f__("error","at subPackages/py/apply/index.vue:793","图片预览失败",n)}})},Z=t=>{v.value.splice(t,1)},ee=t=>{const n=t.id,a=y.value.indexOf(n);a>-1?y.value.splice(a,1):y.value.push(n),e.index.vibrateShort({type:"light"})},ae=()=>{_.value=!_.value,e.index.vibrateShort({type:"light"})},te=()=>{e.index.navigateTo({url:"/subPackages/login/rz-agreement"})},ne=async()=>{if(w.value)return;if(!_.value){e.index.showToast({title:"请先同意友伴服务协议",icon:"none",duration:2e3});return}if(!l.nickname.trim()){e.index.showToast({title:"请输入昵称",icon:"none"});return}if(l.nickname.length>50){e.index.showToast({title:"昵称不能超过50个字符",icon:"none"});return}if(!l.gender){e.index.showToast({title:"请选择性别",icon:"none"});return}const t=parseInt(l.age),n=parseInt(l.height),a=parseInt(l.weight);if(!t||t<18||t>65){e.index.showToast({title:"年龄必须在18-65岁之间",icon:"none"});return}if(!n||n<100||n>250){e.index.showToast({title:"身高必须在100-250cm之间",icon:"none"});return}if(!a||a<30||a>200){e.index.showToast({title:"请输入合理的体重",icon:"none"});return}if(o.value.length===0){e.index.showToast({title:"请至少选择一个服务区域",icon:"none"});return}if(v.value.length===0){e.index.showToast({title:"请上传至少一张生活照",icon:"none"});return}if(v.value.length>9){e.index.showToast({title:"最多只能上传9张照片",icon:"none"});return}if(y.value.length===0){e.index.showToast({title:"请至少选择一项服务技能",icon:"none"});return}e.index.showModal({title:"确认提交",content:"确定要提交入驻申请吗？提交后将进入审核流程。",success:async s=>{s.confirm&&await se()}})},se=async()=>{w.value=!0;try{const t=o.value.map(s=>{const i=h.value.find(u=>u.name===s);return i?String(i.code):null}).filter(s=>s!==null);if(t.length===0){e.index.showToast({title:"服务区域数据异常，请重新选择",icon:"none"});return}const n={nickname:l.nickname.trim(),gender:l.gender==="male"?"男":"女",age:parseInt(l.age),height:parseInt(l.height),weight:parseInt(l.weight),service_areas:t,services:y.value,can_accept_orders:"N",photos:v.value,tags:c.value.map(s=>s.tag_name),phone:j.userInfo.phone||""};e.index.__f__("log","at subPackages/py/apply/index.vue:983","提交数据:",n);const a=await M.createCompanionApplication(n);if(e.index.__f__("log","at subPackages/py/apply/index.vue:988","接口响应:",a),a&&a.data&&a.data.code===0)e.index.showModal({title:"入驻成功 🎉",content:"恭喜您！入驻申请已通过，您已成功成为友伴师。",showCancel:!1,confirmText:"我知道了",success:()=>{e.index.$emit("applicationStatusChanged",{status:"approved",message:"入驻申请已通过"}),e.index.navigateBack()}});else{const s=a&&a.data&&a.data.message||"提交失败，请稍后重试";e.index.showModal({title:"提交失败",content:s,showCancel:!1,confirmText:"我知道了"})}}catch(t){e.index.__f__("error","at subPackages/py/apply/index.vue:1025","提交失败:",t);let n="提交失败，请稍后重试";t&&t.message&&(t.message.includes("网络")?n="网络连接异常，请检查网络后重试":t.message.includes("参数")?n="提交信息有误，请检查后重试":t.message.includes("重复")?n="您已提交过申请，请勿重复提交":n=t.message),e.index.showModal({title:"提交失败",content:n,showCancel:!1,confirmText:"我知道了"})}finally{w.value=!1}};e.onMounted(async()=>{await V(),e.index.__f__("log","at subPackages/py/apply/index.vue:1058","标签缓存配置:",{expireTime:`${O/1e3/60}分钟`,cacheSize:$.value.size})});const le=()=>{d.value=[...c.value],k.value=!0,F(4)},D=()=>{d.value=[],k.value=!1},ie=t=>{z.value=t,F(t)},oe=t=>{const n=B.value.get(t);return n?Date.now()-n<O:!1},ue=t=>$.value.get(t)||[],re=(t,n)=>{$.value.set(t,n),B.value.set(t,Date.now()),e.index.__f__("log","at subPackages/py/apply/index.vue:1106",`标签类型${t}已缓存，数据量: ${n.length}`)},F=async(t,n=!1)=>{if(!n&&oe(t)){const a=ue(t);if(a.length>0){e.index.__f__("log","at subPackages/py/apply/index.vue:1131",`使用缓存数据 - 标签类型${t}，数据量: ${a.length}`),m.value=a;return}}p.value=!0;try{e.index.__f__("log","at subPackages/py/apply/index.vue:1139",`开始加载标签类型: ${t}`);const a={tag_type:t,page:1,pageSize:60};e.index.__f__("log","at subPackages/py/apply/index.vue:1147","请求参数:",a);const s=await M.getPersonalityTags(a);if(e.index.__f__("log","at subPackages/py/apply/index.vue:1150","API响应:",s),s.data&&s.data.code===0&&s.data.data){const i=s.data.data.list||s.data.data;m.value=i,re(t,i),e.index.__f__("log","at subPackages/py/apply/index.vue:1160",`标签类型${t}加载成功:`,i)}else e.index.__f__("warn","at subPackages/py/apply/index.vue:1162",`获取标签类型${t}失败，响应数据:`,s),m.value=[]}catch(a){e.index.__f__("error","at subPackages/py/apply/index.vue:1166",`获取标签类型${t}失败:`,a),e.index.__f__("error","at subPackages/py/apply/index.vue:1167","错误详情:",a.response||a),m.value=[]}finally{p.value=!1}},C=t=>d.value.some(n=>n.id===t),ce=t=>{const n=d.value.findIndex(a=>a.id===t.id);if(n>-1)d.value.splice(n,1);else{if(d.value.length>=5){e.index.showToast({title:"最多只能选择5个标签",icon:"none"});return}d.value.push(t)}e.index.vibrateShort({type:"light"})},de=()=>{c.value=[...d.value],k.value=!1,d.value=[],e.index.showToast({title:`已选择${c.value.length}个标签`,icon:"success"})},ve=t=>{const n=c.value.findIndex(a=>a.id===t.id);n>-1&&(c.value.splice(n,1),e.index.vibrateShort({type:"light"}))};return(t,n)=>e.e({a:l.nickname,b:e.o(a=>l.nickname=a.detail.value),c:I._imports_4,d:l.gender==="male"?1:"",e:e.o(a=>A("male")),f:I._imports_3$2,g:l.gender==="female"?1:"",h:e.o(a=>A("female")),i:l.age,j:e.o(a=>l.age=a.detail.value),k:l.height,l:e.o(a=>l.height=a.detail.value),m:l.weight,n:e.o(a=>l.weight=a.detail.value),o:o.value.length===0},o.value.length===0?{}:{p:e.t(o.value.length)},{q:e.o(H),r:o.value.length>0},o.value.length>0?{s:e.f(o.value,(a,s,i)=>({a:e.t(a),b:a,c:e.o(u=>K(a),a)}))}:{},{t:e.f(v.value,(a,s,i)=>({a:t.$imgBaseUrl+a,b:e.o(u=>Z(s),s),c:s,d:e.o(u=>Y(s),s)})),v:v.value.length<6},v.value.length<6?{w:I._imports_0$4,x:e.o(W)}:{},{y:T.value},T.value?{}:o.value.length===0?{}:g.value.length>0?{B:e.f(g.value,(a,s,i)=>({a:e.t(a.name),b:e.f(a.services,(u,f,U)=>({a:e.t(u.name),b:y.value.includes(u.id)?1:"",c:u.id,d:e.o(S=>ee(u),u.id)})),c:a.id}))}:{},{z:o.value.length===0,A:g.value.length>0,C:c.value.length>0},c.value.length>0?{D:e.f(c.value,(a,s,i)=>({a:e.t(a.tag_name),b:a.id,c:e.o(u=>ve(a),a.id)}))}:{},{E:e.t(c.value.length),F:c.value.length>=5?1:"",G:e.o(a=>c.value.length<5?le():null),H:_.value},_.value?{}:{},{I:_.value?1:"",J:e.o(te),K:e.o(ae),L:!w.value},w.value?{}:{},{M:w.value||!_.value?1:"",N:e.o(ne),O:b.value},b.value?e.e({P:e.o(q),Q:P.value},P.value?{}:{R:e.f(h.value,(a,s,i)=>e.e({a:e.t(a.name),b:r.value.includes(a.name)},r.value.includes(a.name)?{}:{},{c:s,d:e.n({active:r.value.includes(a.name)}),e:e.o(u=>J(a.name),s)}))},{S:e.t(r.value.length),T:e.o(Q),U:e.o(()=>{}),V:e.o(q)}):{},{W:k.value},k.value?e.e({X:e.o(D),Y:e.f(N.value,(a,s,i)=>({a:e.t(a.name),b:a.type,c:e.n({active:z.value===a.type}),d:e.o(u=>ie(a.type),a.type)})),Z:!p.value&&d.value.length>=5},!p.value&&d.value.length>=5?{}:{},{aa:p.value},p.value?{}:{ab:e.f(m.value,(a,s,i)=>e.e({a:e.t(a.tag_name),b:C(a.id)},C(a.id)?{}:{},{c:a.id,d:e.n({selected:C(a.id)}),e:e.o(u=>ce(a),a.id)}))},{ac:!p.value&&m.value.length===0},!p.value&&m.value.length===0?{}:{},{ad:e.t(d.value.length),ae:e.o(de),af:e.o(()=>{}),ag:e.o(D)}):{})}},_e=e._export_sfc(fe,[["__scopeId","data-v-80f15022"]]);wx.createPage(_e);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/py/apply/index.js.map

"use strict";const e=require("../../../common/vendor.js"),W=require("../../../common/assets.js"),x=require("../utils/location.js"),C=require("../../../api/user.js"),h=require("../../../api/order.js"),D=require("../utils/address.js");Math||pe();const pe=()=>"./VideoUploadModal.js",_e={__name:"Workbench",props:{applicationInfo:{type:Object,default:null}},setup(u){const o=u,c=e.ref(!1),p=e.ref(""),f=e.ref(""),T=e.ref(!1),I=e.ref(!1),S=e.ref(!1),m=e.ref([]),k=e.ref(!1),v=e.ref([]),L=e.ref(!1),b=e.ref(!1),g=e.computed(()=>o.applicationInfo&&typeof o.applicationInfo=="object"),w=()=>!m.value||m.value.length===0?null:m.value.find(n=>n.is_today===!0),$=()=>{const t=w();return!t||!t.schedule?0:Object.values(t.schedule).filter(n=>n===1).length},M=()=>{const t=w();return!t||!t.schedule?0:Object.values(t.schedule).filter(n=>n===3).length},j=e.computed(()=>{if(k.value)return"加载中...";if(!w())return"未设置";const n=$(),a=M();return a>0?`${a}个已约`:n===48?"全天可约":n===0?"全天休息":`${n}个可约`}),N=e.computed(()=>{if(k.value)return"正在加载今日安排...";if(!w())return"今日未设置时间安排";const n=$(),a=M();return a>0?`今日有${a}个时间点已被预约`:n===48?"今日全天可接单":n===0?"今日休息，暂停接单":`今日可接单 ${n}个时间点`}),O=()=>{g.value&&typeof o.applicationInfo.is_online<"u"?(c.value=o.applicationInfo.is_online===1,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:326","从applicationInfo获取在线状态:",c.value,"原始值:",o.applicationInfo.is_online)):(c.value=!1,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:329","使用默认在线状态: 下线"))},A=async()=>{if(T.value){e.index.__f__("log","at subPackages/partner/components/Workbench.vue:336","组件已经初始化过，跳过重复初始化");return}e.index.__f__("log","at subPackages/partner/components/Workbench.vue:340","开始初始化Workbench组件"),await e.nextTick$1(),O(),V(),await P(),await l(),T.value=!0,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:358","Workbench组件初始化完成")};e.watch(()=>o.applicationInfo,(t,n)=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:363","applicationInfo发生变化:",{old:n,new:t}),t&&g.value&&(T.value?(e.index.__f__("log","at subPackages/partner/components/Workbench.vue:368","组件已初始化，更新在线状态、日期安排数据和最近订单数据"),O(),P(),l()):A())},{immediate:!0,deep:!0});const E=async()=>{if(I.value){e.index.__f__("log","at subPackages/partner/components/Workbench.vue:382","正在更新状态，忽略重复点击");return}const t=!c.value,n=t?"上线":"下线";if(t&&g.value&&o.applicationInfo.can_accept_orders==="N"&&(!o.applicationInfo.intro_video_url||o.applicationInfo.video_review_status!=="approved")){S.value=!0;return}e.index.showModal({title:`确认${n}`,content:t?"上线后将开始接收订单，确认上线吗？":"下线后将停止接收订单，确认下线吗？",success:async a=>{a.confirm&&await R(t)}})},R=async t=>{var n;I.value=!0;try{let a=null;if(t){e.index.showLoading({title:"获取位置中..."});try{a=await x.getCurrentLocationAddress(!1),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:424","获取位置成功:",a)}catch(i){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:426","获取位置失败:",i),e.index.hideLoading(),e.index.showToast({title:"获取位置失败，无法上线",icon:"none"});return}}else{const i=x.getCacheStatus();i.hasCache&&(a={latitude:i.coordinates.latitude,longitude:i.coordinates.longitude,address:i.address})}const r=D.processAddress(a?a.address:""),d={is_online:t?1:0,latitude:a?a.latitude:null,longitude:a?a.longitude:null,location_text:r};e.index.__f__("log","at subPackages/partner/components/Workbench.vue:458","准备更新在线状态:",d);const s=await C.updateCompanionOnlineStatus(d);e.index.__f__("log","at subPackages/partner/components/Workbench.vue:463","在线",s),s.data&&s.data.code===0?(c.value=t,a&&(p.value=a.address,f.value=new Date().toLocaleTimeString()),e.index.hideLoading(),e.index.showToast({title:t?"已上线，开始接单":"已下线，暂停接单",icon:"none"}),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:480","在线状态更新成功:",s.data)):(e.index.hideLoading(),e.index.showToast({title:((n=s.data)==null?void 0:n.msg)||"状态更新失败",icon:"none"}),e.index.__f__("error","at subPackages/partner/components/Workbench.vue:488","在线状态更新失败:",s.data))}catch(a){e.index.hideLoading(),e.index.showToast({title:"网络错误，请重试",icon:"none"}),e.index.__f__("error","at subPackages/partner/components/Workbench.vue:496","更新在线状态失败:",a)}finally{I.value=!1}},V=()=>{const t=x.getCacheStatus();if(t.hasCache&&t.isValid){p.value=t.address,f.value=new Date(t.timestamp).toLocaleTimeString(),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:510","使用缓存位置信息:",t.address),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:511","使用缓存:",t),y(t.coordinates.latitude,t.coordinates.longitude,t.address);return}x.getCurrentLocationAddress(!1).then(n=>{p.value=n.address,f.value=new Date().toLocaleTimeString(),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:521","获取位置成功",n),y(n.latitude,n.longitude,n.address)}).catch(n=>{e.index.__f__("error","at subPackages/partner/components/Workbench.vue:527","获取位置失败:",n),p.value="位置获取失败",f.value="获取失败"})},z=()=>{e.index.showLoading({title:"更新位置中"}),x.getCurrentLocationAddress(!1).then(t=>{p.value=t.address,f.value=new Date().toLocaleTimeString(),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:545","位置更新成功",t),e.index.hideLoading(),e.index.showToast({title:"位置更新成功",icon:"none"}),y(t.latitude,t.longitude,t.address)}).catch(t=>{e.index.hideLoading(),e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/partner/components/Workbench.vue:563","获取位置失败:",t)})},y=async(t,n,a)=>{var r;try{const d=D.processAddress(a),s={is_online:c.value?1:0,latitude:t,longitude:n,location_text:d};e.index.__f__("log","at subPackages/partner/components/Workbench.vue:581","准备更新位置信息到服务器:",s),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:582","位置描述分析:",D.analyzeAddress(a));const i=await C.updateCompanionOnlineStatus(s);i.data&&i.data.code===0?e.index.__f__("log","at subPackages/partner/components/Workbench.vue:587","位置信息更新成功:",i.data):e.index.__f__("error","at subPackages/partner/components/Workbench.vue:589","位置信息更新失败:",(r=i.data)==null?void 0:r.msg)}catch(d){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:592","位置信息更新API调用失败:",d)}},B=()=>{e.index.chooseLocation({success:async t=>{const n=t.address||t.name||"已选择位置";e.index.__f__("log","at subPackages/partner/components/Workbench.vue:602","手动选择位置",t),p.value=n,f.value=new Date().toLocaleTimeString(),await y(t.latitude,t.longitude,n)},fail:t=>{t.errMsg&&t.errMsg.indexOf("cancel")===-1&&(e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/partner/components/Workbench.vue:617","获取位置失败:",t.errMsg))}})},F=()=>{if(!o.applicationInfo||!o.applicationInfo.id){e.index.showToast({title:"用户信息不完整",icon:"none"});return}e.index.navigateTo({url:`/subPackages/partner/order/index?companion_id=${o.applicationInfo.id}`})},H=t=>{e.index.navigateTo({url:`/subPackages/partner/order/detail?orderId=${t}&companion_id=${o.applicationInfo.id}`})},Y=t=>{t.user_latitude&&t.user_longitude?e.index.openLocation({latitude:Number(t.user_latitude),longitude:Number(t.user_longitude),address:t.service_address}):e.index.showToast({title:"暂无位置信息",icon:"none"})},G=t=>({2:[{text:"拒绝",action:"reject",type:"secondary"},{text:"接单",action:"accept",type:"primary"}],3:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已到达服务地点",action:"arrived",type:"primary"}],4:[{text:"电话联系",action:"call",type:"secondary"}],5:[{text:"电话联系",action:"contact",type:"secondary"},{text:"结束服务",action:"end",type:"primary"}],11:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已出发",action:"depart",type:"depart"}]})[t]||[],J=(t,n)=>{switch(t){case"contact":K(n);break;case"accept":Q(n);break;case"reject":X(n);break;case"arrived":Z(n);break;case"depart":te(n);break;case"call":ee(n);break;case"end":ae(n);break}},K=t=>{t.user&&t.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${t.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:t.user.phone})}})},Q=t=>{e.index.showModal({title:"确认接单",content:"确定要接受这个订单吗？",confirmText:"接单",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const a=await h.acceptCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"接单成功",icon:"success"}),await l();else throw new Error(a.data.msg||"接单失败")}catch(a){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:772","接单失败:",a),e.index.showToast({title:a.message||"接单失败",icon:"none"})}finally{e.index.hideLoading()}}})},X=t=>{e.index.showModal({title:"拒绝订单",content:"确定要拒绝这个订单吗？",confirmText:"拒绝",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const a=await h.rejectCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"已拒绝订单",icon:"success"}),await l();else throw new Error(a.data.msg||"拒绝订单失败")}catch(a){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:816","拒绝订单失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},Z=t=>{e.index.showModal({title:"确认到达",content:"确认您已到达服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const a=await h.arrivedCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"已确认到达",icon:"success"}),await l();else throw new Error(a.data.msg||"确认到达失败")}catch(a){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:860","确认到达失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ee=t=>{t.user&&t.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${t.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:t.user.phone})}})},te=t=>{e.index.showModal({title:"确认出发",content:"确认您已开始出发前往服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const a=await h.departCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"已确认出发",icon:"success"}),await l();else throw new Error(a.data.msg||"确认出发失败")}catch(a){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:923","确认出发失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ae=t=>{e.index.showModal({title:"结束服务",content:"确定要结束服务吗？",confirmText:"结束",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const a=await h.endCompanionService({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"服务已结束",icon:"success"}),await l();else throw new Error(a.data.msg||"结束服务失败")}catch(a){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:967","结束服务失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ne=()=>{S.value=!1},oe=t=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:987","视频上传成功:",t),e.index.$emit("applicationStatusChanged",t)},P=async()=>{var t;if(!g.value||!o.applicationInfo.id){e.index.__f__("log","at subPackages/partner/components/Workbench.vue:995","applicationInfo不完整，跳过获取日期安排数据");return}try{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1002","开始获取日期安排数据，companion_id:",o.applicationInfo.id);const n={companion_id:o.applicationInfo.id},a=await C.getCompanionSchedule(n);e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1009","日期安排数据获取成功:",a),a.data&&a.data.code===0?(m.value=a.data.data,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1013","解析后的日期安排数据:",m.value)):e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1015","获取日期安排数据失败:",(t=a.data)==null?void 0:t.msg)}catch(n){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1018","获取日期安排数据接口调用失败:",n)}finally{k.value=!1}},l=async()=>{var t;if(!g.value||!o.applicationInfo.id){e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1027","applicationInfo不完整，跳过获取最近订单数据");return}try{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1033","开始获取最近订单数据，companion_id:",o.applicationInfo.id);const n={companion_id:Number(o.applicationInfo.id),page:1,page_size:10},a=await h.getCompanionActiveOrders(n);e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1040","最近订单数据获取成功:",a),a.data&&a.data.code===0?(v.value=a.data.data.list,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1043","解析后的最近订单数据:",v.value)):e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1045","获取最近订单数据失败:",(t=a.data)==null?void 0:t.msg)}catch(n){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1048","获取最近订单数据接口调用失败:",n)}finally{L.value=!1}},se=()=>{if(!o.applicationInfo||!o.applicationInfo.id){e.index.showToast({title:"用户信息不完整",icon:"none"});return}e.index.navigateTo({url:`/subPackages/partner/components/DataSelect?companion_id=${o.applicationInfo.id}`})},ie=async()=>{if(!b.value){b.value=!0;try{await Promise.all([P(),l()]),await new Promise(t=>setTimeout(t,800))}catch(t){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1091","刷新失败:",t)}finally{b.value=!1}}},ce=()=>{b.value=!1},re=t=>({2:"等待接单",3:"我已出发",4:"已到达，等待开始服务",5:"服务中",11:"待服务"})[t]||"未知状态",de=t=>({2:"status-pending",3:"status-departing",4:"status-arrived",5:"status-serving",11:"status-departing"})[t]||"status-default",le=t=>{if(!t)return"";const n=new Date(t),a=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getDate()).padStart(2,"0"),d=String(n.getHours()).padStart(2,"0"),s=String(n.getMinutes()).padStart(2,"0");return`${a}-${r} ${d}:${s}`},ue=(t,n)=>{if(!t&&!n)return"待确认";let a="";if(t){const r=new Date(t),d=r.getFullYear(),s=String(r.getMonth()+1).padStart(2,"0"),i=String(r.getDate()).padStart(2,"0"),_=["周日","周一","周二","周三","周四","周五","周六"][r.getDay()];a+=`${d}-${s}-${i} ${_}`}return n&&(a&&(a+=" "),a+=n),a||"待确认"};e.onMounted(()=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1171","Workbench组件mounted，applicationInfo状态:",{hasApplicationInfo:!!o.applicationInfo,applicationInfo:o.applicationInfo}),g.value?A():e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1180","applicationInfo还未准备好，等待watch触发初始化"),e.index.$on("scheduleDataUpdated",q)}),e.onUnmounted(()=>{e.index.$off("scheduleDataUpdated",q)});const q=async t=>{var n;e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1194","收到日期安排数据更新事件:",t),t.companion_id===((n=o.applicationInfo)==null?void 0:n.id)&&(e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1198","刷新日期安排数据"),await P())};return(t,n)=>e.e({a:u.applicationInfo&&u.applicationInfo.avatar},u.applicationInfo&&u.applicationInfo.avatar?{b:t.$imgBaseUrl+u.applicationInfo.avatar}:{},{c:c.value?1:"",d:e.t(c.value?"已上线":"已下线"),e:e.t(c.value?"正在接单中":"暂停接单"),f:e.t(c.value?"下线休息":"开始上线"),g:c.value?1:"",h:e.o(E),i:c.value?1:"",j:W._imports_0$16,k:e.o(z),l:W._imports_1$7,m:e.o(B),n:e.t(p.value||"正在获取位置..."),o:W._imports_2$4,p:e.t(j.value),q:k.value?1:"",r:e.t(N.value),s:e.o(se),t:e.o(F),v:L.value},L.value?{}:v.value.length===0?{x:W._imports_3}:{y:e.f(v.value,(a,r,d)=>{var s,i;return e.e({a:e.t(le(a.created_at)),b:e.t(re(a.status)),c:e.n(de(a.status)),d:t.$imgBaseUrl+a.service_image_url,e:e.t(a.service_name),f:e.t(a.unit_price),g:e.t(a.unit),h:e.t(a.quantity),i:e.t(a.total_amount),j:[2,3,4,5,11].includes(a.status)},[2,3,4,5,11].includes(a.status)?e.e({k:a.user},a.user?{l:e.t((s=a==null?void 0:a.user)==null?void 0:s.nick_name),m:e.t((i=a==null?void 0:a.user)==null?void 0:i.phone)}:{},{n:e.t(a.service_address),o:e.o(_=>Y(a),a.id),p:e.t(ue(a.service_date,a.service_time))}):{},{q:e.f(G(a.status),(_,U,ge)=>({a:e.t(_.text),b:U,c:e.n(_.type),d:e.o(he=>J(_.action,a),U)})),r:a.id,s:e.o(_=>H(a.id),a.id)})})},{w:v.value.length===0,z:b.value,A:e.o(ie),B:e.o(ce),C:e.o(ne),D:e.o(oe),E:e.p({show:S.value,applicationInfo:u.applicationInfo})})}},fe=e._export_sfc(_e,[["__scopeId","data-v-89082ba0"]]);wx.createComponent(fe);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/partner/components/Workbench.js.map

"use strict";const e=require("../../../common/vendor.js"),W=require("../../../common/assets.js"),x=require("../utils/location.js"),C=require("../../../api/user.js"),h=require("../../../api/order.js"),D=require("../utils/address.js");Math||_e();const _e=()=>"./VideoUploadModal.js",fe={__name:"Workbench",props:{applicationInfo:{type:Object,default:null}},setup(l){const o=l,d=e.ref(!1),p=e.ref(""),f=e.ref(""),T=e.ref(!1),S=e.ref(!1),I=e.ref(!1),m=e.ref([]),k=e.ref(!1),b=e.ref([]),L=e.ref(!1),v=e.ref(!1),g=e.computed(()=>o.applicationInfo&&typeof o.applicationInfo=="object"),w=()=>!m.value||m.value.length===0?null:m.value.find(a=>a.is_today===!0),M=()=>{const t=w();return!t||!t.schedule?0:Object.values(t.schedule).filter(a=>a===1).length},$=()=>{const t=w();return!t||!t.schedule?0:Object.values(t.schedule).filter(a=>a===3).length},U=e.computed(()=>{if(k.value)return"加载中...";if(!w())return"未设置";const a=M(),n=$();return n>0?`${n}个已约`:a===48?"全天可约":a===0?"全天休息":`${a}个可约`}),N=e.computed(()=>{if(k.value)return"正在加载今日安排...";if(!w())return"今日未设置时间安排";const a=M(),n=$();return n>0?`今日有${n}个时间点已被预约`:a===48?"今日全天可接单":a===0?"今日休息，暂停接单":`今日可接单 ${a}个时间点`}),O=()=>{g.value&&typeof o.applicationInfo.is_online<"u"?(d.value=o.applicationInfo.is_online===1,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:326","从applicationInfo获取在线状态:",d.value,"原始值:",o.applicationInfo.is_online)):(d.value=!1,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:329","使用默认在线状态: 下线"))},A=async()=>{if(T.value){e.index.__f__("log","at subPackages/partner/components/Workbench.vue:336","组件已经初始化过，跳过重复初始化");return}e.index.__f__("log","at subPackages/partner/components/Workbench.vue:340","开始初始化Workbench组件"),await e.nextTick$1(),O(),z(),await P(),await u(),T.value=!0,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:358","Workbench组件初始化完成")};e.watch(()=>o.applicationInfo,(t,a)=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:363","applicationInfo发生变化:",{old:a,new:t}),t&&g.value&&(T.value?(e.index.__f__("log","at subPackages/partner/components/Workbench.vue:368","组件已初始化，更新在线状态、日期安排数据和最近订单数据"),O(),P(),u()):A())},{immediate:!0,deep:!0});const E=async()=>{if(S.value){e.index.__f__("log","at subPackages/partner/components/Workbench.vue:382","正在更新状态，忽略重复点击");return}const t=!d.value,a=t?"上线":"下线";if(t&&g.value&&o.applicationInfo.can_accept_orders==="N"&&(!o.applicationInfo.intro_video_url||o.applicationInfo.video_review_status!=="approved")){I.value=!0;return}e.index.showModal({title:`确认${a}`,content:t?"上线后将开始接收订单，确认上线吗？":"下线后将停止接收订单，确认下线吗？",success:async n=>{n.confirm&&(t&&await ae(),await R(t))}})},R=async t=>{var a;S.value=!0;try{let n=null;if(t){e.index.showLoading({title:"获取位置中..."});try{n=await x.getCurrentLocationAddress(!1),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:428","获取位置成功:",n)}catch(r){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:430","获取位置失败:",r),e.index.hideLoading(),e.index.showToast({title:"获取位置失败，无法上线",icon:"none"});return}}else{const r=x.getCacheStatus();r.hasCache&&(n={latitude:r.coordinates.latitude,longitude:r.coordinates.longitude,address:r.address})}const i=D.processAddress(n?n.address:""),s={is_online:t?1:0,latitude:n?n.latitude:null,longitude:n?n.longitude:null,location_text:i};e.index.__f__("log","at subPackages/partner/components/Workbench.vue:462","准备更新在线状态:",s);const c=await C.updateCompanionOnlineStatus(s);e.index.__f__("log","at subPackages/partner/components/Workbench.vue:467","在线",c),c.data&&c.data.code===0?(d.value=t,n&&(p.value=n.address,f.value=new Date().toLocaleTimeString()),e.index.hideLoading(),e.index.showToast({title:t?"已上线，开始接单":"已下线，暂停接单",icon:"none"}),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:484","在线状态更新成功:",c.data)):(e.index.hideLoading(),e.index.showToast({title:((a=c.data)==null?void 0:a.msg)||"状态更新失败",icon:"none"}),e.index.__f__("error","at subPackages/partner/components/Workbench.vue:492","在线状态更新失败:",c.data))}catch(n){e.index.hideLoading(),e.index.showToast({title:"网络错误，请重试",icon:"none"}),e.index.__f__("error","at subPackages/partner/components/Workbench.vue:500","更新在线状态失败:",n)}finally{S.value=!1}},z=()=>{const t=x.getCacheStatus();if(t.hasCache&&t.isValid){p.value=t.address,f.value=new Date(t.timestamp).toLocaleTimeString(),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:514","使用缓存位置信息:",t.address),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:515","使用缓存:",t),y(t.coordinates.latitude,t.coordinates.longitude,t.address);return}x.getCurrentLocationAddress(!1).then(a=>{p.value=a.address,f.value=new Date().toLocaleTimeString(),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:525","获取位置成功",a),y(a.latitude,a.longitude,a.address)}).catch(a=>{e.index.__f__("error","at subPackages/partner/components/Workbench.vue:531","获取位置失败:",a),p.value="位置获取失败",f.value="获取失败"})},V=()=>{e.index.showLoading({title:"更新位置中"}),x.getCurrentLocationAddress(!1).then(t=>{p.value=t.address,f.value=new Date().toLocaleTimeString(),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:549","位置更新成功",t),e.index.hideLoading(),e.index.showToast({title:"位置更新成功",icon:"none"}),y(t.latitude,t.longitude,t.address)}).catch(t=>{e.index.hideLoading(),e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/partner/components/Workbench.vue:567","获取位置失败:",t)})},y=async(t,a,n)=>{var i;try{const s=D.processAddress(n),c={is_online:d.value?1:0,latitude:t,longitude:a,location_text:s};e.index.__f__("log","at subPackages/partner/components/Workbench.vue:585","准备更新位置信息到服务器:",c),e.index.__f__("log","at subPackages/partner/components/Workbench.vue:586","位置描述分析:",D.analyzeAddress(n));const r=await C.updateCompanionOnlineStatus(c);r.data&&r.data.code===0?e.index.__f__("log","at subPackages/partner/components/Workbench.vue:591","位置信息更新成功:",r.data):e.index.__f__("error","at subPackages/partner/components/Workbench.vue:593","位置信息更新失败:",(i=r.data)==null?void 0:i.msg)}catch(s){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:596","位置信息更新API调用失败:",s)}},B=()=>{e.index.chooseLocation({success:async t=>{const a=t.address||t.name||"已选择位置";e.index.__f__("log","at subPackages/partner/components/Workbench.vue:606","手动选择位置",t),p.value=a,f.value=new Date().toLocaleTimeString(),await y(t.latitude,t.longitude,a)},fail:t=>{t.errMsg&&t.errMsg.indexOf("cancel")===-1&&(e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/partner/components/Workbench.vue:621","获取位置失败:",t.errMsg))}})},J=()=>{if(!o.applicationInfo||!o.applicationInfo.id){e.index.showToast({title:"用户信息不完整",icon:"none"});return}e.index.navigateTo({url:`/subPackages/partner/order/index?companion_id=${o.applicationInfo.id}`})},F=t=>{e.index.navigateTo({url:`/subPackages/partner/order/detail?orderId=${t}&companion_id=${o.applicationInfo.id}`})},G=t=>{t.user_latitude&&t.user_longitude?e.index.openLocation({latitude:Number(t.user_latitude),longitude:Number(t.user_longitude),address:t.service_address}):e.index.showToast({title:"暂无位置信息",icon:"none"})},H=t=>({2:[{text:"拒绝",action:"reject",type:"secondary"},{text:"接单",action:"accept",type:"primary"}],3:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已到达服务地点",action:"arrived",type:"primary"}],4:[{text:"电话联系",action:"call",type:"secondary"}],5:[{text:"电话联系",action:"contact",type:"secondary"},{text:"结束服务",action:"end",type:"primary"}],11:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已出发",action:"depart",type:"depart"}]})[t]||[],K=(t,a)=>{switch(t){case"contact":X(a);break;case"accept":Y(a);break;case"reject":Q(a);break;case"arrived":Z(a);break;case"depart":te(a);break;case"call":ee(a);break;case"end":ne(a);break}},X=t=>{t.user&&t.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${t.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:a=>{a.confirm&&e.index.makePhoneCall({phoneNumber:t.user.phone})}})},Y=t=>{e.index.showModal({title:"确认接单",content:"确定要接受这个订单吗？",confirmText:"接单",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"处理中..."});const n=await h.acceptCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(n.data.code===0)e.index.showToast({title:"接单成功",icon:"success"}),await u();else throw new Error(n.data.msg||"接单失败")}catch(n){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:776","接单失败:",n),e.index.showToast({title:n.message||"接单失败",icon:"none"})}finally{e.index.hideLoading()}}})},Q=t=>{e.index.showModal({title:"拒绝订单",content:"确定要拒绝这个订单吗？",confirmText:"拒绝",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"处理中..."});const n=await h.rejectCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(n.data.code===0)e.index.showToast({title:"已拒绝订单",icon:"success"}),await u();else throw new Error(n.data.msg||"拒绝订单失败")}catch(n){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:820","拒绝订单失败:",n),e.index.showToast({title:n.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},Z=t=>{e.index.showModal({title:"确认到达",content:"确认您已到达服务地点？",confirmText:"确认",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"更新中..."});const n=await h.arrivedCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(n.data.code===0)e.index.showToast({title:"已确认到达",icon:"success"}),await u();else throw new Error(n.data.msg||"确认到达失败")}catch(n){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:864","确认到达失败:",n),e.index.showToast({title:n.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ee=t=>{t.user&&t.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${t.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:a=>{a.confirm&&e.index.makePhoneCall({phoneNumber:t.user.phone})}})},te=t=>{e.index.showModal({title:"确认出发",content:"确认您已开始出发前往服务地点？",confirmText:"确认",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"更新中..."});const n=await h.departCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(n.data.code===0)e.index.showToast({title:"已确认出发",icon:"success"}),await u();else throw new Error(n.data.msg||"确认出发失败")}catch(n){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:927","确认出发失败:",n),e.index.showToast({title:n.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ne=t=>{e.index.showModal({title:"结束服务",content:"确定要结束服务吗？",confirmText:"结束",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"更新中..."});const n=await h.endCompanionService({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(n.data.code===0)e.index.showToast({title:"服务已结束",icon:"success"}),await u();else throw new Error(n.data.msg||"结束服务失败")}catch(n){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:971","结束服务失败:",n),e.index.showToast({title:n.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ae=async()=>{const t="vrMAJmeAOA0j3yRGX6AjNCOvfgzlJp8T1wWLucyCwKc";try{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:989","开始请求订阅消息权限");const a=await new Promise((n,i)=>{e.index.requestSubscribeMessage({tmplIds:[t],success:s=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:995","订阅消息请求结果:",s),n(s)},fail:s=>{e.index.__f__("error","at subPackages/partner/components/Workbench.vue:999","订阅消息请求失败:",s),i(s)}})});a[t]==="accept"?(e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1007","用户同意订阅消息"),e.index.showToast({title:"已开启接单提醒",icon:"success"})):a[t]==="reject"?(e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1013","用户拒绝订阅消息"),e.index.showModal({title:"接单提醒权限",content:"为了您能及时接收新订单通知，是否去设置页面重新授权？",confirmText:"去设置",cancelText:"暂不开启",success:n=>{n.confirm?e.index.openSetting({success:i=>{i.authSetting["scope.subscribeMessage"]?e.index.requestSubscribeMessage({tmplIds:[t],success:s=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1031","重新授权成功:",s),e.index.showToast({title:"已开启接单提醒",icon:"success"})},fail:s=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1038","重新授权失败:",s)}}):e.index.showToast({title:"未开启接单提醒",icon:"none"})},fail:i=>{e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1049","打开设置页面失败:",i)}}):e.index.showToast({title:"未开启接单提醒",icon:"none"})}})):(e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1062","用户未明确选择订阅消息"),e.index.showToast({title:"未开启接单提醒",icon:"none"}))}catch(a){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1069","订阅消息请求异常:",a),e.index.showToast({title:"订阅消息请求失败",icon:"none"})}},oe=()=>{I.value=!1},se=t=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1085","视频上传成功:",t),e.index.$emit("applicationStatusChanged",t)},P=async()=>{var t;if(!g.value||!o.applicationInfo.id){e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1093","applicationInfo不完整，跳过获取日期安排数据");return}try{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1100","开始获取日期安排数据，companion_id:",o.applicationInfo.id);const a={companion_id:o.applicationInfo.id},n=await C.getCompanionSchedule(a);e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1107","日期安排数据获取成功:",n),n.data&&n.data.code===0?(m.value=n.data.data,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1111","解析后的日期安排数据:",m.value)):e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1113","获取日期安排数据失败:",(t=n.data)==null?void 0:t.msg)}catch(a){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1116","获取日期安排数据接口调用失败:",a)}finally{k.value=!1}},u=async()=>{var t;if(!g.value||!o.applicationInfo.id){e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1125","applicationInfo不完整，跳过获取最近订单数据");return}try{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1131","开始获取最近订单数据，companion_id:",o.applicationInfo.id);const a={companion_id:Number(o.applicationInfo.id),page:1,page_size:10},n=await h.getCompanionActiveOrders(a);e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1138","最近订单数据获取成功:",n),n.data&&n.data.code===0?(b.value=n.data.data.list,e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1141","解析后的最近订单数据:",b.value)):e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1143","获取最近订单数据失败:",(t=n.data)==null?void 0:t.msg)}catch(a){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1146","获取最近订单数据接口调用失败:",a)}finally{L.value=!1}},ie=()=>{if(!o.applicationInfo||!o.applicationInfo.id){e.index.showToast({title:"用户信息不完整",icon:"none"});return}e.index.navigateTo({url:`/subPackages/partner/components/DataSelect?companion_id=${o.applicationInfo.id}`})},ce=async()=>{if(!v.value){v.value=!0;try{await Promise.all([P(),u()]),await new Promise(t=>setTimeout(t,800))}catch(t){e.index.__f__("error","at subPackages/partner/components/Workbench.vue:1189","刷新失败:",t)}finally{v.value=!1}}},re=()=>{v.value=!1},de=t=>({2:"等待接单",3:"我已出发",4:"已到达，等待开始服务",5:"服务中",11:"待服务"})[t]||"未知状态",ue=t=>({2:"status-pending",3:"status-departing",4:"status-arrived",5:"status-serving",11:"status-departing"})[t]||"status-default",le=t=>{if(!t)return"";const a=new Date(t),n=String(a.getMonth()+1).padStart(2,"0"),i=String(a.getDate()).padStart(2,"0"),s=String(a.getHours()).padStart(2,"0"),c=String(a.getMinutes()).padStart(2,"0");return`${n}-${i} ${s}:${c}`},pe=(t,a)=>{if(!t&&!a)return"待确认";let n="";if(t){const i=new Date(t),s=i.getFullYear(),c=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),_=["周日","周一","周二","周三","周四","周五","周六"][i.getDay()];n+=`${s}-${c}-${r} ${_}`}return a&&(n&&(n+=" "),n+=a),n||"待确认"};e.onMounted(()=>{e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1269","Workbench组件mounted，applicationInfo状态:",{hasApplicationInfo:!!o.applicationInfo,applicationInfo:o.applicationInfo}),g.value?A():e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1278","applicationInfo还未准备好，等待watch触发初始化"),e.index.$on("scheduleDataUpdated",q)}),e.onUnmounted(()=>{e.index.$off("scheduleDataUpdated",q)});const q=async t=>{var a;e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1292","收到日期安排数据更新事件:",t),t.companion_id===((a=o.applicationInfo)==null?void 0:a.id)&&(e.index.__f__("log","at subPackages/partner/components/Workbench.vue:1296","刷新日期安排数据"),await P())};return(t,a)=>e.e({a:l.applicationInfo&&l.applicationInfo.avatar},l.applicationInfo&&l.applicationInfo.avatar?{b:t.$imgBaseUrl+l.applicationInfo.avatar}:{},{c:d.value?1:"",d:e.t(d.value?"已上线":"已下线"),e:e.t(d.value?"正在接单中":"暂停接单"),f:e.t(d.value?"下线休息":"开始上线"),g:d.value?1:"",h:e.o(E),i:d.value?1:"",j:W._imports_0$17,k:e.o(V),l:W._imports_1$7,m:e.o(B),n:e.t(p.value||"正在获取位置..."),o:W._imports_2$5,p:e.t(U.value),q:k.value?1:"",r:e.t(N.value),s:e.o(ie),t:e.o(J),v:L.value},L.value?{}:b.value.length===0?{x:W._imports_3}:{y:e.f(b.value,(n,i,s)=>{var c,r;return e.e({a:e.t(le(n.created_at)),b:e.t(de(n.status)),c:e.n(ue(n.status)),d:t.$imgBaseUrl+n.service_image_url,e:e.t(n.service_name),f:e.t(n.unit_price),g:e.t(n.unit),h:e.t(n.quantity),i:e.t(n.total_amount),j:[2,3,4,5,11].includes(n.status)},[2,3,4,5,11].includes(n.status)?e.e({k:n.user},n.user?{l:e.t((c=n==null?void 0:n.user)==null?void 0:c.nick_name),m:e.t((r=n==null?void 0:n.user)==null?void 0:r.phone)}:{},{n:e.t(n.service_address),o:e.o(_=>G(n),n.id),p:e.t(pe(n.service_date,n.service_time))}):{},{q:e.f(H(n.status),(_,j,he)=>({a:e.t(_.text),b:j,c:e.n(_.type),d:e.o(me=>K(_.action,n),j)})),r:n.id,s:e.o(_=>F(n.id),n.id)})})},{w:b.value.length===0,z:v.value,A:e.o(ce),B:e.o(re),C:e.o(oe),D:e.o(se),E:e.p({show:I.value,applicationInfo:l.applicationInfo})})}},ge=e._export_sfc(fe,[["__scopeId","data-v-89082ba0"]]);wx.createComponent(ge);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/partner/components/Workbench.js.map

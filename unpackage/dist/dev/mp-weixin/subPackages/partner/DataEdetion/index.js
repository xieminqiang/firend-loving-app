"use strict";const e=require("../../../common/vendor.js"),$=require("../../../common/assets.js"),E=require("../../../api/user.js"),_e=require("../../../api/home.js"),N=require("../../../api/file.js"),fe=require("../../../stores/user.js"),he=5*60*1e3,pe={__name:"index",setup(me){const O=fe.useUserStore(),U=e.ref(0),b=e.ref(!1),f=e.ref(!1),s=e.reactive({nickname:"",gender:"",age:"",height:"",weight:"",city:"深圳市"}),y=e.ref(!1),r=e.ref([]),c=e.ref([]),_=e.ref([]),P=e.ref(!1),v=e.ref([]),m=e.ref([]),h=e.ref([]),D=e.ref(!1),g=e.ref([]),u=e.ref([]),k=e.ref(!1),d=e.ref([]),p=e.ref(!1),C=e.ref(4),w=e.ref([]),I=e.ref(new Map),L=e.ref(new Map),j=e.ref([{type:4,name:"个性特质"},{type:5,name:"我的爱好"},{type:6,name:"外貌风格"},{type:7,name:"专业技能"},{type:8,name:"热门推荐"}]);e.onMounted(async()=>{const t=e.index.getSystemInfoSync();U.value=t.statusBarHeight||0,await M()});const M=async()=>{try{await V(),await H()}catch(t){e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:500","加载初始数据失败:",t),e.index.showToast({title:"加载数据失败，请重试",icon:"none"})}},H=async()=>{try{const t=await E.getApplicatioInfo();if(t.data&&t.data.code===0&&t.data.data){const n=t.data.data;if(s.nickname=n.nickname||"",s.gender=n.gender==="男"?"male":"female",s.age=n.age?String(n.age):"",s.height=n.height?String(n.height):"",s.weight=n.weight?String(n.weight):"",v.value=n.photos||[],n.service_areas&&n.service_areas.length>0){e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:528","开始处理服务区域回显:",{service_areas:n.service_areas,cityList:_.value});const a=n.service_areas.map(i=>{const o=_.value.find(l=>l.code===Number(i));return e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:536",`查找城市代码 ${i}:`,o),o?o.name:null}).filter(i=>i!==null);r.value=a,s.city=a[0]||"深圳市",e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:543","服务区域回显完成:",{service_areas:n.service_areas,cityNames:a,selectedCities:r.value})}h.value=n.services||[],n.tags&&n.tags.length>0&&(u.value=n.tags.map(a=>({id:Date.now()+Math.random(),tag_name:a}))),r.value.length>0&&await B(),e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:568","申请数据加载成功:",n)}else e.index.__f__("warn","at subPackages/partner/DataEdetion/index.vue:570","获取申请数据失败")}catch(t){e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:573","加载申请数据失败:",t),e.index.showToast({title:"加载申请数据失败",icon:"none"})}},B=async()=>{if(r.value.length===0){m.value=[],g.value=[];return}D.value=!0;try{const t=r.value.map(a=>{const i=_.value.find(o=>o.name===a);return i?i.code:null}).filter(a=>a!==null);if(t.length===0){e.index.__f__("warn","at subPackages/partner/DataEdetion/index.vue:598","未找到有效的城市代码"),m.value=[],g.value=[];return}const n=await E.getServicesByCities(t);n.data&&n.data.code===0&&n.data.data?(m.value=n.data.data,G(),e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:612","服务技能列表加载成功:",m.value),e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:613","服务技能分组:",g.value)):(e.index.__f__("warn","at subPackages/partner/DataEdetion/index.vue:615","获取服务技能列表失败"),m.value=[],g.value=[])}catch(t){e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:620","获取服务技能列表失败:",t),m.value=[],g.value=[]}finally{D.value=!1}},G=()=>{const t={};m.value.forEach(n=>{const a=n.category,i=n.category_name||"其他";t[a]||(t[a]={id:a,name:i,services:[]}),t[a].services.push(n)}),g.value=Object.values(t).sort((n,a)=>n.id-a.id)},V=async()=>{P.value=!0;try{const t=await _e.getCityList();t.data&&t.data.code===0&&t.data.data?(_.value=t.data.data.map(n=>({name:n.name,code:n.city_code})),e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:665","资料编辑页面区域列表加载成功:",_.value),e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:666","城市列表数据结构:",t.data.data)):(e.index.__f__("warn","at subPackages/partner/DataEdetion/index.vue:668","获取区域列表失败"),_.value=[])}catch(t){e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:672","获取区域列表失败:",t),_.value=[]}finally{P.value=!1}},q=t=>{s.gender=t},J=()=>{c.value=[...r.value],y.value=!0},F=()=>{c.value=[],y.value=!1},K=t=>{const n=c.value.indexOf(t);n>-1?c.value.splice(n,1):c.value.push(t),e.index.vibrateShort({type:"light"})},Q=t=>{const n=r.value.indexOf(t);n>-1&&(r.value.splice(n,1),e.index.vibrateShort({type:"light"}))},W=async()=>{if(c.value.length===0){e.index.showToast({title:"请至少选择一个服务区域",icon:"none"});return}r.value=[...c.value],s.city=r.value[0],y.value=!1,c.value=[],h.value=[],g.value=[],await B()},X=()=>{const t=6-v.value.length;if(t<=0){e.index.showToast({title:"最多只能上传6张照片",icon:"none"});return}e.index.chooseImage({count:t,sizeType:["compressed"],sourceType:["album","camera"],success:async n=>{e.index.showLoading({title:"上传中...",mask:!0});try{const a=n.tempFilePaths.map(async(o,l)=>{try{const x=await Y(o);if(e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:785","fileInfo",x),e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:786","filePath",o),!x||!x.extension)throw new Error("无法获取文件信息");const A=await N.uploadFile({filePath:o,name:`photo_${Date.now()}_${l}.${x.extension}`}),T=N.getUploadResult(A);if(!T||!T.url)throw new Error("上传结果解析失败");return T.url}catch(x){throw e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:805",`第${l+1}张照片上传失败:`,x),x}}),i=await Promise.all(a);v.value.push(...i),e.index.showToast({title:`成功上传${i.length}张照片`,icon:"success"})}catch(a){e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:822","照片上传失败:",a),e.index.showToast({title:"照片上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:n=>{e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:832","选择照片失败:",n),e.index.showToast({title:"选择照片失败",icon:"none"})}})},Y=t=>new Promise((n,a)=>{e.index.getFileInfo({filePath:t,success:i=>{const o=t.split(".").pop().toLowerCase();n({size:i.size,extension:o})},fail:i=>{e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:855","获取文件信息失败:",i);const o=t.split(".").pop().toLowerCase()||"jpg";n({size:0,extension:o})}})}),Z=t=>{e.index.previewImage({urls:v.value,current:t})},ee=t=>{v.value.splice(t,1)},ae=t=>{const n=t.id,a=h.value.indexOf(n);a>-1?h.value.splice(a,1):h.value.push(n),e.index.vibrateShort({type:"light"})},te=async()=>{b.value=!0;try{await M()}catch{e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}finally{b.value=!1}},ne=()=>{b.value=!1},ie=async()=>{if(f.value)return;if(!s.nickname.trim()){e.index.showToast({title:"请输入昵称",icon:"none"});return}if(s.nickname.length>50){e.index.showToast({title:"昵称不能超过50个字符",icon:"none"});return}if(!s.gender){e.index.showToast({title:"请选择性别",icon:"none"});return}const t=parseInt(s.age),n=parseInt(s.height),a=parseInt(s.weight);if(!t||t<18||t>65){e.index.showToast({title:"年龄必须在18-65岁之间",icon:"none"});return}if(!n||n<100||n>250){e.index.showToast({title:"身高必须在100-250cm之间",icon:"none"});return}if(!a||a<30||a>200){e.index.showToast({title:"请输入合理的体重",icon:"none"});return}if(r.value.length===0){e.index.showToast({title:"请至少选择一个服务区域",icon:"none"});return}if(v.value.length===0){e.index.showToast({title:"请上传至少一张生活照",icon:"none"});return}if(v.value.length>9){e.index.showToast({title:"最多只能上传9张照片",icon:"none"});return}if(h.value.length===0){e.index.showToast({title:"请至少选择一项服务技能",icon:"none"});return}await se()},se=async()=>{f.value=!0;try{const t=r.value.map(i=>{const o=_.value.find(l=>l.name===i);return o?String(o.code):null}).filter(i=>i!==null);if(t.length===0){e.index.showToast({title:"服务区域数据异常，请重新选择",icon:"none"});return}const n={nickname:s.nickname.trim(),gender:s.gender==="male"?"男":"女",age:parseInt(s.age),height:parseInt(s.height),weight:parseInt(s.weight),service_areas:t,services:h.value,can_accept_orders:"N",photos:v.value,tags:u.value.map(i=>i.tag_name),phone:O.userInfo.phone||""};e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:1027","保存数据:",n);const a=await E.updateCompanionApplication(n);if(e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:1032","接口响应:",a),a&&a.data&&a.data.code===0)e.index.showToast({title:"保存成功",icon:"success",duration:2e3}),e.index.$emit("applicationStatusChanged",{status:"updated",message:"资料更新成功"}),setTimeout(()=>{e.index.navigateBack()},1500);else{const i=a&&a.data&&a.data.message||"保存失败，请稍后重试";e.index.showModal({title:"保存失败",content:i,showCancel:!1,confirmText:"我知道了"})}}catch(t){e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:1066","保存失败:",t);let n="保存失败，请稍后重试";t&&t.message&&(t.message.includes("网络")?n="网络连接异常，请检查网络后重试":t.message.includes("参数")?n="保存信息有误，请检查后重试":n=t.message),e.index.showModal({title:"保存失败",content:n,showCancel:!1,confirmText:"我知道了"})}finally{f.value=!1}},oe=()=>{d.value=[...u.value],k.value=!0,z(4)},R=()=>{d.value=[],k.value=!1},re=t=>{C.value=t,z(t)},le=t=>{const n=L.value.get(t);return n?Date.now()-n<he:!1},ue=t=>I.value.get(t)||[],ce=(t,n)=>{I.value.set(t,n),L.value.set(t,Date.now()),e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:1134",`标签类型${t}已缓存，数据量: ${n.length}`)},z=async(t,n=!1)=>{if(!n&&le(t)){const a=ue(t);if(a.length>0){e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:1157",`使用缓存数据 - 标签类型${t}，数据量: ${a.length}`),w.value=a;return}}p.value=!0;try{e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:1165",`开始加载标签类型: ${t}`);const a={tag_type:t,page:1,pageSize:60};e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:1173","请求参数:",a);const i=await E.getPersonalityTags(a);if(e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:1176","API响应:",i),i.data&&i.data.code===0&&i.data.data){const o=i.data.data.list||i.data.data;w.value=o,ce(t,o),e.index.__f__("log","at subPackages/partner/DataEdetion/index.vue:1186",`标签类型${t}加载成功:`,o)}else e.index.__f__("warn","at subPackages/partner/DataEdetion/index.vue:1188",`获取标签类型${t}失败，响应数据:`,i),w.value=[]}catch(a){e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:1192",`获取标签类型${t}失败:`,a),e.index.__f__("error","at subPackages/partner/DataEdetion/index.vue:1193","错误详情:",a.response||a),w.value=[]}finally{p.value=!1}},S=t=>d.value.some(n=>n.id===t),de=t=>{const n=d.value.findIndex(a=>a.id===t.id);if(n>-1)d.value.splice(n,1);else{if(d.value.length>=5){e.index.showToast({title:"最多只能选择5个标签",icon:"none"});return}d.value.push(t)}e.index.vibrateShort({type:"light"})},ve=()=>{u.value=[...d.value],k.value=!1,d.value=[],e.index.showToast({title:`已选择${u.value.length}个标签`,icon:"success"})},ge=t=>{const n=u.value.findIndex(a=>a.id===t.id);n>-1&&(u.value.splice(n,1),e.index.vibrateShort({type:"light"}))};return(t,n)=>e.e({a:s.nickname,b:e.o(a=>s.nickname=a.detail.value),c:$._imports_4,d:s.gender==="male"?1:"",e:e.o(a=>q("male")),f:$._imports_3$2,g:s.gender==="female"?1:"",h:e.o(a=>q("female")),i:s.age,j:e.o(a=>s.age=a.detail.value),k:s.height,l:e.o(a=>s.height=a.detail.value),m:s.weight,n:e.o(a=>s.weight=a.detail.value),o:r.value.length===0},r.value.length===0?{}:{p:e.t(r.value.length)},{q:e.o(J),r:r.value.length>0},r.value.length>0?{s:e.f(r.value,(a,i,o)=>({a:e.t(a),b:a,c:e.o(l=>Q(a),a)}))}:{},{t:e.f(v.value,(a,i,o)=>({a:t.$imgBaseUrl+a,b:e.o(l=>ee(i),i),c:i,d:e.o(l=>Z(i),i)})),v:v.value.length<6},v.value.length<6?{w:$._imports_0$5,x:e.o(X)}:{},{y:D.value},D.value?{}:r.value.length===0?{}:g.value.length>0?{B:e.f(g.value,(a,i,o)=>({a:e.t(a.name),b:e.f(a.services,(l,x,A)=>({a:e.t(l.name),b:h.value.includes(l.id)?1:"",c:l.id,d:e.o(T=>ae(l),l.id)})),c:a.id}))}:{},{z:r.value.length===0,A:g.value.length>0,C:u.value.length>0},u.value.length>0?{D:e.f(u.value,(a,i,o)=>({a:e.t(a.tag_name),b:a.id,c:e.o(l=>ge(a),a.id)}))}:{},{E:e.t(u.value.length),F:u.value.length>=5?1:"",G:e.o(a=>u.value.length<5?oe():null),H:b.value,I:e.o(te),J:e.o(ne),K:f.value},f.value?{}:{},{L:!f.value},f.value?{}:{},{M:f.value?1:"",N:e.o(ie),O:y.value},y.value?e.e({P:e.o(F),Q:P.value},P.value?{}:{R:e.f(_.value,(a,i,o)=>e.e({a:e.t(a.name),b:c.value.includes(a.name)},c.value.includes(a.name)?{}:{},{c:i,d:e.n({active:c.value.includes(a.name)}),e:e.o(l=>K(a.name),i)}))},{S:e.t(c.value.length),T:e.o(W),U:e.o(()=>{}),V:e.o(F)}):{},{W:k.value},k.value?e.e({X:e.o(R),Y:e.f(j.value,(a,i,o)=>({a:e.t(a.name),b:a.type,c:e.n({active:C.value===a.type}),d:e.o(l=>re(a.type),a.type)})),Z:!p.value&&d.value.length>=5},!p.value&&d.value.length>=5?{}:{},{aa:p.value},p.value?{}:{ab:e.f(w.value,(a,i,o)=>e.e({a:e.t(a.tag_name),b:S(a.id)},S(a.id)?{}:{},{c:a.id,d:e.n({selected:S(a.id)}),e:e.o(l=>de(a),a.id)}))},{ac:!p.value&&w.value.length===0},!p.value&&w.value.length===0?{}:{},{ad:e.t(d.value.length),ae:e.o(ve),af:e.o(()=>{}),ag:e.o(R)}):{})}},xe=e._export_sfc(pe,[["__scopeId","data-v-a9a5bec5"]]);wx.createPage(xe);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/partner/DataEdetion/index.js.map

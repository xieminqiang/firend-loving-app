"use strict";const e=require("../../../common/vendor.js"),$=require("../../../common/assets.js"),_=require("../../../api/order.js"),ae={__name:"index",setup(ne){const i=e.ref("all"),p=e.ref(0),m=e.ref(!1),h=e.ref(!1),w=e.ref(!1),r=e.ref(!0),c=e.ref(1),C=e.ref(20),u=e.ref(null),d=e.ref({}),l=e.ref({all:[],pending_accept:[],pending_service:[],in_service:[],completed:[]});let y=null;e.onUnmounted(()=>{y&&clearTimeout(y)});const f=e.ref([{label:"全部",value:"all",count:0},{label:"待接单",value:"pending_accept",count:0},{label:"待服务",value:"pending_service",count:0},{label:"服务中",value:"in_service",count:0},{label:"已完成",value:"completed",count:0}]);e.onLoad(a=>{if(e.index.__f__("log","at subPackages/partner/order/index.vue:200","友伴订单页面接收到的参数:",a),a.companion_id&&(e.index.__f__("log","at subPackages/partner/order/index.vue:204","设置companion_id为:",a.companion_id),u.value=a.companion_id),a.status){e.index.__f__("log","at subPackages/partner/order/index.vue:209","设置订单状态为:",a.status),i.value=a.status;const n=f.value.findIndex(t=>t.value===a.status);n!==-1&&(p.value=n),c.value=1,r.value=!0,delete d.value[a.status]}else e.index.__f__("log","at subPackages/partner/order/index.vue:222","没有传递状态参数，使用默认状态: all"),i.value="all",p.value=0;e.index.__f__("log","at subPackages/partner/order/index.vue:228","onLoad中加载数据，当前状态:",i.value),g()}),e.watch(i,(a,n)=>{e.index.__f__("log","at subPackages/partner/order/index.vue:234","状态变化:",n,"->",a)});const O=async a=>{if(i.value===a)return;i.value=a;const n=f.value.findIndex(t=>t.value===a);if(n!==-1&&(p.value=n),d.value[a])l.value[a]=d.value[a].list,c.value=d.value[a].page,r.value=d.value[a].hasMore;else{c.value=1,r.value=!0,l.value[a]=[];try{await g()}catch(t){e.index.__f__("error","at subPackages/partner/order/index.vue:262","切换状态失败:",t)}}},I=async a=>{const n=a.detail.current,t=f.value[n].value,o=i.value;p.value=n,i.value=t,y&&clearTimeout(y),o!==t&&!d.value[t]&&(y=setTimeout(async()=>{c.value=1,r.value=!0,l.value[t]=[],await g()},300))},b=a=>l.value[a]||[],g=async()=>{if(!h.value){h.value=!0;try{const a={page:c.value,page_size:C.value,companion_id:Number(u.value)};i.value==="all"||(i.value==="pending_accept"?a.status=2:i.value==="pending_service"?a.status_group="pending_service":i.value==="in_service"?a.status=5:i.value==="completed"&&(a.status=6));const n=await _.getCompanionOrderList(a);if(e.index.__f__("log","at subPackages/partner/order/index.vue:324","response.data",n.data),n.data.code===0){const{list:t,total:o}=n.data.data;c.value===1?(l.value[i.value]=t||[],D(o)):l.value[i.value].push(...t||[]),r.value=l.value[i.value].length<o,d.value[i.value]={list:[...l.value[i.value]],page:c.value,hasMore:r.value}}else throw new Error(n.data.msg||"获取订单列表失败")}catch(a){e.index.__f__("error","at subPackages/partner/order/index.vue:349","加载订单列表失败:",a),e.index.showToast({title:a.message||"加载失败",icon:"none"})}finally{h.value=!1}}},D=a=>{const n=f.value.find(t=>t.value===i.value);n&&(n.count=a||0)},x=async()=>{if(!m.value){m.value=!0,c.value=1,r.value=!0,delete d.value[i.value];try{await g(),await new Promise(a=>setTimeout(a,800))}catch(a){e.index.__f__("error","at subPackages/partner/order/index.vue:384","刷新失败:",a)}finally{m.value=!1}}},E=()=>{m.value=!1},N=async()=>{if(!(w.value||!r.value)){w.value=!0,c.value++;try{await g()}catch(a){e.index.__f__("error","at subPackages/partner/order/index.vue:404","加载更多失败:",a),c.value--}finally{w.value=!1}}},R=a=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-cancelled",9:"status-cancelled",11:"status-to-serve"})[a]||"status-default",j=a=>({1:"待付款",2:"等待接单",3:"我已出发",4:"已到达，等待开始服务",5:"服务中",6:"已完成",7:"已取消",8:"已取消",9:"已取消",11:"待服务"})[a]||"未知状态",q=a=>({2:[{text:"拒绝",action:"reject",type:"secondary"},{text:"接单",action:"accept",type:"primary"}],3:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已到达服务地点",action:"arrived",type:"primary"}],4:[{text:"电话联系",action:"call",type:"secondary"}],5:[{text:"电话联系",action:"contact",type:"secondary"},{text:"结束服务",action:"end",type:"primary"}],6:[{text:"查看评价",action:"review",type:"secondary"},{text:"删除订单",action:"delete",type:"secondary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"订单已取消，给客户退款中",action:"info",type:"info"}],11:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已出发",action:"depart",type:"depart"}]})[a]||[],A=(a,n)=>{switch(a){case"contact":z(n);break;case"accept":F(n);break;case"reject":U(n);break;case"arrived":Y(n);break;case"depart":H(n);break;case"call":B(n);break;case"start":V(n);break;case"end":G(n);break;case"review":J(n);break;case"rebook":K(n);break;case"delete":Q(n);break}},z=a=>{a.user&&a.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${a.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:a.user.phone})}})},F=a=>{e.index.showModal({title:"确认接单",content:"确定要接受这个订单吗？",confirmText:"接单",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const t=await _.acceptCompanionOrder({order_id:a.id,companion_id:Number(u.value)});if(t.data.code===0){e.index.showToast({title:"接单成功",icon:"success"});const o=f.value.findIndex(v=>v.value==="pending_service");o!==-1&&(p.value=o,i.value="pending_service"),delete d.value.pending_service,c.value=1,r.value=!0,l.value.pending_service=[],await g()}else throw new Error(t.data.msg||"接单失败")}catch(t){e.index.__f__("error","at subPackages/partner/order/index.vue:591","接单失败:",t),e.index.showToast({title:t.message||"接单失败",icon:"none"})}finally{e.index.hideLoading()}}})},U=a=>{e.index.showModal({title:"拒绝订单",content:"确定要拒绝这个订单吗？",confirmText:"拒绝",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const t=await _.rejectCompanionOrder({order_id:a.id,companion_id:Number(u.value)});if(t.data.code===0)e.index.showToast({title:"已拒绝订单",icon:"success"}),x();else throw new Error(t.data.msg||"拒绝订单失败")}catch(t){e.index.__f__("error","at subPackages/partner/order/index.vue:635","拒绝订单失败:",t),e.index.showToast({title:t.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},Y=a=>{e.index.showModal({title:"确认到达",content:"确认您已到达服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const t=await _.arrivedCompanionOrder({order_id:a.id,companion_id:Number(u.value)});if(t.data.code===0)e.index.showToast({title:"已确认到达",icon:"success"}),x();else throw new Error(t.data.msg||"确认到达失败")}catch(t){e.index.__f__("error","at subPackages/partner/order/index.vue:679","确认到达失败:",t),e.index.showToast({title:t.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},B=a=>{a.user&&a.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${a.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:a.user.phone})}})},H=a=>{e.index.showModal({title:"确认出发",content:"确认您已开始出发前往服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const t=await _.departCompanionOrder({order_id:a.id,companion_id:Number(u.value)});if(t.data.code===0)e.index.showToast({title:"已确认出发",icon:"success"}),x();else throw new Error(t.data.msg||"确认出发失败")}catch(t){e.index.__f__("error","at subPackages/partner/order/index.vue:742","确认出发失败:",t),e.index.showToast({title:t.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},V=a=>{e.index.showModal({title:"开始服务",content:"确定要开始服务吗？",confirmText:"开始",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const t=await _.startCompanionService({order_id:a.id,companion_id:u.value});if(t.data.code===0)e.index.showToast({title:"服务已开始",icon:"success"}),x();else throw new Error(t.data.msg||"开始服务失败")}catch(t){e.index.__f__("error","at subPackages/partner/order/index.vue:786","开始服务失败:",t),e.index.showToast({title:t.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},G=a=>{e.index.showModal({title:"结束服务",content:"确定要结束服务吗？",confirmText:"结束",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const t=await _.endCompanionService({order_id:a.id,companion_id:u.value});if(t.data.code===0)e.index.showToast({title:"服务已结束",icon:"success"}),x();else throw new Error(t.data.msg||"结束服务失败")}catch(t){e.index.__f__("error","at subPackages/partner/order/index.vue:830","结束服务失败:",t),e.index.showToast({title:t.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},J=a=>{e.index.navigateTo({url:`/subPackages/partner/review?orderId=${a.id}`})},K=a=>{e.index.navigateTo({url:`/subPackages/partner/rebook?orderId=${a.id}`})},Q=a=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"删除中..."});const t={order_id:a.id,companion_id:u.value},o=await _.deleteCompanionOrder(t);if(o.data.code===0)l.value[i.value]=l.value[i.value].filter(v=>v.id!==a.id),e.index.showToast({title:"订单已删除",icon:"success"});else throw new Error(o.data.msg||"删除订单失败")}catch(t){e.index.__f__("error","at subPackages/partner/order/index.vue:890","删除订单失败:",t),e.index.showToast({title:t.message||"删除失败",icon:"none"})}finally{e.index.hideLoading()}}})},W=a=>{e.index.navigateTo({url:`/subPackages/partner/order/detail?orderId=${a}&companion_id=${u.value}`})},X=a=>{a.user_latitude&&a.user_longitude?e.index.openLocation({latitude:Number(a.user_latitude),longitude:Number(a.user_longitude),address:a.service_address}):e.index.showToast({title:"暂无位置信息",icon:"none"})},Z=a=>{const n=new Date(a),t=n.getFullYear(),o=String(n.getMonth()+1).padStart(2,"0"),v=String(n.getDate()).padStart(2,"0"),s=String(n.getHours()).padStart(2,"0"),k=String(n.getMinutes()).padStart(2,"0");return`${t}-${o}-${v} ${s}:${k}`},ee=(a,n)=>{if(!a&&!n)return"待确认";let t="";if(a){const o=new Date(a),v=o.getFullYear(),s=String(o.getMonth()+1).padStart(2,"0"),k=String(o.getDate()).padStart(2,"0"),S=["周日","周一","周二","周三","周四","周五","周六"][o.getDay()];t+=`${v}-${s}-${k} ${S}`}return n&&(t&&(t+=" "),t+=n),t||"待确认"};return(a,n)=>({a:e.f(f.value,(t,o,v)=>({a:e.t(t.label),b:o,c:p.value===o?1:"",d:e.o(s=>O(t.value),o)})),b:e.f(f.value,(t,o,v)=>e.e({a:b(t.value).length===0&&!h.value},b(t.value).length===0&&!h.value?{b:$._imports_3}:e.e({c:e.f(b(t.value),(s,k,S)=>{var P,L;return e.e({a:e.t(Z(s.created_at)),b:e.t(j(s.status)),c:e.n(R(s.status)),d:a.$imgBaseUrl+s.service_image_url,e:e.t(s.service_name),f:e.t(s.unit_price),g:e.t(s.unit),h:e.t(s.quantity),i:e.t(s.total_amount),j:[2,3,4,5,11].includes(s.status)},[2,3,4,5,11].includes(s.status)?e.e({k:s.status!=2&&s.user},s.status!=2&&s.user?{l:e.t((P=s==null?void 0:s.user)==null?void 0:P.nick_name),m:e.t((L=s==null?void 0:s.user)==null?void 0:L.phone)}:{},{n:e.t(s.service_address),o:e.o(T=>X(s),s.id),p:e.t(ee(s.service_date,s.service_time))}):{},{q:s.status===4},s.status===4?{r:$._imports_1$4}:{},{s:e.f(q(s.status),(T,M,se)=>({a:e.t(T.text),b:M,c:e.n(T.type),d:e.o(ie=>A(T.action,s),M)})),t:s.id,v:e.o(T=>W(s.id),s.id)})}),d:r.value&&b(t.value).length>0},r.value&&b(t.value).length>0?e.e({e:w.value},w.value?{}:{}):{}),{f:e.o(x,t.value),g:e.o(E,t.value),h:e.o(N,t.value),i:t.value})),c:m.value,d:p.value,e:e.o(I)})}},te=e._export_sfc(ae,[["__scopeId","data-v-a24e0011"]]);wx.createPage(te);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/partner/order/index.js.map

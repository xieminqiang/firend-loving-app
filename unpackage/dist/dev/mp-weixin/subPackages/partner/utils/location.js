"use strict";const i=require("../../../common/vendor.js");let t={latitude:null,longitude:null,address:"",timestamp:0};const _=2*60*1e3,g=100,h=(a,s,c,n)=>{const d=(c-a)*Math.PI/180,e=(n-s)*Math.PI/180,o=Math.sin(d/2)*Math.sin(d/2)+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(e/2)*Math.sin(e/2);return 6371e3*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))},l=(a,s)=>!t.latitude||!t.longitude?!0:h(t.latitude,t.longitude,a,s)>g,u=()=>t.timestamp?Date.now()-t.timestamp<_:!1;function m(a,s,c=!1){return new Promise((n,r)=>{if(!a||!s){r(new Error("经纬度参数不能为空"));return}if(!(c||!u()||l(a,s))&&t.address){i.index.__f__("log","at subPackages/partner/utils/location.js:93","使用缓存地址，位置变化不大:",t.address),n(t.address);return}i.index.__f__("log","at subPackages/partner/utils/location.js:98","调用腾讯地图API获取地址:",a,s),i.index.request({url:"https://apis.map.qq.com/ws/geocoder/v1/",method:"GET",data:{key:"4Z3BZ-4JXCJ-EFNFY-DIL4V-6KKKH-YHF6Z",location:`${a},${s}`,output:"json"},success:e=>{if(i.index.__f__("log","at subPackages/partner/utils/location.js:110","腾讯地图API响应:",e),e.statusCode===200&&e.data&&e.data.status===0&&e.data.result&&e.data.result.address)t={latitude:a,longitude:s,address:e.data.result.address,timestamp:Date.now()},n(e.data.result.address);else{const o=`${a.toFixed(6)}, ${s.toFixed(6)}`;t={latitude:a,longitude:s,address:o,timestamp:Date.now()},n(o)}},fail:e=>{i.index.__f__("error","at subPackages/partner/utils/location.js:134","腾讯地图API调用失败:",e);const o=`${a.toFixed(6)}, ${s.toFixed(6)}`;t={latitude:a,longitude:s,address:o,timestamp:Date.now()},n(o)}})})}function f(a=!1){return new Promise((s,c)=>{i.index.getLocation({type:"gcj02",success:n=>{i.index.__f__("log","at subPackages/partner/utils/location.js:160","获取位置成功:",n);const{latitude:r,longitude:d}=n;if(!(a||!u()||l(r,d))&&t.address){i.index.__f__("log","at subPackages/partner/utils/location.js:169","使用缓存地址，位置变化不大"),s({latitude:r,longitude:d,address:t.address});return}m(r,d,a).then(o=>{s({latitude:r,longitude:d,address:o})}).catch(o=>{i.index.__f__("error","at subPackages/partner/utils/location.js:188","获取地址失败:",o),s({latitude:r,longitude:d,address:`${r.toFixed(6)}, ${d.toFixed(6)}`})})},fail:n=>{i.index.__f__("error","at subPackages/partner/utils/location.js:198","获取位置失败:",n),c(new Error("获取位置失败: "+(n.errMsg||n.message||"未知错误")))}})})}function p(){return{hasCache:!!t.address,isValid:u(),timestamp:t.timestamp,address:t.address,coordinates:{latitude:t.latitude,longitude:t.longitude}}}exports.getCacheStatus=p;exports.getCurrentLocationAddress=f;
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/partner/utils/location.js.map

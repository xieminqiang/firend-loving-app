"use strict";const e=require("../../common/vendor.js"),l=require("../../common/assets.js"),A=require("../../api/friends.js");require("../../config/http.js");const K=require("../../stores/level.js"),Q=require("../../stores/city.js"),R=require("../../stores/user.js");Array||e.resolveComponent("uni-popup")();const V=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(X+Z+V)();const X=()=>"../../components/common/CitySelector.js",Z=()=>"../../components/common/CityPicker.js",ee={__name:"friend-select",setup(D){const B=e.ref(0);e.ref(null);const L=e.ref(0),p=e.ref(""),b=e.ref(!1),C=e.ref(!1),d=e.ref(""),_=e.computed(()=>{var a;return((a=u.userLocation)==null?void 0:a.latitude)||null}),g=e.computed(()=>{var a;return((a=u.userLocation)==null?void 0:a.longitude)||null});e.ref(!1);const u=Q.useCityStore(),S=R.useUserStore(),q=e.computed(()=>S.userInfo&&Object.keys(S.userInfo).length>0);e.computed(()=>{if(q.value)return S.userInfo});const z=()=>{e.index.navigateTo({url:"/subPackages/login/index"})};e.computed(()=>u.cityList),e.computed(()=>u.currentCity);const c=e.ref([]),m=e.ref(0),T=e.ref(1),M=e.ref(20),f=e.ref(!1),j=e.ref(!0),h=e.ref(!1),O=K.useLevelStore(),y=e.computed(function(){return c.value.map(function(a){const r=a.tags?a.tags.slice(0,3):[],t=a.tags&&a.tags.length>3?a.tags.length-3:0;return{...a,visibleTags:r,extraTags:t}})}),w=e.ref(null),v=e.ref([]),k=e.ref(null),U=e.ref(0),F=async a=>{k.value=a;try{const r={city_code:u.currentCityCode,application_id:a.id};_.value&&g.value&&(r.latitude=parseFloat(_.value),r.longitude=parseFloat(g.value));const t=await A.getCityServices(r);if(t.data&&t.data.code===0){const n=t.data.data;n&&n.services&&n.services.length>0?v.value=n.services:v.value=[]}else v.value=[]}catch(r){e.index.__f__("error","at subPackages/friend/friend-select.vue:258","获取服务信息失败:",r),v.value=[]}w.value.open()},$=()=>{w.value.close()},H=a=>{if(e.index.__f__("log","at subPackages/friend/friend-select.vue:272","选择服务:",a),$(),!q.value){e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),z();return}let r=`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${k.value.id}&level_order=${k.value.level_order||""}&nickname=${k.value.name}`;d.value&&(r+=`&original_service_id=${d.value}`),e.index.navigateTo({url:r})},J=a=>{let r="/subPackages/friend/detail?id="+a+"&city_code="+u.currentCityCode;_.value&&g.value&&(r+="&latitude="+_.value+"&longitude="+g.value),e.index.navigateTo({url:r})},P=async(a=!1)=>{var r;if(!f.value){f.value=!0;try{const t={page:a?1:T.value,page_size:M.value};u.currentCityCode&&(t.city_code=u.currentCityCode),p.value&&p.value.trim()&&(t.nickname=p.value.trim()),_.value&&g.value&&(t.latitude=_.value,t.longitude=g.value),d.value&&(t.service_id=d.value),e.index.__f__("log","at subPackages/friend/friend-select.vue:396","搜索参数:",t);const n=await A.searchCompanions(t);if(e.index.__f__("log","at subPackages/friend/friend-select.vue:400","API完整响应:",n),n.data&&n.data.code===0){const i=n.data.data;if(i&&i.list){const o=i.list.map(s=>({id:s.id,name:s.nickname,gender:s.gender,age:s.age,height:s.height,weight:s.weight,distance:s.distance,tags:s.tags||[],services:(()=>{if(typeof s.services=="string")try{return JSON.parse(s.services)}catch(I){return e.index.__f__("error","at subPackages/friend/friend-select.vue:419","解析services JSON失败:",I),[]}return s.services||[]})(),avatar:s.avatar,online:s.is_online===1,bookable:s.can_accept_orders==="Y"}));a?(c.value=o,T.value=1):(c.value=[...c.value,...o],T.value++),m.value=i.total||0,j.value=o.length===M.value,e.index.__f__("log","at subPackages/friend/friend-select.vue:441","搜索成功，共获取",o.length,"条数据，总数:",m.value),o.length}else e.index.__f__("log","at subPackages/friend/friend-select.vue:452","API返回数据为空"),a&&(c.value=[],m.value=0)}else{e.index.__f__("error","at subPackages/friend/friend-select.vue:460","API返回错误:",n.data);const i=((r=n.data)==null?void 0:r.message)||"搜索失败";e.index.showToast({title:i,icon:"none",duration:2e3}),a&&(c.value=[],m.value=0)}}catch(t){e.index.__f__("error","at subPackages/friend/friend-select.vue:474","搜索伴友师失败:",t),e.index.__f__("error","at subPackages/friend/friend-select.vue:475","错误详情:",t.response||t);let n="搜索失败，请重试";t.response&&t.response.data&&(n=t.response.data.message||n),e.index.showToast({title:n,icon:"none",duration:2e3}),a&&(c.value=[],m.value=0)}finally{f.value=!1,h.value=!0}}},N=()=>{!f.value&&j.value&&P(!1)},W=async()=>{b.value=!0,await P(!0),await new Promise(a=>setTimeout(a,800)),b.value=!1},Y=()=>{clearTimeout(x),x=setTimeout(()=>{P(!0)},500)};let x=null;const E=()=>{e.index.navigateBack({delta:1})},G=async a=>{e.index.vibrateShort({type:"light"}),await P(!0)};return e.onMounted(async()=>{const a=getCurrentPages(),t=a[a.length-1].options||{};t.service_id&&(d.value=t.service_id,e.index.__f__("log","at subPackages/friend/friend-select.vue:555","接收到的服务ID:",d.value));const n=e.index.getSystemInfoSync();B.value=n.statusBarHeight;const i=e.index.getMenuButtonBoundingClientRect();i.value=i;const o=n.screenWidth,s=i.right;L.value=o-s+24,await O.fetchServiceLevels(),await u.initCityData(),await P(!0)}),e.onUnmounted(()=>{x&&clearTimeout(x)}),(a,r)=>e.e({a:l._imports_0$8,b:e.o(E),c:e.o(t=>C.value=!0),d:l._imports_0$9,e:e.o([t=>p.value=t.detail.value,Y]),f:p.value,g:L.value+"px",h:B.value+"px",i:f.value&&!h.value},f.value&&!h.value?{}:y.value.length>0?{k:e.f(y.value,(t,n,i)=>e.e({a:t.avatar,b:t.online},t.online?{}:{},{c:e.t(t.name),d:t.gender==="女"},t.gender==="女"?{e:l._imports_3$2}:{f:l._imports_4$2},{g:e.t(t.age),h:e.t(t.height),i:e.t(t.weight),j:e.t(t.distance),k:e.f(t.visibleTags,(o,s,I)=>({a:e.t(o),b:s})),l:t.extraTags>0},t.extraTags>0?{m:e.t(t.extraTags)}:{},{n:e.o(o=>F(t),t.id),o:t.id,p:e.o(o=>J(t.id),t.id)})),l:l._imports_5}:h.value&&y.value.length===0?{n:l._imports_3}:{},{j:y.value.length>0,m:h.value&&y.value.length===0,o:e.o(N),p:b.value,q:e.o(W),r:e.o(G),s:e.o(t=>C.value=t),t:e.p({visible:C.value}),v:l._imports_7,w:e.o($),x:v.value.length>0},v.value.length>0?{y:e.f(v.value,(t,n,i)=>({a:a.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,(o,s,I)=>({a:e.t(o),b:o})),d:e.t(t.price),e:e.t(t.unit||"小时"),f:e.o(o=>H(t),t.title),g:t.title}))}:{z:l._imports_3},{A:U.value,B:e.sr(w,"b8e59853-2",{k:"servicePopup"}),C:e.o($),D:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})})}},te=e._export_sfc(ee,[["__scopeId","data-v-b8e59853"]]);wx.createPage(te);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/friend/friend-select.js.map

"use strict";const e=require("../../common/vendor.js"),g=require("../../common/assets.js"),M=require("../../api/friends.js");require("../../config/http.js");const Y=require("../../stores/level.js"),E=require("../../stores/city.js");Array||e.resolveComponent("uni-popup")();const G=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(K+Q+G)();const K=()=>"../../components/common/CitySelector.js",Q=()=>"../../components/common/CityPicker.js",R={__name:"friend-select",setup(A){const $=e.ref(0);e.ref(null);const B=e.ref(0),p=e.ref(""),x=e.ref(!1),C=e.ref(!1),v=e.ref(""),d=e.computed(()=>{var a;return((a=u.userLocation)==null?void 0:a.latitude)||null}),_=e.computed(()=>{var a;return((a=u.userLocation)==null?void 0:a.longitude)||null});e.ref(!1);const u=E.useCityStore();e.computed(()=>u.cityList),e.computed(()=>u.currentCity);const l=e.ref([]),m=e.ref(0),S=e.ref(1),I=e.ref(20),f=e.ref(!1),q=e.ref(!0),h=e.ref(!1),D=Y.useLevelStore(),y=e.computed(function(){return l.value.map(function(a){const s=a.tags?a.tags.slice(0,3):[],t=a.tags&&a.tags.length>3?a.tags.length-3:0;return{...a,visibleTags:s,extraTags:t}})}),w=e.ref(null),c=e.ref([]),k=e.ref(null),j=e.ref(0),z=async a=>{k.value=a;try{const s={city_code:u.currentCityCode,application_id:a.id};d.value&&_.value&&(s.latitude=parseFloat(d.value),s.longitude=parseFloat(_.value));const t=await M.getCityServices(s);if(t.data&&t.data.code===0){const n=t.data.data;n&&n.services&&n.services.length>0?c.value=n.services:c.value=[]}else c.value=[]}catch(s){e.index.__f__("error","at subPackages/friend/friend-select.vue:235","获取服务信息失败:",s),c.value=[]}w.value.open()},T=()=>{w.value.close()},F=a=>{e.index.__f__("log","at subPackages/friend/friend-select.vue:249","选择服务:",a),T();let s=`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${k.value.id}&level_order=${k.value.level_order||""}&nickname=${k.value.name}`;v.value&&(s+=`&original_service_id=${v.value}`),e.index.navigateTo({url:s})},H=a=>{let s="/subPackages/friend/detail?id="+a+"&city_code="+u.currentCityCode;d.value&&_.value&&(s+="&latitude="+d.value+"&longitude="+_.value),e.index.navigateTo({url:s})},P=async(a=!1)=>{var s;if(!f.value){f.value=!0;try{const t={page:a?1:S.value,page_size:I.value};u.currentCityCode&&(t.city_code=u.currentCityCode),p.value&&p.value.trim()&&(t.nickname=p.value.trim()),d.value&&_.value&&(t.latitude=d.value,t.longitude=_.value),v.value&&(t.service_id=v.value),e.index.__f__("log","at subPackages/friend/friend-select.vue:362","搜索参数:",t);const n=await M.searchCompanions(t);if(e.index.__f__("log","at subPackages/friend/friend-select.vue:366","API完整响应:",n),n.data&&n.data.code===0){const i=n.data.data;if(i&&i.list){const o=i.list.map(r=>({id:r.id,name:r.nickname,gender:r.gender,age:r.age,height:r.height,weight:r.weight,distance:r.distance,tags:r.tags||[],services:(()=>{if(typeof r.services=="string")try{return JSON.parse(r.services)}catch(L){return e.index.__f__("error","at subPackages/friend/friend-select.vue:385","解析services JSON失败:",L),[]}return r.services||[]})(),avatar:r.avatar,online:r.is_online===1,bookable:r.can_accept_orders==="Y"}));a?(l.value=o,S.value=1):(l.value=[...l.value,...o],S.value++),m.value=i.total||0,q.value=o.length===I.value,e.index.__f__("log","at subPackages/friend/friend-select.vue:407","搜索成功，共获取",o.length,"条数据，总数:",m.value),o.length}else e.index.__f__("log","at subPackages/friend/friend-select.vue:418","API返回数据为空"),a&&(l.value=[],m.value=0)}else{e.index.__f__("error","at subPackages/friend/friend-select.vue:426","API返回错误:",n.data);const i=((s=n.data)==null?void 0:s.message)||"搜索失败";e.index.showToast({title:i,icon:"none",duration:2e3}),a&&(l.value=[],m.value=0)}}catch(t){e.index.__f__("error","at subPackages/friend/friend-select.vue:440","搜索伴友师失败:",t),e.index.__f__("error","at subPackages/friend/friend-select.vue:441","错误详情:",t.response||t);let n="搜索失败，请重试";t.response&&t.response.data&&(n=t.response.data.message||n),e.index.showToast({title:n,icon:"none",duration:2e3}),a&&(l.value=[],m.value=0)}finally{f.value=!1,h.value=!0}}},J=()=>{!f.value&&q.value&&P(!1)},N=async()=>{x.value=!0,await P(!0),await new Promise(a=>setTimeout(a,800)),x.value=!1},O=()=>{clearTimeout(b),b=setTimeout(()=>{P(!0)},500)};let b=null;const U=()=>{e.index.navigateBack({delta:1})},W=async a=>{e.index.vibrateShort({type:"light"}),await P(!0)};return e.onMounted(async()=>{const a=getCurrentPages(),t=a[a.length-1].options||{};t.service_id&&(v.value=t.service_id,e.index.__f__("log","at subPackages/friend/friend-select.vue:521","接收到的服务ID:",v.value));const n=e.index.getSystemInfoSync();$.value=n.statusBarHeight;const i=e.index.getMenuButtonBoundingClientRect();i.value=i;const o=n.screenWidth,r=i.right;B.value=o-r+24,await D.fetchServiceLevels(),await u.initCityData(),await P(!0)}),e.onUnmounted(()=>{b&&clearTimeout(b)}),(a,s)=>e.e({a:g._imports_0$4,b:e.o(U),c:e.o(t=>C.value=!0),d:g._imports_1,e:e.o([t=>p.value=t.detail.value,O]),f:p.value,g:B.value+"px",h:$.value+"px",i:f.value&&!h.value},f.value&&!h.value?{}:y.value.length>0?{k:e.f(y.value,(t,n,i)=>e.e({a:t.avatar,b:t.online},t.online?{}:{},{c:e.t(t.name),d:e.t(t.distance),e:e.o(o=>z(t),t.id),f:t.id,g:e.o(o=>H(t.id),t.id)})),l:g._imports_2}:h.value&&y.value.length===0?{n:g._imports_3}:{},{j:y.value.length>0,m:h.value&&y.value.length===0,o:e.o(J),p:x.value,q:e.o(N),r:e.o(W),s:e.o(t=>C.value=t),t:e.p({visible:C.value}),v:g._imports_4,w:e.o(T),x:c.value.length>0},c.value.length>0?{y:e.f(c.value,(t,n,i)=>({a:a.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,(o,r,L)=>({a:e.t(o),b:o})),d:e.t(t.price),e:e.t(t.unit||"小时"),f:e.o(o=>F(t),t.title),g:t.title}))}:{z:g._imports_3},{A:j.value,B:e.sr(w,"b8e59853-2",{k:"servicePopup"}),C:e.o(T),D:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})})}},V=e._export_sfc(R,[["__scopeId","data-v-b8e59853"]]);wx.createPage(V);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/friend/friend-select.js.map

"use strict";const e=require("../../../common/vendor.js"),F=require("../../../common/assets.js"),M=require("../../../api/user.js"),ve=require("../../../api/home.js"),E=require("../../../api/file.js"),fe=require("../../../stores/user.js"),O=5*60*1e3,ge={__name:"index",setup(he){const U=fe.useUserStore();e.ref(!1);const w=e.ref(!1),h=e.ref(!1),i=e.reactive({nickname:"",gender:"",age:"",height:"",weight:"",city:"深圳市"}),b=e.ref(!1),o=e.ref([]),u=e.ref([]),_=e.ref([]),P=e.ref(!1),v=e.ref([]),x=e.ref([]),m=e.ref([]),T=e.ref(!1),f=e.ref([]),c=e.ref([]),k=e.ref(!1),d=e.ref([]),g=e.ref(!1),I=e.ref(4),y=e.ref([]),$=e.ref(new Map),L=e.ref(new Map),j=e.ref([{type:4,name:"个性特质"},{type:5,name:"我的爱好"},{type:6,name:"外貌风格"},{type:7,name:"专业技能"},{type:8,name:"热门推荐"}]),N=async()=>{if(o.value.length===0){x.value=[],f.value=[];return}T.value=!0;try{const n=o.value.map(a=>{const s=_.value.find(l=>l.name===a);return s?s.code:null}).filter(a=>a!==null);if(n.length===0){e.index.__f__("warn","at subPackages/friend/apply/index.vue:508","未找到有效的城市代码"),x.value=[],f.value=[];return}const t=await M.getServicesByCities(n);t.data&&t.data.code===0&&t.data.data?(x.value=t.data.data,R(),e.index.__f__("log","at subPackages/friend/apply/index.vue:522","服务技能列表加载成功:",x.value),e.index.__f__("log","at subPackages/friend/apply/index.vue:523","服务技能分组:",f.value)):(e.index.__f__("warn","at subPackages/friend/apply/index.vue:525","获取服务技能列表失败"),x.value=[],f.value=[])}catch(n){e.index.__f__("error","at subPackages/friend/apply/index.vue:530","获取服务技能列表失败:",n),x.value=[],f.value=[]}finally{T.value=!1}},R=()=>{const n={};x.value.forEach(t=>{const a=t.category,s=t.category_name||"其他";n[a]||(n[a]={id:a,name:s,services:[]}),n[a].services.push(t)}),f.value=Object.values(n).sort((t,a)=>t.id-a.id)},G=async()=>{P.value=!0;try{const n=await ve.getCityList();n.data&&n.data.code===0&&n.data.data?(_.value=n.data.data.map(t=>({name:t.name,code:t.city_code})),e.index.__f__("log","at subPackages/friend/apply/index.vue:575","申请页面区域列表加载成功:",_.value)):(e.index.__f__("warn","at subPackages/friend/apply/index.vue:577","获取区域列表失败"),_.value=[])}catch(n){e.index.__f__("error","at subPackages/friend/apply/index.vue:581","获取区域列表失败:",n),_.value=[]}finally{P.value=!1}},z=n=>{i.gender=n},V=()=>{u.value=[...o.value],b.value=!0},A=()=>{u.value=[],b.value=!1},H=n=>{const t=u.value.indexOf(n);t>-1?u.value.splice(t,1):u.value.push(n),e.index.vibrateShort({type:"light"})},J=n=>{const t=o.value.indexOf(n);t>-1&&(o.value.splice(t,1),e.index.vibrateShort({type:"light"}))},K=async()=>{if(u.value.length===0){e.index.showToast({title:"请至少选择一个服务区域",icon:"none"});return}o.value=[...u.value],i.city=o.value[0],b.value=!1,u.value=[],m.value=[],f.value=[],await N()},Q=()=>{const n=6-v.value.length;if(n<=0){e.index.showToast({title:"最多只能上传6张照片",icon:"none"});return}e.index.chooseImage({count:n,sizeType:["compressed"],sourceType:["album","camera"],success:async t=>{e.index.showLoading({title:"上传中...",mask:!0});try{const a=t.tempFilePaths.map(async(l,r)=>{try{const p=await W(l);if(e.index.__f__("log","at subPackages/friend/apply/index.vue:696","fileInfo",p),e.index.__f__("log","at subPackages/friend/apply/index.vue:697","filePath",l),!p||!p.extension)throw new Error("无法获取文件信息");const D=await E.uploadFile({filePath:l,name:`photo_${Date.now()}_${r}.${p.extension}`}),S=E.getUploadResult(D);if(!S||!S.url)throw new Error("上传结果解析失败");return S.url}catch(p){throw e.index.__f__("error","at subPackages/friend/apply/index.vue:716",`第${r+1}张照片上传失败:`,p),p}}),s=await Promise.all(a);v.value.push(...s),e.index.showToast({title:`成功上传${s.length}张照片`,icon:"success"})}catch(a){e.index.__f__("error","at subPackages/friend/apply/index.vue:733","照片上传失败:",a),e.index.showToast({title:"照片上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:t=>{e.index.__f__("error","at subPackages/friend/apply/index.vue:743","选择照片失败:",t),e.index.showToast({title:"选择照片失败",icon:"none"})}})},W=n=>new Promise((t,a)=>{e.index.getFileInfo({filePath:n,success:s=>{const l=n.split(".").pop().toLowerCase();t({size:s.size,extension:l})},fail:s=>{e.index.__f__("error","at subPackages/friend/apply/index.vue:766","获取文件信息失败:",s);const l=n.split(".").pop().toLowerCase()||"jpg";t({size:0,extension:l})}})}),X=n=>{e.index.previewImage({urls:v.value,current:n})},Y=n=>{v.value.splice(n,1)},Z=n=>{const t=n.id,a=m.value.indexOf(t);a>-1?m.value.splice(a,1):m.value.push(t),e.index.vibrateShort({type:"light"})},ee=()=>{h.value=!h.value,e.index.vibrateShort({type:"light"})},ae=()=>{e.index.showToast({title:"协议功能待开发",icon:"none"})},ne=async()=>{if(w.value)return;if(!h.value){e.index.showToast({title:"请先同意友伴服务协议",icon:"none",duration:2e3});return}if(!i.nickname.trim()){e.index.showToast({title:"请输入昵称",icon:"none"});return}if(i.nickname.length>50){e.index.showToast({title:"昵称不能超过50个字符",icon:"none"});return}if(!i.gender){e.index.showToast({title:"请选择性别",icon:"none"});return}const n=parseInt(i.age),t=parseInt(i.height),a=parseInt(i.weight);if(!n||n<18||n>65){e.index.showToast({title:"年龄必须在18-65岁之间",icon:"none"});return}if(!t||t<100||t>250){e.index.showToast({title:"身高必须在100-250cm之间",icon:"none"});return}if(!a||a<30||a>200){e.index.showToast({title:"请输入合理的体重",icon:"none"});return}if(o.value.length===0){e.index.showToast({title:"请至少选择一个服务区域",icon:"none"});return}if(v.value.length===0){e.index.showToast({title:"请上传至少一张生活照",icon:"none"});return}if(v.value.length>9){e.index.showToast({title:"最多只能上传9张照片",icon:"none"});return}if(m.value.length===0){e.index.showToast({title:"请至少选择一项服务技能",icon:"none"});return}e.index.showModal({title:"确认提交",content:"确定要提交入驻申请吗？提交后将进入审核流程。",success:async s=>{s.confirm&&await te()}})},te=async()=>{w.value=!0;try{const n=o.value.map(s=>{const l=_.value.find(r=>r.name===s);return l?String(l.code):null}).filter(s=>s!==null);if(n.length===0){e.index.showToast({title:"服务区域数据异常，请重新选择",icon:"none"});return}const t={nickname:i.nickname.trim(),gender:i.gender==="male"?"男":"女",age:parseInt(i.age),height:parseInt(i.height),weight:parseInt(i.weight),service_areas:n,services:m.value,can_accept_orders:"N",photos:v.value,tags:c.value.map(s=>s.tag_name),phone:U.userInfo.phone||""};e.index.__f__("log","at subPackages/friend/apply/index.vue:972","提交数据:",t);const a=await M.createCompanionApplication(t);if(e.index.__f__("log","at subPackages/friend/apply/index.vue:977","接口响应:",a),a&&a.data&&a.data.code===0)e.index.showModal({title:"入驻成功 🎉",content:"恭喜您！入驻申请已通过，您已成功成为友伴师。",showCancel:!1,confirmText:"我知道了",success:()=>{e.index.$emit("applicationStatusChanged",{status:"approved",message:"入驻申请已通过"}),e.index.navigateBack()}});else{const s=a&&a.data&&a.data.message||"提交失败，请稍后重试";e.index.showModal({title:"提交失败",content:s,showCancel:!1,confirmText:"我知道了"})}}catch(n){e.index.__f__("error","at subPackages/friend/apply/index.vue:1014","提交失败:",n);let t="提交失败，请稍后重试";n&&n.message&&(n.message.includes("网络")?t="网络连接异常，请检查网络后重试":n.message.includes("参数")?t="提交信息有误，请检查后重试":n.message.includes("重复")?t="您已提交过申请，请勿重复提交":t=n.message),e.index.showModal({title:"提交失败",content:t,showCancel:!1,confirmText:"我知道了"})}finally{w.value=!1}};e.onMounted(async()=>{await G(),e.index.__f__("log","at subPackages/friend/apply/index.vue:1047","标签缓存配置:",{expireTime:`${O/1e3/60}分钟`,cacheSize:$.value.size})});const se=()=>{d.value=[...c.value],k.value=!0,B(4)},q=()=>{d.value=[],k.value=!1},ie=n=>{I.value=n,B(n)},le=n=>{const t=L.value.get(n);return t?Date.now()-t<O:!1},oe=n=>$.value.get(n)||[],re=(n,t)=>{$.value.set(n,t),L.value.set(n,Date.now()),e.index.__f__("log","at subPackages/friend/apply/index.vue:1095",`标签类型${n}已缓存，数据量: ${t.length}`)},B=async(n,t=!1)=>{if(!t&&le(n)){const a=oe(n);if(a.length>0){e.index.__f__("log","at subPackages/friend/apply/index.vue:1120",`使用缓存数据 - 标签类型${n}，数据量: ${a.length}`),y.value=a;return}}g.value=!0;try{e.index.__f__("log","at subPackages/friend/apply/index.vue:1128",`开始加载标签类型: ${n}`);const a={tag_type:n,page:1,pageSize:60};e.index.__f__("log","at subPackages/friend/apply/index.vue:1136","请求参数:",a);const s=await M.getPersonalityTags(a);if(e.index.__f__("log","at subPackages/friend/apply/index.vue:1139","API响应:",s),s.data&&s.data.code===0&&s.data.data){const l=s.data.data.list||s.data.data;y.value=l,re(n,l),e.index.__f__("log","at subPackages/friend/apply/index.vue:1149",`标签类型${n}加载成功:`,l)}else e.index.__f__("warn","at subPackages/friend/apply/index.vue:1151",`获取标签类型${n}失败，响应数据:`,s),y.value=[]}catch(a){e.index.__f__("error","at subPackages/friend/apply/index.vue:1155",`获取标签类型${n}失败:`,a),e.index.__f__("error","at subPackages/friend/apply/index.vue:1156","错误详情:",a.response||a),y.value=[]}finally{g.value=!1}},C=n=>d.value.some(t=>t.id===n),ue=n=>{const t=d.value.findIndex(a=>a.id===n.id);if(t>-1)d.value.splice(t,1);else{if(d.value.length>=5){e.index.showToast({title:"最多只能选择5个标签",icon:"none"});return}d.value.push(n)}e.index.vibrateShort({type:"light"})},ce=()=>{c.value=[...d.value],k.value=!1,d.value=[],e.index.showToast({title:`已选择${c.value.length}个标签`,icon:"success"})},de=n=>{const t=c.value.findIndex(a=>a.id===n.id);t>-1&&(c.value.splice(t,1),e.index.vibrateShort({type:"light"}))};return(n,t)=>e.e({a:i.nickname,b:e.o(a=>i.nickname=a.detail.value),c:F._imports_4$2,d:i.gender==="male"?1:"",e:e.o(a=>z("male")),f:F._imports_3$2,g:i.gender==="female"?1:"",h:e.o(a=>z("female")),i:i.age,j:e.o(a=>i.age=a.detail.value),k:i.height,l:e.o(a=>i.height=a.detail.value),m:i.weight,n:e.o(a=>i.weight=a.detail.value),o:o.value.length===0},o.value.length===0?{}:{p:e.t(o.value.length)},{q:e.o(V),r:o.value.length>0},o.value.length>0?{s:e.f(o.value,(a,s,l)=>({a:e.t(a),b:a,c:e.o(r=>J(a),a)}))}:{},{t:e.f(v.value,(a,s,l)=>({a:n.$imgBaseUrl+a,b:e.o(r=>Y(s),s),c:s,d:e.o(r=>X(s),s)})),v:v.value.length<6},v.value.length<6?{w:e.o(Q)}:{},{x:T.value},T.value?{}:o.value.length===0?{}:f.value.length>0?{A:e.f(f.value,(a,s,l)=>({a:e.t(a.name),b:e.f(a.services,(r,p,D)=>({a:e.t(r.name),b:m.value.includes(r.id)?1:"",c:r.id,d:e.o(S=>Z(r),r.id)})),c:a.id}))}:{},{y:o.value.length===0,z:f.value.length>0,B:c.value.length>0},c.value.length>0?{C:e.f(c.value,(a,s,l)=>({a:e.t(a.tag_name),b:a.id,c:e.o(r=>de(a),a.id)}))}:{},{D:e.t(c.value.length),E:c.value.length>=5?1:"",F:e.o(a=>c.value.length<5?se():null),G:h.value},h.value?{}:{},{H:h.value?1:"",I:e.o(ae),J:e.o(ee),K:!w.value},w.value?{}:{},{L:w.value||!h.value?1:"",M:e.o(ne),N:b.value},b.value?e.e({O:e.o(A),P:P.value},P.value?{}:{Q:e.f(_.value,(a,s,l)=>e.e({a:e.t(a.name),b:u.value.includes(a.name)},u.value.includes(a.name)?{}:{},{c:s,d:e.n({active:u.value.includes(a.name)}),e:e.o(r=>H(a.name),s)}))},{R:e.t(u.value.length),S:e.o(K),T:e.o(()=>{}),U:e.o(A)}):{},{V:k.value},k.value?e.e({W:e.o(q),X:e.f(j.value,(a,s,l)=>({a:e.t(a.name),b:a.type,c:e.n({active:I.value===a.type}),d:e.o(r=>ie(a.type),a.type)})),Y:!g.value&&d.value.length>=5},!g.value&&d.value.length>=5?{}:{},{Z:g.value},g.value?{}:{aa:e.f(y.value,(a,s,l)=>e.e({a:e.t(a.tag_name),b:C(a.id)},C(a.id)?{}:{},{c:a.id,d:e.n({selected:C(a.id)}),e:e.o(r=>ue(a),a.id)}))},{ab:!g.value&&y.value.length===0},!g.value&&y.value.length===0?{}:{},{ac:e.t(d.value.length),ad:e.o(ce),ae:e.o(()=>{}),af:e.o(q)}):{})}},pe=e._export_sfc(ge,[["__scopeId","data-v-eb2c0b40"]]);wx.createPage(pe);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/friend/apply/index.js.map

"use strict";const e=require("../../common/vendor.js"),y=require("../../common/assets.js"),b=require("../../api/discover.js");if(!Array){const P=e.resolveComponent("u-avatar"),$=e.resolveComponent("u-icon"),r=e.resolveComponent("u-input"),T=e.resolveComponent("u-popup");(P+$+r+T)()}const Q=()=>"../../uni_modules/uview-plus/components/u-avatar/u-avatar.js",W=()=>"../../uni_modules/uview-plus/components/u-icon/u-icon.js",X=()=>"../../uni_modules/uview-plus/components/u-input/u-input.js",Y=()=>"../../uni_modules/uview-plus/components/u-popup/u-popup.js";Math||(Q+Z+W+X+Y)();const Z=()=>"../../components/common/PictureDisplay.js",ee={__name:"comment",props:{userLocation:{type:Object,default:null},cityStore:{type:Object,default:null}},setup(P){const $=e.ref(e.getCurrentInstance().proxy),r=P,T=e.ref(0),B=e.ref(0),k=e.ref(""),D=e.ref(1),_=e.ref(0),w=e.ref(!1),u=e.ref({}),d=e.ref([]),s=e.ref([]),m=e.ref(""),p=e.ref(""),h=e.ref("友好发言，文明聊天"),v=e.ref(!1);e.onLoad(a=>{$.value.getOpenerEventChannel().on("getRecord",async t=>{k.value=t.data.moments_info.moments_id,U()}),p.value="",h.value="友好发言，文明聊天"});const U=async a=>{var o;try{const t=await b.getMomentsDetail({moments_id:k.value});if(t.data&&t.data.code===0){const n=t.data.data;n.companion_info&&(u.value={user_id:n.companion_info.id,nick_name:n.companion_info.nickname,head_img:n.companion_info.avatar,icon_list:[{icon:{color:n.companion_info.gender==="女"?"rgba(252, 139, 198, 1)":"rgba(19, 98, 235, 1)",icon:n.companion_info.gender==="女"?"/static/find/nd_icon.png":"/static/find/nand_icon.png"},data:`${n.companion_info.age}岁`},{icon:{color:"rgba(62, 178, 240, 1)"},data:`${n.companion_info.height}cm`},{icon:{color:"linear-gradient(180deg, rgba(155, 59, 235, 1) 0%, rgba(230, 126, 188, 1) 100%)"},data:`${n.companion_info.weight}kg`}]}),n.moments_info&&(s.value={moments_id:n.moments_info.moments_id,content:n.moments_info.content,file_list:n.moments_info.file_list||[],topic_list:n.moments_info.topic_list||[],is_praised:n.moments_info.is_praised,praise_num:n.moments_info.praise_num,comments_num:n.moments_info.comments_num,is_liked:n.moments_info.is_liked}),S(1)}else e.index.__f__("error","at subPackages/record/comment.vue:286","获取动态详情失败:",(o=t.data)==null?void 0:o.message),e.index.showToast({title:"获取动态详情失败",icon:"none"})}catch(t){e.index.__f__("error","at subPackages/record/comment.vue:293","获取动态详情出错:",t),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},S=async a=>{var o;try{const t=await b.getMomentCommentList({moments_id:k.value,page:a,page_size:10});if(t.data&&t.data.code===0){const n=t.data.data;a===1?(d.value=n.comments_list||[],_.value=n.total||0,w.value=!0):n.comments_list&&n.comments_list.length>0&&(d.value.push(...n.comments_list),D.value=n.page)}else e.index.__f__("error","at subPackages/record/comment.vue:324","获取评论列表失败:",(o=t.data)==null?void 0:o.message),I()}catch(t){e.index.__f__("error","at subPackages/record/comment.vue:329","获取评论列表出错:",t),I()}},I=()=>{d.value=[{comments_id:"1",user_id:"2",nick_name:"评论用户1",head_img:"/static/images/empty.png",content:"这是一条测试评论",content_time:"2024-01-01 12:00",comments_list:[{comments_id:"1-1",user_id:"3",nick_name:"回复用户1",reply_nick_name:"评论用户1",head_img:"/static/images/empty.png",content:"这是一条回复",content_time:"2024-01-01 12:05"}],has_more:!1},{comments_id:"2",user_id:"4",nick_name:"评论用户2",head_img:"/static/images/empty.png",content:"这是另一条测试评论",content_time:"2024-01-01 12:10",comments_list:[],has_more:!1}],_.value=2,w.value=!0},q=()=>{e.index.__f__("log","at subPackages/record/comment.vue:377","监听页面滚动到底部"),S(D.value+1)},x=a=>{p.value=a.comments_id,h.value="回复@"+a.nick_name,v.value=!0},E=async()=>{var a;if(v.value=!1,!m.value.trim()){e.index.showToast({title:"请输入评论内容",icon:"none",duration:1e3});return}try{const o={moments_id:k.value,content:m.value};p.value&&(o.reply_comments_id=p.value);const t=await b.pushMomentComment(o);if(t.data&&t.data.code===0){const n=t.data.data.res_data;p.value?(d.value.forEach(c=>{c.comments_id==n.parent_id&&c.comments_list.push(n)}),p.value="",h.value="友好发言，文明聊天"):d.value.unshift(n),_.value=n.total,s.value.comments_num=n.total,m.value="",e.index.showToast({title:"评论成功!",icon:"none",duration:500})}else e.index.showToast({title:((a=t.data)==null?void 0:a.message)||"评论失败!",icon:"none",duration:1e3})}catch(o){e.index.__f__("error","at subPackages/record/comment.vue:451","发布评论出错:",o),e.index.showToast({title:"网络错误，请重试",icon:"none",duration:1e3})}},N=async a=>{var o;e.index.__f__("log","at subPackages/record/comment.vue:462","展开更多回复",a);try{const t=await b.getMoreMomentCommentList({comments_id:a.comments_id,page:1,page_size:10});if(t.data&&t.data.code===0){const n=t.data.data;a.comments_list=n.more_list||[],a.has_more=n.has_more||!1}else e.index.__f__("error","at subPackages/record/comment.vue:475","获取更多回复失败:",(o=t.data)==null?void 0:o.message)}catch(t){e.index.__f__("error","at subPackages/record/comment.vue:478","获取更多回复出错:",t)}},R=a=>{B.value=a.detail.scrollTop},j=()=>{},M=a=>{},H=()=>{e.index.navigateTo({url:"/pages/detail/detail",animationType:"slide-in-bottom",animationDuration:200,success(a){a.eventChannel.emit("getUserId",{val:u.value.user_id})}})},F=a=>{e.index.navigateTo({url:"/pages/detail/detail",animationType:"slide-in-bottom",animationDuration:200,success(o){o.eventChannel.emit("getUserId",{val:a.user_id})}})},V=()=>{v.value=!0},A=a=>{e.index.showToast({title:"打招呼功能开发中",icon:"none",duration:1e3})},f=(a,o="add",t=1)=>{const n=parseInt(a)||0;return o==="add"?n+t:o==="subtract"?Math.max(0,n-t):n},G=async a=>{try{const o=s.value.is_praised;s.value.is_praised=!o,s.value.is_praised?s.value.praise_num=f(s.value.praise_num,"add",1):s.value.praise_num=f(s.value.praise_num,"subtract",1);const t=await b.praiseMoment({target_id:a.target_id});t.data&&t.data.code===0?e.index.__f__("log","at subPackages/record/comment.vue:584","点赞成功"):(s.value.is_praised=o,o?s.value.praise_num=f(s.value.praise_num,"add",1):s.value.praise_num=f(s.value.praise_num,"subtract",1),e.index.showToast({title:"点赞失败，请重试",icon:"none"}))}catch(o){e.index.__f__("error","at subPackages/record/comment.vue:600","点赞失败:",o);const t=s.value.is_praised;s.value.is_praised=!t,t?s.value.praise_num=f(s.value.praise_num,"add",1):s.value.praise_num=f(s.value.praise_num,"subtract",1),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},J=async()=>{try{const a=u.value;if(!a||!a.user_id){e.index.showToast({title:"用户信息不完整",icon:"none"});return}const o=["110100","310100","440100"];if(o.length===1){const t=o[0];await L(a.user_id,t);return}if(r.userLocation){const t=await K(o,r.userLocation.latitude,r.userLocation.longitude);await L(a.user_id,t,r.userLocation.latitude,r.userLocation.longitude)}else{const t=o[0];await L(a.user_id,t)}}catch(a){e.index.__f__("error","at subPackages/record/comment.vue:651","邀约失败:",a),e.index.showToast({title:"邀约失败，请重试",icon:"none"})}},K=async(a,o,t)=>{var g,C;r.cityStore&&r.cityStore.cityList.length===0&&await r.cityStore.loadCityList(),e.index.__f__("log","at subPackages/record/comment.vue:665","城市列表:",(g=r.cityStore)==null?void 0:g.cityList),e.index.__f__("log","at subPackages/record/comment.vue:666","城市列表serviceAreas:",a);const n=((C=r.cityStore)==null?void 0:C.cityList.filter(l=>a.includes(l.code.toString())))||[];if(n.length===0)return e.index.__f__("warn","at subPackages/record/comment.vue:673","未找到对应的服务城市，使用第一个服务区域"),a[0];if(n.length===1)return n[0].code;let c=n[0],i=1/0;return n.forEach(l=>{var z;if(l.latitude&&l.longitude){const O=((z=r.cityStore)==null?void 0:z.calculateDistance(o,t,l.latitude,l.longitude))||1/0;O<i&&(i=O,c=l)}}),e.index.__f__("log","at subPackages/record/comment.vue:702",`选择最近的服务城市: ${c.name}, 距离: ${i.toFixed(2)}km`),c.code},L=async(a,o,t=null,n=null)=>{let c="/subPackages/friend/detail?id="+a+"&city_code="+o;t&&n&&(c+="&latitude="+t+"&longitude="+n),e.index.navigateTo({url:c})};return(a,o)=>e.e({a:e.p({src:a.$imgBaseUrl+u.value.head_img,size:"38",shape:"circle"}),b:e.o(t=>H()),c:e.t(u.value.nick_name),d:u.value.icon_list},u.value.icon_list?{e:e.f(u.value.icon_list,(t,n,c)=>{var i,g;return e.e({a:t.icon.icon},t.icon.icon?{b:(i=t.icon)==null?void 0:i.icon}:{},{c:e.t(t.data),d:`${(g=t.icon)==null?void 0:g.color}`,e:t})})}:{},{f:e.o(t=>J()),g:e.t(s.value.content),h:s.value.file_list&&s.value.file_list.length>0},s.value.file_list&&s.value.file_list.length>0?{i:e.p({list:s.value.file_list,topicList:s.value.topic_list})}:{},{j:!s.value.is_praised},s.value.is_praised?{}:{k:y._imports_1$1},{l:s.value.is_praised},s.value.is_praised?{m:y._imports_2}:{},{n:e.t(s.value.praise_num||0),o:e.o(t=>G({target_id:s.value.moments_id})),p:y._imports_4$1,q:e.o(t=>A(u.value.user_id)),r:w.value},w.value?e.e({s:e.t(_.value),t:_.value==0},_.value==0?{v:y._imports_3$1}:{w:e.f(d.value,(t,n,c)=>e.e({a:"45c029ce-2-"+c,b:e.p({src:a.$imgBaseUrl+t.head_img,size:"32",shape:"circle"}),c:e.o(i=>F(t),t.comments_id),d:e.t(t.nick_name),e:e.t(t.content),f:e.t(t.content_time),g:e.o(i=>x(t),t.comments_id),h:e.o(i=>x(t),t.comments_id),i:e.f(t.comments_list,(i,g,C)=>({a:"45c029ce-3-"+c+"-"+C,b:e.p({src:a.$imgBaseUrl+i.head_img,size:"22",shape:"circle"}),c:e.o(l=>F(i),i.comments_id),d:e.t(i.nick_name),e:e.t(i.reply_nick_name),f:e.t(i.content),g:e.t(i.content_time),h:e.o(l=>x(i),i.comments_id),i:e.o(l=>x(i),i.comments_id),j:i.comments_id})),j:t.has_more},t.has_more?{k:"45c029ce-4-"+c,l:e.p({name:"arrow-down",color:"#7363FF",size:"14"}),m:e.o(i=>N(t),t.comments_id)}:{},{n:t.comments_id})),x:y._imports_4}):{},{y:T.value,z:e.o(R),A:e.o(q),B:e.o(M),C:e.o(j),D:e.o(t=>m.value=t),E:e.p({placeholder:h.value,border:"surround",fontSize:"24rpx",color:"#1a1a1a",shape:"circle",adjustPosition:!0,disabled:!0,customStyle:{paddingLeft:"24rpx",background:"#F2F2F2"},modelValue:m.value}),F:e.o(()=>{}),G:e.o(V),H:e.o(M),I:e.o(j),J:e.o(t=>m.value=t),K:e.p({focus:v.value,placeholder:h.value,border:"surround",fontSize:"24rpx",color:"#1a1a1a",shape:"circle",adjustPosition:!0,customStyle:{paddingLeft:"24rpx",background:"#F2F2F2"},modelValue:m.value}),L:m.value,M:e.o(E),N:e.o(()=>{}),O:e.o(t=>v.value=!1),P:e.p({show:v.value,round:"10"})})}},te=e._export_sfc(ee,[["__scopeId","data-v-45c029ce"]]);wx.createPage(te);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/record/comment.js.map

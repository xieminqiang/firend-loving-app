"use strict";const e=require("../../common/vendor.js"),S=require("../../common/assets.js"),k=require("../../api/discover.js"),m=require("../../api/file.js");if(!Array){const g=e.resolveComponent("u-icon"),r=e.resolveComponent("u--textarea"),d=e.resolveComponent("u-action-sheet");(g+r+d)()}const N=()=>"../../uni_modules/uview-plus/components/u-icon/u-icon.js",A=()=>"../../uni_modules/uview-plus/components/u--textarea/u--textarea.js",C=()=>"../../uni_modules/uview-plus/components/u-action-sheet/u-action-sheet.js";Math||(N+A+C)();const v=9,V={__name:"index",setup(g){const{proxy:r}=e.getCurrentInstance(),d=e.ref([]),h=e.ref(116.397128),x=e.ref(39.916527),_=e.ref("");e.onLoad(()=>{e.index.__f__("log","at subPackages/release/index.vue:172","发布页面加载完成"),P()});const P=async()=>{try{const a=await k.getMomentsRequest();a.data.code===0?d.value=a.data.data.topic_list||[]:e.index.__f__("warn","at subPackages/release/index.vue:188","获取动态请求数据失败:",a.data.msg)}catch{}finally{e.index.hideLoading()}};e.ref(!1);const u=e.reactive({imgList:[],content:"",status:1,location:"",location_desc:"",topics:[],object_keys:[]}),c=e.ref([]),p=e.ref(!1),M=[{name:"拍照",value:"camera"},{name:"从相册选择",value:"album"},{name:"拍摄视频",value:"video"}],j=()=>{p.value=!0},T=a=>{switch(p.value=!1,a.value){case"camera":b("camera");break;case"album":b("album");break;case"video":L();break}},b=a=>{e.index.chooseImage({count:v-c.value.length,sourceType:[a],sizeType:["compressed"],success:s=>{I(s.tempFilePaths)},fail:s=>{e.index.__f__("error","at subPackages/release/index.vue:250","选择图片失败:",s),e.index.showToast({title:"选择图片失败",icon:"none"})}})},L=()=>{e.index.chooseVideo({sourceType:["album","camera"],maxDuration:60,camera:"back",success:a=>{B(a)},fail:a=>{e.index.__f__("error","at subPackages/release/index.vue:269","选择视频失败:",a),e.index.showToast({title:"选择视频失败",icon:"none"})}})},I=async a=>{for(const s of a){const o={type:"image",url:s,status:"uploading",filePath:s,fileName:s.split("/").pop()||"image.jpg"};e.index.showLoading({title:"上传中..."});try{const i=await m.uploadFile({filePath:s,name:o.fileName}),t=m.getUploadResult(i);if(e.index.hideLoading(),t)o.status="success",o.objectKey=t.objectKey,o.url=t.url,o.uploadedUrl=t.url,c.value.push(o),e.index.__f__("log","at subPackages/release/index.vue:308","图片上传成功:",t);else throw new Error("上传结果解析失败")}catch(i){e.index.__f__("error","at subPackages/release/index.vue:313","图片上传失败:",i),o.status="failed",o.errorMsg=i.message,e.index.showToast({title:"图片上传失败",icon:"none"})}}},B=async a=>{const s={type:"video",url:a.tempFilePath,cover:a.thumbTempFilePath,duration:a.duration,size:a.size,status:"uploading",filePath:a.tempFilePath,fileName:a.tempFilePath.split("/").pop()||"video.mp4"};e.index.showLoading({title:"上传中..."});try{const o=await m.uploadFile({filePath:a.tempFilePath,name:s.fileName}),i=m.getUploadResult(o);if(e.index.hideLoading(),i)s.status="success",s.objectKey=i.objectKey,s.url=i.url,s.uploadedUrl=i.url,s.cover=i.cover||a.thumbTempFilePath,c.value.push(s),e.index.__f__("log","at subPackages/release/index.vue:358","视频上传成功:",i);else throw new Error("上传结果解析失败")}catch(o){e.index.__f__("error","at subPackages/release/index.vue:363","视频上传失败:",o),s.status="failed",s.errorMsg=o.message,e.index.showToast({title:"视频上传失败",icon:"none"})}},y=a=>{const s=c.value[a];if(s.type==="image"){const o=c.value.filter(n=>n.type==="image"),i=o.map(n=>r.$imgBaseUrl+n.url),t=o.findIndex(n=>n===s);e.index.previewImage({urls:i,current:t>=0?t:0,indicator:"number",loop:!0,show:!0,success:function(n){e.index.__f__("log","at subPackages/release/index.vue:390","图片预览成功",n)},fail:function(n){e.index.__f__("error","at subPackages/release/index.vue:393","图片预览失败",n)}})}else s.type==="video"&&e.index.__f__("log","at subPackages/release/index.vue:398","视频播放:",s.url)},F=a=>{e.index.showModal({title:"提示",content:"确定要删除这个文件吗？",success:s=>{s.confirm&&c.value.splice(a,1)}})},f=e.ref(""),l=e.ref(!1),w=e.computed(()=>f.value.trim().length>0),$=e.computed(()=>u.topics.map(a=>a.topic_id)),U=a=>{let s=u.topics.indexOf(a);s===-1&&u.topics.push(a),s!==-1&&u.topics.splice(s,1)},z=()=>{e.index.chooseLocation({success:a=>{const s=a.address||a.name||"已选择位置";e.index.__f__("log","at subPackages/release/index.vue:489","手动选择位置",a),_.value=s,h.value=a.longitude,x.value=a.latitude},fail:a=>{a.errMsg&&a.errMsg.indexOf("cancel")===-1&&(e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/release/index.vue:508","获取位置失败:",a.errMsg))}})},q=async()=>{if(!w.value||l.value)return;l.value=!0;const a=c.value.filter(t=>t.status==="success").map(t=>{if(t.type==="image")return{media_type:1,object_key:t.objectKey,url:t.uploadedUrl,file_name:t.fileName};if(t.type==="video")return{media_type:2,object_key:t.objectKey,url:t.uploadedUrl,file_name:t.fileName,cover:t.cover,duration:t.duration,size:t.size}}).filter(Boolean),s=a.map(t=>t.object_key).filter(Boolean),o=u.topics.map(t=>({topic_id:t.topic_id,topic_desc:t.topic_desc,topic_icon:t.topic_icon}));let i={content:f.value,status:1,location:`${h.value},${x.value}`,location_desc:_.value,topics:o,object_keys:s,media_list:a,image_count:a.filter(t=>t.media_type===1).length,video_count:a.filter(t=>t.media_type===2).length};e.index.__f__("log","at subPackages/release/index.vue:577","发布参数:",i);try{e.index.showLoading({title:"发布中..."});const t=await k.pushMoments(i);t.data.code===0?(e.index.showToast({title:"发布成功",icon:"success",duration:2e3}),setTimeout(()=>{e.index.navigateBack({delta:1})},2e3)):e.index.showToast({title:t.data.msg||"发布失败",icon:"none",duration:2e3})}catch(t){e.index.__f__("error","at subPackages/release/index.vue:605","发布失败:",t),e.index.showToast({title:"发布失败，请重试",icon:"none",duration:2e3})}finally{e.index.hideLoading(),l.value=!1}},K=()=>{e.index.navigateBack({delta:1})};return(a,s)=>e.e({a:e.p({color:"#000",size:"24",name:"close"}),b:e.o(K),c:e.o(o=>f.value=o),d:e.p({placeholder:"请输入内容",border:"bottom",modelValue:f.value}),e:e.f(u.topics,(o,i,t)=>({a:e.t(o.topic_desc),b:o.topic_id})),f:e.f(c.value,(o,i,t)=>e.e({a:o.type==="video"},o.type==="video"?{b:e.unref(r).$imgBaseUrl+o.url,c:e.o(n=>y(i),i)}:{d:e.unref(r).$imgBaseUrl+o.url,e:e.o(n=>y(i),i)},{f:"571672a9-2-"+t,g:e.o(n=>F(i),i),h:i,i:o.type==="video"?1:""})),g:e.p({name:"close",color:"#fff",size:"16"}),h:c.value.length<v},c.value.length<v?{i:e.p({name:"plus",color:"#999",size:"32"}),j:e.o(j)}:{},{k:e.f(d.value,(o,i,t)=>({a:e.t(o.topic_desc),b:$.value.indexOf(o.topic_id)>-1?1:"",c:o.topic_id,d:e.o(n=>U(o),o.topic_id)})),l:S._imports_0$3,m:e.t(_.value===""?"不显示位置":_.value),n:e.o(z),o:e.o(o=>p.value=!1),p:e.o(T),q:e.p({show:p.value,actions:M}),r:l.value},l.value?{}:{},{s:!l.value},l.value?{}:{},{t:l.value||!w.value?1:"",v:e.o(q)})}},O=e._export_sfc(V,[["__scopeId","data-v-571672a9"]]);wx.createPage(O);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/release/index.js.map

"use strict";const e=require("../../../../common/vendor.js"),h=require("../../../../stores/user.js"),f=require("../../../../api/user.js"),r=require("../../../../api/file.js"),x={__name:"edit",setup(k){const c=h.useUserStore();e.computed(()=>c.userInfo||{});const t=e.reactive({head_img:"",nick_name:""}),o=e.ref({}),_=e.computed(()=>t.head_img!==o.value.head_img||t.nick_name!==o.value.nick_name);e.onLoad(()=>{const n=c.userInfo||{};o.value={...n},t.head_img=n.head_img||"",t.nick_name=n.nick_name||"",e.index.__f__("log","at subPackages/settings/pages/index/edit.vue:81","当前用户头像:",n.head_img),e.index.__f__("log","at subPackages/settings/pages/index/edit.vue:82","临时头像数据:",t.head_img)});const g=()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async n=>{const a=n.tempFilePaths[0];e.index.__f__("log","at subPackages/settings/pages/index/edit.vue:110","选择的头像:",a),e.index.showLoading({title:"上传中...",mask:!0});try{const i=await u(a);if(e.index.__f__("log","at subPackages/settings/pages/index/edit.vue:121","fileInfo",i),e.index.__f__("log","at subPackages/settings/pages/index/edit.vue:122","filePath",a),!i||!i.extension)throw new Error("无法获取文件信息");const d=await r.uploadFile({filePath:a,name:`avatar_${Date.now()}.${i.extension}`}),s=r.getUploadResult(d);if(!s||!s.url)throw new Error("上传结果解析失败");t.head_img=s.url,e.index.showToast({title:"头像上传成功",icon:"success"})}catch(i){e.index.__f__("error","at subPackages/settings/pages/index/edit.vue:149","头像上传失败:",i),e.index.showToast({title:"头像上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:n=>{e.index.__f__("error","at subPackages/settings/pages/index/edit.vue:159","选择头像失败:",n),e.index.showToast({title:"选择头像失败",icon:"none"})}})},u=n=>new Promise((a,i)=>{e.index.getFileInfo({filePath:n,success:d=>{const s=n.split(".").pop().toLowerCase();a({size:d.size,extension:s})},fail:d=>{e.index.__f__("error","at subPackages/settings/pages/index/edit.vue:182","获取文件信息失败:",d);const s=n.split(".").pop().toLowerCase()||"jpg";a({size:0,extension:s})}})}),l=n=>{const a=n.detail.value;t.nick_name=a.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g,"")},m=async()=>{if(!_.value){e.index.showToast({title:"没有更改需要保存",icon:"none"});return}if(!t.nick_name.trim()){e.index.showToast({title:"请输入昵称",icon:"none"});return}if(t.nick_name.trim().length<2){e.index.showToast({title:"昵称至少2个字符",icon:"none"});return}try{e.index.showLoading({title:"保存中..."});const n={};t.head_img!==o.value.head_img&&(n.head_img=t.head_img),t.nick_name!==o.value.nick_name&&(n.nick_name=t.nick_name);const a=await f.updateUserBasicInfo(n);e.index.__f__("log","at subPackages/settings/pages/index/edit.vue:244","保存结果:",a.data),a.data.code===0?(c.setUserInfo({...c.userInfo,...n}),o.value={...c.userInfo},e.index.showToast({title:"保存成功",icon:"success"}),setTimeout(()=>{e.index.navigateBack()},1500)):e.index.showToast({title:a.data.msg||"保存失败或者与其他用户同名了",icon:"none"})}catch(n){e.index.__f__("error","at subPackages/settings/pages/index/edit.vue:273","保存失败:",n),n&&n.data&&n.data.code===400?e.index.showToast({title:n.data.msg||"保存失败或者与其他用户同名了",icon:"none"}):e.index.showToast({title:"保存失败，请重试",icon:"none"})}finally{e.index.hideLoading()}};return(n,a)=>e.e({a:t.head_img},t.head_img?{b:t.head_img.startsWith("http")?t.head_img:n.$imgBaseUrl+t.head_img}:{},{c:e.o(g),d:e.o([i=>t.nick_name=i.detail.value,l]),e:t.nick_name,f:e.t(t.nick_name.length),g:e.o(m)})}},p=e._export_sfc(x,[["__scopeId","data-v-e5578b7e"]]);wx.createPage(p);
//# sourceMappingURL=../../../../../.sourcemap/mp-weixin/subPackages/settings/pages/index/edit.js.map

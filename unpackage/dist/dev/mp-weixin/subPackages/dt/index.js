"use strict";const e=require("../../common/vendor.js"),N=require("../../common/assets.js"),P=require("../../api/discover.js"),m=require("../../api/file.js"),A=require("../../stores/user.js");if(!Array){const g=e.resolveComponent("u-icon"),d=e.resolveComponent("u--textarea"),r=e.resolveComponent("u-action-sheet");(g+d+r)()}const C=()=>"../../uni_modules/uview-plus/components/u-icon/u-icon.js",V=()=>"../../uni_modules/uview-plus/components/u--textarea/u--textarea.js",O=()=>"../../uni_modules/uview-plus/components/u-action-sheet/u-action-sheet.js";Math||(C+V+O)();const v=9,D={__name:"index",setup(g){const d=A.useUserStore(),{proxy:r}=e.getCurrentInstance(),h=e.ref([]),x=e.ref(116.397128),b=e.ref(39.916527),_=e.ref("");e.onLoad(()=>{e.index.__f__("log","at subPackages/dt/index.vue:174","发布页面加载完成"),M()});const M=async()=>{try{const t=await P.getMomentsRequest();t.data.code===0?h.value=t.data.data.topic_list||[]:e.index.__f__("warn","at subPackages/dt/index.vue:190","获取动态请求数据失败:",t.data.msg)}catch{}finally{e.index.hideLoading()}};e.ref(!1);const l=e.reactive({imgList:[],content:"",status:1,location:"",location_desc:"",topics:[],object_keys:[]}),c=e.ref([]),p=e.ref(!1),j=[{name:"拍照",value:"camera"},{name:"从相册选择",value:"album"},{name:"拍摄视频",value:"video"}],T=()=>{p.value=!0},L=t=>{switch(p.value=!1,t.value){case"camera":y("camera");break;case"album":y("album");break;case"video":I();break}},y=t=>{e.index.chooseImage({count:v-c.value.length,sourceType:[t],sizeType:["compressed"],success:s=>{B(s.tempFilePaths)},fail:s=>{e.index.__f__("error","at subPackages/dt/index.vue:252","选择图片失败:",s),e.index.showToast({title:"选择图片失败",icon:"none"})}})},I=()=>{e.index.chooseVideo({sourceType:["album","camera"],maxDuration:60,camera:"back",success:t=>{F(t)},fail:t=>{e.index.__f__("error","at subPackages/dt/index.vue:271","选择视频失败:",t),e.index.showToast({title:"选择视频失败",icon:"none"})}})},B=async t=>{for(const s of t){const o={type:"image",url:s,status:"uploading",filePath:s,fileName:s.split("/").pop()||"image.jpg"};e.index.showLoading({title:"上传中..."});try{const i=await m.uploadFile({filePath:s,name:o.fileName}),a=m.getUploadResult(i);if(e.index.hideLoading(),a)o.status="success",o.objectKey=a.objectKey,o.url=a.url,o.uploadedUrl=a.url,c.value.push(o),e.index.__f__("log","at subPackages/dt/index.vue:310","图片上传成功:",a);else throw new Error("上传结果解析失败")}catch(i){e.index.__f__("error","at subPackages/dt/index.vue:315","图片上传失败:",i),o.status="failed",o.errorMsg=i.message,e.index.showToast({title:"图片上传失败",icon:"none"})}}},F=async t=>{const s={type:"video",url:t.tempFilePath,cover:t.thumbTempFilePath,duration:t.duration,size:t.size,status:"uploading",filePath:t.tempFilePath,fileName:t.tempFilePath.split("/").pop()||"video.mp4"};e.index.showLoading({title:"上传中..."});try{const o=await m.uploadFile({filePath:t.tempFilePath,name:s.fileName}),i=m.getUploadResult(o);if(e.index.hideLoading(),i)s.status="success",s.objectKey=i.objectKey,s.url=i.url,s.uploadedUrl=i.url,s.cover=i.cover||t.thumbTempFilePath,c.value.push(s),e.index.__f__("log","at subPackages/dt/index.vue:360","视频上传成功:",i);else throw new Error("上传结果解析失败")}catch(o){e.index.__f__("error","at subPackages/dt/index.vue:365","视频上传失败:",o),s.status="failed",s.errorMsg=o.message,e.index.showToast({title:"视频上传失败",icon:"none"})}},w=t=>{const s=c.value[t];if(s.type==="image"){const o=c.value.filter(n=>n.type==="image"),i=o.map(n=>r.$imgBaseUrl+n.url),a=o.findIndex(n=>n===s);e.index.previewImage({urls:i,current:a>=0?a:0,indicator:"number",loop:!0,show:!0,success:function(n){e.index.__f__("log","at subPackages/dt/index.vue:392","图片预览成功",n)},fail:function(n){e.index.__f__("error","at subPackages/dt/index.vue:395","图片预览失败",n)}})}else s.type==="video"&&e.index.__f__("log","at subPackages/dt/index.vue:400","视频播放:",s.url)},$=t=>{e.index.showModal({title:"提示",content:"确定要删除这个文件吗？",success:s=>{s.confirm&&c.value.splice(t,1)}})},f=e.ref(""),u=e.ref(!1),k=e.computed(()=>f.value.trim().length>0),U=e.computed(()=>l.topics.map(t=>t.topic_id)),S=t=>{let s=l.topics.indexOf(t);s===-1&&l.topics.push(t),s!==-1&&l.topics.splice(s,1)},q=()=>{e.index.chooseLocation({success:t=>{const s=t.address||t.name||"已选择位置";e.index.__f__("log","at subPackages/dt/index.vue:491","手动选择位置",t),_.value=s,x.value=t.longitude,b.value=t.latitude},fail:t=>{t.errMsg&&t.errMsg.indexOf("cancel")===-1&&(e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/dt/index.vue:510","获取位置失败:",t.errMsg))}})},z=async()=>{if(!k.value||u.value)return;u.value=!0;const t=c.value.filter(a=>a.status==="success").map(a=>{if(a.type==="image")return{media_type:1,object_key:a.objectKey,url:a.uploadedUrl,file_name:a.fileName};if(a.type==="video")return{media_type:2,object_key:a.objectKey,url:a.uploadedUrl,file_name:a.fileName,cover:a.cover,duration:a.duration,size:a.size}}).filter(Boolean),s=t.map(a=>a.object_key).filter(Boolean),o=l.topics.map(a=>({topic_id:a.topic_id,topic_desc:a.topic_desc,topic_icon:a.topic_icon}));let i={content:f.value,status:1,location:`${x.value},${b.value}`,location_desc:_.value,topics:o,object_keys:s,media_list:t,image_count:t.filter(a=>a.media_type===1).length,video_count:t.filter(a=>a.media_type===2).length};e.index.__f__("log","at subPackages/dt/index.vue:579","发布参数:",i);try{e.index.showLoading({title:"发布中..."});const a=await P.pushMoments(i);a.data.code===0?(e.index.showToast({title:"发布成功",icon:"success",duration:2e3}),setTimeout(()=>{e.index.navigateBack({delta:1})},2e3)):e.index.showToast({title:a.data.msg||"发布失败",icon:"none",duration:2e3})}catch(a){e.index.__f__("error","at subPackages/dt/index.vue:607","发布失败:",a),e.index.showToast({title:"发布失败，请重试",icon:"none",duration:2e3})}finally{e.index.hideLoading(),u.value=!1}},K=()=>{e.index.navigateBack({delta:1})};return(t,s)=>e.e({a:e.unref(d).switch==1},e.unref(d).switch==1?e.e({b:e.p({color:"#000",size:"24",name:"close"}),c:e.o(K),d:e.o(o=>f.value=o),e:e.p({placeholder:"请输入内容",border:"bottom",modelValue:f.value}),f:e.f(l.topics,(o,i,a)=>({a:e.t(o.topic_desc),b:o.topic_id})),g:e.f(c.value,(o,i,a)=>e.e({a:o.type==="video"},o.type==="video"?{b:e.unref(r).$imgBaseUrl+o.url,c:e.o(n=>w(i),i)}:{d:e.unref(r).$imgBaseUrl+o.url,e:e.o(n=>w(i),i)},{f:"30164c98-2-"+a,g:e.o(n=>$(i),i),h:i,i:o.type==="video"?1:""})),h:e.p({name:"close",color:"#fff",size:"16"}),i:c.value.length<v},c.value.length<v?{j:e.p({name:"plus",color:"#999",size:"32"}),k:e.o(T)}:{},{l:e.f(h.value,(o,i,a)=>({a:e.t(o.topic_desc),b:U.value.indexOf(o.topic_id)>-1?1:"",c:o.topic_id,d:e.o(n=>S(o),o.topic_id)})),m:N._imports_0$1,n:e.t(_.value===""?"不显示位置":_.value),o:e.o(q),p:e.o(o=>p.value=!1),q:e.o(L),r:e.p({show:p.value,actions:j}),s:u.value},u.value?{}:{},{t:!u.value},u.value?{}:{},{v:u.value||!k.value?1:"",w:e.o(z)}):{})}},E=e._export_sfc(D,[["__scopeId","data-v-30164c98"]]);wx.createPage(E);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/dt/index.js.map

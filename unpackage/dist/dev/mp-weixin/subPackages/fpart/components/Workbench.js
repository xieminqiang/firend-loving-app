"use strict";const e=require("../../../common/vendor.js"),W=require("../../../common/assets.js"),x=require("../utils/location.js"),M=require("../../../api/user.js"),h=require("../../../api/order.js"),C=require("../utils/address.js");Math||fe();const fe=()=>"./VideoUploadModal.js",_e={__name:"Workbench",props:{applicationInfo:{type:Object,default:null}},setup(l){const o=l,d=e.ref(!1),p=e.ref(""),_=e.ref(""),T=e.ref(!1),I=e.ref(!1),S=e.ref(!1),m=e.ref([]),k=e.ref(!1),b=e.ref([]),L=e.ref(!1),v=e.ref(!1),g=e.computed(()=>o.applicationInfo&&typeof o.applicationInfo=="object"),w=()=>!m.value||m.value.length===0?null:m.value.find(n=>n.is_today===!0),D=()=>{const t=w();return!t||!t.schedule?0:Object.values(t.schedule).filter(n=>n===1).length},$=()=>{const t=w();return!t||!t.schedule?0:Object.values(t.schedule).filter(n=>n===3).length},U=e.computed(()=>{if(k.value)return"加载中...";if(!w())return"未设置";const n=D(),a=$();return a>0?`${a}个已约`:n===48?"全天可约":n===0?"全天休息":`${n}个可约`}),N=e.computed(()=>{if(k.value)return"正在加载今日安排...";if(!w())return"今日未设置时间安排";const n=D(),a=$();return a>0?`今日有${a}个时间点已被预约`:n===48?"今日全天可接单":n===0?"今日休息，暂停接单":`今日可接单 ${n}个时间点`}),O=()=>{g.value&&typeof o.applicationInfo.is_online<"u"?(d.value=o.applicationInfo.is_online===1,e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:326","从applicationInfo获取在线状态:",d.value,"原始值:",o.applicationInfo.is_online)):(d.value=!1,e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:329","使用默认在线状态: 下线"))},A=async()=>{if(T.value){e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:336","组件已经初始化过，跳过重复初始化");return}e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:340","开始初始化Workbench组件"),await e.nextTick$1(),O(),R(),await P(),await u(),T.value=!0,e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:358","Workbench组件初始化完成")};e.watch(()=>o.applicationInfo,(t,n)=>{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:363","applicationInfo发生变化:",{old:n,new:t}),t&&g.value&&(T.value?(e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:368","组件已初始化，更新在线状态、日期安排数据和最近订单数据"),O(),P(),u()):A())},{immediate:!0,deep:!0});const E=async()=>{if(I.value){e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:382","正在更新状态，忽略重复点击");return}const t=!d.value,n=t?"上线":"下线";if(t&&g.value&&o.applicationInfo.can_accept_orders==="N"&&(!o.applicationInfo.intro_video_url||o.applicationInfo.video_review_status!=="approved")){S.value=!0;return}e.index.showModal({title:`确认${n}`,content:t?"上线后将开始接收订单，确认上线吗？":"下线后将停止接收订单，确认下线吗？",success:async a=>{a.confirm&&(t&&await ne(),await z(t))}})},z=async t=>{var n;I.value=!0;try{let a=null;if(t){e.index.showLoading({title:"获取位置中..."});try{a=await x.getCurrentLocationAddress(!1),e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:428","获取位置成功:",a)}catch(r){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:430","获取位置失败:",r),e.index.hideLoading(),e.index.showToast({title:"获取位置失败，无法上线",icon:"none"});return}}else{const r=x.getCacheStatus();r.hasCache&&(a={latitude:r.coordinates.latitude,longitude:r.coordinates.longitude,address:r.address})}const i=C.processAddress(a?a.address:""),s={is_online:t?1:0,latitude:a?a.latitude:null,longitude:a?a.longitude:null,location_text:i};e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:462","准备更新在线状态:",s);const c=await M.updateCompanionOnlineStatus(s);e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:467","在线",c),c.data&&c.data.code===0?(d.value=t,a&&(p.value=a.address,_.value=new Date().toLocaleTimeString()),e.index.hideLoading(),e.index.showToast({title:t?"已上线，开始接单":"已下线，暂停接单",icon:"none"}),e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:484","在线状态更新成功:",c.data)):(e.index.hideLoading(),e.index.showToast({title:((n=c.data)==null?void 0:n.msg)||"状态更新失败",icon:"none"}),e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:492","在线状态更新失败:",c.data))}catch(a){e.index.hideLoading(),e.index.showToast({title:"网络错误，请重试",icon:"none"}),e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:500","更新在线状态失败:",a)}finally{I.value=!1}},R=()=>{const t=x.getCacheStatus();if(t.hasCache&&t.isValid){p.value=t.address,_.value=new Date(t.timestamp).toLocaleTimeString(),e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:514","使用缓存位置信息:",t.address),e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:515","使用缓存:",t),y(t.coordinates.latitude,t.coordinates.longitude,t.address);return}x.getCurrentLocationAddress(!1).then(n=>{p.value=n.address,_.value=new Date().toLocaleTimeString(),e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:525","获取位置成功",n),y(n.latitude,n.longitude,n.address)}).catch(n=>{e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:531","获取位置失败:",n),p.value="位置获取失败",_.value="获取失败"})},V=()=>{e.index.showLoading({title:"更新位置中"}),x.getCurrentLocationAddress(!1).then(t=>{p.value=t.address,_.value=new Date().toLocaleTimeString(),e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:549","位置更新成功",t),e.index.hideLoading(),e.index.showToast({title:"位置更新成功",icon:"none"}),y(t.latitude,t.longitude,t.address)}).catch(t=>{e.index.hideLoading(),e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:567","获取位置失败:",t)})},y=async(t,n,a)=>{var i;try{const s=C.processAddress(a),c={latitude:t,longitude:n,location_text:s};e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:584","准备更新位置信息到服务器:",c),e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:585","位置描述分析:",C.analyzeAddress(a));const r=await M.updateCompanionLocation(c);r.data&&r.data.code===0?e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:590","位置信息更新成功:",r.data):e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:592","位置信息更新失败:",(i=r.data)==null?void 0:i.msg)}catch(s){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:595","位置信息更新API调用失败:",s)}},B=()=>{e.index.chooseLocation({success:async t=>{const n=t.address||t.name||"已选择位置";e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:605","手动选择位置",t),p.value=n,_.value=new Date().toLocaleTimeString(),await y(t.latitude,t.longitude,n)},fail:t=>{t.errMsg&&t.errMsg.indexOf("cancel")===-1&&(e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:620","获取位置失败:",t.errMsg))}})},Y=()=>{if(!o.applicationInfo||!o.applicationInfo.id){e.index.showToast({title:"用户信息不完整",icon:"none"});return}e.index.navigateTo({url:`/subPackages/fpart/order/index?companion_id=${o.applicationInfo.id}`})},F=t=>{e.index.navigateTo({url:`/subPackages/fpart/order/detail?orderId=${t}&companion_id=${o.applicationInfo.id}`})},G=t=>{t.user_latitude&&t.user_longitude?e.index.openLocation({latitude:Number(t.user_latitude),longitude:Number(t.user_longitude),address:t.service_address}):e.index.showToast({title:"暂无位置信息",icon:"none"})},H=t=>({2:[{text:"拒绝",action:"reject",type:"secondary"},{text:"接单",action:"accept",type:"primary"}],3:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已到达服务地点",action:"arrived",type:"primary"}],4:[{text:"电话联系",action:"call",type:"secondary"}],5:[{text:"电话联系",action:"contact",type:"secondary"},{text:"结束服务",action:"end",type:"primary"}],11:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已出发",action:"depart",type:"depart"}]})[t]||[],J=(t,n)=>{switch(t){case"contact":Q(n);break;case"accept":Z(n);break;case"reject":K(n);break;case"arrived":X(n);break;case"depart":te(n);break;case"call":ee(n);break;case"end":ae(n);break}},Q=t=>{t.user&&t.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${t.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:t.user.phone})}})},Z=t=>{e.index.showModal({title:"确认接单",content:"确定要接受这个订单吗？",confirmText:"接单",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const a=await h.acceptCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"接单成功",icon:"success"}),await u();else throw new Error(a.data.msg||"接单失败")}catch(a){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:775","接单失败:",a),e.index.showToast({title:a.message||"接单失败",icon:"none"})}finally{e.index.hideLoading()}}})},K=t=>{e.index.showModal({title:"拒绝订单",content:"确定要拒绝这个订单吗？",confirmText:"拒绝",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const a=await h.rejectCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"已拒绝订单",icon:"success"}),await u();else throw new Error(a.data.msg||"拒绝订单失败")}catch(a){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:819","拒绝订单失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},X=t=>{e.index.showModal({title:"确认到达",content:"确认您已到达服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const a=await h.arrivedCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"已确认到达",icon:"success"}),await u();else throw new Error(a.data.msg||"确认到达失败")}catch(a){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:863","确认到达失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ee=t=>{t.user&&t.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${t.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:t.user.phone})}})},te=t=>{e.index.showModal({title:"确认出发",content:"确认您已开始出发前往服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const a=await h.departCompanionOrder({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"已确认出发",icon:"success"}),await u();else throw new Error(a.data.msg||"确认出发失败")}catch(a){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:926","确认出发失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ae=t=>{e.index.showModal({title:"结束服务",content:"确定要结束服务吗？",confirmText:"结束",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const a=await h.endCompanionService({order_id:t.id,companion_id:Number(o.applicationInfo.id)});if(a.data.code===0)e.index.showToast({title:"服务已结束",icon:"success"}),await u();else throw new Error(a.data.msg||"结束服务失败")}catch(a){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:970","结束服务失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},ne=async()=>{const t="zovIGlvjM10gOUEZjOB-lOQwISsM0PLqfMtIJPbWf4Y";try{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:988","开始请求订阅消息权限");const n=await new Promise((a,i)=>{e.index.requestSubscribeMessage({tmplIds:[t],success:s=>{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:994","订阅消息请求结果:",s),a(s)},fail:s=>{e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:998","订阅消息请求失败:",s),i(s)}})});n[t]==="accept"?(e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1006","用户同意订阅消息"),e.index.showToast({title:"已开启接单提醒",icon:"success"})):n[t]==="reject"?(e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1012","用户拒绝订阅消息"),e.index.showModal({title:"接单提醒权限",content:"为了您能及时接收新订单通知，是否去设置页面重新授权？",confirmText:"去设置",cancelText:"暂不开启",success:a=>{a.confirm?e.index.openSetting({success:i=>{i.authSetting["scope.subscribeMessage"]?e.index.requestSubscribeMessage({tmplIds:[t],success:s=>{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1030","重新授权成功:",s),e.index.showToast({title:"已开启接单提醒",icon:"success"})},fail:s=>{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1037","重新授权失败:",s)}}):e.index.showToast({title:"未开启接单提醒",icon:"none"})},fail:i=>{e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:1048","打开设置页面失败:",i)}}):e.index.showToast({title:"未开启接单提醒",icon:"none"})}})):(e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1061","用户未明确选择订阅消息"),e.index.showToast({title:"未开启接单提醒",icon:"none"}))}catch(n){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:1068","订阅消息请求异常:",n),e.index.showToast({title:"订阅消息请求失败",icon:"none"})}},oe=()=>{S.value=!1},se=t=>{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1084","视频上传成功:",t),e.index.$emit("applicationStatusChanged",t)},P=async()=>{var t;if(!g.value||!o.applicationInfo.id){e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1092","applicationInfo不完整，跳过获取日期安排数据");return}try{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1099","开始获取日期安排数据，companion_id:",o.applicationInfo.id);const n={companion_id:o.applicationInfo.id},a=await M.getCompanionSchedule(n);e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1106","日期安排数据获取成功:",a),a.data&&a.data.code===0?(m.value=a.data.data,e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1110","解析后的日期安排数据:",m.value)):e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:1112","获取日期安排数据失败:",(t=a.data)==null?void 0:t.msg)}catch(n){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:1115","获取日期安排数据接口调用失败:",n)}finally{k.value=!1}},u=async()=>{var t;if(!g.value||!o.applicationInfo.id){e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1124","applicationInfo不完整，跳过获取最近订单数据");return}try{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1130","开始获取最近订单数据，companion_id:",o.applicationInfo.id);const n={companion_id:Number(o.applicationInfo.id),page:1,page_size:10},a=await h.getCompanionActiveOrders(n);e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1137","最近订单数据获取成功:",a),a.data&&a.data.code===0?(b.value=a.data.data.list,e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1140","解析后的最近订单数据:",b.value)):e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:1142","获取最近订单数据失败:",(t=a.data)==null?void 0:t.msg)}catch(n){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:1145","获取最近订单数据接口调用失败:",n)}finally{L.value=!1}},ie=()=>{if(!o.applicationInfo||!o.applicationInfo.id){e.index.showToast({title:"用户信息不完整",icon:"none"});return}e.index.navigateTo({url:`/subPackages/fpart/components/DataSelect?companion_id=${o.applicationInfo.id}`})},ce=async()=>{if(!v.value){v.value=!0;try{await Promise.all([P(),u()]),await new Promise(t=>setTimeout(t,800))}catch(t){e.index.__f__("error","at subPackages/fpart/components/Workbench.vue:1188","刷新失败:",t)}finally{v.value=!1}}},re=()=>{v.value=!1},de=t=>({2:"等待接单",3:"我已出发",4:"已到达，等待开始服务",5:"服务中",11:"待服务"})[t]||"未知状态",ue=t=>({2:"status-pending",3:"status-departing",4:"status-arrived",5:"status-serving",11:"status-departing"})[t]||"status-default",le=t=>{if(!t)return"";const n=new Date(t),a=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0"),s=String(n.getHours()).padStart(2,"0"),c=String(n.getMinutes()).padStart(2,"0");return`${a}-${i} ${s}:${c}`},pe=(t,n)=>{if(!t&&!n)return"待确认";let a="";if(t){const i=new Date(t),s=i.getFullYear(),c=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),f=["周日","周一","周二","周三","周四","周五","周六"][i.getDay()];a+=`${s}-${c}-${r} ${f}`}return n&&(a&&(a+=" "),a+=n),a||"待确认"};e.onMounted(()=>{e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1268","Workbench组件mounted，applicationInfo状态:",{hasApplicationInfo:!!o.applicationInfo,applicationInfo:o.applicationInfo}),g.value?A():e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1277","applicationInfo还未准备好，等待watch触发初始化"),e.index.$on("scheduleDataUpdated",q)}),e.onUnmounted(()=>{e.index.$off("scheduleDataUpdated",q)});const q=async t=>{var n;e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1291","收到日期安排数据更新事件:",t),t.companion_id===((n=o.applicationInfo)==null?void 0:n.id)&&(e.index.__f__("log","at subPackages/fpart/components/Workbench.vue:1295","刷新日期安排数据"),await P())};return(t,n)=>e.e({a:l.applicationInfo&&l.applicationInfo.avatar},l.applicationInfo&&l.applicationInfo.avatar?{b:t.$imgBaseUrl+l.applicationInfo.avatar}:{},{c:d.value?1:"",d:e.t(d.value?"已上线":"已下线"),e:e.t(d.value?"正在接单中":"暂停接单"),f:e.t(d.value?"下线休息":"开始上线"),g:d.value?1:"",h:e.o(E),i:d.value?1:"",j:W._imports_0$15,k:e.o(V),l:W._imports_1$8,m:e.o(B),n:e.t(p.value||"正在获取位置..."),o:W._imports_2$5,p:e.t(U.value),q:k.value?1:"",r:e.t(N.value),s:e.o(ie),t:e.o(Y),v:L.value},L.value?{}:b.value.length===0?{x:W._imports_3}:{y:e.f(b.value,(a,i,s)=>{var c,r;return e.e({a:e.t(le(a.created_at)),b:e.t(de(a.status)),c:e.n(ue(a.status)),d:t.$imgBaseUrl+a.service_image_url,e:e.t(a.service_name),f:e.t(a.unit_price),g:e.t(a.unit),h:e.t(a.quantity),i:e.t(a.total_amount),j:[2,3,4,5,11].includes(a.status)},[2,3,4,5,11].includes(a.status)?e.e({k:a.user},a.user?{l:e.t((c=a==null?void 0:a.user)==null?void 0:c.nick_name),m:e.t((r=a==null?void 0:a.user)==null?void 0:r.phone)}:{},{n:e.t(a.service_address),o:e.o(f=>G(a),a.id),p:e.t(pe(a.service_date,a.service_time))}):{},{q:e.f(H(a.status),(f,j,he)=>({a:e.t(f.text),b:j,c:e.n(f.type),d:e.o(me=>J(f.action,a),j)})),r:a.id,s:e.o(f=>F(a.id),a.id)})})},{w:b.value.length===0,z:v.value,A:e.o(ce),B:e.o(re),C:e.o(oe),D:e.o(se),E:e.p({show:S.value,applicationInfo:l.applicationInfo})})}},ge=e._export_sfc(_e,[["__scopeId","data-v-4f614f88"]]);wx.createComponent(ge);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/fpart/components/Workbench.js.map

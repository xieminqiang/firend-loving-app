"use strict";const e=require("../../../common/vendor.js"),U=require("../../../common/assets.js"),h=require("../../../api/file.js"),w=require("../../../api/order.js"),C={__name:"partner-evaluate",setup(q){const{proxy:v}=e.getCurrentInstance(),g=e.ref(""),x=e.ref(""),s=e.ref({}),o=e.ref(null),d=e.ref(""),u=e.ref([]),l=e.ref(!1),p=e.computed(()=>d.value.trim().length>0);e.onLoad(t=>{t.orderId&&(g.value=t.orderId),t.companion_id&&(x.value=t.companion_id),y()});const y=async()=>{try{e.index.showLoading({title:"加载中..."});const t=await w.getOrderCommentList({order_id:Number(g.value)});if(t.data.code===0){const n=t.data.data.list||[];s.value=n.find(a=>a.is_companion===0)||{},o.value=n.find(a=>a.is_companion===1)||null,e.index.__f__("log","at subPackages/fpart/order/partner-evaluate.vue:247","用户评价:",s.value),e.index.__f__("log","at subPackages/fpart/order/partner-evaluate.vue:248","友伴师回复:",o.value)}else throw new Error(t.data.msg||"获取评价失败")}catch(t){e.index.__f__("error","at subPackages/fpart/order/partner-evaluate.vue:253","加载评价失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{e.index.hideLoading()}},$=()=>{const t=3-u.value.length;if(t<=0){e.index.showToast({title:"最多只能上传3张图片",icon:"none"});return}e.index.chooseImage({count:t,sizeType:["compressed"],sourceType:["album","camera"],success:async n=>{e.index.showLoading({title:"上传中...",mask:!0});try{const a=n.tempFilePaths.map(async(i,c)=>{try{const m=await b(i);if(!m||!m.extension)throw new Error("无法获取文件信息");const S=await h.uploadFile({filePath:i,name:`reply_${Date.now()}_${c}.${m.extension}`}),_=h.getUploadResult(S);if(!_||!_.url)throw new Error("上传结果解析失败");return _.url}catch(m){throw e.index.__f__("error","at subPackages/fpart/order/partner-evaluate.vue:310",`第${c+1}张图片上传失败:`,m),m}}),r=await Promise.all(a);u.value.push(...r),e.index.showToast({title:`成功上传${r.length}张图片`,icon:"success"})}catch(a){e.index.__f__("error","at subPackages/fpart/order/partner-evaluate.vue:327","图片上传失败:",a),e.index.showToast({title:"图片上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:n=>{e.index.__f__("error","at subPackages/fpart/order/partner-evaluate.vue:337","选择图片失败:",n),e.index.showToast({title:"选择图片失败",icon:"none"})}})},b=t=>new Promise((n,a)=>{e.index.getFileInfo({filePath:t,success:r=>{const i=t.split(".").pop().toLowerCase();n({size:r.size,extension:i})},fail:r=>{e.index.__f__("error","at subPackages/fpart/order/partner-evaluate.vue:360","获取文件信息失败:",r);const i=t.split(".").pop().toLowerCase()||"jpg";n({size:0,extension:i})}})}),P=t=>{const n=u.value.map(a=>v.$imgBaseUrl+a);e.index.previewImage({urls:n,current:t})},I=t=>{u.value.splice(t,1)},k=t=>{const n=s.value.comment_images.map(a=>v.$imgBaseUrl+a);e.index.previewImage({urls:n,current:t})},T=t=>{const n=o.value.comment_images.map(a=>v.$imgBaseUrl+a);e.index.previewImage({urls:n,current:t})},L=async()=>{var t,n;if(!(!p.value||l.value)){l.value=!0;try{const a={order_id:parseInt(g.value),rating:0,comment:d.value.trim(),comment_images:u.value,is_anonymous:0,is_companion:1};e.index.__f__("log","at subPackages/fpart/order/partner-evaluate.vue:423","提交回复数据:",a);const r=await w.createOrderComment(a);if(r.data&&r.data.code===0)e.index.showToast({title:"回复提交成功",icon:"success",duration:2e3}),setTimeout(()=>{e.index.navigateBack()},1500);else throw new Error(((t=r.data)==null?void 0:t.msg)||"回复提交失败")}catch(a){e.index.__f__("error","at subPackages/fpart/order/partner-evaluate.vue:444","提交回复失败:",a),e.index.showToast({title:((n=a.data)==null?void 0:n.msg)||"提交失败，请重试",icon:"none"})}finally{l.value=!1}}},f=t=>{if(!t)return"";const n=new Date(t),a=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0"),c=String(n.getHours()).padStart(2,"0"),m=String(n.getMinutes()).padStart(2,"0");return`${a}-${r}-${i} ${c}:${m}`};return(t,n)=>e.e({a:e.f(5,(a,r,i)=>({a,b:a<=s.value.rating?1:""})),b:e.t(s.value.rating),c:e.t(s.value.comment),d:s.value.comment_images&&s.value.comment_images.length>0},s.value.comment_images&&s.value.comment_images.length>0?{e:e.f(s.value.comment_images,(a,r,i)=>({a:e.unref(v).$imgBaseUrl+a,b:r,c:e.o(c=>k(r),r)}))}:{},{f:e.t(f(s.value.comment_time)),g:o.value},o.value?e.e({h:e.t(o.value.comment),i:o.value.comment_images&&o.value.comment_images.length>0},o.value.comment_images&&o.value.comment_images.length>0?{j:e.f(o.value.comment_images,(a,r,i)=>({a:e.unref(v).$imgBaseUrl+a,b:r,c:e.o(c=>T(r),r)}))}:{},{k:e.t(f(o.value.comment_time))}):{},{l:!o.value},o.value?{}:e.e({m:d.value,n:e.o(a=>d.value=a.detail.value),o:e.t(d.value.length),p:e.f(u.value,(a,r,i)=>({a:e.unref(v).$imgBaseUrl+a,b:e.o(c=>I(r),r),c:r,d:e.o(c=>P(r),r)})),q:u.value.length<3},u.value.length<3?{r:U._imports_0$4,s:e.o($)}:{}),{t:!o.value},o.value?{}:e.e({v:l.value},l.value?{}:{},{w:!l.value},l.value?{}:{},{x:l.value||!p.value?1:"",y:e.o(L)}))}},B=e._export_sfc(C,[["__scopeId","data-v-c464af52"]]);wx.createPage(B);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/subPackages/fpart/order/partner-evaluate.js.map

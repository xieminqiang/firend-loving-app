"use strict";const t=require("../../common/vendor.js"),O=require("../../common/assets.js"),g=require("../../api/order.js"),D=require("../../stores/city.js"),q={__name:"detail",setup(I){const s=t.ref({}),p=t.ref(null),y=D.useCityStore(),d=t.ref([{title:"友伴接单",icon:"✓",status:"pending"},{title:"友伴出发",icon:"✓",status:"pending"},{title:"友伴到达",icon:"✓",status:"pending"},{title:"开始服务",icon:"✓",status:"pending"},{title:"服务完成",icon:"✓",status:"pending"}]);t.onLoad(e=>{e.orderId&&(p.value=e.orderId,m())});const m=async()=>{try{t.index.showLoading({title:"加载中..."});const e=await g.getOrderDetail({order_id:Number(p.value)});if(t.index.__f__("log","at subPackages/order/detail.vue:185",e.data),e.data.code===0)s.value={...e.data.data.order,logs:e.data.data.logs||[]},x();else throw new Error(e.data.msg||"获取订单详情失败")}catch(e){t.index.__f__("error","at subPackages/order/detail.vue:197","加载订单详情失败:",e),t.index.showToast({title:e.message||"加载失败",icon:"none"})}finally{t.index.hideLoading()}},x=()=>{const e=s.value.logs||[];d.value.forEach(n=>{n.status="pending"}),e.find(n=>n.status===11)&&(d.value[0].status="completed"),e.find(n=>n.status===3)&&(d.value[1].status="completed"),e.find(n=>n.status===4)&&(d.value[2].status="completed"),e.find(n=>n.status===5)&&(d.value[3].status="completed"),e.find(n=>n.status===6)&&(d.value[4].status="completed")},f=e=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"})[e]||"status-default",_=e=>({1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"})[e]||"未知状态",v=e=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"续钟",action:"extend",type:"primary"},{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:"再次预约",action:"rebook",type:"primary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]})[e]||[],h=(e,a)=>{switch(e){case"cancel":w();break;case"refund":T();break;case"pay":k(a);break;case"contact":t.index.showToast({title:"联系功能暂不可用",icon:"none"});break;case"extend":S(a);break;case"rebook":L(a);break;case"delete":P();break;case"start":b();break}},w=e=>{t.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:a=>{a.confirm&&t.index.showToast({title:"订单已取消",icon:"success"})}})},T=e=>{t.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"申请退款",cancelText:"取消",success:a=>{a.confirm&&t.index.showToast({title:"退款申请已提交",icon:"success"})}})},k=async e=>{try{t.index.showLoading({title:"处理中..."});const a={order_id:e.id,payment_method:1},o=await g.orderParams(a);if(o.data.code===0)t.index.requestPayment({provider:"wxpay",...o.data.data.pay_params,success:r=>{t.index.__f__("log","at subPackages/order/detail.vue:439","支付成功",r),t.index.showToast({title:"支付成功",icon:"success"}),setTimeout(()=>{m()},1500)},fail:r=>{t.index.__f__("error","at subPackages/order/detail.vue:450","支付失败",JSON.stringify(r)),t.index.showToast({title:"支付失败",icon:"none"})}});else throw new Error(o.data.msg||"获取支付参数失败")}catch(a){t.index.__f__("error","at subPackages/order/detail.vue:461","支付失败:",a),t.index.showToast({title:a.message||"支付失败",icon:"none"})}finally{t.index.hideLoading()}},b=e=>{t.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:a=>{a.confirm&&t.index.showToast({title:"服务已开始",icon:"success"})}})},S=e=>{t.index.navigateTo({url:`/subPackages/order/extend?orderId=${e.id}`})},L=e=>{if(e.companion_id){let a="/subPackages/friend/detail?id="+e.companion_id+"&city_code="+y.currentCityCode;t.index.navigateTo({url:a})}else t.index.showToast({title:"友伴信息不存在",icon:"none"})},P=e=>{t.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:a=>{a.confirm&&t.index.showToast({title:"订单已删除",icon:"success"})}})},l=e=>{if(!e)return"";const a=new Date(e),o=a.getFullYear(),r=String(a.getMonth()+1).padStart(2,"0"),c=String(a.getDate()).padStart(2,"0"),i=String(a.getHours()).padStart(2,"0"),n=String(a.getMinutes()).padStart(2,"0");return`${o}-${r}-${c} ${i}:${n}`},M=e=>{if(!e){t.index.showToast({title:"订单号为空",icon:"none"});return}t.index.setClipboardData({data:e,success:()=>{t.index.showToast({title:"订单号已复制",icon:"success"})},fail:()=>{t.index.showToast({title:"复制失败",icon:"none"})}})},$=(e,a)=>{if(!e&&!a)return"待确认";let o="";if(e){const r=new Date(e),c=r.getFullYear(),i=String(r.getMonth()+1).padStart(2,"0"),n=String(r.getDate()).padStart(2,"0"),u=["周日","周一","周二","周三","周四","周五","周六"][r.getDay()];o+=`${c}-${i}-${n} ${u}`}return a&&(o&&(o+=" "),o+=a),o||"待确认"};return(e,a)=>{var o,r,c,i;return t.e({a:t.t(_(s.value.status)),b:t.n(f(s.value.status)),c:e.$imgBaseUrl+s.value.service_image_url,d:t.t(s.value.service_name),e:t.t(s.value.unit_price),f:t.t(s.value.unit),g:t.t(s.value.quantity),h:t.t(s.value.total_amount),i:(r=(o=s.value)==null?void 0:o.companion)==null?void 0:r.avatar,j:t.t((i=(c=s.value)==null?void 0:c.companion)==null?void 0:i.nickname),k:t.t(s.value.service_address),l:t.t($(s.value.service_date,s.value.service_time)),m:t.t(s.value.order_no),n:O._imports_0$6,o:t.o(n=>M(s.value.order_no)),p:s.value.start_time},s.value.start_time?{q:t.t(l(s.value.start_time))}:{},{r:s.value.end_time},s.value.end_time?{s:t.t(l(s.value.end_time))}:{},{t:t.t(l(s.value.created_at)),v:s.value.payment_time},s.value.payment_time?{w:t.t(l(s.value.payment_time))}:{},{x:s.value.remark},s.value.remark?{y:t.t(s.value.remark)}:{},{z:t.f(v(s.value.status),(n,u,E)=>t.e({a:t.t(n.text),b:n.text==="联系客服"},n.text==="联系客服"?{c:t.o(()=>{},u)}:{},{d:u,e:t.n(n.type),f:t.o(A=>h(n.action,s.value),u)}))})}}},C=t._export_sfc(q,[["__scopeId","data-v-c0a82bfd"]]);wx.createPage(C);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/detail.js.map

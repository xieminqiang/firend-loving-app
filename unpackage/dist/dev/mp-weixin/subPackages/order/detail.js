"use strict";const e=require("../../common/vendor.js"),R=require("../../common/assets.js"),g=require("../../api/order.js"),U=require("../../stores/city.js"),A=require("../../stores/user.js"),B={__name:"detail",setup(j){const l=A.useUserStore(),n=e.ref({}),v=e.ref(null),_=U.useCityStore(),i=e.ref([{title:"友伴接单",icon:"✓",status:"pending"},{title:"友伴出发",icon:"✓",status:"pending"},{title:"友伴到达",icon:"✓",status:"pending"},{title:"开始服务",icon:"✓",status:"pending"},{title:"服务完成",icon:"✓",status:"pending"}]);e.onLoad(t=>{if(!l.userInfo||Object.keys(l.userInfo).length===0||!l.token){e.index.showToast({title:"请先登录",icon:"none"}),setTimeout(()=>{e.index.navigateTo({url:"/subPackages/login/index"})},1500);return}t.orderId&&(v.value=t.orderId,p())});const p=async()=>{try{e.index.showLoading({title:"加载中..."});const t=await g.getOrderDetail({order_id:Number(v.value)});if(e.index.__f__("log","at subPackages/order/detail.vue:201",t.data),t.data.code===0)n.value={...t.data.data.order,logs:t.data.data.logs||[]},f();else throw new Error(t.data.msg||"获取订单详情失败")}catch(t){e.index.__f__("error","at subPackages/order/detail.vue:213","加载订单详情失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{e.index.hideLoading()}},f=()=>{const t=n.value.logs||[];i.value.forEach(s=>{s.status="pending"}),t.find(s=>s.status===11)&&(i.value[0].status="completed"),t.find(s=>s.status===3)&&(i.value[1].status="completed"),t.find(s=>s.status===4)&&(i.value[2].status="completed"),t.find(s=>s.status===5)&&(i.value[3].status="completed"),t.find(s=>s.status===6)&&(i.value[4].status="completed")},x=t=>t,y=(t,a)=>t==="completed"?"completed":"pending",h=t=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"})[t]||"status-default",w=t=>({1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"})[t]||"未知状态",k=t=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:n.value.is_comment===1?"查看评价":"去评价",action:n.value.is_comment===1?"viewComment":"evaluate",type:"primary"},{text:"再次预约",action:"rebook",type:"secondary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]})[t]||[],T=(t,a)=>{switch(t){case"cancel":b(a);break;case"refund":S();break;case"pay":$(a);break;case"contact":e.index.showToast({title:"联系功能暂不可用",icon:"none"});break;case"extend":L(a);break;case"rebook":O(a);break;case"delete":M(a);break;case"start":P();break;case"evaluate":C(a);break;case"viewComment":I(a);break}},b=t=>{e.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"取消中..."});const o={order_id:t.id,cancel_reason:"用户取消"},r=await g.cancelOrder(o);if(r.data.code===0)e.index.showToast({title:"订单已取消",icon:"success"}),e.index.$emit("orderStatusChanged",{type:"cancel",orderId:t.id,status:7}),setTimeout(()=>{p()},1500);else throw new Error(r.data.msg||"取消订单失败")}catch(o){e.index.__f__("error","at subPackages/order/detail.vue:446","取消订单失败:",o),e.index.showToast({title:o.message||"取消订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},S=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"申请退款",cancelText:"取消",success:a=>{a.confirm&&e.index.showToast({title:"退款申请已提交",icon:"success"})}})},$=async t=>{try{e.index.showLoading({title:"处理中..."});const a={order_id:t.id,payment_method:1},o=await g.orderParams(a);if(o.data.code===0)e.index.requestPayment({provider:"wxpay",...o.data.data.pay_params,success:r=>{e.index.__f__("log","at subPackages/order/detail.vue:500","支付成功",r),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout(()=>{p()},1500)},fail:r=>{e.index.__f__("error","at subPackages/order/detail.vue:511","支付失败",JSON.stringify(r)),e.index.showToast({title:"支付失败",icon:"none"})}});else throw new Error(o.data.msg||"获取支付参数失败")}catch(a){e.index.__f__("error","at subPackages/order/detail.vue:522","支付失败:",a),e.index.showToast({title:a.message||"支付失败",icon:"none"})}finally{e.index.hideLoading()}},P=t=>{e.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:a=>{a.confirm&&e.index.showToast({title:"服务已开始",icon:"success"})}})},L=t=>{e.index.navigateTo({url:`/subPackages/order/extend?orderId=${t.id}`})},O=t=>{if(t.companion_id){let a="/subPackages/friend/detail?id="+t.companion_id+"&city_code="+_.currentCityCode;e.index.navigateTo({url:a})}else e.index.showToast({title:"友伴信息不存在",icon:"none"})},C=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate?orderId=${t.id}&serviceName=${encodeURIComponent(t.service_name)}&serviceImage=${encodeURIComponent(t.service_image_url)}`})},I=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate-detail?orderId=${t.id}`})},M=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"删除中..."});const o={order_id:t.id},r=await g.deleteOrder(o);if(r.data.code===0)e.index.showToast({title:"订单已删除",icon:"success"}),e.index.$emit("orderOrderDeleted",{orderId:t.id,status:t.status}),setTimeout(()=>{e.index.navigateBack()},1500);else throw new Error(r.data.msg||"删除订单失败")}catch(o){e.index.__f__("error","at subPackages/order/detail.vue:631","删除订单失败:",o),e.index.showToast({title:o.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},m=t=>{if(!t)return"";const a=new Date(t),o=a.getFullYear(),r=String(a.getMonth()+1).padStart(2,"0"),d=String(a.getDate()).padStart(2,"0"),u=String(a.getHours()).padStart(2,"0"),s=String(a.getMinutes()).padStart(2,"0");return`${o}-${r}-${d} ${u}:${s}`},D=t=>{if(!t){e.index.showToast({title:"订单号为空",icon:"none"});return}e.index.setClipboardData({data:t,success:()=>{e.index.showToast({title:"订单号已复制",icon:"success"})},fail:()=>{e.index.showToast({title:"复制失败",icon:"none"})}})},q=(t,a)=>{if(!t&&!a)return"待确认";let o="";if(t){const r=new Date(t),d=r.getFullYear(),u=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0"),c=["周日","周一","周二","周三","周四","周五","周六"][r.getDay()];o+=`${d}-${u}-${s} ${c}`}return a&&(o&&(o+=" "),o+=a),o||"待确认"};return(t,a)=>{var o,r,d,u;return e.e({a:e.t(w(n.value.status)),b:e.n(h(n.value.status)),c:e.unref(l).switch==1},e.unref(l).switch==1?{d:e.f(i.value,(s,c,E)=>e.e({a:e.t(s.icon),b:e.t(s.title),c:c<i.value.length-1},c<i.value.length-1?{d:e.n(y(s.status,i.value[c+1].status))}:{},{e:c,f:e.n(x(s.status))}))}:{},{e:t.$imgBaseUrl+n.value.service_image_url,f:e.t(n.value.service_name),g:e.t(n.value.unit_price),h:e.t(n.value.unit),i:e.t(n.value.quantity),j:e.t(n.value.total_amount),k:t.$imgBaseUrl+((r=(o=n.value)==null?void 0:o.companion)==null?void 0:r.avatar),l:e.t((u=(d=n.value)==null?void 0:d.companion)==null?void 0:u.nickname),m:e.t(n.value.service_address),n:e.t(q(n.value.service_date,n.value.service_time)),o:e.t(n.value.order_no),p:R._imports_0$6,q:e.o(s=>D(n.value.order_no)),r:n.value.start_time},n.value.start_time?{s:e.t(m(n.value.start_time))}:{},{t:n.value.end_time},n.value.end_time?{v:e.t(m(n.value.end_time))}:{},{w:e.t(m(n.value.created_at)),x:n.value.payment_time},n.value.payment_time?{y:e.t(m(n.value.payment_time))}:{},{z:n.value.remark},n.value.remark?{A:e.t(n.value.remark)}:{},{B:e.f(k(n.value.status),(s,c,E)=>e.e({a:e.t(s.text),b:s.text==="联系客服"},s.text==="联系客服"?{c:e.o(()=>{},c)}:{},{d:c,e:e.n(s.type),f:e.o(F=>T(s.action,n.value),c)}))})}}},N=e._export_sfc(B,[["__scopeId","data-v-c0a82bfd"]]);wx.createPage(N);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/detail.js.map

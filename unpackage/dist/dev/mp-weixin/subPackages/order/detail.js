"use strict";const e=require("../../common/vendor.js"),U=require("../../common/assets.js"),d=require("../../api/order.js"),B=require("../../stores/city.js"),j=require("../../stores/user.js"),F={__name:"detail",setup(z){const p=j.useUserStore(),s=e.ref({}),f=e.ref(null),_=B.useCityStore(),i=e.ref([{title:"友伴接单",icon:"✓",status:"pending"},{title:"友伴出发",icon:"✓",status:"pending"},{title:"友伴到达",icon:"✓",status:"pending"},{title:"开始服务",icon:"✓",status:"pending"},{title:"服务完成",icon:"✓",status:"pending"}]);e.onLoad(t=>{if(!p.userInfo||Object.keys(p.userInfo).length===0||!p.token){e.index.showToast({title:"请先登录",icon:"none"}),setTimeout(()=>{e.index.navigateTo({url:"/subPackages/login/index"})},1500);return}t.orderId&&(f.value=t.orderId,l())});const l=async()=>{try{e.index.showLoading({title:"加载中..."});const t=await d.getOrderDetail({order_id:Number(f.value)});if(e.index.__f__("log","at subPackages/order/detail.vue:201",t.data),t.data.code===0)s.value={...t.data.data.order,logs:t.data.data.logs||[]},x();else throw new Error(t.data.msg||"获取订单详情失败")}catch(t){e.index.__f__("error","at subPackages/order/detail.vue:213","加载订单详情失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{e.index.hideLoading()}},x=()=>{const t=s.value.logs||[];i.value.forEach(r=>{r.status="pending"}),t.find(r=>r.status===11)&&(i.value[0].status="completed"),t.find(r=>r.status===3)&&(i.value[1].status="completed"),t.find(r=>r.status===4)&&(i.value[2].status="completed"),t.find(r=>r.status===5)&&(i.value[3].status="completed"),t.find(r=>r.status===6)&&(i.value[4].status="completed")},h=t=>t,y=(t,a)=>t==="completed"?"completed":"pending",v=t=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"})[t]||"status-default",w=t=>({1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"})[t]||"未知状态",T=t=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:s.value.is_comment===1?"查看评价":"去评价",action:s.value.is_comment===1?"viewComment":"evaluate",type:"primary"},{text:"再次预约",action:"rebook",type:"secondary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]})[t]||[],k=(t,a)=>{switch(t){case"cancel":b(a);break;case"refund":S(a);break;case"pay":D(a);break;case"contact":e.index.__f__("log","at subPackages/order/detail.vue:373",a.companion),a.companion.phone&&e.index.showModal({title:"联系友伴师",content:"是否拨打友伴师的电话？",confirmText:"拨打",cancelText:"取消",success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:a.companion.phone})}});break;case"extend":M(a);break;case"rebook":O(a);break;case"delete":E(a);break;case"start":C(a);break;case"evaluate":I(a);break;case"viewComment":A(a);break}},b=t=>{e.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"取消中..."});const n={order_id:t.id,cancel_reason:"用户取消"},o=await d.cancelOrder(n);if(o.data.code===0)e.index.showToast({title:"订单已取消",icon:"success"}),e.index.$emit("orderStatusChanged",{type:"cancel",orderId:t.id,status:7}),setTimeout(()=>{l()},1500);else throw new Error(o.data.msg||"取消订单失败")}catch(n){e.index.__f__("error","at subPackages/order/detail.vue:458","取消订单失败:",n),e.index.showToast({title:n.message||"取消订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},S=t=>{t.status===3?P(t):t.status===4?$(t):L(t)},L=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"继续退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"用户申请退款"},o=await d.applyRefund(n);if(o.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),setTimeout(()=>{l()},1500);else throw new Error(o.data.msg||"申请退款失败")}catch(n){e.index.__f__("error","at subPackages/order/detail.vue:519","申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},P=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已出发，退款时将扣除来回程车费。",confirmText:"继续退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"部分退款，扣除来回程车费"},o=await d.applyRefundAfterDeparture(n);if(o.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),setTimeout(()=>{l()},1500);else throw new Error(o.data.msg||"申请退款失败")}catch(n){e.index.__f__("error","at subPackages/order/detail.vue:568","申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},$=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已到达，退款时将扣除友伴师来回程车费。",confirmText:"申请退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"部分退款，扣除友伴师来回程车费"},o=await d.applyRefundAfterDeparture(n);if(o.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),setTimeout(()=>{l()},1500);else throw new Error(o.data.msg||"申请退款失败")}catch(n){e.index.__f__("error","at subPackages/order/detail.vue:617","申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},D=async t=>{try{e.index.showLoading({title:"处理中..."});const a={order_id:t.id,payment_method:1},n=await d.orderParams(a);if(n.data.code===0)e.index.requestPayment({provider:"wxpay",...n.data.data.pay_params,success:o=>{e.index.__f__("log","at subPackages/order/detail.vue:652","支付成功",o),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout(()=>{l()},1500)},fail:o=>{e.index.__f__("error","at subPackages/order/detail.vue:663","支付失败",JSON.stringify(o)),e.index.showToast({title:"支付失败",icon:"none"})}});else throw new Error(n.data.msg||"获取支付参数失败")}catch(a){e.index.__f__("error","at subPackages/order/detail.vue:674","支付失败:",a),e.index.showToast({title:a.message||"支付失败",icon:"none"})}finally{e.index.hideLoading()}},C=t=>{e.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"处理中..."});const n={order_id:t.id},o=await d.startService(n);if(o.data.code===0)e.index.showToast({title:"服务已开始",icon:"success"}),e.index.$emit("orderStatusChanged",{type:"start",orderId:t.id,status:5}),setTimeout(()=>{l()},1500);else throw new Error(o.data.msg||"开始服务失败")}catch(n){e.index.__f__("error","at subPackages/order/detail.vue:727","开始服务失败:",n),e.index.showToast({title:n.message||"开始服务失败",icon:"none"})}finally{e.index.hideLoading()}}})},M=t=>{e.index.navigateTo({url:`/subPackages/order/extend?orderId=${t.id}`})},O=t=>{if(t.companion_id){let a="/subPackages/py/detail?id="+t.companion_id+"&city_code="+_.currentCityCode;e.index.navigateTo({url:a})}else e.index.showToast({title:"友伴信息不存在",icon:"none"})},I=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate?orderId=${t.id}&serviceName=${encodeURIComponent(t.service_name)}&serviceImage=${encodeURIComponent(t.service_image_url)}`})},A=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate-detail?orderId=${t.id}`})},E=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"删除中..."});const n={order_id:t.id},o=await d.deleteOrder(n);if(o.data.code===0)e.index.showToast({title:"订单已删除",icon:"success"}),e.index.$emit("orderOrderDeleted",{orderId:t.id,status:t.status}),setTimeout(()=>{e.index.navigateBack()},1500);else throw new Error(o.data.msg||"删除订单失败")}catch(n){e.index.__f__("error","at subPackages/order/detail.vue:820","删除订单失败:",n),e.index.showToast({title:n.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},g=t=>{if(!t)return"";const a=new Date(t),n=a.getFullYear(),o=String(a.getMonth()+1).padStart(2,"0"),u=String(a.getDate()).padStart(2,"0"),m=String(a.getHours()).padStart(2,"0"),r=String(a.getMinutes()).padStart(2,"0");return`${n}-${o}-${u} ${m}:${r}`},R=t=>{if(!t){e.index.showToast({title:"订单号为空",icon:"none"});return}e.index.setClipboardData({data:t,success:()=>{e.index.showToast({title:"订单号已复制",icon:"success"})},fail:()=>{e.index.showToast({title:"复制失败",icon:"none"})}})},q=(t,a)=>{if(!t&&!a)return"待确认";let n="";if(t){const o=new Date(t),u=o.getFullYear(),m=String(o.getMonth()+1).padStart(2,"0"),r=String(o.getDate()).padStart(2,"0"),c=["周日","周一","周二","周三","周四","周五","周六"][o.getDay()];n+=`${u}-${m}-${r} ${c}`}return a&&(n&&(n+=" "),n+=a),n||"待确认"};return(t,a)=>{var n,o,u,m;return e.e({a:e.t(w(s.value.status)),b:e.n(v(s.value.status)),c:e.unref(p).switch==1},e.unref(p).switch==1?{d:e.f(i.value,(r,c,N)=>e.e({a:e.t(r.icon),b:e.t(r.title),c:c<i.value.length-1},c<i.value.length-1?{d:e.n(y(r.status,i.value[c+1].status))}:{},{e:c,f:e.n(h(r.status))}))}:{},{e:t.$imgBaseUrl+s.value.service_image_url,f:e.t(s.value.service_name),g:e.t(s.value.unit_price),h:e.t(s.value.unit),i:e.t(s.value.quantity),j:e.t(s.value.total_amount),k:t.$imgBaseUrl+((o=(n=s.value)==null?void 0:n.companion)==null?void 0:o.avatar),l:e.t((m=(u=s.value)==null?void 0:u.companion)==null?void 0:m.nickname),m:e.t(s.value.service_address),n:e.t(q(s.value.service_date,s.value.service_time)),o:e.t(s.value.order_no),p:U._imports_0$5,q:e.o(r=>R(s.value.order_no)),r:s.value.start_time},s.value.start_time?{s:e.t(g(s.value.start_time))}:{},{t:s.value.end_time},s.value.end_time?{v:e.t(g(s.value.end_time))}:{},{w:e.t(g(s.value.created_at)),x:s.value.payment_time},s.value.payment_time?{y:e.t(g(s.value.payment_time))}:{},{z:s.value.remark},s.value.remark?{A:e.t(s.value.remark)}:{},{B:e.f(T(s.value.status),(r,c,N)=>e.e({a:e.t(r.text),b:r.text==="联系客服"},r.text==="联系客服"?{c:e.o(()=>{},c)}:{},{d:c,e:e.n(r.type),f:e.o(H=>k(r.action,s.value),c)}))})}}},Y=e._export_sfc(F,[["__scopeId","data-v-c0a82bfd"]]);wx.createPage(Y);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/detail.js.map

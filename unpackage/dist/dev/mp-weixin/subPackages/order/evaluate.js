"use strict";const e=require("../../common/vendor.js"),k=require("../../common/assets.js"),h=require("../../api/file.js"),C=require("../../api/order.js");Array||e.resolveComponent("u-rate")();const F=()=>"../../uni_modules/uview-plus/components/u-rate/u-rate.js";Math||F();const U={__name:"evaluate",setup(w){const _=e.ref(""),f=e.ref(""),g=e.ref(""),i=e.ref(5),c=e.ref(""),s=e.ref([]),v=e.ref(!1),n=e.ref(!1),p=e.computed(()=>i.value>0&&c.value.trim().length>0);e.onLoad(a=>{a.orderId&&(_.value=a.orderId),a.serviceName&&(f.value=decodeURIComponent(a.serviceName)),a.serviceImage&&(g.value=decodeURIComponent(a.serviceImage))});const x=()=>{v.value=!v.value},y=()=>{const a=3-s.value.length;if(a<=0){e.index.showToast({title:"最多只能上传3张图片",icon:"none"});return}e.index.chooseImage({count:a,sizeType:["compressed"],sourceType:["album","camera"],success:async r=>{e.index.showLoading({title:"上传中...",mask:!0});try{const t=r.tempFilePaths.map(async(u,d)=>{try{const l=await I(u);if(!l||!l.extension)throw new Error("无法获取文件信息");const $=await h.uploadFile({filePath:u,name:`evaluate_${Date.now()}_${d}.${l.extension}`}),m=h.getUploadResult($);if(!m||!m.url)throw new Error("上传结果解析失败");return m.url}catch(l){throw e.index.__f__("error","at subPackages/order/evaluate.vue:253",`第${d+1}张图片上传失败:`,l),l}}),o=await Promise.all(t);s.value.push(...o),e.index.showToast({title:`成功上传${o.length}张图片`,icon:"success"})}catch(t){e.index.__f__("error","at subPackages/order/evaluate.vue:270","图片上传失败:",t),e.index.showToast({title:"图片上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:r=>{e.index.__f__("error","at subPackages/order/evaluate.vue:280","选择图片失败:",r),e.index.showToast({title:"选择图片失败",icon:"none"})}})},I=a=>new Promise((r,t)=>{e.index.getFileInfo({filePath:a,success:o=>{const u=a.split(".").pop().toLowerCase();r({size:o.size,extension:u})},fail:o=>{e.index.__f__("error","at subPackages/order/evaluate.vue:303","获取文件信息失败:",o);const u=a.split(".").pop().toLowerCase()||"jpg";r({size:0,extension:u})}})}),P=a=>{e.index.previewImage({urls:s.value,current:a})},b=a=>{s.value.splice(a,1)},T=async()=>{var a,r;if(!(!p.value||n.value)){n.value=!0;try{const t={order_id:parseInt(_.value),rating:i.value,comment:c.value.trim(),comment_images:s.value,is_anonymous:v.value?1:0};e.index.__f__("log","at subPackages/order/evaluate.vue:346","提交评价数据:",t);const o=await C.createOrderComment(t);if(o.data&&o.data.code===0)e.index.showToast({title:"评价提交成功",icon:"none",duration:2e3}),setTimeout(()=>{e.index.navigateBack()},1500);else throw new Error(((a=o.data)==null?void 0:a.msg)||"评价提交失败")}catch(t){e.index.__f__("error","at subPackages/order/evaluate.vue:367","提交评价失败:",t),e.index.showToast({title:((r=t.data)==null?void 0:r.msg)||"提交失败，请重试",icon:"none"})}finally{n.value=!1}}};return(a,r)=>e.e({a:a.$imgBaseUrl+g.value,b:e.t(f.value),c:e.o(t=>i.value=t),d:e.p({color:"#999999","active-color":"#7363FF","is-fill":!1,size:"20",modelValue:i.value}),e:e.t(i.value),f:c.value,g:e.o(t=>c.value=t.detail.value),h:e.t(c.value.length),i:e.f(s.value,(t,o,u)=>({a:a.$imgBaseUrl+t,b:e.o(d=>b(o),o),c:o,d:e.o(d=>P(o),o)})),j:s.value.length<3},s.value.length<3?{k:k._imports_0$4,l:e.o(y)}:{},{m:v.value?1:"",n:e.o(x),o:n.value},n.value?{}:{},{p:!n.value},n.value?{}:{},{q:n.value||!p.value?1:"",r:e.o(T)})}},q=e._export_sfc(U,[["__scopeId","data-v-ec68aea7"]]);wx.createPage(q);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/evaluate.js.map

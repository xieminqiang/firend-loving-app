"use strict";const e=require("../../common/vendor.js"),k=require("../../common/assets.js"),y=require("../../api/order.js"),E=require("../../api/user.js");Array||e.resolveComponent("uni-popup")();const te=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||te();const se={__name:"submit",setup(F){const c=e.ref({}),T=e.ref(""),M=e.ref("taxi"),p=e.ref(1),N=e.ref(0),W=e.ref(0),$=e.ref(""),S=e.ref(!1),v=e.ref([]),x=e.ref(0),D=e.ref(null),A=e.ref(0),I=e.ref(!1),C=e.ref(null),h=e.ref("请选择地址"),O=e.ref(null),_=e.ref({}),q=e.ref({wx_open_id:"",nickname:""}),J=e.computed(()=>{var s,o;const t=(((o=(s=_.value)==null?void 0:s.price_info)==null?void 0:o.unit_price)*p.value||0)+N.value;return Number(t.toFixed(2))}),L=async()=>{var a;try{const{service_id:t,level_order:s,companion_id:o,price_template_id:u}=c.value;if(!t||!s||!o||!u){e.index.__f__("warn","at subPackages/order/submit.vue:228","缺少必要的参数");return}const i=await y.getServiceInfo({service_id:Number(t),level_order:Number(s),companion_id:Number(o),price_template_id:Number(u)});if(e.index.__f__("log","at subPackages/order/submit.vue:238","response.data",i.data),i.data.code===0){const r=i.data.data;_.value=r;const n=((a=r==null?void 0:r.price_info)==null?void 0:a.min_quantity)||1;p.value=n}else throw new Error(i.data.msg||"获取服务信息失败")}catch(t){e.index.__f__("error","at subPackages/order/submit.vue:251","加载服务信息失败:",t),e.index.showToast({title:t.message||"加载服务信息失败",icon:"none"})}},G=async()=>{var a;try{const{companion_id:t}=c.value;if(!t){e.index.__f__("warn","at subPackages/order/submit.vue:265","缺少友伴师ID参数");return}const s=await E.getCompanionWxOpenId({companion_id:Number(t)});if(e.index.__f__("log","at subPackages/order/submit.vue:273","友伴师微信信息:",s.data),s.data&&s.data.code===0){const o=s.data.data;q.value={wx_open_id:o.wx_open_id||"",nickname:o.nickname||""},e.index.__f__("log","at subPackages/order/submit.vue:281","友伴师微信openid:",o.wx_open_id)}else e.index.__f__("error","at subPackages/order/submit.vue:283","获取友伴师微信信息失败:",(a=s.data)==null?void 0:a.message)}catch(t){e.index.__f__("error","at subPackages/order/submit.vue:286","获取友伴师微信信息失败:",t)}},Q=()=>{e.index.chooseLocation({success:async a=>{const t=a.address||a.name||"已选择位置";e.index.__f__("log","at subPackages/order/submit.vue:296","手动选择位置",a),h.value=t,O.value={latitude:a.latitude,longitude:a.longitude,address:t},await H(a.latitude,a.longitude)},fail:a=>{a.errMsg&&a.errMsg.indexOf("cancel")===-1&&(e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/order/submit.vue:316","获取位置失败:",a.errMsg))}})},R=()=>{if(v.value.length===0){e.index.showToast({title:"暂无可用时间",icon:"none"});return}x.value=j(),S.value=!0,e.nextTick$1(()=>{I.value=!1,A.value=0,C.value.open()})},B=a=>{x.value=a,D.value=null,I.value=!0,e.nextTick$1(()=>{const t=e.index.upx2px(140),s=e.index.getWindowInfo().windowWidth,o=e.index.upx2px(40),u=s-o,i=Math.floor(u/t*.8);if(a>2){const r=Math.max(0,a*t-i*t/3);A.value=r}else A.value=0;setTimeout(()=>{I.value=!1},300)})},z=a=>{if(a.status!==1)return;D.value=a;const t=v.value[x.value];T.value=`${t.day_name} ${t.date} ${a.time}`,C.value.close(),S.value=!1},j=()=>{if(v.value.length===0)return 0;for(let a=0;a<v.value.length;a++){const t=v.value[a];if(((t==null?void 0:t.time_slots)||[]).some(u=>u.status===1))return a}return 0},K=()=>{var a;return v.value.length===0?[]:((a=v.value[x.value])==null?void 0:a.time_slots)||[]},U=a=>{M.value=a},V=()=>{p.value++},X=()=>{var t,s;const a=((s=(t=_.value)==null?void 0:t.price_info)==null?void 0:s.min_quantity)||1;p.value>a&&p.value--},H=async(a,t)=>{var s,o;try{const u={companion_id:Number(c.value.companion_id),user_latitude:a,user_longitude:t};e.index.__f__("log","at subPackages/order/submit.vue:452","计算距离请求参数:",u);const i=await y.calculateDistance(u);if(i.data&&i.data.code===0){const r=i.data.data;e.index.__f__("log","at subPackages/order/submit.vue:458","距离计算结果:",r),r.distance!==void 0&&(W.value=r.distance),r.transport_fee!==void 0&&(N.value=Number((r.transport_fee*2).toFixed(2)))}else e.index.__f__("error","at subPackages/order/submit.vue:471","计算距离失败:",(s=i.data)==null?void 0:s.msg),e.index.showToast({title:((o=i.data)==null?void 0:o.msg)||"计算距离失败",icon:"none"})}catch(u){e.index.__f__("error","at subPackages/order/submit.vue:478","计算距离接口调用失败:",u),e.index.showToast({title:"计算距离失败，请重试",icon:"none"})}},Y=async()=>{const a=["vrMAJmeAOA0j3yRGX6AjNEJxqaJ2mvERTFlV89fK3GA","zovIGlvjM10gOUEZjOB-lOQwISsM0PLqfMtIJPbWf4Y"];try{e.index.__f__("log","at subPackages/order/submit.vue:502","开始请求订阅消息权限");const t=await new Promise((i,r)=>{e.index.requestSubscribeMessage({tmplIds:a,success:n=>{e.index.__f__("log","at subPackages/order/submit.vue:508","订阅消息请求结果:",n),i(n)},fail:n=>{e.index.__f__("error","at subPackages/order/submit.vue:512","订阅消息请求失败:",n),r(n)}})});let s=0,o=0,u=!0;return a.forEach(i=>{t[i]==="accept"?s++:(t[i]==="reject"&&o++,u=!1)}),s>0&&(e.index.__f__("log","at subPackages/order/submit.vue:536","用户同意订阅消息"),e.index.showToast({title:"已开启订单提醒",icon:"success"})),o>0?(e.index.__f__("log","at subPackages/order/submit.vue:544","用户拒绝订阅消息"),new Promise(i=>{e.index.showModal({title:"订单提醒权限",content:"为了您能及时接收订单状态通知，是否去设置页面重新授权？",confirmText:"去设置",cancelText:"暂不开启",success:r=>{r.confirm?e.index.openSetting({success:n=>{n.authSetting["scope.subscribeMessage"]?e.index.requestSubscribeMessage({tmplIds:a,success:d=>{e.index.__f__("log","at subPackages/order/submit.vue:563","重新授权成功:",d);let m=0,f=!0;a.forEach(g=>{d[g]==="accept"?m++:f=!1}),m>0&&e.index.showToast({title:"已开启订单提醒",icon:"success"}),i(f)},fail:d=>{e.index.__f__("log","at subPackages/order/submit.vue:585","重新授权失败:",d),i(!1)}}):(e.index.showToast({title:"未开启订单提醒",icon:"none"}),i(!1))},fail:n=>{e.index.__f__("error","at subPackages/order/submit.vue:598","打开设置页面失败:",n),i(!1)}}):(e.index.showToast({title:"未开启订单提醒",icon:"none"}),i(!1))}})})):s===0&&o===0?(e.index.__f__("log","at subPackages/order/submit.vue:616","用户未明确选择订阅消息"),e.index.showToast({title:"未开启订单提醒",icon:"none"}),!1):u}catch(t){return e.index.__f__("error","at subPackages/order/submit.vue:626","订阅消息请求异常:",t),e.index.showToast({title:"订阅消息请求失败",icon:"none"}),!1}},Z=async()=>{var i,r;if(h.value==="请选择地址"){e.index.showToast({title:"请先选择服务地址",icon:"none"});return}if(!T.value){e.index.showToast({title:"请先选择服务时间",icon:"none"});return}if(await Y()===!1){e.index.showModal({title:"提示",content:"为了确保您能及时接收订单状态通知，请先开启订阅消息权限后再提交订单",showCancel:!1,confirmText:"我知道了"});return}const t=T.value.match(/(\d{4}-\d{2}-\d{2})\s+(.+)/);if(!t){e.index.showToast({title:"服务时间格式错误",icon:"none"});return}const s=t[1],o=t[2],u={companion_id:Number(c.value.companion_id),service_id:Number(c.value.service_id),level_order:Number(c.value.level_order),price_template_id:Number(c.value.price_template_id),quantity:p.value,service_address:h.value,service_date:s,service_time:o,remark:$.value,user_latitude:(i=O.value)==null?void 0:i.latitude,user_longitude:(r=O.value)==null?void 0:r.longitude};e.index.__f__("log","at subPackages/order/submit.vue:697","提交订单数据:",u),e.index.showLoading({title:"提交中..."});try{const n=await y.createOrderV2(u);if(n.data.code===0){e.index.__f__("log","at subPackages/order/submit.vue:708","订单创建成功:",n.data);try{const d={order_id:n.data.data.order_id,payment_method:1},m=await y.orderParams(d);if(m.data.code===0)e.index.requestPayment({provider:"wxpay",...m.data.data.pay_params,success:async f=>{var g,P;e.index.__f__("log","at subPackages/order/submit.vue:724","支付成功",f),e.index.showToast({title:"支付成功",icon:"success"});try{if(!q.value.wx_open_id){e.index.__f__("warn","at subPackages/order/submit.vue:734","友伴师微信openid为空，跳过订阅消息发送");return}const w={to_user:q.value.wx_open_id,template_id:"vrMAJmeAOA0j3yRGX6AjNCOvfgzlJp8T1wWLucyCwKc",page:`subPackages/partner/order/detail?orderId=${n.data.data.order_id}&companion_id=${c.value.companion_id}`,data:{phrase4:{value:"待接单"},thing3:{value:((P=(g=_.value)==null?void 0:g.service)==null?void 0:P.name)||"服务"},character_string10:{value:s+" "+o},character_string1:{value:m.data.data.order_no},thing15:{value:h.value}}};await E.sendSubscribeMessage(w),e.index.__f__("log","at subPackages/order/submit.vue:763","订阅消息发送成功，发送给友伴师:",q.value.nickname)}catch(w){e.index.__f__("error","at subPackages/order/submit.vue:765","发送订阅消息失败:",w)}setTimeout(()=>{e.index.navigateBack()},1500)},fail:f=>{e.index.__f__("error","at subPackages/order/submit.vue:775","支付失败",JSON.stringify(f)),e.index.showToast({title:"支付失败",icon:"none"})}});else throw new Error(m.data.msg||"获取支付参数失败")}catch(d){e.index.__f__("error","at subPackages/order/submit.vue:786","获取支付参数失败:",d),e.index.showToast({title:d.message||"获取支付参数失败",icon:"none"})}}else throw new Error(n.data.msg||"创建订单失败")}catch(n){e.index.__f__("error","at subPackages/order/submit.vue:796","提交订单失败:",n),e.index.showToast({title:n.message||"提交订单失败",icon:"none"})}finally{e.index.hideLoading()}};return e.onMounted(()=>{const a=getCurrentPages(),t=a[a.length-1];c.value=t.options||{},e.index.__f__("log","at subPackages/order/submit.vue:812","订单提交页面参数:",c.value),L(),G(),c.value.companion_id&&y.getCompanionAvailableSchedule(Number(c.value.companion_id)).then(s=>{e.index.__f__("log","at subPackages/order/submit.vue:824","友伴师可用时间安排:",s),s.data&&s.data.code===0&&(v.value=s.data.data.schedule||[],v.value.length>0&&(x.value=j()))}).catch(s=>{e.index.__f__("error","at subPackages/order/submit.vue:834","获取友伴师可用时间安排失败:",s)})}),(a,t)=>{var s,o,u,i,r,n,d,m,f,g,P,w;return e.e({a:k._imports_0$12,b:e.t(h.value),c:h.value!=="请选择地址"?1:"",d:k._imports_0$13,e:e.o(Q),f:e.t(T.value),g:k._imports_0$13,h:e.o(R),i:M.value==="taxi"},M.value==="taxi"?{}:{},{j:M.value==="taxi"?1:"",k:e.o(l=>U("taxi")),l:(s=_.value)==null?void 0:s.service},(o=_.value)!=null&&o.service?{m:a.$imgBaseUrl+((i=(u=_.value)==null?void 0:u.service)==null?void 0:i.image_url),n:e.t((n=(r=_.value)==null?void 0:r.service)==null?void 0:n.name),o:e.t((m=(d=_.value)==null?void 0:d.price_info)==null?void 0:m.unit_price),p:e.t((g=(f=_.value)==null?void 0:f.price_info)==null?void 0:g.unit),q:e.t(c.value.nickname),r:k._imports_2$3,s:p.value<=(((w=(P=_.value)==null?void 0:P.price_info)==null?void 0:w.min_quantity)||1)?1:"",t:e.o(X),v:e.t(p.value),w:k._imports_3$4,x:e.o(V)}:{},{y:e.t(N.value.toFixed(2)),z:e.t(W.value),A:$.value,B:e.o(l=>$.value=l.detail.value),C:e.t(J.value.toFixed(2)),D:e.o(Z),E:e.f(v.value,(l,b,ee)=>({a:e.t(l.day_name),b:e.t(l.date),c:b,d:x.value===b?1:"",e:e.o(ae=>B(b),b)})),F:A.value,G:I.value,H:e.f(K(),(l,b,ee)=>({a:e.t(l.time),b,c:l.status===1?1:"",d:l.status===2?1:"",e:D.value===l?1:"",f:e.o(ae=>z(l),b)})),I:e.sr(C,"d71fedd4-0",{k:"timePickerPopup"}),J:e.o(l=>S.value=!1),K:e.p({type:"bottom","mask-click":!0,round:"20"})})}}},ie=e._export_sfc(se,[["__scopeId","data-v-d71fedd4"]]);wx.createPage(ie);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/submit.js.map

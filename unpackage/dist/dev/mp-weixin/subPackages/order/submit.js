"use strict";const e=require("../../common/vendor.js"),h=require("../../common/assets.js"),P=require("../../api/order.js");Array||e.resolveComponent("uni-popup")();const Z=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||Z();const ee={__name:"submit",setup(C){const l=e.ref({}),w=e.ref(""),k=e.ref("taxi"),f=e.ref(1),A=e.ref(0),D=e.ref(0),q=e.ref(""),N=e.ref(!1),_=e.ref([]),g=e.ref(0),S=e.ref(null),y=e.ref(0),T=e.ref(!1),$=e.ref(null),b=e.ref("请选择地址"),I=e.ref(null),v=e.ref({}),F=e.computed(()=>{var s,n;const a=(((n=(s=v.value)==null?void 0:s.price_info)==null?void 0:n.unit_price)*f.value||0)+A.value;return Number(a.toFixed(2))}),W=async()=>{var t;try{const{service_id:a,level_order:s,companion_id:n,price_template_id:r}=l.value;if(!a||!s||!n||!r){e.index.__f__("warn","at subPackages/order/submit.vue:222","缺少必要的参数");return}const i=await P.getServiceInfo({service_id:Number(a),level_order:Number(s),companion_id:Number(n),price_template_id:Number(r)});if(e.index.__f__("log","at subPackages/order/submit.vue:232","response.data",i.data),i.data.code===0){const o=i.data.data;v.value=o;const u=((t=o==null?void 0:o.price_info)==null?void 0:t.min_quantity)||1;f.value=u}else throw new Error(i.data.msg||"获取服务信息失败")}catch(a){e.index.__f__("error","at subPackages/order/submit.vue:245","加载服务信息失败:",a),e.index.showToast({title:a.message||"加载服务信息失败",icon:"none"})}},J=()=>{e.index.chooseLocation({success:async t=>{const a=t.address||t.name||"已选择位置";e.index.__f__("log","at subPackages/order/submit.vue:261","手动选择位置",t),b.value=a,I.value={latitude:t.latitude,longitude:t.longitude,address:a},await U(t.latitude,t.longitude)},fail:t=>{t.errMsg&&t.errMsg.indexOf("cancel")===-1&&(e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/order/submit.vue:281","获取位置失败:",t.errMsg))}})},L=()=>{if(_.value.length===0){e.index.showToast({title:"暂无可用时间",icon:"none"});return}g.value=E(),N.value=!0,e.nextTick$1(()=>{T.value=!1,y.value=0,$.value.open()})},Q=t=>{g.value=t,S.value=null,T.value=!0,e.nextTick$1(()=>{const a=e.index.upx2px(140),s=e.index.getWindowInfo().windowWidth,n=e.index.upx2px(40),r=s-n,i=Math.floor(r/a*.8);if(t>2){const o=Math.max(0,t*a-i*a/3);y.value=o}else y.value=0;setTimeout(()=>{T.value=!1},300)})},B=t=>{if(t.status!==1)return;S.value=t;const a=_.value[g.value];w.value=`${a.day_name} ${a.date} ${t.time}`,$.value.close(),N.value=!1},E=()=>{if(_.value.length===0)return 0;for(let t=0;t<_.value.length;t++){const a=_.value[t];if(((a==null?void 0:a.time_slots)||[]).some(r=>r.status===1))return t}return 0},G=()=>{var t;return _.value.length===0?[]:((t=_.value[g.value])==null?void 0:t.time_slots)||[]},z=t=>{k.value=t},K=()=>{f.value++},R=()=>{var a,s;const t=((s=(a=v.value)==null?void 0:a.price_info)==null?void 0:s.min_quantity)||1;f.value>t&&f.value--},U=async(t,a)=>{var s,n;try{const r={companion_id:Number(l.value.companion_id),user_latitude:t,user_longitude:a};e.index.__f__("log","at subPackages/order/submit.vue:417","计算距离请求参数:",r);const i=await P.calculateDistance(r);if(i.data&&i.data.code===0){const o=i.data.data;e.index.__f__("log","at subPackages/order/submit.vue:423","距离计算结果:",o),o.distance!==void 0&&(D.value=o.distance),o.transport_fee!==void 0&&(A.value=Number((o.transport_fee*2).toFixed(2)))}else e.index.__f__("error","at subPackages/order/submit.vue:436","计算距离失败:",(s=i.data)==null?void 0:s.msg),e.index.showToast({title:((n=i.data)==null?void 0:n.msg)||"计算距离失败",icon:"none"})}catch(r){e.index.__f__("error","at subPackages/order/submit.vue:443","计算距离接口调用失败:",r),e.index.showToast({title:"计算距离失败，请重试",icon:"none"})}},V=async()=>{const t=["zovIGlvjM10gOUEZjOB-lOQwISsM0PLqfMtIJPbWf4Y","vrMAJmeAOA0j3yRGX6AjNEJxqaJ2mvERTFlV89fK3GA"];try{e.index.__f__("log","at subPackages/order/submit.vue:467","开始请求订阅消息权限");const a=await new Promise((i,o)=>{e.index.requestSubscribeMessage({tmplIds:t,success:u=>{e.index.__f__("log","at subPackages/order/submit.vue:473","订阅消息请求结果:",u),i(u)},fail:u=>{e.index.__f__("error","at subPackages/order/submit.vue:477","订阅消息请求失败:",u),o(u)}})});let s=0,n=0,r=!0;return t.forEach(i=>{a[i]==="accept"?s++:(a[i]==="reject"&&n++,r=!1)}),s>0&&(e.index.__f__("log","at subPackages/order/submit.vue:501","用户同意订阅消息"),e.index.showToast({title:"已开启订单提醒",icon:"success"})),n>0?(e.index.__f__("log","at subPackages/order/submit.vue:509","用户拒绝订阅消息"),new Promise(i=>{e.index.showModal({title:"订单提醒权限",content:"为了您能及时接收订单状态通知，是否去设置页面重新授权？",confirmText:"去设置",cancelText:"暂不开启",success:o=>{o.confirm?e.index.openSetting({success:u=>{u.authSetting["scope.subscribeMessage"]?e.index.requestSubscribeMessage({tmplIds:t,success:d=>{e.index.__f__("log","at subPackages/order/submit.vue:528","重新授权成功:",d);let m=0,x=!0;t.forEach(M=>{d[M]==="accept"?m++:x=!1}),m>0&&e.index.showToast({title:"已开启订单提醒",icon:"success"}),i(x)},fail:d=>{e.index.__f__("log","at subPackages/order/submit.vue:550","重新授权失败:",d),i(!1)}}):(e.index.showToast({title:"未开启订单提醒",icon:"none"}),i(!1))},fail:u=>{e.index.__f__("error","at subPackages/order/submit.vue:563","打开设置页面失败:",u),i(!1)}}):(e.index.showToast({title:"未开启订单提醒",icon:"none"}),i(!1))}})})):s===0&&n===0?(e.index.__f__("log","at subPackages/order/submit.vue:581","用户未明确选择订阅消息"),e.index.showToast({title:"未开启订单提醒",icon:"none"}),!1):r}catch(a){return e.index.__f__("error","at subPackages/order/submit.vue:591","订阅消息请求异常:",a),e.index.showToast({title:"订阅消息请求失败",icon:"none"}),!1}},H=async()=>{var r,i;if(b.value==="请选择地址"){e.index.showToast({title:"请先选择服务地址",icon:"none"});return}if(!w.value){e.index.showToast({title:"请先选择服务时间",icon:"none"});return}await V();const t=w.value.match(/(\d{4}-\d{2}-\d{2})\s+(.+)/);if(!t){e.index.showToast({title:"服务时间格式错误",icon:"none"});return}const a=t[1],s=t[2],n={companion_id:Number(l.value.companion_id),service_id:Number(l.value.service_id),level_order:Number(l.value.level_order),price_template_id:Number(l.value.price_template_id),quantity:f.value,service_address:b.value,service_date:a,service_time:s,remark:q.value,user_latitude:(r=I.value)==null?void 0:r.latitude,user_longitude:(i=I.value)==null?void 0:i.longitude};e.index.__f__("log","at subPackages/order/submit.vue:653","提交订单数据:",n),e.index.showLoading({title:"提交中..."});try{const o=await P.createOrderV2(n);if(o.data.code===0){e.index.__f__("log","at subPackages/order/submit.vue:664","订单创建成功:",o.data);try{const u={order_id:o.data.data.order_id,payment_method:1},d=await P.orderParams(u);if(d.data.code===0)e.index.requestPayment({provider:"wxpay",...d.data.data.pay_params,success:async m=>{e.index.__f__("log","at subPackages/order/submit.vue:680","支付成功",m),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout(()=>{e.index.navigateBack()},1500)},fail:m=>{e.index.__f__("error","at subPackages/order/submit.vue:693","支付失败",JSON.stringify(m)),e.index.showToast({title:"支付失败",icon:"none"})}});else throw new Error(d.data.msg||"获取支付参数失败")}catch(u){e.index.__f__("error","at subPackages/order/submit.vue:704","获取支付参数失败:",u),e.index.showToast({title:u.message||"获取支付参数失败",icon:"none"})}}else throw new Error(o.data.msg||"创建订单失败")}catch(o){e.index.__f__("error","at subPackages/order/submit.vue:714","提交订单失败:",o),e.index.showToast({title:o.message||"提交订单失败",icon:"none"})}finally{e.index.hideLoading()}};return e.onMounted(()=>{const t=getCurrentPages(),a=t[t.length-1];l.value=a.options||{},e.index.__f__("log","at subPackages/order/submit.vue:730","订单提交页面参数:",l.value),W(),l.value.companion_id&&P.getCompanionAvailableSchedule(Number(l.value.companion_id)).then(s=>{e.index.__f__("log","at subPackages/order/submit.vue:740","友伴师可用时间安排:",s),s.data&&s.data.code===0&&(_.value=s.data.data.schedule||[],_.value.length>0&&(g.value=E()))}).catch(s=>{e.index.__f__("error","at subPackages/order/submit.vue:750","获取友伴师可用时间安排失败:",s)})}),(t,a)=>{var s,n,r,i,o,u,d,m,x,M,O,j;return e.e({a:h._imports_0$11,b:e.t(b.value),c:b.value!=="请选择地址"?1:"",d:h._imports_0$12,e:e.o(J),f:e.t(w.value),g:h._imports_0$12,h:e.o(L),i:k.value==="taxi"},k.value==="taxi"?{}:{},{j:k.value==="taxi"?1:"",k:e.o(c=>z("taxi")),l:(s=v.value)==null?void 0:s.service},(n=v.value)!=null&&n.service?{m:t.$imgBaseUrl+((i=(r=v.value)==null?void 0:r.service)==null?void 0:i.image_url),n:e.t((u=(o=v.value)==null?void 0:o.service)==null?void 0:u.name),o:e.t((m=(d=v.value)==null?void 0:d.price_info)==null?void 0:m.unit_price),p:e.t((M=(x=v.value)==null?void 0:x.price_info)==null?void 0:M.unit),q:e.t(l.value.nickname),r:h._imports_2$3,s:f.value<=(((j=(O=v.value)==null?void 0:O.price_info)==null?void 0:j.min_quantity)||1)?1:"",t:e.o(R),v:e.t(f.value),w:h._imports_3$4,x:e.o(K)}:{},{y:e.t(A.value.toFixed(2)),z:e.t(D.value),A:q.value,B:e.o(c=>q.value=c.detail.value),C:e.t(F.value.toFixed(2)),D:e.o(H),E:e.f(_.value,(c,p,X)=>({a:e.t(c.day_name),b:e.t(c.date),c:p,d:g.value===p?1:"",e:e.o(Y=>Q(p),p)})),F:y.value,G:T.value,H:e.f(G(),(c,p,X)=>({a:e.t(c.time),b:p,c:c.status===1?1:"",d:c.status===2?1:"",e:S.value===c?1:"",f:e.o(Y=>B(c),p)})),I:e.sr($,"d71fedd4-0",{k:"timePickerPopup"}),J:e.o(c=>N.value=!1),K:e.p({type:"bottom","mask-click":!0,round:"20"})})}}},te=e._export_sfc(ee,[["__scopeId","data-v-d71fedd4"]]);wx.createPage(te);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/submit.js.map

"use strict";const e=require("../../common/vendor.js"),x=require("../../common/assets.js"),h=require("../../api/order.js");Array||e.resolveComponent("uni-popup")();const Y=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||Y();const Z={__name:"submit",setup(L){const c=e.ref({}),y=e.ref(""),P=e.ref("taxi"),v=e.ref(1),T=e.ref(0),A=e.ref(0),$=e.ref(""),N=e.ref(!1),l=e.ref([]),f=e.ref(0),D=e.ref(null),w=e.ref(0),k=e.ref(!1),q=e.ref(null),b=e.ref("请选择地址"),M=e.ref(null),d=e.ref({}),O=e.computed(()=>{var o,r;const a=(((r=(o=d.value)==null?void 0:o.price_info)==null?void 0:r.unit_price)*v.value||0)+T.value;return Number(a.toFixed(2))}),E=async()=>{var t;try{const{service_id:a,level_order:o,companion_id:r,price_template_id:n}=c.value;if(!a||!o||!r||!n){e.index.__f__("warn","at subPackages/order/submit.vue:221","缺少必要的参数");return}const i=await h.getServiceInfo({service_id:Number(a),level_order:Number(o),companion_id:Number(r),price_template_id:Number(n)});if(e.index.__f__("log","at subPackages/order/submit.vue:231","response.data",i.data),i.data.code===0){const s=i.data.data;d.value=s;const _=((t=s==null?void 0:s.price_info)==null?void 0:t.min_quantity)||1;v.value=_}else throw new Error(i.data.msg||"获取服务信息失败")}catch(a){e.index.__f__("error","at subPackages/order/submit.vue:244","加载服务信息失败:",a),e.index.showToast({title:a.message||"加载服务信息失败",icon:"none"})}},Q=()=>{e.index.chooseLocation({success:async t=>{const a=t.address||t.name||"已选择位置";e.index.__f__("log","at subPackages/order/submit.vue:258","手动选择位置",t),b.value=a,M.value={latitude:t.latitude,longitude:t.longitude,address:a},await R(t.latitude,t.longitude)},fail:t=>{t.errMsg&&t.errMsg.indexOf("cancel")===-1&&(e.index.showToast({title:"获取位置失败",icon:"none"}),e.index.__f__("error","at subPackages/order/submit.vue:278","获取位置失败:",t.errMsg))}})},j=()=>{if(l.value.length===0){e.index.showToast({title:"暂无可用时间",icon:"none"});return}f.value=I(),N.value=!0,e.nextTick$1(()=>{k.value=!1,w.value=0,q.value.open()})},B=t=>{f.value=t,D.value=null,k.value=!0,e.nextTick$1(()=>{const a=e.index.upx2px(140),o=e.index.getWindowInfo().windowWidth,r=e.index.upx2px(40),n=o-r,i=Math.floor(n/a*.8);if(t>2){const s=Math.max(0,t*a-i*a/3);w.value=s}else w.value=0;setTimeout(()=>{k.value=!1},300)})},J=t=>{if(t.status!==1)return;D.value=t;const a=l.value[f.value];y.value=`${a.day_name} ${a.date} ${t.time}`,q.value.close(),N.value=!1},I=()=>{if(l.value.length===0)return 0;for(let t=0;t<l.value.length;t++){const a=l.value[t];if(((a==null?void 0:a.time_slots)||[]).some(n=>n.status===1))return t}return 0},z=()=>{var t;return l.value.length===0?[]:((t=l.value[f.value])==null?void 0:t.time_slots)||[]},G=t=>{P.value=t},H=()=>{v.value++},K=()=>{var a,o;const t=((o=(a=d.value)==null?void 0:a.price_info)==null?void 0:o.min_quantity)||1;v.value>t&&v.value--},R=async(t,a)=>{var o,r;try{const n={companion_id:Number(c.value.companion_id),user_latitude:t,user_longitude:a};e.index.__f__("log","at subPackages/order/submit.vue:414","计算距离请求参数:",n);const i=await h.calculateDistance(n);if(i.data&&i.data.code===0){const s=i.data.data;e.index.__f__("log","at subPackages/order/submit.vue:420","距离计算结果:",s),s.distance!==void 0&&(A.value=s.distance),s.transport_fee!==void 0&&(T.value=Number((s.transport_fee*2).toFixed(2)))}else e.index.__f__("error","at subPackages/order/submit.vue:433","计算距离失败:",(o=i.data)==null?void 0:o.msg),e.index.showToast({title:((r=i.data)==null?void 0:r.msg)||"计算距离失败",icon:"none"})}catch(n){e.index.__f__("error","at subPackages/order/submit.vue:440","计算距离接口调用失败:",n),e.index.showToast({title:"计算距离失败，请重试",icon:"none"})}},U=async()=>{var n,i;if(b.value==="请选择地址"){e.index.showToast({title:"请先选择服务地址",icon:"none"});return}if(!y.value){e.index.showToast({title:"请先选择服务时间",icon:"none"});return}const t=y.value.match(/(\d{4}-\d{2}-\d{2})\s+(.+)/);if(!t){e.index.showToast({title:"服务时间格式错误",icon:"none"});return}const a=t[1],o=t[2],r={companion_id:Number(c.value.companion_id),service_id:Number(c.value.service_id),level_order:Number(c.value.level_order),price_template_id:Number(c.value.price_template_id),quantity:v.value,service_address:b.value,service_date:a,service_time:o,remark:$.value,user_latitude:(n=M.value)==null?void 0:n.latitude,user_longitude:(i=M.value)==null?void 0:i.longitude};e.index.__f__("log","at subPackages/order/submit.vue:504","提交订单数据:",r),e.index.showLoading({title:"提交中..."});try{const s=await h.createOrderV2(r);if(s.data.code===0){e.index.__f__("log","at subPackages/order/submit.vue:515","订单创建成功:",s.data);try{const _={order_id:s.data.data.order_id,payment_method:1},p=await h.orderParams(_);if(p.data.code===0)e.index.requestPayment({provider:"wxpay",...p.data.data.pay_params,success:g=>{e.index.__f__("log","at subPackages/order/submit.vue:531","支付成功",g),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout(()=>{e.index.navigateTo({url:"/subPackages/order/index?refresh=true"})},1500)},fail:g=>{e.index.__f__("error","at subPackages/order/submit.vue:544","支付失败",JSON.stringify(g)),e.index.showToast({title:"支付失败",icon:"none"})}});else throw new Error(p.data.msg||"获取支付参数失败")}catch(_){e.index.__f__("error","at subPackages/order/submit.vue:555","获取支付参数失败:",_),e.index.showToast({title:_.message||"获取支付参数失败",icon:"none"})}}else throw new Error(s.data.msg||"创建订单失败")}catch(s){e.index.__f__("error","at subPackages/order/submit.vue:565","提交订单失败:",s),e.index.showToast({title:s.message||"提交订单失败",icon:"none"})}finally{e.index.hideLoading()}};return e.onMounted(()=>{const t=getCurrentPages(),a=t[t.length-1];c.value=a.options||{},e.index.__f__("log","at subPackages/order/submit.vue:581","订单提交页面参数:",c.value),E(),c.value.companion_id&&h.getCompanionAvailableSchedule(Number(c.value.companion_id)).then(o=>{e.index.__f__("log","at subPackages/order/submit.vue:590","友伴师可用时间安排:",o),o.data&&o.data.code===0&&(l.value=o.data.data.schedule||[],l.value.length>0&&(f.value=I()))}).catch(o=>{e.index.__f__("error","at subPackages/order/submit.vue:600","获取友伴师可用时间安排失败:",o)})}),(t,a)=>{var o,r,n,i,s,_,p,g,S,F,W,C;return e.e({a:x._imports_0$8,b:e.t(b.value),c:b.value!=="请选择地址"?1:"",d:x._imports_0$1,e:e.o(Q),f:e.t(y.value),g:x._imports_0$1,h:e.o(j),i:P.value==="taxi"},P.value==="taxi"?{}:{},{j:P.value==="taxi"?1:"",k:e.o(u=>G("taxi")),l:(o=d.value)==null?void 0:o.service},(r=d.value)!=null&&r.service?{m:t.$imgBaseUrl+((i=(n=d.value)==null?void 0:n.service)==null?void 0:i.image_url),n:e.t((_=(s=d.value)==null?void 0:s.service)==null?void 0:_.name),o:e.t((g=(p=d.value)==null?void 0:p.price_info)==null?void 0:g.unit_price),p:e.t((F=(S=d.value)==null?void 0:S.price_info)==null?void 0:F.unit),q:e.t(c.value.nickname),r:x._imports_2$5,s:v.value<=(((C=(W=d.value)==null?void 0:W.price_info)==null?void 0:C.min_quantity)||1)?1:"",t:e.o(K),v:e.t(v.value),w:x._imports_3$3,x:e.o(H)}:{},{y:e.t(T.value.toFixed(2)),z:e.t(A.value),A:$.value,B:e.o(u=>$.value=u.detail.value),C:e.t(O.value.toFixed(2)),D:e.o(U),E:e.f(l.value,(u,m,V)=>({a:e.t(u.day_name),b:e.t(u.date),c:m,d:f.value===m?1:"",e:e.o(X=>B(m),m)})),F:w.value,G:k.value,H:e.f(z(),(u,m,V)=>({a:e.t(u.time),b:m,c:u.status===1?1:"",d:u.status===2?1:"",e:D.value===u?1:"",f:e.o(X=>J(u),m)})),I:e.sr(q,"d71fedd4-0",{k:"timePickerPopup"}),J:e.o(u=>N.value=!1),K:e.p({type:"bottom","mask-click":!0,round:"20"})})}}},ee=e._export_sfc(Z,[["__scopeId","data-v-d71fedd4"]]);wx.createPage(ee);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/submit.js.map

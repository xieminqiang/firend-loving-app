"use strict";const e=require("../../common/vendor.js"),D=require("../../common/assets.js"),C=require("../../stores/user.js"),v=require("../../api/order.js"),R={__name:"refund",setup(I){C.useUserStore();const u=e.ref(!1),d=e.ref(!1),c=e.ref(!1),l=e.ref(!0),f=e.ref(1),h=e.ref(20),s=e.ref([]);e.onUnmounted(()=>{e.index.$off("orderStatusChanged"),e.index.$off("orderOrderDeleted")}),e.onMounted(()=>{e.index.$on("orderStatusChanged",T),e.index.$on("orderOrderDeleted",$)}),e.onLoad(t=>{e.index.__f__("log","at subPackages/order/refund.vue:122","退款页面加载"),g()});const g=async()=>{if(!d.value){d.value=!0;try{const t={page:f.value,page_size:h.value},n=await v.getRefundOrderList(t);if(e.index.__f__("log","at subPackages/order/refund.vue:140","退款订单响应:",n.data),n.data.code===0){const{list:a,total:r}=n.data.data;f.value===1?s.value=a||[]:s.value.push(...a||[]),l.value=s.value.length<r}else throw new Error(n.data.msg||"获取退款订单列表失败")}catch(t){e.index.__f__("error","at subPackages/order/refund.vue:156","加载退款订单列表失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{d.value=!1}}},p=async()=>{if(!u.value){u.value=!0,f.value=1,l.value=!0;try{await g(),await new Promise(t=>setTimeout(t,800))}catch(t){e.index.__f__("error","at subPackages/order/refund.vue:180","刷新失败:",t)}finally{u.value=!1}}},x=()=>{u.value=!1},m=async()=>{if(!(c.value||!l.value)){c.value=!0,f.value++;try{await g()}catch(t){e.index.__f__("error","at subPackages/order/refund.vue:200","加载更多失败:",t),f.value--}finally{c.value=!1}}},w=t=>({8:"status-refunded",9:"status-refunding"})[t]||"status-default",y=t=>({8:"已退款",9:"退款中"})[t]||"未知状态",b=(t,n=null)=>({8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}]})[t]||[],P=(t,n)=>{switch(t){case"contact":k(n);break;case"delete":S(n);break}},k=async t=>{if(e.index.__f__("log","at subPackages/order/refund.vue:252",t),t.companion_id)try{e.index.showLoading({title:"获取电话中..."});const n={companion_id:t.companion_id},a=await v.getCompanionPhone(n);if(a.data.code===0){const r=a.data.data.phone;e.index.hideLoading(),e.index.showModal({title:"联系友伴师",content:`是否拨打友伴师的电话？
${r}`,confirmText:"拨打",cancelText:"取消",success:i=>{i.confirm&&e.index.makePhoneCall({phoneNumber:r})}})}else throw new Error(a.data.msg||"获取友伴师电话失败")}catch(n){e.index.__f__("error","at subPackages/order/refund.vue:288","获取友伴师电话失败:",n),e.index.hideLoading(),e.index.showToast({title:n.message||"获取友伴师电话失败",icon:"none"})}else e.index.showToast({title:"友伴师信息不存在",icon:"none"})},S=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"删除中..."});const a={order_id:t.id},r=await v.deleteOrder(a);if(r.data.code===0)s.value=s.value.filter(i=>i.id!==t.id),e.index.showToast({title:"订单已删除",icon:"success"});else throw new Error(r.data.msg||"删除订单失败")}catch(a){e.index.__f__("error","at subPackages/order/refund.vue:335","删除订单失败:",a),e.index.showToast({title:a.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},M=t=>{e.index.navigateTo({url:`/subPackages/order/detail?orderId=${t}`})},T=t=>{e.index.__f__("log","at subPackages/order/refund.vue:357","收到订单状态变化事件:",t);const{type:n,orderId:a,status:r}=t;n==="refund"&&O(a,r)},$=t=>{e.index.__f__("log","at subPackages/order/refund.vue:370","收到订单删除事件:",t);const{orderId:n}=t;s.value=s.value.filter(a=>a.id!==n)},O=(t,n)=>{const a=s.value.findIndex(r=>r.id===t);a!==-1&&(s.value[a].status=n)},L=t=>{const n=new Date(t),a=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0"),o=String(n.getHours()).padStart(2,"0"),_=String(n.getMinutes()).padStart(2,"0");return`${a}-${r}-${i} ${o}:${_}`};return(t,n)=>e.e({a:s.value.length===0&&!d.value},s.value.length===0&&!d.value?{b:D._imports_3}:e.e({c:e.f(s.value,(a,r,i)=>({a:e.t(L(a.created_at)),b:e.t(y(a.status)),c:e.n(w(a.status)),d:t.$imgBaseUrl+a.service_image_url,e:e.t(a.service_name),f:e.t(a.unit_price),g:e.t(a.unit),h:e.t(a.quantity),i:e.t(a.total_amount),j:e.f(b(a.status,a),(o,_,E)=>e.e({a:e.t(o.text),b:o.text==="联系客服"},o.text==="联系客服"?{c:e.o(()=>{},_)}:{},{d:_,e:e.n(o.type),f:e.o(U=>P(o.action,a),_)})),k:a.id,l:e.o(o=>M(a.id),a.id)})),d:l.value&&s.value.length>0},l.value&&s.value.length>0?e.e({e:c.value},c.value?{}:{}):{}),{f:u.value,g:e.o(p),h:e.o(x),i:e.o(m)})}},q=e._export_sfc(R,[["__scopeId","data-v-b67ff755"]]);wx.createPage(q);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/refund.js.map

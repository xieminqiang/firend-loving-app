"use strict";const e=require("../../common/vendor.js"),P=require("../../common/assets.js"),W=require("../../stores/user.js"),X=require("../../stores/city.js"),u=require("../../api/order.js"),Z={__name:"index",setup(te){W.useUserStore();const L=X.useCityStore(),o=e.ref("all"),f=e.ref(0),g=e.ref(!1),p=e.ref(!1),h=e.ref(!1),i=e.ref(!0),c=e.ref(1),S=e.ref(20),d=e.ref({}),l=e.ref({all:[],pending_payment:[],pending_service:[],in_service:[],completed:[],cancelled:[],refunded:[],refunding:[]});let y=null;e.onUnmounted(()=>{y&&clearTimeout(y)});const x=e.ref([{label:"全部",value:"all",count:0},{label:"待付款",value:"pending_payment",count:0},{label:"待服务",value:"pending_service",count:0},{label:"进行中",value:"in_service",count:0},{label:"已完成",value:"completed",count:0}]);e.onLoad(t=>{if(e.index.__f__("log","at subPackages/order/index.vue:186","订单页面接收到的参数:",t),t.status){e.index.__f__("log","at subPackages/order/index.vue:188","设置订单状态为:",t.status),o.value=t.status;const n=x.value.findIndex(a=>a.value===t.status);n!==-1&&(f.value=n),c.value=1,i.value=!0,delete d.value[t.status]}else e.index.__f__("log","at subPackages/order/index.vue:201","没有传递状态参数，使用默认状态: all"),o.value="all",f.value=0;e.index.__f__("log","at subPackages/order/index.vue:207","onLoad中加载数据，当前状态:",o.value),w()}),e.watch(o,(t,n)=>{e.index.__f__("log","at subPackages/order/index.vue:213","状态变化:",n,"->",t)});const M=async t=>{if(o.value===t)return;o.value=t;const n=x.value.findIndex(a=>a.value===t);if(n!==-1&&(f.value=n),d.value[t])l.value[t]=d.value[t].list,c.value=d.value[t].page,i.value=d.value[t].hasMore;else{c.value=1,i.value=!0,l.value[t]=[];try{await w()}catch(a){e.index.__f__("error","at subPackages/order/index.vue:241","切换状态失败:",a)}}},D=async t=>{const n=t.detail.current,a=x.value[n].value,s=o.value;f.value=n,o.value=a,y&&clearTimeout(y),s!==a&&!d.value[a]&&(y=setTimeout(async()=>{c.value=1,i.value=!0,l.value[a]=[],await w()},300))},m=t=>l.value[t]||[],w=async()=>{if(!p.value){p.value=!0;try{const t={page:c.value,page_size:S.value,status_group:o.value},n=await u.getOrderList(t);if(e.index.__f__("log","at subPackages/order/index.vue:290","response.data",n.data),n.data.code===0){const{list:a,total:s}=n.data.data;c.value===1?(l.value[o.value]=a||[],O(s)):l.value[o.value].push(...a||[]),i.value=l.value[o.value].length<s,d.value[o.value]={list:[...l.value[o.value]],page:c.value,hasMore:i.value}}else throw new Error(n.msg||"获取订单列表失败")}catch(t){e.index.__f__("error","at subPackages/order/index.vue:315","加载订单列表失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{p.value=!1}}},O=t=>{const n=x.value.find(a=>a.value===o.value);n&&(n.count=t||0)},v=async()=>{if(!g.value){g.value=!0,c.value=1,i.value=!0,delete d.value[o.value];try{await w(),await new Promise(t=>setTimeout(t,800))}catch(t){e.index.__f__("error","at subPackages/order/index.vue:366","刷新失败:",t)}finally{g.value=!1}}},R=()=>{g.value=!1},$=async()=>{if(!(h.value||!i.value)){h.value=!0,c.value++;try{await w()}catch(t){e.index.__f__("error","at subPackages/order/index.vue:386","加载更多失败:",t),c.value--}finally{h.value=!1}}},C=t=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"})[t]||"status-default",A=t=>({1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"})[t]||"未知状态",E=t=>t===1?"需付款：":t===2||t===3||t===4||t===5||t===6||t===11?"实付款：":"订单金额：",q=t=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"续钟",action:"extend",type:"primary"},{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:"再次预约",action:"rebook",type:"primary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]})[t]||[],I=(t,n)=>{switch(t){case"cancel":U(n);break;case"refund":n.status===3?N(n):n.status===4?j(n):z(n);break;case"pay":B(n);break;case"contact":F(n);break;case"extend":J(n);break;case"rebook":Y(n);break;case"review":G(n);break;case"delete":K(n);break;case"start":H(n);break}},U=t=>{e.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"取消中..."});const a={order_id:t.id,cancel_reason:"用户取消"},s=await u.cancelOrder(a);if(s.data.code===0)e.index.showToast({title:"订单已取消",icon:"success"}),v();else throw new Error(s.data.msg||"取消订单失败")}catch(a){e.index.__f__("error","at subPackages/order/index.vue:560","取消订单失败:",a),e.index.showToast({title:a.message||"取消订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},z=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"继续退款",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"用户申请退款"},s=await u.applyRefund(a);if(s.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),v();else throw new Error(s.data.msg||"申请退款失败")}catch(a){e.index.__f__("error","at subPackages/order/index.vue:607","申请退款失败:",a),e.index.showToast({title:a.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},N=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已出发，退款时将扣除来回程车费。",confirmText:"继续退款",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"部分退款，扣除来回程车费"},s=await u.applyRefundAfterDeparture(a);if(s.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),v();else throw new Error(s.data.msg||"申请退款失败")}catch(a){e.index.__f__("error","at subPackages/order/index.vue:654","申请退款失败:",a),e.index.showToast({title:a.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},j=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已到达，退款时将扣除友伴师来回程车费。",confirmText:"申请退款",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"部分退款，扣除友伴师来回程车费"},s=await u.applyRefundAfterDeparture(a);if(s.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),v();else throw new Error(s.data.msg||"申请退款失败")}catch(a){e.index.__f__("error","at subPackages/order/index.vue:701","申请退款失败:",a),e.index.showToast({title:a.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},B=async t=>{try{e.index.showLoading({title:"处理中..."});const n={order_id:t.id,payment_method:1},a=await u.orderParams(n);if(a.data.code===0)e.index.requestPayment({provider:"wxpay",...a.data.data.pay_params,success:s=>{e.index.__f__("log","at subPackages/order/index.vue:736","支付成功",s),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout(()=>{v()},1500)},fail:s=>{e.index.__f__("error","at subPackages/order/index.vue:747","支付失败",JSON.stringify(s)),e.index.showToast({title:"支付失败",icon:"none"})}});else throw new Error(a.data.msg||"获取支付参数失败")}catch(n){e.index.__f__("error","at subPackages/order/index.vue:758","支付失败:",n),e.index.showToast({title:n.message||"支付失败",icon:"none"})}finally{e.index.hideLoading()}},F=t=>{t.companion_id&&e.index.showModal({title:"联系友伴师",content:"是否拨打友伴师的电话？",confirmText:"拨打",cancelText:"取消",success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:"13800138000"})}})},H=t=>{e.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const a={order_id:t.id},s=await u.startService(a);if(s.data.code===0)e.index.showToast({title:"服务已开始",icon:"success"}),v();else throw new Error(s.data.msg||"开始服务失败")}catch(a){e.index.__f__("error","at subPackages/order/index.vue:821","开始服务失败:",a),e.index.showToast({title:a.message||"开始服务失败",icon:"none"})}finally{e.index.hideLoading()}}})},J=t=>{e.index.navigateTo({url:`/subPackages/order/extend?orderId=${t.id}`})},Y=t=>{if(t.companion_id){let n="/subPackages/friend/detail?id="+t.companion_id+"&city_code="+L.currentCityCode;e.index.navigateTo({url:n})}else e.index.showToast({title:"友伴信息不存在",icon:"none"})},G=t=>{e.index.navigateTo({url:`/subPackages/order/review?orderId=${t.id}`})},K=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"删除中..."});const a={order_id:t.id},s=await u.deleteOrder(a);if(s.data.code===0)l.value[o.value]=l.value[o.value].filter(T=>T.id!==t.id),e.index.showToast({title:"订单已删除",icon:"success"});else throw new Error(s.data.msg||"删除订单失败")}catch(a){e.index.__f__("error","at subPackages/order/index.vue:896","删除订单失败:",a),e.index.showToast({title:a.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},Q=t=>{e.index.navigateTo({url:`/subPackages/order/detail?orderId=${t}`})},V=t=>{const n=new Date(t),a=n.getFullYear(),s=String(n.getMonth()+1).padStart(2,"0"),T=String(n.getDate()).padStart(2,"0"),r=String(n.getHours()).padStart(2,"0"),k=String(n.getMinutes()).padStart(2,"0");return`${a}-${s}-${T} ${r}:${k}`};return(t,n)=>({a:e.f(x.value,(a,s,T)=>({a:e.t(a.label),b:s,c:f.value===s?1:"",d:e.o(r=>M(a.value),s)})),b:e.f(x.value,(a,s,T)=>e.e({a:m(a.value).length===0&&!p.value},m(a.value).length===0&&!p.value?{b:P._imports_3}:e.e({c:e.f(m(a.value),(r,k,ae)=>e.e({a:e.t(V(r.created_at)),b:e.t(A(r.status)),c:e.n(C(r.status)),d:t.$imgBaseUrl+r.service_image_url,e:e.t(r.service_name),f:e.t(r.unit_price),g:e.t(r.unit),h:e.t(r.quantity),i:e.t(E(r.status)),j:e.t(r.total_amount),k:r.status===4},r.status===4?{l:P._imports_1$5}:{},{m:e.f(q(r.status),(_,b,ne)=>e.e({a:e.t(_.text),b:_.text==="联系客服"},_.text==="联系客服"?{c:e.o(()=>{},b)}:{},{d:b,e:e.n(_.type),f:e.o(se=>I(_.action,r),b)})),n:r.id,o:e.o(_=>Q(r.id),r.id)})),d:i.value&&m(a.value).length>0},i.value&&m(a.value).length>0?e.e({e:h.value},h.value?{}:{}):{}),{f:e.o(v,a.value),g:e.o(R,a.value),h:e.o($,a.value),i:a.value})),c:g.value,d:f.value,e:e.o(D)})}},ee=e._export_sfc(Z,[["__scopeId","data-v-c7cccef5"]]);wx.createPage(ee);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/index.js.map

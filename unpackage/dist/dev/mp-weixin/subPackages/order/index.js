"use strict";const e=require("../../common/vendor.js"),O=require("../../common/assets.js"),ne=require("../../stores/user.js"),se=require("../../stores/city.js"),v=require("../../api/order.js"),re={__name:"index",setup(ie){ne.useUserStore();const S=se.useCityStore(),i=e.ref("all"),_=e.ref(0),h=e.ref(!1),p=e.ref(!1),m=e.ref(!1),c=e.ref(!0),l=e.ref(1),L=e.ref(20),d=e.ref({}),o=e.ref({all:[],pending_payment:[],pending_service:[],in_service:[],completed:[],cancelled:[],refunded:[],refunding:[]});let y=null;e.onUnmounted(()=>{y&&clearTimeout(y),e.index.$off("orderStatusChanged"),e.index.$off("orderOrderDeleted")}),e.onMounted(()=>{e.index.$on("orderStatusChanged",Z),e.index.$on("orderOrderDeleted",K)});const x=e.ref([{label:"全部",value:"all",count:0},{label:"待付款",value:"pending_payment",count:0},{label:"待服务",value:"pending_service",count:0},{label:"进行中",value:"in_service",count:0},{label:"已完成",value:"completed",count:0}]);e.onLoad(t=>{if(e.index.__f__("log","at subPackages/order/index.vue:199","订单页面接收到的参数:",t),t.status){e.index.__f__("log","at subPackages/order/index.vue:201","设置订单状态为:",t.status),i.value=t.status;const a=x.value.findIndex(n=>n.value===t.status);a!==-1&&(_.value=a),l.value=1,c.value=!0,delete d.value[t.status]}else e.index.__f__("log","at subPackages/order/index.vue:214","没有传递状态参数，使用默认状态: all"),i.value="all",_.value=0;e.index.__f__("log","at subPackages/order/index.vue:220","onLoad中加载数据，当前状态:",i.value),b()}),e.watch(i,(t,a)=>{e.index.__f__("log","at subPackages/order/index.vue:226","状态变化:",a,"->",t)});const M=async t=>{if(i.value===t)return;i.value=t;const a=x.value.findIndex(n=>n.value===t);if(a!==-1&&(_.value=a),d.value[t])o.value[t]=d.value[t].list,l.value=d.value[t].page,c.value=d.value[t].hasMore;else{l.value=1,c.value=!0,o.value[t]=[];try{await b()}catch(n){e.index.__f__("error","at subPackages/order/index.vue:254","切换状态失败:",n)}}},C=async t=>{const a=t.detail.current,n=x.value[a].value,s=i.value;_.value=a,i.value=n,y&&clearTimeout(y),s!==n&&!d.value[n]&&(y=setTimeout(async()=>{l.value=1,c.value=!0,o.value[n]=[],await b()},300))},w=t=>o.value[t]||[],b=async()=>{if(!p.value){p.value=!0;try{const t={page:l.value,page_size:L.value,status_group:i.value},a=await v.getOrderList(t);if(e.index.__f__("log","at subPackages/order/index.vue:303","response.data",a.data),a.data.code===0){const{list:n,total:s}=a.data.data;l.value===1?(o.value[i.value]=n||[],$(s)):o.value[i.value].push(...n||[]),c.value=o.value[i.value].length<s,d.value[i.value]={list:[...o.value[i.value]],page:l.value,hasMore:c.value}}else throw new Error(a.msg||"获取订单列表失败")}catch(t){e.index.__f__("error","at subPackages/order/index.vue:328","加载订单列表失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{p.value=!1}}},$=t=>{const a=x.value.find(n=>n.value===i.value);a&&(a.count=t||0)},f=async()=>{if(!h.value){h.value=!0,l.value=1,c.value=!0,delete d.value[i.value];try{await b(),await new Promise(t=>setTimeout(t,800))}catch(t){e.index.__f__("error","at subPackages/order/index.vue:379","刷新失败:",t)}finally{h.value=!1}}},D=()=>{h.value=!1},I=async()=>{if(!(m.value||!c.value)){m.value=!0,l.value++;try{await b()}catch(t){e.index.__f__("error","at subPackages/order/index.vue:399","加载更多失败:",t),l.value--}finally{m.value=!1}}},R=t=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"})[t]||"status-default",E=t=>({1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"})[t]||"未知状态",A=t=>t===1?"需付款：":t===2||t===3||t===4||t===5||t===6||t===11?"实付款：":"订单金额：",q=(t,a=null)=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:a&&a.is_comment===1?"查看评价":"去评价",action:a&&a.is_comment===1?"viewComment":"evaluate",type:"primary"},{text:"再次预约",action:"rebook",type:"secondary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]})[t]||[],U=(t,a)=>{switch(t){case"cancel":j(a);break;case"refund":a.status===3?z(a):a.status===4?F(a):N(a);break;case"pay":B(a);break;case"contact":H(a);break;case"extend":V(a);break;case"rebook":Y(a);break;case"review":handleReviewOrder(a);break;case"delete":W(a);break;case"start":J(a);break;case"evaluate":G(a);break;case"viewComment":Q(a);break}},j=t=>{e.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"取消中..."});const n={order_id:t.id,cancel_reason:"用户取消"},s=await v.cancelOrder(n);if(s.data.code===0)e.index.showToast({title:"订单已取消",icon:"success"}),f();else throw new Error(s.data.msg||"取消订单失败")}catch(n){e.index.__f__("error","at subPackages/order/index.vue:580","取消订单失败:",n),e.index.showToast({title:n.message||"取消订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},N=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"继续退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"用户申请退款"},s=await v.applyRefund(n);if(s.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),f();else throw new Error(s.data.msg||"申请退款失败")}catch(n){e.index.__f__("error","at subPackages/order/index.vue:627","申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},z=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已出发，退款时将扣除来回程车费。",confirmText:"继续退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"部分退款，扣除来回程车费"},s=await v.applyRefundAfterDeparture(n);if(s.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),f();else throw new Error(s.data.msg||"申请退款失败")}catch(n){e.index.__f__("error","at subPackages/order/index.vue:674","申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},F=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已到达，退款时将扣除友伴师来回程车费。",confirmText:"申请退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"部分退款，扣除友伴师来回程车费"},s=await v.applyRefundAfterDeparture(n);if(s.data.code===0)e.index.showToast({title:"退款申请已提交",icon:"success"}),f();else throw new Error(s.data.msg||"申请退款失败")}catch(n){e.index.__f__("error","at subPackages/order/index.vue:721","申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},B=async t=>{try{e.index.showLoading({title:"处理中..."});const a={order_id:t.id,payment_method:1},n=await v.orderParams(a);if(n.data.code===0)e.index.requestPayment({provider:"wxpay",...n.data.data.pay_params,success:s=>{e.index.__f__("log","at subPackages/order/index.vue:756","支付成功",s),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout(()=>{f()},1500)},fail:s=>{e.index.__f__("error","at subPackages/order/index.vue:767","支付失败",JSON.stringify(s)),e.index.showToast({title:"支付失败",icon:"none"})}});else throw new Error(n.data.msg||"获取支付参数失败")}catch(a){e.index.__f__("error","at subPackages/order/index.vue:778","支付失败:",a),e.index.showToast({title:a.message||"支付失败",icon:"none"})}finally{e.index.hideLoading()}},H=t=>{t.companion_id&&e.index.showModal({title:"联系友伴师",content:"是否拨打友伴师的电话？",confirmText:"拨打",cancelText:"取消",success:a=>{a.confirm&&e.index.makePhoneCall({phoneNumber:"13800138000"})}})},J=t=>{e.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"处理中..."});const n={order_id:t.id},s=await v.startService(n);if(s.data.code===0)e.index.showToast({title:"服务已开始",icon:"success"}),f();else throw new Error(s.data.msg||"开始服务失败")}catch(n){e.index.__f__("error","at subPackages/order/index.vue:841","开始服务失败:",n),e.index.showToast({title:n.message||"开始服务失败",icon:"none"})}finally{e.index.hideLoading()}}})},V=t=>{e.index.navigateTo({url:`/subPackages/order/extend?orderId=${t.id}`})},Y=t=>{if(t.companion_id){let a="/subPackages/friend/detail?id="+t.companion_id+"&city_code="+S.currentCityCode;e.index.navigateTo({url:a})}else e.index.showToast({title:"友伴信息不存在",icon:"none"})},G=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate?orderId=${t.id}&serviceName=${encodeURIComponent(t.service_name)}&serviceImage=${encodeURIComponent(t.service_image_url)}`})},Q=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate-detail?orderId=${t.id}`})},W=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"删除中..."});const n={order_id:t.id},s=await v.deleteOrder(n);if(s.data.code===0)o.value[i.value]=o.value[i.value].filter(u=>u.id!==t.id),e.index.showToast({title:"订单已删除",icon:"success"});else throw new Error(s.data.msg||"删除订单失败")}catch(n){e.index.__f__("error","at subPackages/order/index.vue:925","删除订单失败:",n),e.index.showToast({title:n.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},X=t=>{e.index.navigateTo({url:`/subPackages/order/detail?orderId=${t}`})},Z=t=>{e.index.__f__("log","at subPackages/order/index.vue:947","收到订单状态变化事件:",t);const{type:a,orderId:n,status:s}=t;a==="cancel"&&ee(n,s)},K=t=>{e.index.__f__("log","at subPackages/order/index.vue:961","收到订单删除事件:",t);const{orderId:a,status:n}=t;te(a)},ee=(t,a)=>{let n=null;Object.keys(o.value).forEach(s=>{const u=o.value[s].findIndex(r=>r.id===t);u!==-1&&(n=o.value[s][u],o.value[s].splice(u,1))}),n&&(n.status=a,a===7?o.value.cancelled.unshift(n):a===8?o.value.refunded.unshift(n):a===9&&o.value.refunding.unshift(n),k())},te=t=>{Object.keys(o.value).forEach(a=>{const n=o.value[a].findIndex(s=>s.id===t);n!==-1&&o.value[a].splice(n,1)}),k()},k=()=>{Object.keys(o.value).forEach(t=>{d.value[t]&&(d.value[t].list=[...o.value[t]])})},ae=t=>{const a=new Date(t),n=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),u=String(a.getDate()).padStart(2,"0"),r=String(a.getHours()).padStart(2,"0"),P=String(a.getMinutes()).padStart(2,"0");return`${n}-${s}-${u} ${r}:${P}`};return(t,a)=>({a:e.f(x.value,(n,s,u)=>({a:e.t(n.label),b:s,c:_.value===s?1:"",d:e.o(r=>M(n.value),s)})),b:e.f(x.value,(n,s,u)=>e.e({a:w(n.value).length===0&&!p.value},w(n.value).length===0&&!p.value?{b:O._imports_3}:e.e({c:e.f(w(n.value),(r,P,ce)=>e.e({a:e.t(ae(r.created_at)),b:e.t(E(r.status)),c:e.n(R(r.status)),d:t.$imgBaseUrl+r.service_image_url,e:e.t(r.service_name),f:e.t(r.unit_price),g:e.t(r.unit),h:e.t(r.quantity),i:e.t(A(r.status)),j:e.t(r.total_amount),k:r.status===4},r.status===4?{l:O._imports_1$2}:{},{m:e.f(q(r.status,r),(g,T,le)=>e.e({a:e.t(g.text),b:g.text==="联系客服"},g.text==="联系客服"?{c:e.o(()=>{},T)}:{},{d:T,e:e.n(g.type),f:e.o(de=>U(g.action,r),T)})),n:r.id,o:e.o(g=>X(r.id),r.id)})),d:c.value&&w(n.value).length>0},c.value&&w(n.value).length>0?e.e({e:m.value},m.value?{}:{}):{}),{f:e.o(f,n.value),g:e.o(D,n.value),h:e.o(I,n.value),i:n.value})),c:h.value,d:_.value,e:e.o(C)})}},oe=e._export_sfc(re,[["__scopeId","data-v-c7cccef5"]]);wx.createPage(oe);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subPackages/order/index.js.map

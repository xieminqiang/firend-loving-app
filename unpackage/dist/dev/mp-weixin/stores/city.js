"use strict";const a=require("../common/vendor.js"),m=require("../api/home.js"),x=a.defineStore("city",()=>{const e=a.ref([]),i=a.ref(0),o=a.ref(null),v=a.computed(()=>{var t;return e.value.length>0&&((t=e.value[i.value])==null?void 0:t.name)||"选择区域"}),h=a.computed(()=>{var t;return e.value.length>0&&((t=e.value[i.value])==null?void 0:t.code)||null}),r=(t,s,n,l)=>{const y=(n-t)*Math.PI/180,g=(l-s)*Math.PI/180,f=Math.sin(y/2)*Math.sin(y/2)+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(g/2)*Math.sin(g/2);return 6371*(2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f)))},u=()=>new Promise((t,s)=>{a.index.getLocation({type:"wgs84",success:n=>{a.index.__f__("log","at stores/city.js:45","获取位置成功:",n),o.value={latitude:n.latitude,longitude:n.longitude},t(n)},fail:n=>{a.index.__f__("log","at stores/city.js:53","获取位置失败:",n),t(null)}})}),d=()=>{if(!o.value||e.value.length===0){i.value=0;return}let t=0,s=1/0;e.value.forEach((n,l)=>{if(n.latitude&&n.longitude){const c=r(o.value.latitude,o.value.longitude,n.latitude,n.longitude);c<s&&(s=c,t=l)}}),i.value=t,a.index.__f__("log","at stores/city.js:88",`选择最近的城市: ${e.value[t].name}, 距离: ${s.toFixed(2)}km`)},_=async()=>{try{const t=await m.getCityList();t.data&&t.data.code===0&&t.data.data?(e.value=t.data.data.map(s=>({name:s.name,code:s.city_code,latitude:parseFloat(s.lat)||null,longitude:parseFloat(s.lng)||null})),a.index.__f__("log","at stores/city.js:105","原始城市数据:",t.data.data),a.index.__f__("log","at stores/city.js:106","处理后的城市数据:",e.value),e.value.length>0&&d(),a.index.__f__("log","at stores/city.js:113","城市列表加载成功:",e.value)):(a.index.__f__("warn","at stores/city.js:115","获取城市列表失败，使用默认城市列表"),e.value=[])}catch(t){a.index.__f__("error","at stores/city.js:119","获取城市列表失败:",t),e.value=[]}};return{cityList:e,cityIndex:i,userLocation:o,currentCity:v,currentCityCode:h,calculateDistance:r,getUserLocation:u,selectNearestCity:d,loadCityList:_,selectCity:async t=>{t>=0&&t<e.value.length&&(i.value=t,a.index.__f__("log","at stores/city.js:128",`手动选择城市: ${e.value[t].name}`))},selectCityByName:t=>{const s=e.value.findIndex(n=>n.name===t);s!==-1&&(i.value=s,a.index.__f__("log","at stores/city.js:137",`根据名称选择城市: ${t}`))},initCityData:async()=>{await u(),await _()}}},{persist:{key:"city-store",storage:{getItem(e){return a.index.getStorageSync(e)},setItem(e,i){a.index.setStorageSync(e,i)}}}});exports.useCityStore=x;
//# sourceMappingURL=../../.sourcemap/mp-weixin/stores/city.js.map

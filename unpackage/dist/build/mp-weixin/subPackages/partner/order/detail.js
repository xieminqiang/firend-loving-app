"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),a=require("../../../api/order.js"),n=require("../../../stores/user.js"),o={__name:"detail",setup(o){const i=n.useUserStore(),r=e.ref({}),s=e.ref(null),c=e.ref(null);e.onLoad((t=>{if(!i.userInfo||0===Object.keys(i.userInfo).length||!i.token)return e.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{e.index.navigateTo({url:"/subPackages/login/index"})}),1500);t.orderId&&(s.value=t.orderId),t.companion_id&&(c.value=t.companion_id),d()}));const d=async()=>{try{e.index.showLoading({title:"加载中..."});const t=await a.getCompanionOrderDetail({order_id:Number(s.value),companion_id:Number(c.value)});if(0!==t.data.code)throw new Error(t.data.msg||"获取订单详情失败");r.value={...t.data.data.order,logs:t.data.data.logs||[]}}catch(t){console.error("加载订单详情失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{e.index.hideLoading()}},l=t=>{t.user&&t.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${t.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:a=>{a.confirm&&e.index.makePhoneCall({phoneNumber:t.user.phone})}})},u=t=>{e.index.showModal({title:"确认接单",content:"确定要接受这个订单吗？",confirmText:"接单",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const n=await a.acceptCompanionOrder({order_id:t.id,companion_id:Number(c.value)});if(0!==n.data.code)throw new Error(n.data.msg||"接单失败");e.index.showToast({title:"接单成功",icon:"success"}),setTimeout((()=>{d()}),1500)}catch(o){console.error("接单失败:",o),e.index.showToast({title:o.message||"接单失败",icon:"none"})}finally{e.index.hideLoading()}}})},m=t=>{e.index.showModal({title:"拒绝订单",content:"确定要拒绝这个订单吗？",confirmText:"拒绝",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const n=await a.rejectCompanionOrder({order_id:t.id,companion_id:Number(c.value)});if(0!==n.data.code)throw new Error(n.data.msg||"拒绝订单失败");e.index.showToast({title:"已拒绝订单",icon:"success"}),setTimeout((()=>{d()}),1500)}catch(o){console.error("拒绝订单失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},x=t=>{e.index.showModal({title:"确认到达",content:"确认您已到达服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const n=await a.arrivedCompanionOrder({order_id:t.id,companion_id:Number(c.value)});if(0!==n.data.code)throw new Error(n.data.msg||"确认到达失败");e.index.showToast({title:"已确认到达",icon:"success"}),setTimeout((()=>{d()}),1500)}catch(o){console.error("确认到达失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},h=t=>{t.user&&t.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${t.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:a=>{a.confirm&&e.index.makePhoneCall({phoneNumber:t.user.phone})}})},v=t=>{e.index.showModal({title:"确认出发",content:"确认您已开始出发前往服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const n=await a.departCompanionOrder({order_id:t.id,companion_id:Number(c.value)});if(0!==n.data.code)throw new Error(n.data.msg||"确认出发失败");e.index.showToast({title:"已确认出发",icon:"success"}),setTimeout((()=>{d()}),1500)}catch(o){console.error("确认出发失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},p=t=>{e.index.showModal({title:"开始服务",content:"确定要开始服务吗？",confirmText:"开始",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const n=await a.startCompanionService({order_id:t.id,companion_id:Number(c.value)});if(0!==n.data.code)throw new Error(n.data.msg||"开始服务失败");e.index.showToast({title:"服务已开始",icon:"success"}),setTimeout((()=>{d()}),1500)}catch(o){console.error("开始服务失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},w=t=>{e.index.showModal({title:"结束服务",content:"确定要结束服务吗？",confirmText:"结束",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const n=await a.endCompanionService({order_id:t.id,companion_id:Number(c.value)});if(0!==n.data.code)throw new Error(n.data.msg||"结束服务失败");e.index.showToast({title:"服务已结束",icon:"success"}),setTimeout((()=>{d()}),1500)}catch(o){console.error("结束服务失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},g=t=>{e.index.navigateTo({url:`/subPackages/partner/order/partner-evaluate?orderId=${t.id}&companion_id=${c.value}`})},y=t=>{e.index.navigateTo({url:`/subPackages/partner/rebook?orderId=${t.id}`})},f=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"删除中..."});const n=await a.deleteCompanionOrder({order_id:t.id,companion_id:Number(c.value)});if(0!==n.data.code)throw new Error(n.data.msg||"删除订单失败");e.index.showToast({title:"订单已删除",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(o){console.error("删除订单失败:",o),e.index.showToast({title:o.message||"删除失败",icon:"none"})}finally{e.index.hideLoading()}}})},_=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},T=(e,t)=>{if(!e&&!t)return"待确认";let a="";if(e){const t=new Date(e);a+=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${["周日","周一","周二","周三","周四","周五","周六"][t.getDay()]}`}return t&&(a&&(a+=" "),a+=t),a||"待确认"};return(a,n)=>{var o,i,s,c,d,b;return e.e({a:a.$imgBaseUrl+r.value.service_image_url,b:e.t(r.value.service_name),c:e.t(r.value.unit_price),d:e.t(r.value.unit),e:e.t(r.value.quantity),f:e.t(r.value.total_amount),g:e.t(null==(i=null==(o=r.value)?void 0:o.user)?void 0:i.nick_name),h:e.t(null==(c=null==(s=r.value)?void 0:s.user)?void 0:c.phone),i:e.t(r.value.service_address),j:[2,3,4,5,11].includes(r.value.status)},[2,3,4,5,11].includes(r.value.status)?{k:e.o((t=>{var a;(a=r.value).user_latitude&&a.user_longitude?e.index.openLocation({latitude:Number(a.user_latitude),longitude:Number(a.user_longitude),address:a.service_address}):e.index.showToast({title:"暂无位置信息",icon:"none"})}))}:{},{l:e.t(T(r.value.service_date,r.value.service_time)),m:e.t(r.value.order_no),n:t._imports_0$6,o:e.o((t=>{var a;(a=r.value.order_no)?e.index.setClipboardData({data:a,success:()=>{e.index.showToast({title:"订单号已复制",icon:"success"})},fail:()=>{e.index.showToast({title:"复制失败",icon:"none"})}}):e.index.showToast({title:"订单号为空",icon:"none"})})),p:r.value.start_time},r.value.start_time?{q:e.t(_(r.value.start_time))}:{},{r:r.value.end_time},r.value.end_time?{s:e.t(_(r.value.end_time))}:{},{t:e.t(_(r.value.created_at)),v:r.value.payment_time},r.value.payment_time?{w:e.t(_(r.value.payment_time))}:{},{x:r.value.remark},r.value.remark?{y:e.t(r.value.remark)}:{},{z:e.f((d=r.value.status,b=r.value,{2:[{text:"拒绝",action:"reject",type:"secondary"},{text:"接单",action:"accept",type:"primary"}],3:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已到达服务地点",action:"arrived",type:"primary"}],4:[{text:"电话联系",action:"call",type:"secondary"}],5:[{text:"电话联系",action:"contact",type:"secondary"},{text:"结束服务",action:"end",type:"primary"}],6:[...1===b.is_comment?[{text:"查看评价",action:"review",type:"secondary"}]:[],{text:"删除订单",action:"delete",type:"secondary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"订单已取消，给客户退款中",action:"info",type:"info"}],11:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已出发",action:"depart",type:"depart"}]}[d]||[]),((t,a,n)=>({a:e.t(t.text),b:a,c:e.n(t.type),d:e.o((e=>((e,t)=>{switch(e){case"contact":l(t);break;case"accept":u(t);break;case"reject":m(t);break;case"arrived":x(t);break;case"depart":v(t);break;case"call":h(t);break;case"start":p(t);break;case"end":w(t);break;case"review":g(t);break;case"rebook":y(t);break;case"delete":f(t)}})(t.action,r.value)),a)})))})}}},i=e._export_sfc(o,[["__scopeId","data-v-2ad91ee0"]]);wx.createPage(i);

"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/order.js"),n={__name:"index",setup(n){const o=e.ref("all"),i=e.ref(0),s=e.ref(!1),l=e.ref(!1),c=e.ref(!1),r=e.ref(!0),d=e.ref(1),u=e.ref(20),v=e.ref(null),m=e.ref({}),p=e.ref({all:[],pending_accept:[],pending_service:[],in_service:[],completed:[]});let g=null;e.onUnmounted((()=>{g&&clearTimeout(g)}));const x=e.ref([{label:"全部",value:"all",count:0},{label:"待接单",value:"pending_accept",count:0},{label:"待服务",value:"pending_service",count:0},{label:"服务中",value:"in_service",count:0},{label:"已完成",value:"completed",count:0}]);e.onLoad((e=>{if(console.log("友伴订单页面接收到的参数:",e),e.companion_id&&(console.log("设置companion_id为:",e.companion_id),v.value=e.companion_id),e.status){console.log("设置订单状态为:",e.status),o.value=e.status;const a=x.value.findIndex((a=>a.value===e.status));-1!==a&&(i.value=a),d.value=1,r.value=!0,delete m.value[e.status]}else console.log("没有传递状态参数，使用默认状态: all"),o.value="all",i.value=0;console.log("onLoad中加载数据，当前状态:",o.value),w()})),e.watch(o,((e,a)=>{console.log("状态变化:",a,"->",e)}));const h=async e=>{const a=e.detail.current,t=x.value[a].value,n=o.value;i.value=a,o.value=t,g&&clearTimeout(g),n===t||m.value[t]||(g=setTimeout((async()=>{d.value=1,r.value=!0,p.value[t]=[],await w()}),300))},f=e=>p.value[e]||[],w=async()=>{if(!l.value){l.value=!0;try{const e={page:d.value,page_size:u.value,companion_id:Number(v.value)};"all"===o.value||("pending_accept"===o.value?e.status=2:"pending_service"===o.value?e.status_group="pending_service":"in_service"===o.value?e.status=5:"completed"===o.value&&(e.status=6));const a=await t.getCompanionOrderList(e);if(console.log("response.data",a.data),0!==a.data.code)throw new Error(a.data.msg||"获取订单列表失败");{const{list:e,total:t}=a.data.data;1===d.value?(p.value[o.value]=e||[],_(t)):p.value[o.value].push(...e||[]),r.value=p.value[o.value].length<t,m.value[o.value]={list:[...p.value[o.value]],page:d.value,hasMore:r.value}}}catch(a){console.error("加载订单列表失败:",a),e.index.showToast({title:a.message||"加载失败",icon:"none"})}finally{l.value=!1}}},_=e=>{const a=x.value.find((e=>e.value===o.value));a&&(a.count=e||0)},y=async()=>{if(!s.value){s.value=!0,d.value=1,r.value=!0,delete m.value[o.value];try{await w(),await new Promise((e=>setTimeout(e,800)))}catch(e){console.error("刷新失败:",e)}finally{s.value=!1}}},T=()=>{s.value=!1},b=async()=>{if(!c.value&&r.value){c.value=!0,d.value++;try{await w()}catch(e){console.error("加载更多失败:",e),d.value--}finally{c.value=!1}}},k=e=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-cancelled",9:"status-cancelled",11:"status-to-serve"}[e]||"status-default"),L=(e,a)=>({2:[{text:"拒绝",action:"reject",type:"secondary"},{text:"接单",action:"accept",type:"primary"}],3:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已到达服务地点",action:"arrived",type:"primary"}],4:[{text:"电话联系",action:"call",type:"secondary"}],5:[{text:"电话联系",action:"contact",type:"secondary"},{text:"结束服务",action:"end",type:"primary"}],6:[...1===a.is_comment?[{text:"查看评价",action:"review",type:"secondary"}]:[],{text:"删除订单",action:"delete",type:"secondary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"订单已取消，给客户退款中",action:"info",type:"info"}],11:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已出发",action:"depart",type:"depart"}]}[e]||[]),$=a=>{a.user&&a.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${a.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:t=>{t.confirm&&e.index.makePhoneCall({phoneNumber:a.user.phone})}})},M=a=>{e.index.showModal({title:"确认接单",content:"确定要接受这个订单吗？",confirmText:"接单",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const n=await t.acceptCompanionOrder({order_id:a.id,companion_id:Number(v.value)});if(0!==n.data.code)throw new Error(n.data.msg||"接单失败");{e.index.showToast({title:"接单成功",icon:"success"});const a=x.value.findIndex((e=>"pending_service"===e.value));-1!==a&&(i.value=a,o.value="pending_service"),delete m.value.pending_service,d.value=1,r.value=!0,p.value.pending_service=[],await w()}}catch(s){console.error("接单失败:",s),e.index.showToast({title:s.message||"接单失败",icon:"none"})}finally{e.index.hideLoading()}}})},S=a=>{e.index.showModal({title:"拒绝订单",content:"确定要拒绝这个订单吗？",confirmText:"拒绝",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const n=await t.rejectCompanionOrder({order_id:a.id,companion_id:Number(v.value)});if(0!==n.data.code)throw new Error(n.data.msg||"拒绝订单失败");e.index.showToast({title:"已拒绝订单",icon:"success"}),y()}catch(o){console.error("拒绝订单失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},N=a=>{e.index.showModal({title:"确认到达",content:"确认您已到达服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const n=await t.arrivedCompanionOrder({order_id:a.id,companion_id:Number(v.value)});if(0!==n.data.code)throw new Error(n.data.msg||"确认到达失败");e.index.showToast({title:"已确认到达",icon:"success"}),y()}catch(o){console.error("确认到达失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},C=a=>{a.user&&a.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${a.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:t=>{t.confirm&&e.index.makePhoneCall({phoneNumber:a.user.phone})}})},E=a=>{e.index.showModal({title:"确认出发",content:"确认您已开始出发前往服务地点？",confirmText:"确认",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const n=await t.departCompanionOrder({order_id:a.id,companion_id:Number(v.value)});if(0!==n.data.code)throw new Error(n.data.msg||"确认出发失败");e.index.showToast({title:"已确认出发",icon:"success"}),y()}catch(o){console.error("确认出发失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},j=a=>{e.index.showModal({title:"开始服务",content:"确定要开始服务吗？",confirmText:"开始",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const n=await t.startCompanionService({order_id:a.id,companion_id:Number(v.value)});if(0!==n.data.code)throw new Error(n.data.msg||"开始服务失败");e.index.showToast({title:"服务已开始",icon:"success"}),y()}catch(o){console.error("开始服务失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},I=a=>{e.index.showModal({title:"结束服务",content:"确定要结束服务吗？",confirmText:"结束",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"更新中..."});const n=await t.endCompanionService({order_id:a.id,companion_id:Number(v.value)});if(0!==n.data.code)throw new Error(n.data.msg||"结束服务失败");e.index.showToast({title:"服务已结束",icon:"success"}),y()}catch(o){console.error("结束服务失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},P=a=>{e.index.navigateTo({url:`/subPackages/partner/order/partner-evaluate?orderId=${a.id}&companion_id=${v.value}`})},O=a=>{e.index.navigateTo({url:`/subPackages/partner/rebook?orderId=${a.id}`})},q=a=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"删除中..."});const n={order_id:a.id,companion_id:v.value},i=await t.deleteCompanionOrder(n);if(0!==i.data.code)throw new Error(i.data.msg||"删除订单失败");p.value[o.value]=p.value[o.value].filter((e=>e.id!==a.id)),e.index.showToast({title:"订单已删除",icon:"success"})}catch(i){console.error("删除订单失败:",i),e.index.showToast({title:i.message||"删除失败",icon:"none"})}finally{e.index.hideLoading()}}})},D=e=>{const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`},F=(e,a)=>{if(!e&&!a)return"待确认";let t="";if(e){const a=new Date(e);t+=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${["周日","周一","周二","周三","周四","周五","周六"][a.getDay()]}`}return a&&(t&&(t+=" "),t+=a),t||"待确认"};return(t,n)=>({a:e.f(x.value,((a,t,n)=>({a:e.t(a.label),b:t,c:i.value===t?1:"",d:e.o((e=>(async e=>{if(o.value===e)return;o.value=e;const a=x.value.findIndex((a=>a.value===e));if(-1!==a&&(i.value=a),m.value[e])p.value[e]=m.value[e].list,d.value=m.value[e].page,r.value=m.value[e].hasMore;else{d.value=1,r.value=!0,p.value[e]=[];try{await w()}catch(t){console.error("切换状态失败:",t)}}})(a.value)),t)}))),b:e.f(x.value,((n,o,i)=>e.e({a:0===f(n.value).length&&!l.value},0!==f(n.value).length||l.value?e.e({c:e.f(f(n.value),((n,o,i)=>{var s,l,c;return e.e({a:e.t(D(n.created_at)),b:e.t((c=n.status,{1:"待付款",2:"等待接单",3:"我已出发",4:"已到达，等待开始服务",5:"服务中",6:"已完成",7:"已取消",8:"已取消",9:"已取消",11:"待服务"}[c]||"未知状态")),c:e.n(k(n.status)),d:t.$imgBaseUrl+n.service_image_url,e:e.t(n.service_name),f:e.t(n.unit_price),g:e.t(n.unit),h:e.t(n.quantity),i:e.t(n.total_amount),j:[2,3,4,5,11].includes(n.status)},[2,3,4,5,11].includes(n.status)?e.e({k:2!=n.status&&n.user},2!=n.status&&n.user?{l:e.t(null==(s=null==n?void 0:n.user)?void 0:s.nick_name),m:e.t(null==(l=null==n?void 0:n.user)?void 0:l.phone)}:{},{n:e.t(n.service_address),o:e.o((a=>(a=>{a.user_latitude&&a.user_longitude?e.index.openLocation({latitude:Number(a.user_latitude),longitude:Number(a.user_longitude),address:a.service_address}):e.index.showToast({title:"暂无位置信息",icon:"none"})})(n)),n.id),p:e.t(F(n.service_date,n.service_time))}):{},{q:4===n.status},4===n.status?{r:a._imports_1$2}:{},{s:e.f(L(n.status,n),((a,t,o)=>({a:e.t(a.text),b:t,c:e.n(a.type),d:e.o((e=>((e,a)=>{switch(e){case"contact":$(a);break;case"accept":M(a);break;case"reject":S(a);break;case"arrived":N(a);break;case"depart":E(a);break;case"call":C(a);break;case"start":j(a);break;case"end":I(a);break;case"review":P(a);break;case"rebook":O(a);break;case"delete":q(a)}})(a.action,n)),t)}))),t:n.id,v:e.o((a=>{return t=n.id,void e.index.navigateTo({url:`/subPackages/partner/order/detail?orderId=${t}&companion_id=${v.value}`});var t}),n.id)})})),d:r.value&&f(n.value).length>0},r.value&&f(n.value).length>0?e.e({e:c.value},(c.value,{})):{}):{b:a._imports_3},{f:e.o(y,n.value),g:e.o(T,n.value),h:e.o(b,n.value),i:n.value}))),c:s.value,d:i.value,e:e.o(h)})}},o=e._export_sfc(n,[["__scopeId","data-v-a963f3d7"]]);wx.createPage(o);

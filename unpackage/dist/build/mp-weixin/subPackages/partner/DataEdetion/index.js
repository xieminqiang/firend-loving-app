"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/user.js"),n=require("../../../api/home.js"),l=require("../../../api/file.js"),o=require("../../../stores/user.js"),i={__name:"index",setup(i){const s=o.useUserStore(),{proxy:c}=e.getCurrentInstance(),u=e.ref(0),r=e.ref(!1),v=e.ref(!1),d=e.reactive({nickname:"",gender:"",age:"",height:"",weight:"",city:"深圳市"}),g=e.ref(!1),h=e.ref([]),m=e.ref([]),f=e.ref([]),p=e.ref(!1),w=e.ref([]),y=e.ref([]),x=e.ref([]),_=e.ref(!1),T=e.ref([]),$=e.ref([]),b=e.ref(!1),I=e.ref([]),S=e.ref(!1),k=e.ref(4),C=e.ref([]),P=e.ref(new Map),j=e.ref(new Map),q=e.ref([{type:4,name:"个性特质"},{type:5,name:"我的爱好"},{type:6,name:"外貌风格"},{type:7,name:"专业技能"},{type:8,name:"热门推荐"}]);e.onMounted((async()=>{const a=e.index.getSystemInfoSync();u.value=a.statusBarHeight||0,await B()}));const B=async()=>{try{await U(),await L()}catch(a){console.error("加载初始数据失败:",a),e.index.showToast({title:"加载数据失败，请重试",icon:"none"})}},L=async()=>{try{const e=await t.getApplicatioInfo();if(e.data&&0===e.data.code&&e.data.data){const a=e.data.data;if(d.nickname=a.nickname||"",d.gender="男"===a.gender?"male":"female",d.age=a.age?String(a.age):"",d.height=a.height?String(a.height):"",d.weight=a.weight?String(a.weight):"",w.value=a.photos||[],a.service_areas&&a.service_areas.length>0){console.log("开始处理服务区域回显:",{service_areas:a.service_areas,cityList:f.value});const e=a.service_areas.map((e=>{const a=f.value.find((a=>a.code===Number(e)));return console.log(`查找城市代码 ${e}:`,a),a?a.name:null})).filter((e=>null!==e));h.value=e,d.city=e[0]||"深圳市",console.log("服务区域回显完成:",{service_areas:a.service_areas,cityNames:e,selectedCities:h.value})}x.value=a.services||[],a.tags&&a.tags.length>0&&($.value=a.tags.map((e=>({id:Date.now()+Math.random(),tag_name:e})))),h.value.length>0&&await M(),console.log("申请数据加载成功:",a)}else console.warn("获取申请数据失败")}catch(a){console.error("加载申请数据失败:",a),e.index.showToast({title:"加载申请数据失败",icon:"none"})}},M=async()=>{if(0===h.value.length)return y.value=[],void(T.value=[]);_.value=!0;try{const e=h.value.map((e=>{const a=f.value.find((a=>a.name===e));return a?a.code:null})).filter((e=>null!==e));if(0===e.length)return console.warn("未找到有效的城市代码"),y.value=[],void(T.value=[]);const a=await t.getServicesByCities(e);a.data&&0===a.data.code&&a.data.data?(y.value=a.data.data,z(),console.log("服务技能列表加载成功:",y.value),console.log("服务技能分组:",T.value)):(console.warn("获取服务技能列表失败"),y.value=[],T.value=[])}catch(e){console.error("获取服务技能列表失败:",e),y.value=[],T.value=[]}finally{_.value=!1}},z=()=>{const e={};y.value.forEach((a=>{const t=a.category,n=a.category_name||"其他";e[t]||(e[t]={id:t,name:n,services:[]}),e[t].services.push(a)})),T.value=Object.values(e).sort(((e,a)=>e.id-a.id))},U=async()=>{p.value=!0;try{const e=await n.getCityList();e.data&&0===e.data.code&&e.data.data?(f.value=e.data.data.map((e=>({name:e.name,code:e.city_code}))),console.log("资料编辑页面区域列表加载成功:",f.value),console.log("城市列表数据结构:",e.data.data)):(console.warn("获取区域列表失败"),f.value=[])}catch(e){console.error("获取区域列表失败:",e),f.value=[]}finally{p.value=!1}},D=e=>{d.gender=e},O=()=>{m.value=[...h.value],g.value=!0},A=()=>{m.value=[],g.value=!1},E=async()=>{0!==m.value.length?(h.value=[...m.value],d.city=h.value[0],g.value=!1,m.value=[],x.value=[],T.value=[],await M()):e.index.showToast({title:"请至少选择一个服务区域",icon:"none"})},F=()=>{const a=6-w.value.length;a<=0?e.index.showToast({title:"最多只能上传6张照片",icon:"none"}):e.index.chooseImage({count:a,sizeType:["compressed"],sourceType:["album","camera"],success:async a=>{e.index.showLoading({title:"上传中...",mask:!0});try{const t=a.tempFilePaths.map((async(e,a)=>{try{const t=await N(e);if(console.log("fileInfo",t),console.log("filePath",e),!t||!t.extension)throw new Error("无法获取文件信息");const n=await l.uploadFile({filePath:e,name:`photo_${Date.now()}_${a}.${t.extension}`}),o=l.getUploadResult(n);if(!o||!o.url)throw new Error("上传结果解析失败");return o.url}catch(t){throw console.error(`第${a+1}张照片上传失败:`,t),t}})),n=await Promise.all(t);w.value.push(...n),e.index.showToast({title:`成功上传${n.length}张照片`,icon:"success"})}catch(t){console.error("照片上传失败:",t),e.index.showToast({title:"照片上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:a=>{console.error("选择照片失败:",a),e.index.showToast({title:"选择照片失败",icon:"none"})}})},N=a=>new Promise(((t,n)=>{e.index.getFileInfo({filePath:a,success:e=>{const n=a.split(".").pop().toLowerCase();t({size:e.size,extension:n})},fail:e=>{console.error("获取文件信息失败:",e);const n=a.split(".").pop().toLowerCase()||"jpg";t({size:0,extension:n})}})})),H=async()=>{r.value=!0;try{await B()}catch(a){e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}finally{r.value=!1}},R=()=>{r.value=!1},G=async()=>{if(v.value)return;if(!d.nickname.trim())return void e.index.showToast({title:"请输入昵称",icon:"none"});if(d.nickname.length>50)return void e.index.showToast({title:"昵称不能超过50个字符",icon:"none"});if(!d.gender)return void e.index.showToast({title:"请选择性别",icon:"none"});const a=parseInt(d.age),t=parseInt(d.height),n=parseInt(d.weight);!a||a<18||a>65?e.index.showToast({title:"年龄必须在18-65岁之间",icon:"none"}):!t||t<100||t>250?e.index.showToast({title:"身高必须在100-250cm之间",icon:"none"}):!n||n<30||n>200?e.index.showToast({title:"请输入合理的体重",icon:"none"}):0!==h.value.length?0!==w.value.length?w.value.length>9?e.index.showToast({title:"最多只能上传9张照片",icon:"none"}):0!==x.value.length?await J():e.index.showToast({title:"请至少选择一项服务技能",icon:"none"}):e.index.showToast({title:"请上传至少一张生活照",icon:"none"}):e.index.showToast({title:"请至少选择一个服务区域",icon:"none"})},J=async()=>{v.value=!0;try{const a=h.value.map((e=>{const a=f.value.find((a=>a.name===e));return a?String(a.code):null})).filter((e=>null!==e));if(0===a.length)return void e.index.showToast({title:"服务区域数据异常，请重新选择",icon:"none"});const n={nickname:d.nickname.trim(),gender:"male"===d.gender?"男":"女",age:parseInt(d.age),height:parseInt(d.height),weight:parseInt(d.weight),service_areas:a,services:x.value,can_accept_orders:"N",photos:w.value,tags:$.value.map((e=>e.tag_name)),phone:s.userInfo.phone||""};console.log("保存数据:",n);const l=await t.updateCompanionApplication(n);if(console.log("接口响应:",l),l&&l.data&&0===l.data.code)e.index.showToast({title:"保存成功",icon:"success",duration:2e3}),e.index.$emit("applicationStatusChanged",{status:"updated",message:"资料更新成功"}),setTimeout((()=>{e.index.navigateBack()}),1500);else{const a=l&&l.data&&l.data.message||"保存失败，请稍后重试";e.index.showModal({title:"保存失败",content:a,showCancel:!1,confirmText:"我知道了"})}}catch(a){console.error("保存失败:",a);let t="保存失败，请稍后重试";a&&a.message&&(t=a.message.includes("网络")?"网络连接异常，请检查网络后重试":a.message.includes("参数")?"保存信息有误，请检查后重试":a.message),e.index.showModal({title:"保存失败",content:t,showCancel:!1,confirmText:"我知道了"})}finally{v.value=!1}},K=()=>{I.value=[],b.value=!1},Q=async(e,a=!1)=>{if(!a&&(e=>{const a=j.value.get(e);return!!a&&Date.now()-a<3e5})(e)){const a=(e=>P.value.get(e)||[])(e);if(a.length>0)return console.log(`使用缓存数据 - 标签类型${e}，数据量: ${a.length}`),void(C.value=a)}S.value=!0;try{console.log(`开始加载标签类型: ${e}`);const a={tag_type:e,page:1,pageSize:60};console.log("请求参数:",a);const n=await t.getPersonalityTags(a);if(console.log("API响应:",n),n.data&&0===n.data.code&&n.data.data){const a=n.data.data.list||n.data.data;C.value=a,((e,a)=>{P.value.set(e,a),j.value.set(e,Date.now()),console.log(`标签类型${e}已缓存，数据量: ${a.length}`)})(e,a),console.log(`标签类型${e}加载成功:`,a)}else console.warn(`获取标签类型${e}失败，响应数据:`,n),C.value=[]}catch(n){console.error(`获取标签类型${e}失败:`,n),console.error("错误详情:",n.response||n),C.value=[]}finally{S.value=!1}},V=e=>I.value.some((a=>a.id===e)),W=()=>{$.value=[...I.value],b.value=!1,I.value=[],e.index.showToast({title:`已选择${$.value.length}个标签`,icon:"success"})};return(t,n)=>e.e({a:d.nickname,b:e.o((e=>d.nickname=e.detail.value)),c:a._imports_4,d:"male"===d.gender?1:"",e:e.o((e=>D("male"))),f:a._imports_3$2,g:"female"===d.gender?1:"",h:e.o((e=>D("female"))),i:d.age,j:e.o((e=>d.age=e.detail.value)),k:d.height,l:e.o((e=>d.height=e.detail.value)),m:d.weight,n:e.o((e=>d.weight=e.detail.value)),o:0===h.value.length},0===h.value.length?{}:{p:e.t(h.value.length)},{q:e.o(O),r:h.value.length>0},h.value.length>0?{s:e.f(h.value,((a,t,n)=>({a:e.t(a),b:a,c:e.o((t=>(a=>{const t=h.value.indexOf(a);t>-1&&(h.value.splice(t,1),e.index.vibrateShort({type:"light"}))})(a)),a)})))}:{},{t:e.f(w.value,((a,n,l)=>({a:t.$imgBaseUrl+a,b:e.o((e=>(e=>{w.value.splice(e,1)})(n)),n),c:n,d:e.o((a=>(a=>{e.index.previewImage({urls:w.value.map((e=>c.$imgBaseUrl+e)),current:c.$imgBaseUrl+w.value[a],indicator:"number",loop:!0,show:!0,success:function(e){console.log("图片预览成功",e)},fail:function(e){console.error("图片预览失败",e)}})})(n)),n)}))),v:w.value.length<6},w.value.length<6?{w:a._imports_0$5,x:e.o(F)}:{},{y:_.value},_.value||0===h.value.length?{}:T.value.length>0?{B:e.f(T.value,((a,t,n)=>({a:e.t(a.name),b:e.f(a.services,((a,t,n)=>({a:e.t(a.name),b:x.value.includes(a.id)?1:"",c:a.id,d:e.o((t=>(a=>{const t=a.id,n=x.value.indexOf(t);n>-1?x.value.splice(n,1):x.value.push(t),e.index.vibrateShort({type:"light"})})(a)),a.id)}))),c:a.id})))}:{},{z:0===h.value.length,A:T.value.length>0,C:$.value.length>0},$.value.length>0?{D:e.f($.value,((a,t,n)=>({a:e.t(a.tag_name),b:a.id,c:e.o((t=>(a=>{const t=$.value.findIndex((e=>e.id===a.id));t>-1&&($.value.splice(t,1),e.index.vibrateShort({type:"light"}))})(a)),a.id)})))}:{},{E:e.t($.value.length),F:$.value.length>=5?1:"",G:e.o((e=>$.value.length<5?(I.value=[...$.value],b.value=!0,void Q(4)):null)),H:r.value,I:e.o(H),J:e.o(R),K:v.value},(v.value,{}),{L:!v.value},(v.value,{}),{M:v.value?1:"",N:e.o(G),O:g.value},g.value?e.e({P:e.o(A),Q:p.value},p.value?{}:{R:e.f(f.value,((a,t,n)=>e.e({a:e.t(a.name),b:m.value.includes(a.name)},(m.value.includes(a.name),{}),{c:t,d:e.n({active:m.value.includes(a.name)}),e:e.o((t=>(a=>{const t=m.value.indexOf(a);t>-1?m.value.splice(t,1):m.value.push(a),e.index.vibrateShort({type:"light"})})(a.name)),t)})))},{S:e.t(m.value.length),T:e.o(E),U:e.o((()=>{})),V:e.o(A)}):{},{W:b.value},b.value?e.e({X:e.o(K),Y:e.f(q.value,((a,t,n)=>({a:e.t(a.name),b:a.type,c:e.n({active:k.value===a.type}),d:e.o((e=>{return t=a.type,k.value=t,void Q(t);var t}),a.type)}))),Z:!S.value&&I.value.length>=5},(!S.value&&I.value.length,{}),{aa:S.value},S.value?{}:{ab:e.f(C.value,((a,t,n)=>e.e({a:e.t(a.tag_name),b:V(a.id)},(V(a.id),{}),{c:a.id,d:e.n({selected:V(a.id)}),e:e.o((t=>(a=>{const t=I.value.findIndex((e=>e.id===a.id));if(t>-1)I.value.splice(t,1);else{if(I.value.length>=5)return void e.index.showToast({title:"最多只能选择5个标签",icon:"none"});I.value.push(a)}e.index.vibrateShort({type:"light"})})(a)),a.id)})))},{ac:!S.value&&0===C.value.length},(S.value||C.value.length,{}),{ad:e.t(I.value.length),ae:e.o(W),af:e.o((()=>{})),ag:e.o(K)}):{})}},s=e._export_sfc(i,[["__scopeId","data-v-f2e11859"]]);wx.createPage(s);

"use strict";const t=require("../../../common/vendor.js");let e={latitude:null,longitude:null,address:"",timestamp:0};const s=(t,s)=>{if(!e.latitude||!e.longitude)return!0;return((t,e,s,a)=>{const d=(s-t)*Math.PI/180,o=(a-e)*Math.PI/180,r=Math.sin(d/2)*Math.sin(d/2)+Math.cos(t*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2);return 2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))*6371e3})(e.latitude,e.longitude,t,s)>100},a=()=>{if(!e.timestamp)return!1;return Date.now()-e.timestamp<12e4};exports.getCacheStatus=function(){return{hasCache:!!e.address,isValid:a(),timestamp:e.timestamp,address:e.address,coordinates:{latitude:e.latitude,longitude:e.longitude}}},exports.getCurrentLocationAddress=function(d=!1){return new Promise(((o,r)=>{t.index.getLocation({success:r=>{console.log("获取位置成功:",r);const{latitude:i,longitude:n}=r;if(!(d||!a()||s(i,n))&&e.address)return console.log("使用缓存地址，位置变化不大"),void o({latitude:i,longitude:n,address:e.address});(function(d,o,r=!1){return new Promise(((i,n)=>{if(d&&o)return!r&&a()&&!s(d,o)&&e.address?(console.log("使用缓存地址，位置变化不大:",e.address),void i(e.address)):(console.log("调用腾讯地图API获取地址:",d,o),void t.index.request({url:"https://apis.map.qq.com/ws/geocoder/v1/",method:"GET",data:{key:"4Z3BZ-4JXCJ-EFNFY-DIL4V-6KKKH-YHF6Z",location:`${d},${o}`,output:"json"},success:t=>{if(console.log("腾讯地图API响应:",t),200===t.statusCode&&t.data&&0===t.data.status&&t.data.result&&t.data.result.address)e={latitude:d,longitude:o,address:t.data.result.address,timestamp:Date.now()},i(t.data.result.address);else{const t=`${d.toFixed(6)}, ${o.toFixed(6)}`;e={latitude:d,longitude:o,address:t,timestamp:Date.now()},i(t)}},fail:t=>{console.error("腾讯地图API调用失败:",t);const s=`${d.toFixed(6)}, ${o.toFixed(6)}`;e={latitude:d,longitude:o,address:s,timestamp:Date.now()},i(s)}}));n(new Error("经纬度参数不能为空"))}))})(i,n,d).then((t=>{o({latitude:i,longitude:n,address:t})})).catch((t=>{console.error("获取地址失败:",t),o({latitude:i,longitude:n,address:`${i.toFixed(6)}, ${n.toFixed(6)}`})}))},fail:t=>{console.error("获取位置失败:",t),r(new Error("获取位置失败: "+(t.errMsg||t.message||"未知错误")))}})}))};

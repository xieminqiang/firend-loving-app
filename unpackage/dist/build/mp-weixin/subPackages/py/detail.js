"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),n=require("../../api/friends.js"),a=require("../../api/discover.js"),t=require("../../stores/level.js"),i=require("../../stores/user.js");if(!Array){(e.resolveComponent("u-tabs")+e.resolveComponent("u-avatar")+e.resolveComponent("u-popup"))()}Math||((()=>"../../uni_modules/uview-plus/components/u-tabs/u-tabs.js")+l+(()=>"../../uni_modules/uview-plus/components/u-avatar/u-avatar.js")+(()=>"../../uni_modules/uview-plus/components/u-popup/u-popup.js"))();const l=()=>"../../components/common/PictureDisplay.js",s={__name:"detail",setup(l){const s=e.ref({}),{proxy:r}=e.getCurrentInstance(),u=t.useLevelStore(),m=i.useUserStore(),c=e.computed((()=>m.userInfo&&Object.keys(m.userInfo).length>0));e.computed((()=>{if(c.value)return m.userInfo}));const v=["提供项目","TA的动态","客户评价"],d=e.ref(0),_=e.computed((()=>v.map((e=>({name:e}))))),p=e=>{let o,n;if("object"==typeof e&&null!==e)o=e.index,n=e.name;else{if("number"!=typeof e)return void console.error("Invalid tab change item:",e);o=e,n=v[o]}o<0||o>=v.length?console.error("Invalid tab index:",o):n?(console.log("Tab changed to:",n,"index:",o),d.value=o):console.error("Tab not found for index:",o,"item:",e)},g=e.ref({}),f=e.ref([]),h=e.ref([]),b=e.ref([]),y=e.ref(!1),x=e.ref([]),w=e.ref(!1),$=e.ref(!1),I=e.ref(""),j=e.ref(!1),C=e.computed((()=>g.value.level_order&&u.sortedServiceLevels.length?u.sortedServiceLevels.find((e=>e.level_order===g.value.level_order)):null)),k=o=>{if(!c.value)return e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void e.index.navigateTo({url:"/subPackages/login/index"});e.index.navigateTo({url:`/subPackages/order/submit?service_id=${o.service_id}&price_template_id=${o.price_template_id||""}&companion_id=${s.value.id}&level_order=${g.value.level_order||""}&nickname=${g.value.nickname}`})},S=e=>{console.log("播放视频:",e),I.value=e,$.value=!0},B=()=>{$.value=!1,I.value=""},T=async o=>{try{const n=o.moments_info.is_praised;o.moments_info.is_praised=!n,o.moments_info.is_praised?o.moments_info.praise_num=parseInt(o.moments_info.praise_num)+1:o.moments_info.praise_num=Math.max(0,parseInt(o.moments_info.praise_num)-1);const t=await a.praiseMoment({target_id:o.moments_info.moments_id});t.data&&0===t.data.code?console.log("点赞成功"):(o.moments_info.is_praised=n,o.moments_info.praise_num=n?parseInt(o.moments_info.praise_num)+1:Math.max(0,parseInt(o.moments_info.praise_num)-1),e.index.showToast({title:"点赞失败，请重试",icon:"none"}))}catch(n){console.error("点赞失败:",n);const a=o.moments_info.is_praised;o.moments_info.is_praised=!a,o.moments_info.praise_num=a?parseInt(o.moments_info.praise_num)+1:Math.max(0,parseInt(o.moments_info.praise_num)-1),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},U=e=>{if(!e)return"";const o=new Date(e),n=new Date-o,a=Math.floor(n/864e5);return 0===a?"今天":1===a?"昨天":a<7?`${a}天前`:e.split(" ")[0]},M=e=>{e.detail.scrollTop>=q.value?j.value=!0:j.value=!1},q=e.ref(0),A=()=>{e.index.createSelectorQuery().select(".profile-tabs").boundingClientRect((e=>{e&&(q.value=e.top)})).exec()};return e.onMounted((async()=>{await u.fetchServiceLevels();const e=getCurrentPages(),o=e[e.length-1];s.value=o.options||{},console.log("页面参数:",s.value),console.log("经纬度参数:",{latitude:s.value.latitude,longitude:s.value.longitude}),s.value.id&&s.value.city_code&&(async()=>{var e;try{const o={city_code:s.value.city_code,application_id:s.value.id};s.value.latitude&&s.value.longitude&&(o.latitude=parseFloat(s.value.latitude),o.longitude=parseFloat(s.value.longitude));const a=await n.getCityServices(o);if(console.log("城市服务信息响应:",a),A(),a.data&&0===a.data.code){const e=a.data.data;console.log("城市服务数据:",e),e&&(g.value={avatar:e.avatar,nickname:e.nickname||"未知用户",verified:!0,age:e.age,weight:e.weight,height:e.height,distance:e.distance,tags:e.tags||[],level_order:e.level_order,levelIcon:"",gender:e.gender||""},e.photos&&e.photos.length>0&&(f.value=e.photos.map((e=>({img:e})))),e.services&&e.services.length>0&&(h.value=e.services))}else console.error("获取城市服务失败:",(null==(e=a.data)?void 0:e.message)||"未知错误")}catch(o){console.error("获取城市服务异常:",o)}})(),s.value.id&&(async()=>{var e;if(s.value.id)try{y.value=!0;const o={companion_id:parseInt(s.value.id),page:1,page_size:50},n=await a.getMomentsByCompanion(o);if(console.log("动态列表响应:",n),n.data&&0===n.data.code){const e=n.data.data;e&&e.moments_list&&(b.value=e.moments_list,console.log("动态列表数据:",b.value))}else console.error("获取动态列表失败:",(null==(e=n.data)?void 0:e.message)||"未知错误")}catch(o){console.error("获取动态列表异常:",o)}finally{y.value=!1}})(),s.value.id&&(async()=>{var e;if(s.value.id)try{w.value=!0;const o={companion_id:parseInt(s.value.id),page:1,rating:5,page_size:20},n=await a.getCompanionCommentList(o);if(console.log("评论列表响应:",n),n.data&&0===n.data.code){const e=n.data.data;e&&e.list&&(x.value=e.list,console.log("评论列表数据:",x.value))}else console.error("获取评论列表失败:",(null==(e=n.data)?void 0:e.message)||"未知错误")}catch(o){console.error("获取评论列表异常:",o)}finally{w.value=!1}})()})),e.onUnmounted((()=>{})),(n,a)=>{var t,i,l,s;return e.e({a:e.unref(r).$imgBaseUrl+g.value.avatar,b:e.t(g.value.nickname),c:g.value.verified&&C.value},g.value.verified&&C.value?{d:null==(t=C.value)?void 0:t.icon_url}:{},{e:null==(i=C.value)?void 0:i.level_name},(null==(l=C.value)?void 0:l.level_name)?{f:e.t(null==(s=C.value)?void 0:s.level_name)}:{},{g:g.value.tags&&g.value.tags.length>0},g.value.tags&&g.value.tags.length>0?{h:e.f(g.value.tags,((o,n,a)=>({a:e.t(o),b:o})))}:{},{i:"女"===g.value.gender?"/static/icons/friend/white_nv.png":"/static/icons/friend/white_nan.png",j:e.t(g.value.age),k:e.t(g.value.weight),l:e.t(g.value.height),m:""!==g.value.distance},""!==g.value.distance?{n:o._imports_0$6,o:e.t(g.value.distance)}:{},{p:e.f(f.value,((o,n,a)=>({a:e.unref(r).$imgBaseUrl+o.img,b:e.o((o=>{return a=n,void e.index.previewImage({urls:f.value.map((e=>r.$imgBaseUrl+e.img)),current:r.$imgBaseUrl+f.value[a].img,indicator:"number",loop:!0,show:!0,success:function(e){console.log("图片预览成功",e)},fail:function(e){console.error("图片预览失败",e)}});var a}),n),c:n}))),q:o._imports_1$3,r:o._imports_2$2,s:o._imports_3$3,t:e.o(p),v:e.p({list:_.value,current:d.value,lineWidth:"60",lineHeight:"2",lineColor:"linear-gradient(90deg, rgba(115, 99, 255, 1) 0%, rgba(255, 105, 222, 1) 100%)",activeStyle:{color:"#7363FF",fontWeight:"500",fontSize:"28rpx"},inactiveStyle:{color:"#1A1A1A",fontWeight:"400",fontSize:"28rpx"},itemStyle:"padding: 16rpx 50rpx; height: auto; border-radius: 30rpx;"}),w:j.value?1:"",x:h.value.length>0},h.value.length>0?{y:e.f(h.value,((o,n,a)=>({a:e.unref(r).$imgBaseUrl+o.service_image_url,b:e.t(o.service_name),c:e.f(o.service_tags,((o,n,a)=>({a:e.t(o),b:o}))),d:e.t(o.price),e:e.t(o.unit||"小时"),f:e.o((e=>k(o)),o.title),g:o.title})))}:{z:o._imports_3},{A:0===d.value,B:y.value},y.value?{}:b.value.length>0?{D:e.f(b.value,((n,a,t)=>{var i,l,s,r,u,m,c,v,d,_,p,g,f;return e.e({a:e.t(null==(i=n.moments_info)?void 0:i.time_date),b:e.t(null==(l=n.moments_info)?void 0:l.time_time),c:e.t(null==(s=n.moments_info)?void 0:s.content),d:null==(r=n.moments_info)?void 0:r.file_list},(null==(u=n.moments_info)?void 0:u.file_list)?{e:e.o(S,a),f:"8eb4c70d-1-"+t,g:e.p({list:null==(m=n.moments_info)?void 0:m.file_list,topicList:null==(c=n.moments_info)?void 0:c.topic_list})}:{},{h:!(null==(v=n.moments_info)?void 0:v.is_praised)},(null==(d=n.moments_info)?void 0:d.is_praised)?{}:{i:o._imports_0$3,j:e.o((e=>T(n)),a)},{k:null==(_=n.moments_info)?void 0:_.is_praised},(null==(p=n.moments_info)?void 0:p.is_praised)?{l:o._imports_1$1,m:e.o((e=>T(n)),a)}:{},{n:e.t((null==(g=n.moments_info)?void 0:g.praise_num)||0),o:e.t((null==(f=n.moments_info)?void 0:f.comments_num)||0),p:e.o((o=>(o=>{e.index.navigateTo({url:"/subPackages/record/comment",success(e){e.eventChannel.emit("getRecord",{data:o})}})})(n)),a),q:a})})),E:o._imports_2$1}:{F:o._imports_3},{C:b.value.length>0,G:1===d.value,H:w.value},w.value?{}:x.value.length>0?{J:e.f(x.value,((o,n,a)=>e.e({a:"8eb4c70d-2-"+a,b:e.p({src:o.is_anonymous?"":e.unref(r).$imgBaseUrl+o.user_img,size:"40",shape:"circle"}),c:e.t(o.is_anonymous?"匿名用户":o.user_nickname),d:e.f(5,((n,a,t)=>({a:n,b:e.n({filled:n<=o.rating})}))),e:e.t(U(o.comment_time)),f:e.t(o.comment),g:o.comment_images&&o.comment_images.length>0},o.comment_images&&o.comment_images.length>0?{h:e.f(o.comment_images,((n,a,t)=>({a:e.unref(r).$imgBaseUrl+n,b:a,c:e.o((n=>((o,n)=>{const a=n.map((e=>r.$imgBaseUrl+e));e.index.previewImage({urls:a,current:o,indicator:"number",loop:!0,show:!0,success:function(e){console.log("评论图片预览成功",e)},fail:function(e){console.error("评论图片预览失败",e)}})})(a,o.comment_images)),a)})))}:{},{i:o.id})))}:{K:o._imports_3},{I:x.value.length>0,L:2===d.value,M:e.o(M),N:I.value,O:o._imports_8,P:e.o(B),Q:e.p({show:$.value,mode:"center",safeAreaInsetBottom:!1})})}}},r=e._export_sfc(s,[["__scopeId","data-v-8eb4c70d"]]);wx.createPage(r);

"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/user.js"),n=require("../../../api/home.js"),l=require("../../../api/file.js"),o=require("../../../stores/user.js"),i={__name:"index",setup(i){const s=o.useUserStore(),{proxy:u}=e.getCurrentInstance();e.ref(!1);const c=e.ref(!1),r=e.ref(!1),v=e.reactive({nickname:"",gender:"",age:"",height:"",weight:"",city:"æ·±åœ³å¸‚"}),d=e.ref(!1),g=e.ref([]),h=e.ref([]),f=e.ref([]),m=e.ref(!1),p=e.ref([]),w=e.ref([]),x=e.ref([]),y=e.ref(!1),T=e.ref([]),_=e.ref([]),b=e.ref(!1),$=e.ref([]),I=e.ref(!1),S=e.ref(4),k=e.ref([]),C=e.ref(new Map),P=e.ref(new Map),j=e.ref([{type:4,name:"ä¸ªæ€§ç‰¹è´¨"},{type:5,name:"æˆ‘çš„çˆ±å¥½"},{type:6,name:"å¤–è²Œé£æ ¼"},{type:7,name:"ä¸“ä¸šæŠ€èƒ½"},{type:8,name:"çƒ­é—¨æ¨è"}]),z=()=>{const e={};w.value.forEach((a=>{const t=a.category,n=a.category_name||"å…¶ä»–";e[t]||(e[t]={id:t,name:n,services:[]}),e[t].services.push(a)})),T.value=Object.values(e).sort(((e,a)=>e.id-a.id))},M=e=>{v.gender=e},q=()=>{h.value=[...g.value],d.value=!0},B=()=>{h.value=[],d.value=!1},L=async()=>{0!==h.value.length?(g.value=[...h.value],v.city=g.value[0],d.value=!1,h.value=[],x.value=[],T.value=[],await(async()=>{if(0===g.value.length)return w.value=[],void(T.value=[]);y.value=!0;try{const e=g.value.map((e=>{const a=f.value.find((a=>a.name===e));return a?a.code:null})).filter((e=>null!==e));if(0===e.length)return console.warn("æœªæ‰¾åˆ°æœ‰æ•ˆçš„åŸå¸‚ä»£ç "),w.value=[],void(T.value=[]);const a=await t.getServicesByCities(e);a.data&&0===a.data.code&&a.data.data?(w.value=a.data.data,z(),console.log("æœåŠ¡æŠ€èƒ½åˆ—è¡¨åŠ è½½æˆåŠŸ:",w.value),console.log("æœåŠ¡æŠ€èƒ½åˆ†ç»„:",T.value)):(console.warn("è·å–æœåŠ¡æŠ€èƒ½åˆ—è¡¨å¤±è´¥"),w.value=[],T.value=[])}catch(e){console.error("è·å–æœåŠ¡æŠ€èƒ½åˆ—è¡¨å¤±è´¥:",e),w.value=[],T.value=[]}finally{y.value=!1}})()):e.index.showToast({title:"è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæœåŠ¡åŒºåŸŸ",icon:"none"})},U=()=>{const a=6-p.value.length;a<=0?e.index.showToast({title:"æœ€å¤šåªèƒ½ä¸Šä¼ 6å¼ ç…§ç‰‡",icon:"none"}):e.index.chooseImage({count:a,sizeType:["compressed"],sourceType:["album","camera"],success:async a=>{e.index.showLoading({title:"ä¸Šä¼ ä¸­...",mask:!0});try{const t=a.tempFilePaths.map((async(e,a)=>{try{const t=await O(e);if(console.log("fileInfo",t),console.log("filePath",e),!t||!t.extension)throw new Error("æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯");const n=await l.uploadFile({filePath:e,name:`photo_${Date.now()}_${a}.${t.extension}`}),o=l.getUploadResult(n);if(!o||!o.url)throw new Error("ä¸Šä¼ ç»“æœè§£æå¤±è´¥");return o.url}catch(t){throw console.error(`ç¬¬${a+1}å¼ ç…§ç‰‡ä¸Šä¼ å¤±è´¥:`,t),t}})),n=await Promise.all(t);p.value.push(...n),e.index.showToast({title:`æˆåŠŸä¸Šä¼ ${n.length}å¼ ç…§ç‰‡`,icon:"success"})}catch(t){console.error("ç…§ç‰‡ä¸Šä¼ å¤±è´¥:",t),e.index.showToast({title:"ç…§ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}finally{e.index.hideLoading()}},fail:a=>{console.error("é€‰æ‹©ç…§ç‰‡å¤±è´¥:",a),e.index.showToast({title:"é€‰æ‹©ç…§ç‰‡å¤±è´¥",icon:"none"})}})},O=a=>new Promise(((t,n)=>{e.index.getFileInfo({filePath:a,success:e=>{const n=a.split(".").pop().toLowerCase();t({size:e.size,extension:n})},fail:e=>{console.error("è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥:",e);const n=a.split(".").pop().toLowerCase()||"jpg";t({size:0,extension:n})}})})),D=()=>{r.value=!r.value,e.index.vibrateShort({type:"light"})},E=()=>{e.index.navigateTo({url:"/subPackages/login/rz-agreement"})},F=async()=>{if(c.value)return;if(!r.value)return void e.index.showToast({title:"è¯·å…ˆåŒæ„å‹ä¼´æœåŠ¡åè®®",icon:"none",duration:2e3});if(!v.nickname.trim())return void e.index.showToast({title:"è¯·è¾“å…¥æ˜µç§°",icon:"none"});if(v.nickname.length>50)return void e.index.showToast({title:"æ˜µç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦",icon:"none"});if(!v.gender)return void e.index.showToast({title:"è¯·é€‰æ‹©æ€§åˆ«",icon:"none"});const a=parseInt(v.age),t=parseInt(v.height),n=parseInt(v.weight);!a||a<18||a>65?e.index.showToast({title:"å¹´é¾„å¿…é¡»åœ¨18-65å²ä¹‹é—´",icon:"none"}):!t||t<100||t>250?e.index.showToast({title:"èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´",icon:"none"}):!n||n<30||n>200?e.index.showToast({title:"è¯·è¾“å…¥åˆç†çš„ä½“é‡",icon:"none"}):0!==g.value.length?0!==p.value.length?p.value.length>9?e.index.showToast({title:"æœ€å¤šåªèƒ½ä¸Šä¼ 9å¼ ç…§ç‰‡",icon:"none"}):0!==x.value.length?e.index.showModal({title:"ç¡®è®¤æäº¤",content:"ç¡®å®šè¦æäº¤å…¥é©»ç”³è¯·å—ï¼Ÿæäº¤åå°†è¿›å…¥å®¡æ ¸æµç¨‹ã€‚",success:async e=>{e.confirm&&await A()}}):e.index.showToast({title:"è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æœåŠ¡æŠ€èƒ½",icon:"none"}):e.index.showToast({title:"è¯·ä¸Šä¼ è‡³å°‘ä¸€å¼ ç”Ÿæ´»ç…§",icon:"none"}):e.index.showToast({title:"è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæœåŠ¡åŒºåŸŸ",icon:"none"})},A=async()=>{c.value=!0;try{const a=g.value.map((e=>{const a=f.value.find((a=>a.name===e));return a?String(a.code):null})).filter((e=>null!==e));if(0===a.length)return void e.index.showToast({title:"æœåŠ¡åŒºåŸŸæ•°æ®å¼‚å¸¸ï¼Œè¯·é‡æ–°é€‰æ‹©",icon:"none"});const n={nickname:v.nickname.trim(),gender:"male"===v.gender?"ç”·":"å¥³",age:parseInt(v.age),height:parseInt(v.height),weight:parseInt(v.weight),service_areas:a,services:x.value,can_accept_orders:"N",photos:p.value,tags:_.value.map((e=>e.tag_name)),phone:s.userInfo.phone||""};console.log("æäº¤æ•°æ®:",n);const l=await t.createCompanionApplication(n);if(console.log("æ¥å£å“åº”:",l),l&&l.data&&0===l.data.code){const a="æ­å–œæ‚¨ï¼å…¥é©»ç”³è¯·å·²é€šè¿‡ï¼Œæ‚¨å·²æˆåŠŸæˆä¸ºå‹ä¼´å¸ˆã€‚";e.index.showModal({title:"å…¥é©»æˆåŠŸ ğŸ‰",content:a,showCancel:!1,confirmText:"æˆ‘çŸ¥é“äº†",success:()=>{e.index.$emit("applicationStatusChanged",{status:"approved",message:"å…¥é©»ç”³è¯·å·²é€šè¿‡"}),e.index.navigateBack()}})}else{const a=l&&l.data&&l.data.message||"æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";e.index.showModal({title:"æäº¤å¤±è´¥",content:a,showCancel:!1,confirmText:"æˆ‘çŸ¥é“äº†"})}}catch(a){console.error("æäº¤å¤±è´¥:",a);let t="æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";a&&a.message&&(t=a.message.includes("ç½‘ç»œ")?"ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•":a.message.includes("å‚æ•°")?"æäº¤ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•":a.message.includes("é‡å¤")?"æ‚¨å·²æäº¤è¿‡ç”³è¯·ï¼Œè¯·å‹¿é‡å¤æäº¤":a.message),e.index.showModal({title:"æäº¤å¤±è´¥",content:t,showCancel:!1,confirmText:"æˆ‘çŸ¥é“äº†"})}finally{c.value=!1}};e.onMounted((async()=>{await(async()=>{m.value=!0;try{const e=await n.getCityList();e.data&&0===e.data.code&&e.data.data?(f.value=e.data.data.map((e=>({name:e.name,code:e.city_code}))),console.log("ç”³è¯·é¡µé¢åŒºåŸŸåˆ—è¡¨åŠ è½½æˆåŠŸ:",f.value)):(console.warn("è·å–åŒºåŸŸåˆ—è¡¨å¤±è´¥"),f.value=[])}catch(e){console.error("è·å–åŒºåŸŸåˆ—è¡¨å¤±è´¥:",e),f.value=[]}finally{m.value=!1}})(),console.log("æ ‡ç­¾ç¼“å­˜é…ç½®:",{expireTime:"5åˆ†é’Ÿ",cacheSize:C.value.size})}));const N=()=>{$.value=[],b.value=!1},R=async(e,a=!1)=>{if(!a&&(e=>{const a=P.value.get(e);return!!a&&Date.now()-a<3e5})(e)){const a=(e=>C.value.get(e)||[])(e);if(a.length>0)return console.log(`ä½¿ç”¨ç¼“å­˜æ•°æ® - æ ‡ç­¾ç±»å‹${e}ï¼Œæ•°æ®é‡: ${a.length}`),void(k.value=a)}I.value=!0;try{console.log(`å¼€å§‹åŠ è½½æ ‡ç­¾ç±»å‹: ${e}`);const a={tag_type:e,page:1,pageSize:60};console.log("è¯·æ±‚å‚æ•°:",a);const n=await t.getPersonalityTags(a);if(console.log("APIå“åº”:",n),n.data&&0===n.data.code&&n.data.data){const a=n.data.data.list||n.data.data;k.value=a,((e,a)=>{C.value.set(e,a),P.value.set(e,Date.now()),console.log(`æ ‡ç­¾ç±»å‹${e}å·²ç¼“å­˜ï¼Œæ•°æ®é‡: ${a.length}`)})(e,a),console.log(`æ ‡ç­¾ç±»å‹${e}åŠ è½½æˆåŠŸ:`,a)}else console.warn(`è·å–æ ‡ç­¾ç±»å‹${e}å¤±è´¥ï¼Œå“åº”æ•°æ®:`,n),k.value=[]}catch(n){console.error(`è·å–æ ‡ç­¾ç±»å‹${e}å¤±è´¥:`,n),console.error("é”™è¯¯è¯¦æƒ…:",n.response||n),k.value=[]}finally{I.value=!1}},G=e=>$.value.some((a=>a.id===e)),H=()=>{_.value=[...$.value],b.value=!1,$.value=[],e.index.showToast({title:`å·²é€‰æ‹©${_.value.length}ä¸ªæ ‡ç­¾`,icon:"success"})};return(t,n)=>e.e({a:v.nickname,b:e.o((e=>v.nickname=e.detail.value)),c:a._imports_4,d:"male"===v.gender?1:"",e:e.o((e=>M("male"))),f:a._imports_3$2,g:"female"===v.gender?1:"",h:e.o((e=>M("female"))),i:v.age,j:e.o((e=>v.age=e.detail.value)),k:v.height,l:e.o((e=>v.height=e.detail.value)),m:v.weight,n:e.o((e=>v.weight=e.detail.value)),o:0===g.value.length},0===g.value.length?{}:{p:e.t(g.value.length)},{q:e.o(q),r:g.value.length>0},g.value.length>0?{s:e.f(g.value,((a,t,n)=>({a:e.t(a),b:a,c:e.o((t=>(a=>{const t=g.value.indexOf(a);t>-1&&(g.value.splice(t,1),e.index.vibrateShort({type:"light"}))})(a)),a)})))}:{},{t:e.f(p.value,((a,n,l)=>({a:t.$imgBaseUrl+a,b:e.o((e=>(e=>{p.value.splice(e,1)})(n)),n),c:n,d:e.o((a=>(a=>{e.index.previewImage({urls:p.value.map((e=>u.$imgBaseUrl+e)),current:u.$imgBaseUrl+p.value[a],indicator:"number",loop:!0,show:!0,success:function(e){console.log("å›¾ç‰‡é¢„è§ˆæˆåŠŸ",e)},fail:function(e){console.error("å›¾ç‰‡é¢„è§ˆå¤±è´¥",e)}})})(n)),n)}))),v:p.value.length<6},p.value.length<6?{w:a._imports_0$4,x:e.o(U)}:{},{y:y.value},y.value||0===g.value.length?{}:T.value.length>0?{B:e.f(T.value,((a,t,n)=>({a:e.t(a.name),b:e.f(a.services,((a,t,n)=>({a:e.t(a.name),b:x.value.includes(a.id)?1:"",c:a.id,d:e.o((t=>(a=>{const t=a.id,n=x.value.indexOf(t);n>-1?x.value.splice(n,1):x.value.push(t),e.index.vibrateShort({type:"light"})})(a)),a.id)}))),c:a.id})))}:{},{z:0===g.value.length,A:T.value.length>0,C:_.value.length>0},_.value.length>0?{D:e.f(_.value,((a,t,n)=>({a:e.t(a.tag_name),b:a.id,c:e.o((t=>(a=>{const t=_.value.findIndex((e=>e.id===a.id));t>-1&&(_.value.splice(t,1),e.index.vibrateShort({type:"light"}))})(a)),a.id)})))}:{},{E:e.t(_.value.length),F:_.value.length>=5?1:"",G:e.o((e=>_.value.length<5?($.value=[..._.value],b.value=!0,void R(4)):null)),H:r.value},(r.value,{}),{I:r.value?1:"",J:e.o(E),K:e.o(D),L:!c.value},(c.value,{}),{M:c.value||!r.value?1:"",N:e.o(F),O:d.value},d.value?e.e({P:e.o(B),Q:m.value},m.value?{}:{R:e.f(f.value,((a,t,n)=>e.e({a:e.t(a.name),b:h.value.includes(a.name)},(h.value.includes(a.name),{}),{c:t,d:e.n({active:h.value.includes(a.name)}),e:e.o((t=>(a=>{const t=h.value.indexOf(a);t>-1?h.value.splice(t,1):h.value.push(a),e.index.vibrateShort({type:"light"})})(a.name)),t)})))},{S:e.t(h.value.length),T:e.o(L),U:e.o((()=>{})),V:e.o(B)}):{},{W:b.value},b.value?e.e({X:e.o(N),Y:e.f(j.value,((a,t,n)=>({a:e.t(a.name),b:a.type,c:e.n({active:S.value===a.type}),d:e.o((e=>{return t=a.type,S.value=t,void R(t);var t}),a.type)}))),Z:!I.value&&$.value.length>=5},(!I.value&&$.value.length,{}),{aa:I.value},I.value?{}:{ab:e.f(k.value,((a,t,n)=>e.e({a:e.t(a.tag_name),b:G(a.id)},(G(a.id),{}),{c:a.id,d:e.n({selected:G(a.id)}),e:e.o((t=>(a=>{const t=$.value.findIndex((e=>e.id===a.id));if(t>-1)$.value.splice(t,1);else{if($.value.length>=5)return void e.index.showToast({title:"æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªæ ‡ç­¾",icon:"none"});$.value.push(a)}e.index.vibrateShort({type:"light"})})(a)),a.id)})))},{ac:!I.value&&0===k.value.length},(I.value||k.value.length,{}),{ad:e.t($.value.length),ae:e.o(H),af:e.o((()=>{})),ag:e.o(N)}):{})}},s=e._export_sfc(i,[["__scopeId","data-v-ccbcad49"]]);wx.createPage(s);

"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../stores/user.js"),n=require("../../../../api/user.js"),i=require("../../../../api/file.js"),a={__name:"edit",setup(a){const s=o.useUserStore();e.computed((()=>s.userInfo||{}));const t=e.reactive({head_img:"",nick_name:""}),c=e.ref({}),l=e.computed((()=>t.head_img!==c.value.head_img||t.nick_name!==c.value.nick_name));e.onLoad((()=>{const e=s.userInfo||{};c.value={...e},t.head_img=e.head_img||"",t.nick_name=e.nick_name||"",console.log("当前用户头像:",e.head_img),console.log("临时头像数据:",t.head_img)}));const r=()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async o=>{const n=o.tempFilePaths[0];console.log("选择的头像:",n),e.index.showLoading({title:"上传中...",mask:!0});try{const o=await d(n);if(console.log("fileInfo",o),console.log("filePath",n),!o||!o.extension)throw new Error("无法获取文件信息");const a=await i.uploadFile({filePath:n,name:`avatar_${Date.now()}.${o.extension}`}),s=i.getUploadResult(a);if(!s||!s.url)throw new Error("上传结果解析失败");t.head_img=s.url,e.index.showToast({title:"头像上传成功",icon:"success"})}catch(a){console.error("头像上传失败:",a),e.index.showToast({title:"头像上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:o=>{console.error("选择头像失败:",o),e.index.showToast({title:"选择头像失败",icon:"none"})}})},d=o=>new Promise(((n,i)=>{e.index.getFileInfo({filePath:o,success:e=>{const i=o.split(".").pop().toLowerCase();n({size:e.size,extension:i})},fail:e=>{console.error("获取文件信息失败:",e);const i=o.split(".").pop().toLowerCase()||"jpg";n({size:0,extension:i})}})})),m=e=>{const o=e.detail.value;t.nick_name=o.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g,"")},h=async()=>{if(l.value)if(t.nick_name.trim())if(t.nick_name.trim().length<2)e.index.showToast({title:"昵称至少2个字符",icon:"none"});else try{e.index.showLoading({title:"保存中..."});const o={};t.head_img!==c.value.head_img&&(o.head_img=t.head_img),t.nick_name!==c.value.nick_name&&(o.nick_name=t.nick_name);const i=await n.updateUserBasicInfo(o);console.log("保存结果:",i.data),0===i.data.code?(s.setUserInfo({...s.userInfo,...o}),c.value={...s.userInfo},e.index.showToast({title:"保存成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)):e.index.showToast({title:i.data.msg||"保存失败或者与其他用户同名了",icon:"none"})}catch(o){console.error("保存失败:",o),o&&o.data&&400===o.data.code?e.index.showToast({title:o.data.msg||"保存失败或者与其他用户同名了",icon:"none"}):e.index.showToast({title:"保存失败，请重试",icon:"none"})}finally{e.index.hideLoading()}else e.index.showToast({title:"请输入昵称",icon:"none"});else e.index.showToast({title:"没有更改需要保存",icon:"none"})};return(o,n)=>e.e({a:t.head_img},t.head_img?{b:t.head_img.startsWith("http")?t.head_img:o.$imgBaseUrl+t.head_img}:{},{c:e.o(r),d:e.o([e=>t.nick_name=e.detail.value,m]),e:t.nick_name,f:e.t(t.nick_name.length),g:e.o(h)})}},s=e._export_sfc(a,[["__scopeId","data-v-fea6330a"]]);wx.createPage(s);

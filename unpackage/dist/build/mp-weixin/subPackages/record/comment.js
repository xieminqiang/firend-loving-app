"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),o=require("../../api/discover.js");if(!Array){(e.resolveComponent("u-avatar")+e.resolveComponent("u-icon")+e.resolveComponent("u-input")+e.resolveComponent("u-popup"))()}Math||((()=>"../../uni_modules/uview-plus/components/u-avatar/u-avatar.js")+t+(()=>"../../uni_modules/uview-plus/components/u-icon/u-icon.js")+(()=>"../../uni_modules/uview-plus/components/u-input/u-input.js")+(()=>"../../uni_modules/uview-plus/components/u-popup/u-popup.js"))();const t=()=>"../../components/common/PictureDisplay.js",n={__name:"comment",props:{userLocation:{type:Object,default:null},cityStore:{type:Object,default:null}},setup(t){const n=e.ref(e.getCurrentInstance().proxy),i=e.ref(0),l=e.ref(0),s=e.ref(""),u=e.ref(1),r=e.ref(0),c=e.ref(!1),d=e.ref({}),m=e.ref([]),v=e.ref([]),_=e.ref(""),p=e.ref(""),g=e.ref("友好发言，文明聊天"),f=e.ref(!1),h=e.ref(!1),b=e.ref(0),y=e.ref(0),w=e.ref(!1);e.onLoad((e=>{n.value.getOpenerEventChannel().on("getRecord",(async e=>{s.value=e.data.moments_info.moments_id,x()})),p.value="",g.value="友好发言，文明聊天"}));const x=async a=>{var t;try{const a=await o.getMomentsDetail({moments_id:s.value});if(a.data&&0===a.data.code){const e=a.data.data;e.companion_info&&(d.value={user_id:e.companion_info.id,nick_name:e.companion_info.nickname,head_img:e.companion_info.avatar,icon_list:[{icon:{color:"女"===e.companion_info.gender?"rgba(252, 139, 198, 1)":"rgba(19, 98, 235, 1)",icon:"女"===e.companion_info.gender?"/static/find/nd_icon.png":"/static/find/nand_icon.png"},data:`${e.companion_info.age}岁`},{icon:{color:"rgba(62, 178, 240, 1)"},data:`${e.companion_info.height}cm`},{icon:{color:"linear-gradient(180deg, rgba(155, 59, 235, 1) 0%, rgba(230, 126, 188, 1) 100%)"},data:`${e.companion_info.weight}kg`}]}),e.moments_info&&(v.value=e.moments_info),k(1)}else console.error("获取动态详情失败:",null==(t=a.data)?void 0:t.message),e.index.showToast({title:"获取动态详情失败",icon:"none"})}catch(n){console.error("获取动态详情出错:",n),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},k=async e=>{var a;try{const t=await o.getMomentCommentList({moments_id:s.value,page:e,page_size:10});if(t.data&&0===t.data.code){const a=t.data.data;1===e?(m.value=a.comments_list||[],r.value=a.total||0,c.value=!0):a.comments_list&&a.comments_list.length>0&&(m.value.push(...a.comments_list),u.value=a.page)}else console.error("获取评论列表失败:",null==(a=t.data)?void 0:a.message),C()}catch(t){console.error("获取评论列表出错:",t),C()}},C=()=>{m.value=[],r.value=0,c.value=!0},j=()=>{console.log("监听页面滚动到底部"),k(u.value+1)},T=e=>{p.value=e.comments_id,g.value="回复@"+e.nick_name,f.value=!0},z=async()=>{var a;if(!(_.value||""))return console.log("输入内容为空，显示错误提示"),void e.index.showToast({title:"请输入评论内容",icon:"none",duration:1e3});try{const t={moments_id:s.value,content:_.value};p.value&&(t.reply_comments_id=p.value);const n=await o.pushMomentComment(t);if(n.data&&0===n.data.code){const a=n.data.data.res_data;p.value?(m.value.forEach((e=>{e.comments_id==a.parent_id&&e.comments_list.push(a)})),p.value="",g.value="友好发言，文明聊天"):m.value.unshift(a),r.value=a.total,v.value.comments_num=a.total,_.value="",Y(),e.index.showToast({title:"评论成功!",icon:"none",duration:500})}else e.index.showToast({title:(null==(a=n.data)?void 0:a.message)||"评论失败!",icon:"none",duration:1e3})}catch(t){console.error("发布评论出错:",t),e.index.showToast({title:"网络错误，请重试",icon:"none",duration:1e3})}},F=e=>{l.value=e.detail.scrollTop},M=()=>{},$=e=>{},I=e=>{h.value=!0},L=e=>{h.value=!1},O=e=>{console.log("handleInputChange 被调用，接收到的值:",e),_.value=e,console.log("rplContent 更新为:",_.value)},S=e=>{w.value=!0,b.value=e.touches[0].clientY,y.value=e.touches[0].clientY},D=e=>{if(!w.value)return;y.value=e.touches[0].clientY;y.value-b.value>0&&e.preventDefault()},B=e=>{if(!w.value)return;y.value-b.value>50&&Y(),w.value=!1,b.value=0,y.value=0},P=a=>{e.index.navigateTo({url:"/pages/detail/detail",animationType:"slide-in-bottom",animationDuration:200,success(e){e.eventChannel.emit("getUserId",{val:a.user_id})}})},U=()=>{f.value=!0,setTimeout((()=>{h.value=!0}),350)},Y=()=>{h.value=!1,f.value=!1,_.value="",p.value="",g.value="友好发言，文明聊天"},q=(e,a="add",o=1)=>{const t=parseInt(e)||0;return"add"===a?t+o:"subtract"===a?Math.max(0,t-o):t};return(t,n)=>e.e({a:e.p({src:t.$imgBaseUrl+d.value.head_img,size:"38",shape:"circle",mode:"aspectFill"}),b:e.o((a=>{e.index.navigateTo({url:"/pages/detail/detail",animationType:"slide-in-bottom",animationDuration:200,success(e){e.eventChannel.emit("getUserId",{val:d.value.user_id})}})})),c:e.t(d.value.nick_name),d:d.value.icon_list},d.value.icon_list?{e:e.f(d.value.icon_list,((a,o,t)=>{var n,i;return e.e({a:a.icon.icon},a.icon.icon?{b:null==(n=a.icon)?void 0:n.icon}:{},{c:e.t(a.data),d:`${null==(i=a.icon)?void 0:i.color}`,e:a})}))}:{},{f:e.t(v.value.content),g:v.value.file_list&&v.value.file_list.length>0},v.value.file_list&&v.value.file_list.length>0?{h:e.p({list:v.value.file_list,topicList:v.value.topic_list})}:{},{i:!v.value.is_praised},v.value.is_praised?{}:{j:a._imports_0$3},{k:v.value.is_praised},v.value.is_praised?{l:a._imports_1$1}:{},{m:e.t(v.value.praise_num||0),n:e.o((a=>(async a=>{try{const t=v.value.is_praised;v.value.is_praised=!t,v.value.is_praised?v.value.praise_num=q(v.value.praise_num,"add",1):v.value.praise_num=q(v.value.praise_num,"subtract",1);const n=await o.praiseMoment({target_id:a.target_id});n.data&&0===n.data.code?console.log("点赞成功"):(v.value.is_praised=t,v.value.praise_num=q(v.value.praise_num,t?"add":"subtract",1),e.index.showToast({title:"点赞失败，请重试",icon:"none"}))}catch(t){console.error("点赞失败:",t);const a=v.value.is_praised;v.value.is_praised=!a,v.value.praise_num=q(v.value.praise_num,a?"add":"subtract",1),e.index.showToast({title:"网络错误，请重试",icon:"none"})}})({target_id:v.value.moments_id}))),o:c.value},c.value?e.e({p:e.t(r.value),q:0==r.value},0==r.value?{r:a._imports_2}:{s:e.f(m.value,((a,n,i)=>e.e({a:"05bb63c0-2-"+i,b:e.p({src:t.$imgBaseUrl+(v.value.user_id===a.user_id?d.value.head_img:a.head_img),size:"32",shape:"circle",mode:"aspectFill"}),c:e.o((e=>P(a)),a.comments_id),d:e.t(v.value.user_id===a.user_id?d.value.nick_name:a.nick_name),e:e.t(a.content),f:e.t(a.content_time),g:e.o((e=>T(a)),a.comments_id),h:e.o((e=>T(a)),a.comments_id),i:e.f(a.comments_list,((a,o,n)=>({a:"05bb63c0-3-"+i+"-"+n,b:e.p({src:t.$imgBaseUrl+(v.value.user_id===a.user_id?d.value.head_img:a.head_img),size:"22",shape:"circle"}),c:e.o((e=>P(a)),a.comments_id),d:e.t(v.value.user_id===a.user_id?d.value.nick_name:a.nick_name),e:e.t(v.value.user_id===a.reply_user_id?d.value.nick_name:a.reply_nick_name),f:e.t(a.content),g:e.t(a.content_time),h:e.o((e=>T(a)),a.comments_id),i:e.o((e=>T(a)),a.comments_id),j:a.comments_id}))),j:a.has_more},a.has_more?{k:"05bb63c0-4-"+i,l:e.p({name:"arrow-down",color:"#7363FF",size:"14"}),m:e.o((e=>(async e=>{var a;console.log("展开更多回复",e);try{const t=await o.getMoreMomentCommentList({comments_id:e.comments_id,page:1,page_size:10});if(t.data&&0===t.data.code){const a=t.data.data;e.comments_list=a.more_list||[],e.has_more=a.has_more||!1}else console.error("获取更多回复失败:",null==(a=t.data)?void 0:a.message)}catch(t){console.error("获取更多回复出错:",t)}})(a)),a.comments_id)}:{},{n:a.comments_id}))),t:a._imports_3$1}):{},{v:i.value,w:e.o(F),x:e.o(j),y:e.o($),z:e.o(M),A:e.p({placeholder:g.value,border:"surround",value:_.value,fontSize:"24rpx",color:"#1a1a1a",shape:"circle",adjustPosition:!0,disabled:!0,customStyle:{paddingLeft:"24rpx",background:"#F2F2F2"}}),B:e.o((()=>{})),C:e.o(U),D:e.o(S),E:e.o(D),F:e.o(B),G:e.o(I),H:e.o(L),I:e.o(O),J:e.o((e=>_.value=e)),K:e.p({focus:f.value&&h.value,placeholder:g.value,border:"surround",fontSize:"24rpx",color:"#1a1a1a",shape:"circle",adjustPosition:!0,customStyle:{paddingLeft:"24rpx",background:"#F2F2F2",transition:"all 0.2s ease"},modelValue:_.value}),L:_.value.trim()?1:"",M:e.o(z),N:e.o((()=>{})),O:e.o(Y),P:e.p({show:f.value,round:"10",closeOnClickOverlay:!0,closeOnClickModal:!0,zIndex:999,overlay:!0,overlayStyle:{backgroundColor:"rgba(0, 0, 0, 0.5)"},duration:300,mode:"bottom",safeAreaInsetBottom:!0,customStyle:{transition:"all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)",transform:f.value?"translateY(0)":"translateY(100%)"}})})}},i=e._export_sfc(n,[["__scopeId","data-v-05bb63c0"]]);wx.createPage(i);

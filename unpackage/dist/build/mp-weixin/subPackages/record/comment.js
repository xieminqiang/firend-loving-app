"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),o=require("../../api/discover.js");if(!Array){(e.resolveComponent("u-avatar")+e.resolveComponent("u-icon")+e.resolveComponent("u-input")+e.resolveComponent("u-popup"))()}Math||((()=>"../../uni_modules/uview-plus/components/u-avatar/u-avatar.js")+n+(()=>"../../uni_modules/uview-plus/components/u-icon/u-icon.js")+(()=>"../../uni_modules/uview-plus/components/u-input/u-input.js")+(()=>"../../uni_modules/uview-plus/components/u-popup/u-popup.js"))();const n=()=>"../../components/common/PictureDisplay.js",t={__name:"comment",props:{userLocation:{type:Object,default:null},cityStore:{type:Object,default:null}},setup(n){const t=e.ref(e.getCurrentInstance().proxy),i=e.ref(0),s=e.ref(0),l=e.ref(""),c=e.ref(1),r=e.ref(0),u=e.ref(!1),m=e.ref({}),d=e.ref([]),_=e.ref([]),v=e.ref(""),p=e.ref(""),f=e.ref("友好发言，文明聊天"),g=e.ref(!1);e.onLoad((e=>{t.value.getOpenerEventChannel().on("getRecord",(async e=>{l.value=e.data.moments_info.moments_id,h()})),p.value="",f.value="友好发言，文明聊天"}));const h=async a=>{var n;try{const a=await o.getMomentsDetail({moments_id:l.value});if(a.data&&0===a.data.code){const e=a.data.data;e.companion_info&&(m.value={user_id:e.companion_info.id,nick_name:e.companion_info.nickname,head_img:e.companion_info.avatar,icon_list:[{icon:{color:"女"===e.companion_info.gender?"rgba(252, 139, 198, 1)":"rgba(19, 98, 235, 1)",icon:"女"===e.companion_info.gender?"/static/find/nd_icon.png":"/static/find/nand_icon.png"},data:`${e.companion_info.age}岁`},{icon:{color:"rgba(62, 178, 240, 1)"},data:`${e.companion_info.height}cm`},{icon:{color:"linear-gradient(180deg, rgba(155, 59, 235, 1) 0%, rgba(230, 126, 188, 1) 100%)"},data:`${e.companion_info.weight}kg`}]}),e.moments_info&&(_.value={moments_id:e.moments_info.moments_id,content:e.moments_info.content,file_list:e.moments_info.file_list||[],topic_list:e.moments_info.topic_list||[],is_praised:e.moments_info.is_praised,praise_num:e.moments_info.praise_num,comments_num:e.moments_info.comments_num,is_liked:e.moments_info.is_liked}),y(1)}else console.error("获取动态详情失败:",null==(n=a.data)?void 0:n.message),e.index.showToast({title:"获取动态详情失败",icon:"none"})}catch(t){console.error("获取动态详情出错:",t),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},y=async e=>{var a;try{const n=await o.getMomentCommentList({moments_id:l.value,page:e,page_size:10});if(n.data&&0===n.data.code){const a=n.data.data;1===e?(d.value=a.comments_list||[],r.value=a.total||0,u.value=!0):a.comments_list&&a.comments_list.length>0&&(d.value.push(...a.comments_list),c.value=a.page)}else console.error("获取评论列表失败:",null==(a=n.data)?void 0:a.message),w()}catch(n){console.error("获取评论列表出错:",n),w()}},w=()=>{d.value=[],r.value=0,u.value=!0},b=()=>{console.log("监听页面滚动到底部"),y(c.value+1)},x=e=>{p.value=e.comments_id,f.value="回复@"+e.nick_name,g.value=!0},j=async()=>{var a;if(g.value=!1,v.value.trim())try{const n={moments_id:l.value,content:v.value};p.value&&(n.reply_comments_id=p.value);const t=await o.pushMomentComment(n);if(t.data&&0===t.data.code){const a=t.data.data.res_data;p.value?(d.value.forEach((e=>{e.comments_id==a.parent_id&&e.comments_list.push(a)})),p.value="",f.value="友好发言，文明聊天"):d.value.unshift(a),r.value=a.total,_.value.comments_num=a.total,v.value="",e.index.showToast({title:"评论成功!",icon:"none",duration:500})}else e.index.showToast({title:(null==(a=t.data)?void 0:a.message)||"评论失败!",icon:"none",duration:1e3})}catch(n){console.error("发布评论出错:",n),e.index.showToast({title:"网络错误，请重试",icon:"none",duration:1e3})}else e.index.showToast({title:"请输入评论内容",icon:"none",duration:1e3})},k=e=>{s.value=e.detail.scrollTop},T=()=>{},C=e=>{},$=a=>{e.index.navigateTo({url:"/pages/detail/detail",animationType:"slide-in-bottom",animationDuration:200,success(e){e.eventChannel.emit("getUserId",{val:a.user_id})}})},z=()=>{g.value=!0},F=(e,a="add",o=1)=>{const n=parseInt(e)||0;return"add"===a?n+o:"subtract"===a?Math.max(0,n-o):n};return(n,t)=>e.e({a:e.p({src:n.$imgBaseUrl+m.value.head_img,size:"38",shape:"circle"}),b:e.o((a=>{e.index.navigateTo({url:"/pages/detail/detail",animationType:"slide-in-bottom",animationDuration:200,success(e){e.eventChannel.emit("getUserId",{val:m.value.user_id})}})})),c:e.t(m.value.nick_name),d:m.value.icon_list},m.value.icon_list?{e:e.f(m.value.icon_list,((a,o,n)=>{var t,i;return e.e({a:a.icon.icon},a.icon.icon?{b:null==(t=a.icon)?void 0:t.icon}:{},{c:e.t(a.data),d:`${null==(i=a.icon)?void 0:i.color}`,e:a})}))}:{},{f:e.t(_.value.content),g:_.value.file_list&&_.value.file_list.length>0},_.value.file_list&&_.value.file_list.length>0?{h:e.p({list:_.value.file_list,topicList:_.value.topic_list})}:{},{i:!_.value.is_praised},_.value.is_praised?{}:{j:a._imports_0$4},{k:_.value.is_praised},_.value.is_praised?{l:a._imports_1$1}:{},{m:e.t(_.value.praise_num||0),n:e.o((a=>(async a=>{try{const n=_.value.is_praised;_.value.is_praised=!n,_.value.is_praised?_.value.praise_num=F(_.value.praise_num,"add",1):_.value.praise_num=F(_.value.praise_num,"subtract",1);const t=await o.praiseMoment({target_id:a.target_id});t.data&&0===t.data.code?console.log("点赞成功"):(_.value.is_praised=n,_.value.praise_num=F(_.value.praise_num,n?"add":"subtract",1),e.index.showToast({title:"点赞失败，请重试",icon:"none"}))}catch(n){console.error("点赞失败:",n);const a=_.value.is_praised;_.value.is_praised=!a,_.value.praise_num=F(_.value.praise_num,a?"add":"subtract",1),e.index.showToast({title:"网络错误，请重试",icon:"none"})}})({target_id:_.value.moments_id}))),o:u.value},u.value?e.e({p:e.t(r.value),q:0==r.value},0==r.value?{r:a._imports_2}:{s:e.f(d.value,((a,t,i)=>e.e({a:"2fa7301f-2-"+i,b:e.p({src:n.$imgBaseUrl+a.head_img,size:"32",shape:"circle"}),c:e.o((e=>$(a)),a.comments_id),d:e.t(a.nick_name),e:e.t(a.content),f:e.t(a.content_time),g:e.o((e=>x(a)),a.comments_id),h:e.o((e=>x(a)),a.comments_id),i:e.f(a.comments_list,((a,o,t)=>({a:"2fa7301f-3-"+i+"-"+t,b:e.p({src:n.$imgBaseUrl+a.head_img,size:"22",shape:"circle"}),c:e.o((e=>$(a)),a.comments_id),d:e.t(a.nick_name),e:e.t(a.reply_nick_name),f:e.t(a.content),g:e.t(a.content_time),h:e.o((e=>x(a)),a.comments_id),i:e.o((e=>x(a)),a.comments_id),j:a.comments_id}))),j:a.has_more},a.has_more?{k:"2fa7301f-4-"+i,l:e.p({name:"arrow-down",color:"#7363FF",size:"14"}),m:e.o((e=>(async e=>{var a;console.log("展开更多回复",e);try{const n=await o.getMoreMomentCommentList({comments_id:e.comments_id,page:1,page_size:10});if(n.data&&0===n.data.code){const a=n.data.data;e.comments_list=a.more_list||[],e.has_more=a.has_more||!1}else console.error("获取更多回复失败:",null==(a=n.data)?void 0:a.message)}catch(n){console.error("获取更多回复出错:",n)}})(a)),a.comments_id)}:{},{n:a.comments_id}))),t:a._imports_3$1}):{},{v:i.value,w:e.o(k),x:e.o(b),y:e.o(C),z:e.o(T),A:e.o((e=>v.value=e)),B:e.p({placeholder:f.value,border:"surround",fontSize:"24rpx",color:"#1a1a1a",shape:"circle",adjustPosition:!0,disabled:!0,customStyle:{paddingLeft:"24rpx",background:"#F2F2F2"},modelValue:v.value}),C:e.o((()=>{})),D:e.o(z),E:e.o(C),F:e.o(T),G:e.o((e=>v.value=e)),H:e.p({focus:g.value,placeholder:f.value,border:"surround",fontSize:"24rpx",color:"#1a1a1a",shape:"circle",adjustPosition:!0,customStyle:{paddingLeft:"24rpx",background:"#F2F2F2"},modelValue:v.value}),I:v.value,J:e.o(j),K:e.o((()=>{})),L:e.o((e=>g.value=!1)),M:e.p({show:g.value,round:"10"})})}},i=e._export_sfc(t,[["__scopeId","data-v-2fa7301f"]]);wx.createPage(i);

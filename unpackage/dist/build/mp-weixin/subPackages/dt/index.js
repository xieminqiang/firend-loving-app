"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),t=require("../../api/discover.js"),a=require("../../api/file.js"),i=require("../../stores/user.js");if(!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u--textarea")+e.resolveComponent("u-action-sheet"))()}Math||((()=>"../../uni_modules/uview-plus/components/u-icon/u-icon.js")+(()=>"../../uni_modules/uview-plus/components/u--textarea/u--textarea.js")+(()=>"../../uni_modules/uview-plus/components/u-action-sheet/u-action-sheet.js"))();const s={__name:"index",setup(s){const l=i.useUserStore(),{proxy:n}=e.getCurrentInstance(),c=e.ref([]),r=e.ref(116.397128),u=e.ref(39.916527),d=e.ref("");e.onLoad((()=>{console.log("发布页面加载完成"),p()}));const p=async()=>{try{const o=await t.getMomentsRequest();0===o.data.code?c.value=o.data.data.topic_list||[]:console.warn("获取动态请求数据失败:",o.data.msg)}catch(o){}finally{e.index.hideLoading()}};e.ref(!1);const m=e.reactive({imgList:[],content:"",status:1,location:"",location_desc:"",topics:[],object_keys:[]}),v=e.ref([]),f=e.ref(!1),h=[{name:"拍照",value:"camera"},{name:"从相册选择",value:"album"},{name:"拍摄视频",value:"video"}],g=()=>{f.value=!0},_=e=>{switch(f.value=!1,e.value){case"camera":y("camera");break;case"album":y("album");break;case"video":x()}},y=o=>{e.index.chooseImage({count:9-v.value.length,sourceType:[o],sizeType:["compressed"],success:e=>{w(e.tempFilePaths)},fail:o=>{console.error("选择图片失败:",o),e.index.showToast({title:"选择图片失败",icon:"none"})}})},x=()=>{e.index.chooseVideo({sourceType:["album","camera"],maxDuration:60,camera:"back",success:e=>{b(e)},fail:o=>{console.error("选择视频失败:",o),e.index.showToast({title:"选择视频失败",icon:"none"})}})},w=async o=>{for(const i of o){const o={type:"image",url:i,status:"uploading",filePath:i,fileName:i.split("/").pop()||"image.jpg"};e.index.showLoading({title:"上传中..."});try{const t=await a.uploadFile({filePath:i,name:o.fileName}),s=a.getUploadResult(t);if(e.index.hideLoading(),!s)throw new Error("上传结果解析失败");o.status="success",o.objectKey=s.objectKey,o.url=s.url,o.uploadedUrl=s.url,v.value.push(o),console.log("图片上传成功:",s)}catch(t){console.error("图片上传失败:",t),o.status="failed",o.errorMsg=t.message,e.index.showToast({title:"图片上传失败",icon:"none"})}}},b=async o=>{const t={type:"video",url:o.tempFilePath,cover:o.thumbTempFilePath,duration:o.duration,size:o.size,status:"uploading",filePath:o.tempFilePath,fileName:o.tempFilePath.split("/").pop()||"video.mp4"};e.index.showLoading({title:"上传中..."});try{const i=await a.uploadFile({filePath:o.tempFilePath,name:t.fileName}),s=a.getUploadResult(i);if(e.index.hideLoading(),!s)throw new Error("上传结果解析失败");t.status="success",t.objectKey=s.objectKey,t.url=s.url,t.uploadedUrl=s.url,t.cover=s.cover||o.thumbTempFilePath,v.value.push(t),console.log("视频上传成功:",s)}catch(i){console.error("视频上传失败:",i),t.status="failed",t.errorMsg=i.message,e.index.showToast({title:"视频上传失败",icon:"none"})}},j=o=>{const t=v.value[o];if("image"===t.type){const o=v.value.filter((e=>"image"===e.type)),a=o.map((e=>n.$imgBaseUrl+e.url)),i=o.findIndex((e=>e===t));e.index.previewImage({urls:a,current:i>=0?i:0,indicator:"number",loop:!0,show:!0,success:function(e){console.log("图片预览成功",e)},fail:function(e){console.error("图片预览失败",e)}})}else"video"===t.type&&console.log("视频播放:",t.url)},T=e.ref(""),P=e.ref(!1),k=e.computed((()=>T.value.trim().length>0)),L=e.computed((()=>m.topics.map((e=>e.topic_id)))),U=()=>{e.index.chooseLocation({success:e=>{const o=e.address||e.name||"已选择位置";console.log("手动选择位置",e),d.value=o,r.value=e.longitude,u.value=e.latitude},fail:o=>{o.errMsg&&-1===o.errMsg.indexOf("cancel")&&(e.index.showToast({title:"获取位置失败",icon:"none"}),console.error("获取位置失败:",o.errMsg))}})},F=async()=>{if(!k.value||P.value)return;P.value=!0;const o=v.value.filter((e=>"success"===e.status)).map((e=>"image"===e.type?{media_type:1,object_key:e.objectKey,url:e.uploadedUrl,file_name:e.fileName}:"video"===e.type?{media_type:2,object_key:e.objectKey,url:e.uploadedUrl,file_name:e.fileName,cover:e.cover,duration:e.duration,size:e.size}:void 0)).filter(Boolean),a=o.map((e=>e.object_key)).filter(Boolean),i=m.topics.map((e=>({topic_id:e.topic_id,topic_desc:e.topic_desc,topic_icon:e.topic_icon})));let s={content:T.value,status:1,location:`${r.value},${u.value}`,location_desc:d.value,topics:i,object_keys:a,media_list:o,image_count:o.filter((e=>1===e.media_type)).length,video_count:o.filter((e=>2===e.media_type)).length};console.log("发布参数:",s);try{e.index.showLoading({title:"发布中..."});const o=await t.pushMoments(s);0===o.data.code?(e.index.showToast({title:"发布成功",icon:"success",duration:2e3}),setTimeout((()=>{e.index.navigateBack({delta:1})}),2e3)):e.index.showToast({title:o.data.msg||"发布失败",icon:"none",duration:2e3})}catch(l){console.error("发布失败:",l),e.index.showToast({title:"发布失败，请重试",icon:"none",duration:2e3})}finally{e.index.hideLoading(),P.value=!1}},M=()=>{e.index.navigateBack({delta:1})};return(t,a)=>e.e({a:1==e.unref(l).switch},1==e.unref(l).switch?e.e({b:e.p({color:"#000",size:"24",name:"close"}),c:e.o(M),d:e.o((e=>T.value=e)),e:e.p({placeholder:"请输入内容",border:"bottom",modelValue:T.value}),f:e.f(m.topics,((o,t,a)=>({a:e.t(o.topic_desc),b:o.topic_id}))),g:e.f(v.value,((o,t,a)=>e.e({a:"video"===o.type},"video"===o.type?{b:e.unref(n).$imgBaseUrl+o.url,c:e.o((e=>j(t)),t)}:{d:e.unref(n).$imgBaseUrl+o.url,e:e.o((e=>j(t)),t)},{f:"f4a1c7b0-2-"+a,g:e.o((o=>(o=>{e.index.showModal({title:"提示",content:"确定要删除这个文件吗？",success:e=>{e.confirm&&v.value.splice(o,1)}})})(t)),t),h:t,i:"video"===o.type?1:""}))),h:e.p({name:"close",color:"#fff",size:"16"}),i:v.value.length<9},v.value.length<9?{j:e.p({name:"plus",color:"#999",size:"32"}),k:e.o(g)}:{},{l:e.f(c.value,((o,t,a)=>({a:e.t(o.topic_desc),b:L.value.indexOf(o.topic_id)>-1?1:"",c:o.topic_id,d:e.o((e=>(e=>{let o=m.topics.indexOf(e);-1===o&&m.topics.push(e),-1!==o&&m.topics.splice(o,1)})(o)),o.topic_id)}))),m:o._imports_0$1,n:e.t(""===d.value?"不显示位置":d.value),o:e.o(U),p:e.o((e=>f.value=!1)),q:e.o(_),r:e.p({show:f.value,actions:h}),s:P.value},(P.value,{}),{t:!P.value},(P.value,{}),{v:P.value||!k.value?1:"",w:e.o(F)}):{})}},l=e._export_sfc(s,[["__scopeId","data-v-f4a1c7b0"]]);wx.createPage(l);

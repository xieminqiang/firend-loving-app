"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/file.js"),o=require("../../../api/order.js"),n={__name:"partner-evaluate",setup(n){const{proxy:i}=e.getCurrentInstance(),r=e.ref(""),l=e.ref(""),s=e.ref({}),c=e.ref(null),u=e.ref(""),m=e.ref([]),d=e.ref(!1),v=e.computed((()=>u.value.trim().length>0));e.onLoad((e=>{e.orderId&&(r.value=e.orderId),e.companion_id&&(l.value=e.companion_id),g()}));const g=async()=>{try{e.index.showLoading({title:"加载中..."});const a=await o.getOrderCommentList({order_id:Number(r.value)});if(0!==a.data.code)throw new Error(a.data.msg||"获取评价失败");{const e=a.data.data.list||[];s.value=e.find((e=>0===e.is_companion))||{},c.value=e.find((e=>1===e.is_companion))||null,console.log("用户评价:",s.value),console.log("友伴师回复:",c.value)}}catch(a){console.error("加载评价失败:",a),e.index.showToast({title:a.message||"加载失败",icon:"none"})}finally{e.index.hideLoading()}},p=()=>{const a=3-m.value.length;a<=0?e.index.showToast({title:"最多只能上传3张图片",icon:"none"}):e.index.chooseImage({count:a,sizeType:["compressed"],sourceType:["album","camera"],success:async a=>{e.index.showLoading({title:"上传中...",mask:!0});try{const o=a.tempFilePaths.map((async(e,a)=>{try{const o=await h(e);if(!o||!o.extension)throw new Error("无法获取文件信息");const n=await t.uploadFile({filePath:e,name:`reply_${Date.now()}_${a}.${o.extension}`}),i=t.getUploadResult(n);if(!i||!i.url)throw new Error("上传结果解析失败");return i.url}catch(o){throw console.error(`第${a+1}张图片上传失败:`,o),o}})),n=await Promise.all(o);m.value.push(...n),e.index.showToast({title:`成功上传${n.length}张图片`,icon:"success"})}catch(o){console.error("图片上传失败:",o),e.index.showToast({title:"图片上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:a=>{console.error("选择图片失败:",a),e.index.showToast({title:"选择图片失败",icon:"none"})}})},h=a=>new Promise(((t,o)=>{e.index.getFileInfo({filePath:a,success:e=>{const o=a.split(".").pop().toLowerCase();t({size:e.size,extension:o})},fail:e=>{console.error("获取文件信息失败:",e);const o=a.split(".").pop().toLowerCase()||"jpg";t({size:0,extension:o})}})})),f=async()=>{var a,t;if(v.value&&!d.value){d.value=!0;try{const t={order_id:parseInt(r.value),rating:0,comment:u.value.trim(),comment_images:m.value,is_anonymous:0,is_companion:1};console.log("提交回复数据:",t);const n=await o.createOrderComment(t);if(!n.data||0!==n.data.code)throw new Error((null==(a=n.data)?void 0:a.msg)||"回复提交失败");e.index.showToast({title:"回复提交成功",icon:"success",duration:2e3}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(n){console.error("提交回复失败:",n),e.index.showToast({title:(null==(t=n.data)?void 0:t.msg)||"提交失败，请重试",icon:"none"})}finally{d.value=!1}}},w=e=>{if(!e)return"";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`};return(t,o)=>e.e({a:e.f(5,((e,a,t)=>({a:e,b:e<=s.value.rating?1:""}))),b:e.t(s.value.rating),c:e.t(s.value.comment),d:s.value.comment_images&&s.value.comment_images.length>0},s.value.comment_images&&s.value.comment_images.length>0?{e:e.f(s.value.comment_images,((a,t,o)=>({a:e.unref(i).$imgBaseUrl+a,b:t,c:e.o((a=>(a=>{const t=s.value.comment_images.map((e=>i.$imgBaseUrl+e));e.index.previewImage({urls:t,current:a})})(t)),t)})))}:{},{f:e.t(w(s.value.comment_time)),g:c.value},c.value?e.e({h:e.t(c.value.comment),i:c.value.comment_images&&c.value.comment_images.length>0},c.value.comment_images&&c.value.comment_images.length>0?{j:e.f(c.value.comment_images,((a,t,o)=>({a:e.unref(i).$imgBaseUrl+a,b:t,c:e.o((a=>(a=>{const t=c.value.comment_images.map((e=>i.$imgBaseUrl+e));e.index.previewImage({urls:t,current:a})})(t)),t)})))}:{},{k:e.t(w(c.value.comment_time))}):{},{l:!c.value},c.value?{}:e.e({m:u.value,n:e.o((e=>u.value=e.detail.value)),o:e.t(u.value.length),p:e.f(m.value,((a,t,o)=>({a:e.unref(i).$imgBaseUrl+a,b:e.o((e=>(e=>{m.value.splice(e,1)})(t)),t),c:t,d:e.o((a=>(a=>{const t=m.value.map((e=>i.$imgBaseUrl+e));e.index.previewImage({urls:t,current:a})})(t)),t)}))),q:m.value.length<3},m.value.length<3?{r:a._imports_0$4,s:e.o(p)}:{}),{t:!c.value},c.value?{}:e.e({v:d.value},(d.value,{}),{w:!d.value},(d.value,{}),{x:d.value||!v.value?1:"",y:e.o(f)}))}},i=e._export_sfc(n,[["__scopeId","data-v-6f2951cd"]]);wx.createPage(i);

"use strict";const e=require("../../../common/vendor.js"),o=require("../../../api/user.js"),a={__name:"DataSelect",setup(a){const n=e.ref(null),t=e.ref(!0),l=e.ref(0),d=e.ref([]),i=e.ref(0),s=e.ref([]),c=e.ref([{key:"monday",name:"周一"},{key:"tuesday",name:"周二"},{key:"wednesday",name:"周三"},{key:"thursday",name:"周四"},{key:"friday",name:"周五"},{key:"saturday",name:"周六"},{key:"sunday",name:"周日"}]),u=()=>{const e=d.value.find((e=>!0===e.is_today));e?(l.value=e.day_of_week-1,console.log("设置为今天:",e.day_of_week,"选中索引:",l.value)):(l.value=0,console.log("未找到今天数据，默认选中周一"))},r=()=>{const e=l.value+1,o=s.value.find((o=>o.day_of_week===e)),a=d.value.find((o=>o.day_of_week===e));o&&a&&(a.schedule=JSON.parse(JSON.stringify(o.schedule)),console.log("重置星期数据:",e,"为原始状态"))},v=e=>{const o=e+1,a=d.value.find((e=>e.day_of_week===o));return!!a&&a.is_today},f=()=>{const e=l.value+1,o=d.value.find((o=>o.day_of_week===e));return o?o.schedule:{}},h=e=>{const o=e+1,a=d.value.find((e=>e.day_of_week===o));if(!a)return"未设置";const n=a.schedule,t=Object.values(n).filter((e=>1===e)).length,l=Object.values(n).filter((e=>3===e)).length;let i="";return i=l>0?`${l}个已约`:48===t?"全天可约":0===t?"全天休息":`${t}个可约`,a.is_today,i},y=e=>{switch(e){case 1:return"available";case 2:default:return"unavailable";case 3:return"booked"}},_=e=>{switch(e){case 1:return"可约";case 2:default:return"休息";case 3:return"已约"}},g=()=>{const e=l.value+1,o=d.value.find((o=>o.day_of_week===e));o&&Object.keys(o.schedule).forEach((e=>{3!==o.schedule[e]&&(o.schedule[e]=1)}))},m=()=>{const e=l.value+1,o=d.value.find((o=>o.day_of_week===e));o&&Object.keys(o.schedule).forEach((e=>{3!==o.schedule[e]&&(o.schedule[e]=2)}))},w=async()=>{var a;if(!n.value)return void e.index.showToast({title:"用户信息不完整",icon:"none"});const t=l.value+1,i=d.value.find((e=>e.day_of_week===t));if(!i)return void e.index.showToast({title:"未找到当前星期的数据",icon:"none"});const c=s.value.find((e=>e.day_of_week===t));if(c&&JSON.stringify(c.schedule)===JSON.stringify(i.schedule))return void e.index.showToast({title:"没有修改内容",icon:"none"});const u={companion_id:n.value,day_of_week:t,schedule:i.schedule};console.log("准备保存的数据:",u);try{e.index.showLoading({title:"保存中..."});const l=await o.saveCompanionSchedule(u);if(e.index.hideLoading(),l.data&&0===l.data.code){const o=s.value.findIndex((e=>e.day_of_week===t));-1!==o&&(s.value[o]=JSON.parse(JSON.stringify(i))),e.index.showToast({title:"保存成功",icon:"success"}),console.log("保存成功:",l.data),e.index.$emit("scheduleDataUpdated",{companion_id:n.value,day_of_week:t,schedule:i.schedule})}else e.index.showToast({title:(null==(a=l.data)?void 0:a.msg)||"保存失败",icon:"none"}),console.error("保存失败:",l.data)}catch(r){e.index.hideLoading(),e.index.showToast({title:"网络错误，请重试",icon:"none"}),console.error("保存接口调用失败:",r)}};return e.onMounted((()=>{console.log("DataSelect组件mounted"),(()=>{const o=getCurrentPages(),a=o[o.length-1].options;a.companion_id?(n.value=parseInt(a.companion_id),console.log("获取到companion_id:",n.value)):(console.error("未获取到companion_id参数"),e.index.showToast({title:"参数错误",icon:"none"}))})(),(async()=>{var a;if(n.value)try{console.log("开始调用getCompanionSchedule接口，companion_id:",n.value);let l={companion_id:n.value};console.log("obj:",l);const i=await o.getCompanionSchedule(l);console.log("接口调用成功:",i),i.data&&0===i.data.code?(d.value=i.data.data,s.value=JSON.parse(JSON.stringify(i.data.data)),console.log("解析后的数据:",d.value),u()):e.index.showToast({title:(null==(a=i.data)?void 0:a.msg)||"获取数据失败",icon:"none"})}catch(l){console.error("接口调用失败:",l),e.index.showToast({title:"网络错误",icon:"none"})}finally{t.value=!1}else console.error("companion_id为空，无法调用接口")})(),(()=>{const o=e.index.getSystemInfoSync().windowHeight;i.value=o-10,console.log("timeGridHeight.value:",i.value),e.index.createSelectorQuery().select(".time-grid-header").boundingClientRect((e=>{e&&(i.value=i.value-e.bottom)})).exec(),e.index.createSelectorQuery().select(".bottom-fixed").boundingClientRect((e=>{e&&(console.log("rect:",e.height),i.value=i.value-e.height)})).exec()})()})),(o,a)=>({a:e.f(c.value,((o,a,n)=>({a:e.t(o.name),b:e.t(h(a)),c:o.key,d:l.value===a?1:"",e:v(a)?1:"",f:e.o((e=>(e=>{l.value!==e&&r(),l.value=e})(a)),o.key)}))),b:e.t(c.value[l.value].name),c:e.o(g),d:e.o(m),e:e.f(f(),((o,a,n)=>({a:e.t(a),b:e.t(_(o)),c:a,d:e.n(y(o)),e:e.o((o=>(o=>{const a=l.value+1,n=d.value.find((e=>e.day_of_week===a));if(!n)return;const t=n.schedule[o];3!==t?n.schedule[o]=1===t?2:1:e.index.showToast({title:"已约时间段不能修改",icon:"none"})})(a)),a)}))),f:i.value+"px",g:e.o(w)})}},n=e._export_sfc(a,[["__scopeId","data-v-4d3e02a3"]]);wx.createPage(n);

"use strict";const e=require("../../../common/vendor.js"),o=require("../../../common/assets.js"),t=require("../utils/location.js"),n=require("../../../api/user.js"),a=require("../../../api/order.js"),i=require("../utils/address.js");Math||s();const s=()=>"./VideoUploadModal.js",c={__name:"Workbench",props:{applicationInfo:{type:Object,default:null}},setup(s){const c=s,l=e.ref(!1),r=e.ref(""),d=e.ref(""),u=e.ref(!1),p=e.ref(!1),g=e.ref(!1),f=e.ref([]),h=e.ref(!1),v=e.ref([]),m=e.ref(!1),x=e.ref(!1),w=e.computed((()=>c.applicationInfo&&"object"==typeof c.applicationInfo)),_=()=>{if(!f.value||0===f.value.length)return null;return f.value.find((e=>!0===e.is_today))},y=()=>{const e=_();return e&&e.schedule?Object.values(e.schedule).filter((e=>1===e)).length:0},I=()=>{const e=_();return e&&e.schedule?Object.values(e.schedule).filter((e=>3===e)).length:0},T=e.computed((()=>{if(h.value)return"加载中...";if(!_())return"未设置";const e=y(),o=I();return o>0?`${o}个已约`:48===e?"全天可约":0===e?"全天休息":`${e}个可约`})),b=e.computed((()=>{if(h.value)return"正在加载今日安排...";if(!_())return"今日未设置时间安排";const e=y(),o=I();return o>0?`今日有${o}个时间点已被预约`:48===e?"今日全天可接单":0===e?"今日休息，暂停接单":`今日可接单 ${e}个时间点`})),L=()=>{w.value&&void 0!==c.applicationInfo.is_online?(l.value=1===c.applicationInfo.is_online,console.log("从applicationInfo获取在线状态:",l.value,"原始值:",c.applicationInfo.is_online)):(l.value=!1,console.log("使用默认在线状态: 下线"))},S=async()=>{u.value?console.log("组件已经初始化过，跳过重复初始化"):(console.log("开始初始化Workbench组件"),await e.nextTick$1(),L(),k(),await F(),await G(),u.value=!0,console.log("Workbench组件初始化完成"))};e.watch((()=>c.applicationInfo),((e,o)=>{console.log("applicationInfo发生变化:",{old:o,new:e}),e&&w.value&&(u.value?(console.log("组件已初始化，更新在线状态、日期安排数据和最近订单数据"),L(),F(),G()):S())}),{immediate:!0,deep:!0});const $=async()=>{if(p.value)return void console.log("正在更新状态，忽略重复点击");const o=!l.value,t=o?"上线":"下线";!o||!w.value||"N"!==c.applicationInfo.can_accept_orders||c.applicationInfo.intro_video_url&&"approved"===c.applicationInfo.video_review_status?e.index.showModal({title:`确认${t}`,content:o?"上线后将开始接收订单，确认上线吗？":"下线后将停止接收订单，确认下线吗？",success:async e=>{e.confirm&&(o&&await B(),await M(o))}}):g.value=!0},M=async o=>{var a;p.value=!0;try{let c=null;if(o){e.index.showLoading({title:"获取位置中..."});try{c=await t.getCurrentLocationAddress(!1),console.log("获取位置成功:",c)}catch(s){return console.error("获取位置失败:",s),e.index.hideLoading(),void e.index.showToast({title:"获取位置失败，无法上线",icon:"none"})}}else{const e=t.getCacheStatus();e.hasCache&&(c={latitude:e.coordinates.latitude,longitude:e.coordinates.longitude,address:e.address})}const u=i.processAddress(c?c.address:""),g={is_online:o?1:0,latitude:c?c.latitude:null,longitude:c?c.longitude:null,location_text:u};console.log("准备更新在线状态:",g);const f=await n.updateCompanionOnlineStatus(g);console.log("在线",f),f.data&&0===f.data.code?(l.value=o,c&&(r.value=c.address,d.value=(new Date).toLocaleTimeString()),e.index.hideLoading(),e.index.showToast({title:o?"已上线，开始接单":"已下线，暂停接单",icon:"none"}),console.log("在线状态更新成功:",f.data)):(e.index.hideLoading(),e.index.showToast({title:(null==(a=f.data)?void 0:a.msg)||"状态更新失败",icon:"none"}),console.error("在线状态更新失败:",f.data))}catch(s){e.index.hideLoading(),e.index.showToast({title:"网络错误，请重试",icon:"none"}),console.error("更新在线状态失败:",s)}finally{p.value=!1}},k=()=>{const e=t.getCacheStatus();if(e.hasCache&&e.isValid)return r.value=e.address,d.value=new Date(e.timestamp).toLocaleTimeString(),console.log("使用缓存位置信息:",e.address),console.log("使用缓存:",e),void j(e.coordinates.latitude,e.coordinates.longitude,e.address);t.getCurrentLocationAddress(!1).then((e=>{r.value=e.address,d.value=(new Date).toLocaleTimeString(),console.log("获取位置成功",e),j(e.latitude,e.longitude,e.address)})).catch((e=>{console.error("获取位置失败:",e),r.value="位置获取失败",d.value="获取失败"}))},C=()=>{e.index.showLoading({title:"更新位置中"}),t.getCurrentLocationAddress(!1).then((o=>{r.value=o.address,d.value=(new Date).toLocaleTimeString(),console.log("位置更新成功",o),e.index.hideLoading(),e.index.showToast({title:"位置更新成功",icon:"none"}),j(o.latitude,o.longitude,o.address)})).catch((o=>{e.index.hideLoading(),e.index.showToast({title:"获取位置失败",icon:"none"}),console.error("获取位置失败:",o)}))},j=async(e,o,t)=>{var a;try{const s={latitude:e,longitude:o,location_text:i.processAddress(t)};console.log("准备更新位置信息到服务器:",s),console.log("位置描述分析:",i.analyzeAddress(t));const c=await n.updateCompanionLocation(s);c.data&&0===c.data.code?console.log("位置信息更新成功:",c.data):console.error("位置信息更新失败:",null==(a=c.data)?void 0:a.msg)}catch(s){console.error("位置信息更新API调用失败:",s)}},D=()=>{e.index.chooseLocation({success:async e=>{const o=e.address||e.name||"已选择位置";console.log("手动选择位置",e),r.value=o,d.value=(new Date).toLocaleTimeString(),await j(e.latitude,e.longitude,o)},fail:o=>{o.errMsg&&-1===o.errMsg.indexOf("cancel")&&(e.index.showToast({title:"获取位置失败",icon:"none"}),console.error("获取位置失败:",o.errMsg))}})},O=()=>{c.applicationInfo&&c.applicationInfo.id?e.index.navigateTo({url:`/subPackages/fpart/order/index?companion_id=${c.applicationInfo.id}`}):e.index.showToast({title:"用户信息不完整",icon:"none"})},q=e=>({2:[{text:"拒绝",action:"reject",type:"secondary"},{text:"接单",action:"accept",type:"primary"}],3:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已到达服务地点",action:"arrived",type:"primary"}],4:[{text:"电话联系",action:"call",type:"secondary"}],5:[{text:"电话联系",action:"contact",type:"secondary"},{text:"结束服务",action:"end",type:"primary"}],11:[{text:"电话联系",action:"contact",type:"secondary"},{text:"我已出发",action:"depart",type:"depart"}]}[e]||[]),N=o=>{o.user&&o.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${o.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:t=>{t.confirm&&e.index.makePhoneCall({phoneNumber:o.user.phone})}})},P=o=>{e.index.showModal({title:"确认接单",content:"确定要接受这个订单吗？",confirmText:"接单",cancelText:"取消",success:async t=>{if(t.confirm)try{e.index.showLoading({title:"处理中..."});const t=await a.acceptCompanionOrder({order_id:o.id,companion_id:Number(c.applicationInfo.id)});if(0!==t.data.code)throw new Error(t.data.msg||"接单失败");e.index.showToast({title:"接单成功",icon:"success"}),await G()}catch(n){console.error("接单失败:",n),e.index.showToast({title:n.message||"接单失败",icon:"none"})}finally{e.index.hideLoading()}}})},A=o=>{e.index.showModal({title:"拒绝订单",content:"确定要拒绝这个订单吗？",confirmText:"拒绝",cancelText:"取消",success:async t=>{if(t.confirm)try{e.index.showLoading({title:"处理中..."});const t=await a.rejectCompanionOrder({order_id:o.id,companion_id:Number(c.applicationInfo.id)});if(0!==t.data.code)throw new Error(t.data.msg||"拒绝订单失败");e.index.showToast({title:"已拒绝订单",icon:"success"}),await G()}catch(n){console.error("拒绝订单失败:",n),e.index.showToast({title:n.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},E=o=>{e.index.showModal({title:"确认到达",content:"确认您已到达服务地点？",confirmText:"确认",cancelText:"取消",success:async t=>{if(t.confirm)try{e.index.showLoading({title:"更新中..."});const t=await a.arrivedCompanionOrder({order_id:o.id,companion_id:Number(c.applicationInfo.id)});if(0!==t.data.code)throw new Error(t.data.msg||"确认到达失败");e.index.showToast({title:"已确认到达",icon:"success"}),await G()}catch(n){console.error("确认到达失败:",n),e.index.showToast({title:n.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},U=o=>{o.user&&o.user.phone&&e.index.showModal({title:"电话联系",content:`是否拨打客户 ${o.user.nick_name} 的电话？`,confirmText:"拨打",cancelText:"取消",success:t=>{t.confirm&&e.index.makePhoneCall({phoneNumber:o.user.phone})}})},W=o=>{e.index.showModal({title:"确认出发",content:"确认您已开始出发前往服务地点？",confirmText:"确认",cancelText:"取消",success:async t=>{if(t.confirm)try{e.index.showLoading({title:"更新中..."});const t=await a.departCompanionOrder({order_id:o.id,companion_id:Number(c.applicationInfo.id)});if(0!==t.data.code)throw new Error(t.data.msg||"确认出发失败");e.index.showToast({title:"已确认出发",icon:"success"}),await G()}catch(n){console.error("确认出发失败:",n),e.index.showToast({title:n.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},z=o=>{e.index.showModal({title:"结束服务",content:"确定要结束服务吗？",confirmText:"结束",cancelText:"取消",success:async t=>{if(t.confirm)try{e.index.showLoading({title:"更新中..."});const t=await a.endCompanionService({order_id:o.id,companion_id:Number(c.applicationInfo.id)});if(0!==t.data.code)throw new Error(t.data.msg||"结束服务失败");e.index.showToast({title:"服务已结束",icon:"success"}),await G()}catch(n){console.error("结束服务失败:",n),e.index.showToast({title:n.message||"操作失败",icon:"none"})}finally{e.index.hideLoading()}}})},B=async()=>{const o="zovIGlvjM10gOUEZjOB-lOQwISsM0PLqfMtIJPbWf4Y";try{console.log("开始请求订阅消息权限");const t=await new Promise(((t,n)=>{e.index.requestSubscribeMessage({tmplIds:[o],success:e=>{console.log("订阅消息请求结果:",e),t(e)},fail:e=>{console.error("订阅消息请求失败:",e),n(e)}})}));"accept"===t[o]?(console.log("用户同意订阅消息"),e.index.showToast({title:"已开启接单提醒",icon:"success"})):"reject"===t[o]?(console.log("用户拒绝订阅消息"),e.index.showModal({title:"接单提醒权限",content:"为了您能及时接收新订单通知，是否去设置页面重新授权？",confirmText:"去设置",cancelText:"暂不开启",success:t=>{t.confirm?e.index.openSetting({success:t=>{t.authSetting["scope.subscribeMessage"]?e.index.requestSubscribeMessage({tmplIds:[o],success:o=>{console.log("重新授权成功:",o),e.index.showToast({title:"已开启接单提醒",icon:"success"})},fail:e=>{console.log("重新授权失败:",e)}}):e.index.showToast({title:"未开启接单提醒",icon:"none"})},fail:e=>{console.error("打开设置页面失败:",e)}}):e.index.showToast({title:"未开启接单提醒",icon:"none"})}})):(console.log("用户未明确选择订阅消息"),e.index.showToast({title:"未开启接单提醒",icon:"none"}))}catch(t){console.error("订阅消息请求异常:",t),e.index.showToast({title:"订阅消息请求失败",icon:"none"})}},V=()=>{g.value=!1},Y=o=>{console.log("视频上传成功:",o),e.index.$emit("applicationStatusChanged",o)},F=async()=>{var e;if(w.value&&c.applicationInfo.id)try{console.log("开始获取日期安排数据，companion_id:",c.applicationInfo.id);const o={companion_id:c.applicationInfo.id},t=await n.getCompanionSchedule(o);console.log("日期安排数据获取成功:",t),t.data&&0===t.data.code?(f.value=t.data.data,console.log("解析后的日期安排数据:",f.value)):console.error("获取日期安排数据失败:",null==(e=t.data)?void 0:e.msg)}catch(o){console.error("获取日期安排数据接口调用失败:",o)}finally{h.value=!1}else console.log("applicationInfo不完整，跳过获取日期安排数据")},G=async()=>{var e;if(w.value&&c.applicationInfo.id)try{console.log("开始获取最近订单数据，companion_id:",c.applicationInfo.id);const o={companion_id:Number(c.applicationInfo.id),page:1,page_size:10},t=await a.getCompanionActiveOrders(o);console.log("最近订单数据获取成功:",t),t.data&&0===t.data.code?(v.value=t.data.data.list,console.log("解析后的最近订单数据:",v.value)):console.error("获取最近订单数据失败:",null==(e=t.data)?void 0:e.msg)}catch(o){console.error("获取最近订单数据接口调用失败:",o)}finally{m.value=!1}else console.log("applicationInfo不完整，跳过获取最近订单数据")},H=()=>{c.applicationInfo&&c.applicationInfo.id?e.index.navigateTo({url:`/subPackages/fpart/components/DataSelect?companion_id=${c.applicationInfo.id}`}):e.index.showToast({title:"用户信息不完整",icon:"none"})},J=async()=>{if(!x.value){x.value=!0;try{await Promise.all([F(),G()]),await new Promise((e=>setTimeout(e,800)))}catch(e){console.error("刷新失败:",e)}finally{x.value=!1}}},Q=()=>{x.value=!1},Z=e=>({2:"status-pending",3:"status-departing",4:"status-arrived",5:"status-serving",11:"status-departing"}[e]||"status-default"),K=e=>{if(!e)return"";const o=new Date(e);return`${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")} ${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`},R=(e,o)=>{if(!e&&!o)return"待确认";let t="";if(e){const o=new Date(e);t+=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")} ${["周日","周一","周二","周三","周四","周五","周六"][o.getDay()]}`}return o&&(t&&(t+=" "),t+=o),t||"待确认"};e.onMounted((()=>{console.log("Workbench组件mounted，applicationInfo状态:",{hasApplicationInfo:!!c.applicationInfo,applicationInfo:c.applicationInfo}),w.value?S():console.log("applicationInfo还未准备好，等待watch触发初始化"),e.index.$on("scheduleDataUpdated",X)})),e.onUnmounted((()=>{e.index.$off("scheduleDataUpdated",X)}));const X=async e=>{var o;console.log("收到日期安排数据更新事件:",e),e.companion_id===(null==(o=c.applicationInfo)?void 0:o.id)&&(console.log("刷新日期安排数据"),await F())};return(t,n)=>e.e({a:s.applicationInfo&&s.applicationInfo.avatar},s.applicationInfo&&s.applicationInfo.avatar?{b:t.$imgBaseUrl+s.applicationInfo.avatar}:{},{c:l.value?1:"",d:e.t(l.value?"已上线":"已下线"),e:e.t(l.value?"正在接单中":"暂停接单"),f:e.t(l.value?"下线休息":"开始上线"),g:l.value?1:"",h:e.o($),i:l.value?1:"",j:o._imports_0$15,k:e.o(C),l:o._imports_1$8,m:e.o(D),n:e.t(r.value||"正在获取位置..."),o:o._imports_2$5,p:e.t(T.value),q:h.value?1:"",r:e.t(b.value),s:e.o(H),t:e.o(O),v:m.value},m.value?{}:0===v.value.length?{x:o._imports_3}:{y:e.f(v.value,((o,n,a)=>{var i,s,l;return e.e({a:e.t(K(o.created_at)),b:e.t((l=o.status,{2:"等待接单",3:"我已出发",4:"已到达，等待开始服务",5:"服务中",11:"待服务"}[l]||"未知状态")),c:e.n(Z(o.status)),d:t.$imgBaseUrl+o.service_image_url,e:e.t(o.service_name),f:e.t(o.unit_price),g:e.t(o.unit),h:e.t(o.quantity),i:e.t(o.total_amount),j:[2,3,4,5,11].includes(o.status)},[2,3,4,5,11].includes(o.status)?e.e({k:o.user},o.user?{l:e.t(null==(i=null==o?void 0:o.user)?void 0:i.nick_name),m:e.t(null==(s=null==o?void 0:o.user)?void 0:s.phone)}:{},{n:e.t(o.service_address),o:e.o((t=>(o=>{o.user_latitude&&o.user_longitude?e.index.openLocation({latitude:Number(o.user_latitude),longitude:Number(o.user_longitude),address:o.service_address}):e.index.showToast({title:"暂无位置信息",icon:"none"})})(o)),o.id),p:e.t(R(o.service_date,o.service_time))}):{},{q:e.f(q(o.status),((t,n,a)=>({a:e.t(t.text),b:n,c:e.n(t.type),d:e.o((e=>((e,o)=>{switch(e){case"contact":N(o);break;case"accept":P(o);break;case"reject":A(o);break;case"arrived":E(o);break;case"depart":W(o);break;case"call":U(o);break;case"end":z(o)}})(t.action,o)),n)}))),r:o.id,s:e.o((t=>{return n=o.id,void e.index.navigateTo({url:`/subPackages/fpart/order/detail?orderId=${n}&companion_id=${c.applicationInfo.id}`});var n}),o.id)})}))},{w:0===v.value.length,z:x.value,A:e.o(J),B:e.o(Q),C:e.o(V),D:e.o(Y),E:e.p({show:g.value,applicationInfo:s.applicationInfo})})}},l=e._export_sfc(c,[["__scopeId","data-v-bbf30e2f"]]);wx.createComponent(l);

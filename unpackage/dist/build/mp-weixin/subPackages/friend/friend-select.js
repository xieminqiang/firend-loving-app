"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../api/friends.js");require("../../config/http.js");const o=require("../../stores/level.js"),i=require("../../stores/city.js"),l=require("../../stores/user.js");if(!Array){e.resolveComponent("uni-popup")()}Math||(n+r+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const n=()=>"../../components/common/CitySelector.js",r=()=>"../../components/common/CityPicker.js",s={__name:"friend-select",setup(n){const r=e.ref(0);e.ref(null);const s=e.ref(0),u=e.ref(""),c=e.ref(!1),v=e.ref(!1),d=e.ref(""),g=e.computed((()=>{var e;return(null==(e=m.userLocation)?void 0:e.latitude)||null})),p=e.computed((()=>{var e;return(null==(e=m.userLocation)?void 0:e.longitude)||null}));e.ref(!1);const m=i.useCityStore(),f=l.useUserStore(),_=e.computed((()=>f.userInfo&&Object.keys(f.userInfo).length>0));e.computed((()=>{if(_.value)return f.userInfo}));e.computed((()=>m.cityList)),e.computed((()=>m.currentCity));const h=e.ref([]),y=e.ref(0),x=e.ref(1),C=e.ref(20),b=e.ref(!1),w=e.ref(!0),T=e.ref(!1),k=o.useLevelStore(),j=e.computed((function(){return h.value.map((function(e){const t=e.tags?e.tags.slice(0,3):[],a=e.tags&&e.tags.length>3?e.tags.length-3:0;return{...e,visibleTags:t,extraTags:a}}))})),P=e.ref(null),S=e.ref([]),$=e.ref(null),I=e.ref(0),q=()=>{P.value.close()},B=t=>{if(console.log("选择服务:",t),q(),!_.value)return e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void e.index.navigateTo({url:"/subPackages/login/index"});let a=`/subPackages/order/submit?service_id=${t.service_id}&price_template_id=${t.price_template_id||""}&companion_id=${$.value.id}&level_order=${$.value.level_order||""}&nickname=${$.value.name}`;d.value&&(a+=`&original_service_id=${d.value}`),e.index.navigateTo({url:a})},A=async(t=!1)=>{var o;if(!b.value){b.value=!0;try{const i={page:t?1:x.value,page_size:C.value};m.currentCityCode&&(i.city_code=m.currentCityCode),u.value&&u.value.trim()&&(i.nickname=u.value.trim()),g.value&&p.value&&(i.latitude=g.value,i.longitude=p.value),d.value&&(i.service_id=d.value),console.log("搜索参数:",i);const l=await a.searchCompanions(i);if(console.log("API完整响应:",l),l.data&&0===l.data.code){const e=l.data.data;if(e&&e.list){const a=e.list.map((e=>({id:e.id,name:e.nickname,gender:e.gender,age:e.age,height:e.height,weight:e.weight,distance:e.distance,tags:e.tags||[],services:(()=>{if("string"==typeof e.services)try{return JSON.parse(e.services)}catch(t){return console.error("解析services JSON失败:",t),[]}return e.services||[]})(),avatar:e.avatar,online:1===e.is_online,bookable:"Y"===e.can_accept_orders})));t?(h.value=a,x.value=1):(h.value=[...h.value,...a],x.value++),y.value=e.total||0,w.value=a.length===C.value,console.log("搜索成功，共获取",a.length,"条数据，总数:",y.value),a.length}else console.log("API返回数据为空"),t&&(h.value=[],y.value=0)}else{console.error("API返回错误:",l.data);const a=(null==(o=l.data)?void 0:o.message)||"搜索失败";e.index.showToast({title:a,icon:"none",duration:2e3}),t&&(h.value=[],y.value=0)}}catch(i){console.error("搜索伴友师失败:",i),console.error("错误详情:",i.response||i);let a="搜索失败，请重试";i.response&&i.response.data&&(a=i.response.data.message||a),e.index.showToast({title:a,icon:"none",duration:2e3}),t&&(h.value=[],y.value=0)}finally{b.value=!1,T.value=!0}}},L=()=>{!b.value&&w.value&&A(!1)},D=async()=>{c.value=!0,await A(!0),await new Promise((e=>setTimeout(e,800))),c.value=!1},M=()=>{clearTimeout(O),O=setTimeout((()=>{A(!0)}),500)};let O=null;const U=()=>{e.index.navigateBack({delta:1})},z=async t=>{e.index.vibrateShort({type:"light"}),await A(!0)};return e.onMounted((async()=>{const t=getCurrentPages(),a=t[t.length-1].options||{};a.service_id&&(d.value=a.service_id,console.log("接收到的服务ID:",d.value));const o=e.index.getSystemInfoSync();r.value=o.statusBarHeight;const i=e.index.getMenuButtonBoundingClientRect();i.value=i;const l=o.screenWidth,n=i.right;s.value=l-n+24,await k.fetchServiceLevels(),await m.initCityData(),await A(!0)})),e.onUnmounted((()=>{O&&clearTimeout(O)})),(o,i)=>e.e({a:t._imports_0$8,b:e.o(U),c:e.o((e=>v.value=!0)),d:t._imports_0$9,e:e.o([e=>u.value=e.detail.value,M]),f:u.value,g:s.value+"px",h:r.value+"px",i:b.value&&!T.value},b.value&&!T.value?{}:j.value.length>0?{k:e.f(j.value,((o,i,l)=>e.e({a:o.avatar,b:o.online},(o.online,{}),{c:e.t(o.name),d:"女"===o.gender},"女"===o.gender?{e:t._imports_3$2}:{f:t._imports_4},{g:e.t(o.age),h:e.t(o.height),i:e.t(o.weight),j:e.t(o.distance),k:e.f(o.visibleTags,((t,a,o)=>({a:e.t(t),b:a}))),l:o.extraTags>0},o.extraTags>0?{m:e.t(o.extraTags)}:{},{n:e.o((e=>(async e=>{$.value=e;try{const t={city_code:m.currentCityCode,application_id:e.id};g.value&&p.value&&(t.latitude=parseFloat(g.value),t.longitude=parseFloat(p.value));const o=await a.getCityServices(t);if(o.data&&0===o.data.code){const e=o.data.data;e&&e.services&&e.services.length>0?S.value=e.services:S.value=[]}else S.value=[]}catch(t){console.error("获取服务信息失败:",t),S.value=[]}P.value.open()})(o)),o.id),o:o.id,p:e.o((t=>(t=>{let a="/subPackages/friend/detail?id="+t+"&city_code="+m.currentCityCode;g.value&&p.value&&(a+="&latitude="+g.value+"&longitude="+p.value),e.index.navigateTo({url:a})})(o.id)),o.id)}))),l:t._imports_5}:T.value&&0===j.value.length?{n:t._imports_3}:{},{j:j.value.length>0,m:T.value&&0===j.value.length,o:e.o(L),p:c.value,q:e.o(D),r:e.o(z),s:e.o((e=>v.value=e)),t:e.p({visible:v.value}),v:t._imports_7,w:e.o(q),x:S.value.length>0},S.value.length>0?{y:e.f(S.value,((t,a,i)=>({a:o.$imgBaseUrl+t.service_image_url,b:e.t(t.service_name),c:e.f(t.service_tags,((t,a,o)=>({a:e.t(t),b:t}))),d:e.t(t.price),e:e.t(t.unit||"小时"),f:e.o((e=>B(t)),t.title),g:t.title})))}:{z:t._imports_3},{A:I.value,B:e.sr(P,"71dc3915-2",{k:"servicePopup"}),C:e.o(q),D:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})})}},u=e._export_sfc(s,[["__scopeId","data-v-71dc3915"]]);wx.createPage(u);

"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),t=require("../../api/friends.js");require("../../config/http.js");const i=require("../../stores/level.js"),l=require("../../stores/city.js");if(!Array){e.resolveComponent("uni-popup")()}Math||(n+o+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const n=()=>"../../components/common/CitySelector.js",o=()=>"../../components/common/CityPicker.js",s={__name:"friend-select",setup(n){const o=e.ref(0);e.ref(null);const s=e.ref(0),r=e.ref(""),u=e.ref(!1),c=e.ref(!1),v=e.ref(""),d=e.computed((()=>{var e;return(null==(e=p.userLocation)?void 0:e.latitude)||null})),g=e.computed((()=>{var e;return(null==(e=p.userLocation)?void 0:e.longitude)||null}));e.ref(!1);const p=l.useCityStore();e.computed((()=>p.cityList)),e.computed((()=>p.currentCity));const m=e.ref([]),_=e.ref(0),f=e.ref(1),h=e.ref(20),y=e.ref(!1),C=e.ref(!0),w=e.ref(!1),x=i.useLevelStore(),b=e.computed((function(){return m.value.map((function(e){const a=e.tags?e.tags.slice(0,3):[],t=e.tags&&e.tags.length>3?e.tags.length-3:0;return{...e,visibleTags:a,extraTags:t}}))})),k=e.ref(null),j=e.ref([]),P=e.ref(null),S=e.ref(0),T=()=>{k.value.close()},q=async(a=!1)=>{var i;if(!y.value){y.value=!0;try{const l={page:a?1:f.value,page_size:h.value};p.currentCityCode&&(l.city_code=p.currentCityCode),r.value&&r.value.trim()&&(l.nickname=r.value.trim()),d.value&&g.value&&(l.latitude=d.value,l.longitude=g.value),v.value&&(l.service_id=v.value),console.log("搜索参数:",l);const n=await t.searchCompanions(l);if(console.log("API完整响应:",n),n.data&&0===n.data.code){const e=n.data.data;if(e&&e.list){const t=e.list.map((e=>({id:e.id,name:e.nickname,gender:e.gender,age:e.age,height:e.height,weight:e.weight,distance:e.distance,tags:e.tags||[],services:(()=>{if("string"==typeof e.services)try{return JSON.parse(e.services)}catch(a){return console.error("解析services JSON失败:",a),[]}return e.services||[]})(),avatar:e.avatar,online:1===e.is_online,bookable:"Y"===e.can_accept_orders})));a?(m.value=t,f.value=1):(m.value=[...m.value,...t],f.value++),_.value=e.total||0,C.value=t.length===h.value,console.log("搜索成功，共获取",t.length,"条数据，总数:",_.value),t.length}else console.log("API返回数据为空"),a&&(m.value=[],_.value=0)}else{console.error("API返回错误:",n.data);const t=(null==(i=n.data)?void 0:i.message)||"搜索失败";e.index.showToast({title:t,icon:"none",duration:2e3}),a&&(m.value=[],_.value=0)}}catch(l){console.error("搜索伴友师失败:",l),console.error("错误详情:",l.response||l);let t="搜索失败，请重试";l.response&&l.response.data&&(t=l.response.data.message||t),e.index.showToast({title:t,icon:"none",duration:2e3}),a&&(m.value=[],_.value=0)}finally{y.value=!1,w.value=!0}}},$=()=>{!y.value&&C.value&&q(!1)},I=async()=>{u.value=!0,await q(!0),await new Promise((e=>setTimeout(e,800))),u.value=!1},A=()=>{clearTimeout(B),B=setTimeout((()=>{q(!0)}),500)};let B=null;const L=()=>{e.index.navigateBack({delta:1})},D=async a=>{e.index.vibrateShort({type:"light"}),await q(!0)};return e.onMounted((async()=>{const a=getCurrentPages(),t=a[a.length-1].options||{};t.service_id&&(v.value=t.service_id,console.log("接收到的服务ID:",v.value));const i=e.index.getSystemInfoSync();o.value=i.statusBarHeight;const l=e.index.getMenuButtonBoundingClientRect();l.value=l;const n=i.screenWidth,r=l.right;s.value=n-r+24,await x.fetchServiceLevels(),await p.initCityData(),await q(!0)})),e.onUnmounted((()=>{B&&clearTimeout(B)})),(i,l)=>e.e({a:a._imports_0$3,b:e.o(L),c:e.o((e=>c.value=!0)),d:a._imports_1,e:e.o([e=>r.value=e.detail.value,A]),f:r.value,g:s.value+"px",h:o.value+"px",i:y.value&&!w.value},y.value&&!w.value?{}:b.value.length>0?{k:e.f(b.value,((a,i,l)=>e.e({a:a.avatar,b:a.online},(a.online,{}),{c:e.t(a.name),d:e.t(a.distance),e:e.o((e=>(async e=>{P.value=e;try{const a={city_code:p.currentCityCode,application_id:e.id};d.value&&g.value&&(a.latitude=parseFloat(d.value),a.longitude=parseFloat(g.value));const i=await t.getCityServices(a);if(i.data&&0===i.data.code){const e=i.data.data;e&&e.services&&e.services.length>0?j.value=e.services.map((e=>({title:e.service_name,img:"https://sygx-server-bucket-admin.oss-cn-shanghai.aliyuncs.com"+e.service_image_url||"",tags:e.service_tags||[],price:e.price,service_id:e.service_id,price_template_id:e.price_template_id||"",unit:e.unit,min_quantity:e.min_quantity}))):j.value=[]}else j.value=[]}catch(a){console.error("获取服务信息失败:",a),j.value=[]}k.value.open()})(a)),a.id),f:a.id,g:e.o((t=>(a=>{let t="/subPackages/friend/detail?id="+a+"&city_code="+p.currentCityCode;d.value&&g.value&&(t+="&latitude="+d.value+"&longitude="+g.value),e.index.navigateTo({url:t})})(a.id)),a.id)}))),l:a._imports_2}:w.value&&0===b.value.length?{n:a._imports_3}:{},{j:b.value.length>0,m:w.value&&0===b.value.length,o:e.o($),p:u.value,q:e.o(I),r:e.o(D),s:e.o((e=>c.value=e)),t:e.p({visible:c.value}),v:a._imports_4,w:e.o(T),x:j.value.length>0},j.value.length>0?{y:e.f(j.value,((a,t,i)=>({a:a.img,b:e.t(a.title),c:e.f(a.tags,((a,t,i)=>({a:e.t(a),b:a}))),d:e.t(a.price),e:e.t(a.unit||"小时"),f:e.o((t=>(a=>{console.log("选择服务:",a),T();let t=`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${P.value.id}&level_order=${P.value.level_order||""}&nickname=${P.value.name}`;v.value&&(t+=`&original_service_id=${v.value}`),e.index.navigateTo({url:t})})(a)),a.title),g:a.title})))}:{z:a._imports_3},{A:S.value,B:e.sr(k,"a0a0483c-2",{k:"servicePopup"}),C:e.o(T),D:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})})}},r=e._export_sfc(s,[["__scopeId","data-v-a0a0483c"]]);wx.createPage(r);

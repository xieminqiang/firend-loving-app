"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),a=require("../../api/file.js"),t=require("../../api/order.js");if(!Array){e.resolveComponent("u-rate")()}Math;const n={__name:"evaluate",setup(n){const l=e.ref(""),r=e.ref(""),s=e.ref(""),i=e.ref(5),u=e.ref(""),c=e.ref([]),v=e.ref(!1),d=e.ref(!1),m=e.computed((()=>i.value>0&&u.value.trim().length>0));e.onLoad((e=>{e.orderId&&(l.value=e.orderId),e.serviceName&&(r.value=decodeURIComponent(e.serviceName)),e.serviceImage&&(s.value=decodeURIComponent(e.serviceImage))}));const p=()=>{v.value=!v.value},h=()=>{const o=3-c.value.length;o<=0?e.index.showToast({title:"最多只能上传3张图片",icon:"none"}):e.index.chooseImage({count:o,sizeType:["compressed"],sourceType:["album","camera"],success:async o=>{e.index.showLoading({title:"上传中...",mask:!0});try{const t=o.tempFilePaths.map((async(e,o)=>{try{const t=await f(e);if(!t||!t.extension)throw new Error("无法获取文件信息");const n=await a.uploadFile({filePath:e,name:`evaluate_${Date.now()}_${o}.${t.extension}`}),l=a.getUploadResult(n);if(!l||!l.url)throw new Error("上传结果解析失败");return l.url}catch(t){throw console.error(`第${o+1}张图片上传失败:`,t),t}})),n=await Promise.all(t);c.value.push(...n),e.index.showToast({title:`成功上传${n.length}张图片`,icon:"success"})}catch(t){console.error("图片上传失败:",t),e.index.showToast({title:"图片上传失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},fail:o=>{console.error("选择图片失败:",o),e.index.showToast({title:"选择图片失败",icon:"none"})}})},f=o=>new Promise(((a,t)=>{e.index.getFileInfo({filePath:o,success:e=>{const t=o.split(".").pop().toLowerCase();a({size:e.size,extension:t})},fail:e=>{console.error("获取文件信息失败:",e);const t=o.split(".").pop().toLowerCase()||"jpg";a({size:0,extension:t})}})})),g=async()=>{var o,a;if(m.value&&!d.value){d.value=!0;try{const a={order_id:parseInt(l.value),rating:i.value,comment:u.value.trim(),comment_images:c.value,is_anonymous:v.value?1:0};console.log("提交评价数据:",a);const n=await t.createOrderComment(a);if(!n.data||0!==n.data.code)throw new Error((null==(o=n.data)?void 0:o.msg)||"评价提交失败");e.index.showToast({title:"评价提交成功",icon:"none",duration:2e3}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(n){console.error("提交评价失败:",n),e.index.showToast({title:(null==(a=n.data)?void 0:a.msg)||"提交失败，请重试",icon:"none"})}finally{d.value=!1}}};return(a,t)=>e.e({a:a.$imgBaseUrl+s.value,b:e.t(r.value),c:e.o((e=>i.value=e)),d:e.p({color:"#999999","active-color":"#7363FF","is-fill":!1,size:"20",modelValue:i.value}),e:e.t(i.value),f:u.value,g:e.o((e=>u.value=e.detail.value)),h:e.t(u.value.length),i:e.f(c.value,((o,t,n)=>({a:a.$imgBaseUrl+o,b:e.o((e=>(e=>{c.value.splice(e,1)})(t)),t),c:t,d:e.o((o=>(o=>{e.index.previewImage({urls:c.value,current:o})})(t)),t)}))),j:c.value.length<3},c.value.length<3?{k:o._imports_0$4,l:e.o(h)}:{},{m:v.value?1:"",n:e.o(p),o:d.value},(d.value,{}),{p:!d.value},(d.value,{}),{q:d.value||!m.value?1:"",r:e.o(g)})}},l=e._export_sfc(n,[["__scopeId","data-v-e7dbd64b"]]);wx.createPage(l);

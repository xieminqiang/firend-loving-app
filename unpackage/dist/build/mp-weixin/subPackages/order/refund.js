"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../stores/user.js"),o=require("../../api/order.js"),n={__name:"refund",setup(n){a.useUserStore();const r=e.ref(!1),i=e.ref(!1),s=e.ref(!1),d=e.ref(!0),l=e.ref(1),c=e.ref(20),u=e.ref([]);e.onUnmounted((()=>{e.index.$off("orderStatusChanged"),e.index.$off("orderOrderDeleted")})),e.onMounted((()=>{e.index.$on("orderStatusChanged",y),e.index.$on("orderOrderDeleted",_)})),e.onLoad((e=>{console.log("退款页面加载"),v()}));const v=async()=>{if(!i.value){i.value=!0;try{const e={page:l.value,page_size:c.value},t=await o.getRefundOrderList(e);if(console.log("退款订单响应:",t.data),0!==t.data.code)throw new Error(t.data.msg||"获取退款订单列表失败");{const{list:e,total:a}=t.data.data;1===l.value?u.value=e||[]:u.value.push(...e||[]),d.value=u.value.length<a}}catch(t){console.error("加载退款订单列表失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{i.value=!1}}},g=async()=>{if(!r.value){r.value=!0,l.value=1,d.value=!0;try{await v(),await new Promise((e=>setTimeout(e,800)))}catch(e){console.error("刷新失败:",e)}finally{r.value=!1}}},f=()=>{r.value=!1},h=async()=>{if(!s.value&&d.value){s.value=!0,l.value++;try{await v()}catch(e){console.error("加载更多失败:",e),l.value--}finally{s.value=!1}}},m=e=>({8:"status-refunded",9:"status-refunding"}[e]||"status-default"),x=(e,t=null)=>({8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}]}[e]||[]),w=async t=>{if(console.log(t),t.companion_id)try{e.index.showLoading({title:"获取电话中..."});const a={companion_id:t.companion_id},n=await o.getCompanionPhone(a);if(0!==n.data.code)throw new Error(n.data.msg||"获取友伴师电话失败");{const t=n.data.data.phone;e.index.hideLoading(),e.index.showModal({title:"联系友伴师",content:`是否拨打友伴师的电话？\n${t}`,confirmText:"拨打",cancelText:"取消",success:a=>{a.confirm&&e.index.makePhoneCall({phoneNumber:t})}})}}catch(a){console.error("获取友伴师电话失败:",a),e.index.hideLoading(),e.index.showToast({title:a.message||"获取友伴师电话失败",icon:"none"})}else e.index.showToast({title:"友伴师信息不存在",icon:"none"})},p=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"删除中..."});const a={order_id:t.id},n=await o.deleteOrder(a);if(0!==n.data.code)throw new Error(n.data.msg||"删除订单失败");u.value=u.value.filter((e=>e.id!==t.id)),e.index.showToast({title:"订单已删除",icon:"success"})}catch(n){console.error("删除订单失败:",n),e.index.showToast({title:n.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},y=e=>{console.log("收到订单状态变化事件:",e);const{type:t,orderId:a,status:o}=e;"refund"===t&&$(a,o)},_=e=>{console.log("收到订单删除事件:",e);const{orderId:t}=e;u.value=u.value.filter((e=>e.id!==t))},$=(e,t)=>{const a=u.value.findIndex((t=>t.id===e));-1!==a&&(u.value[a].status=t)},S=e=>{const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return(a,o)=>e.e({a:0===u.value.length&&!i.value},0!==u.value.length||i.value?e.e({c:e.f(u.value,((t,o,n)=>{return{a:e.t(S(t.created_at)),b:e.t((r=t.status,{8:"已退款",9:"退款中"}[r]||"未知状态")),c:e.n(m(t.status)),d:a.$imgBaseUrl+t.service_image_url,e:e.t(t.service_name),f:e.t(t.unit_price),g:e.t(t.unit),h:e.t(t.quantity),i:e.t(t.total_amount),j:e.f(x(t.status,t),((a,o,n)=>e.e({a:e.t(a.text),b:"联系客服"===a.text},"联系客服"===a.text?{c:e.o((()=>{}),o)}:{},{d:o,e:e.n(a.type),f:e.o((e=>((e,t)=>{switch(e){case"contact":w(t);break;case"delete":p(t)}})(a.action,t)),o)}))),k:t.id,l:e.o((a=>{return o=t.id,void e.index.navigateTo({url:`/subPackages/order/detail?orderId=${o}`});var o}),t.id)};var r})),d:d.value&&u.value.length>0},d.value&&u.value.length>0?e.e({e:s.value},(s.value,{})):{}):{b:t._imports_3},{f:r.value,g:e.o(g),h:e.o(f),i:e.o(h)})}},r=e._export_sfc(n,[["__scopeId","data-v-a3a06059"]]);wx.createPage(r);

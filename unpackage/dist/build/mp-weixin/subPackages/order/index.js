"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../stores/user.js"),n=require("../../stores/city.js"),o=require("../../api/order.js"),s={__name:"index",setup(s){a.useUserStore();const i=n.useCityStore(),r=e.ref("all"),l=e.ref(0),c=e.ref(!1),d=e.ref(!1),u=e.ref(!1),v=e.ref(!0),f=e.ref(1),x=e.ref(20),y=e.ref({}),g=e.ref({all:[],pending_payment:[],pending_service:[],in_service:[],completed:[],cancelled:[],refunded:[],refunding:[]});let m=null;e.onUnmounted((()=>{m&&clearTimeout(m),e.index.$off("orderStatusChanged"),e.index.$off("orderOrderDeleted")})),e.onMounted((()=>{e.index.$on("orderStatusChanged",z),e.index.$on("orderOrderDeleted",B)}));const h=e.ref([{label:"全部",value:"all",count:0},{label:"待付款",value:"pending_payment",count:0},{label:"待服务",value:"pending_service",count:0},{label:"进行中",value:"in_service",count:0},{label:"已完成",value:"completed",count:0}]);e.onLoad((e=>{if(console.log("订单页面接收到的参数:",e),e.status){console.log("设置订单状态为:",e.status),r.value=e.status;const t=h.value.findIndex((t=>t.value===e.status));-1!==t&&(l.value=t),f.value=1,v.value=!0,delete y.value[e.status]}else console.log("没有传递状态参数，使用默认状态: all"),r.value="all",l.value=0;console.log("onLoad中加载数据，当前状态:",r.value),_()})),e.watch(r,((e,t)=>{console.log("状态变化:",t,"->",e)}));const p=async e=>{const t=e.detail.current,a=h.value[t].value,n=r.value;l.value=t,r.value=a,m&&clearTimeout(m),n===a||y.value[a]||(m=setTimeout((async()=>{f.value=1,v.value=!0,g.value[a]=[],await _()}),300))},w=e=>g.value[e]||[],_=async()=>{if(!d.value){d.value=!0;try{const e={page:f.value,page_size:x.value,status_group:r.value},t=await o.getOrderList(e);if(console.log("response.data",t.data),0!==t.data.code)throw new Error(t.msg||"获取订单列表失败");{const{list:e,total:a}=t.data.data;1===f.value?(g.value[r.value]=e||[],T(a)):g.value[r.value].push(...e||[]),v.value=g.value[r.value].length<a,y.value[r.value]={list:[...g.value[r.value]],page:f.value,hasMore:v.value}}}catch(t){console.error("加载订单列表失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{d.value=!1}}},T=e=>{const t=h.value.find((e=>e.value===r.value));t&&(t.count=e||0)},b=async()=>{if(!c.value){c.value=!0,f.value=1,v.value=!0,delete y.value[r.value];try{await _(),await new Promise((e=>setTimeout(e,800)))}catch(e){console.error("刷新失败:",e)}finally{c.value=!1}}},k=()=>{c.value=!1},L=async()=>{if(!u.value&&v.value){u.value=!0,f.value++;try{await _()}catch(e){console.error("加载更多失败:",e),f.value--}finally{u.value=!1}}},$=e=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"}[e]||"status-default"),I=e=>1===e?"需付款：":2===e||3===e||4===e||5===e||6===e||11===e?"实付款：":"订单金额：",S=(e,t=null)=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:t&&1===t.is_comment?"查看评价":"去评价",action:t&&1===t.is_comment?"viewComment":"evaluate",type:"primary"},{text:"再次预约",action:"rebook",type:"secondary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]}[e]||[]),M=t=>{e.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"取消中..."});const a={order_id:t.id,cancel_reason:"用户取消"},n=await o.cancelOrder(a);if(0!==n.data.code)throw new Error(n.data.msg||"取消订单失败");e.index.showToast({title:"订单已取消",icon:"success"}),b()}catch(n){console.error("取消订单失败:",n),e.index.showToast({title:n.message||"取消订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},E=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"继续退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"用户申请退款"},n=await o.applyRefund(a);if(0!==n.data.code)throw new Error(n.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),b()}catch(n){console.error("申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},C=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已出发，退款时将扣除来回程车费。",confirmText:"继续退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"部分退款，扣除来回程车费"},n=await o.applyRefundAfterDeparture(a);if(0!==n.data.code)throw new Error(n.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),b()}catch(n){console.error("申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},O=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已到达，退款时将扣除友伴师来回程车费。",confirmText:"申请退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"部分退款，扣除友伴师来回程车费"},n=await o.applyRefundAfterDeparture(a);if(0!==n.data.code)throw new Error(n.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),b()}catch(n){console.error("申请退款失败:",n),e.index.showToast({title:n.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},P=async t=>{try{e.index.showLoading({title:"处理中..."});const a={order_id:t.id,payment_method:1},n=await o.orderParams(a);if(0!==n.data.code)throw new Error(n.data.msg||"获取支付参数失败");e.index.requestPayment({provider:"wxpay",...n.data.data.pay_params,success:t=>{console.log("支付成功",t),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout((()=>{b()}),1500)},fail:t=>{console.error("支付失败",JSON.stringify(t)),e.index.showToast({title:"支付失败",icon:"none"})}})}catch(a){console.error("支付失败:",a),e.index.showToast({title:a.message||"支付失败",icon:"none"})}finally{e.index.hideLoading()}},j=t=>{t.companion_id&&e.index.showModal({title:"联系友伴师",content:"是否拨打友伴师的电话？",confirmText:"拨打",cancelText:"取消",success:t=>{t.confirm&&e.index.makePhoneCall({phoneNumber:"13800138000"})}})},q=t=>{e.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"处理中..."});const a={order_id:t.id},n=await o.startService(a);if(0!==n.data.code)throw new Error(n.data.msg||"开始服务失败");e.index.showToast({title:"服务已开始",icon:"success"}),b()}catch(n){console.error("开始服务失败:",n),e.index.showToast({title:n.message||"开始服务失败",icon:"none"})}finally{e.index.hideLoading()}}})},D=t=>{e.index.navigateTo({url:`/subPackages/order/extend?orderId=${t.id}`})},R=t=>{if(t.companion_id){let a="/subPackages/friend/detail?id="+t.companion_id+"&city_code="+i.currentCityCode;e.index.navigateTo({url:a})}else e.index.showToast({title:"友伴信息不存在",icon:"none"})},U=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate?orderId=${t.id}&serviceName=${encodeURIComponent(t.service_name)}&serviceImage=${encodeURIComponent(t.service_image_url)}`})},N=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate-detail?orderId=${t.id}`})},A=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"删除中..."});const a={order_id:t.id},n=await o.deleteOrder(a);if(0!==n.data.code)throw new Error(n.data.msg||"删除订单失败");g.value[r.value]=g.value[r.value].filter((e=>e.id!==t.id)),e.index.showToast({title:"订单已删除",icon:"success"})}catch(n){console.error("删除订单失败:",n),e.index.showToast({title:n.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},z=e=>{console.log("收到订单状态变化事件:",e);const{type:t,orderId:a,status:n}=e;"cancel"===t&&F(a,n)},B=e=>{console.log("收到订单删除事件:",e);const{orderId:t,status:a}=e;H(t)},F=(e,t)=>{let a=null;Object.keys(g.value).forEach((t=>{const n=g.value[t].findIndex((t=>t.id===e));-1!==n&&(a=g.value[t][n],g.value[t].splice(n,1))})),a&&(a.status=t,7===t?g.value.cancelled.unshift(a):8===t?g.value.refunded.unshift(a):9===t&&g.value.refunding.unshift(a),J())},H=e=>{Object.keys(g.value).forEach((t=>{const a=g.value[t].findIndex((t=>t.id===e));-1!==a&&g.value[t].splice(a,1)})),J()},J=()=>{Object.keys(g.value).forEach((e=>{y.value[e]&&(y.value[e].list=[...g.value[e]])}))},Y=e=>{const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return(a,n)=>({a:e.f(h.value,((t,a,n)=>({a:e.t(t.label),b:a,c:l.value===a?1:"",d:e.o((e=>(async e=>{if(r.value===e)return;r.value=e;const t=h.value.findIndex((t=>t.value===e));if(-1!==t&&(l.value=t),y.value[e])g.value[e]=y.value[e].list,f.value=y.value[e].page,v.value=y.value[e].hasMore;else{f.value=1,v.value=!0,g.value[e]=[];try{await _()}catch(a){console.error("切换状态失败:",a)}}})(t.value)),a)}))),b:e.f(h.value,((n,o,s)=>e.e({a:0===w(n.value).length&&!d.value},0!==w(n.value).length||d.value?e.e({c:e.f(w(n.value),((n,o,s)=>{return e.e({a:e.t(Y(n.created_at)),b:e.t((i=n.status,{1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"}[i]||"未知状态")),c:e.n($(n.status)),d:a.$imgBaseUrl+n.service_image_url,e:e.t(n.service_name),f:e.t(n.unit_price),g:e.t(n.unit),h:e.t(n.quantity),i:e.t(I(n.status)),j:e.t(n.total_amount),k:4===n.status},4===n.status?{l:t._imports_1$1}:{},{m:e.f(S(n.status,n),((t,a,o)=>e.e({a:e.t(t.text),b:"联系客服"===t.text},"联系客服"===t.text?{c:e.o((()=>{}),a)}:{},{d:a,e:e.n(t.type),f:e.o((e=>((e,t)=>{switch(e){case"cancel":M(t);break;case"refund":3===t.status?C(t):4===t.status?O(t):E(t);break;case"pay":P(t);break;case"contact":j(t);break;case"extend":D(t);break;case"rebook":R(t);break;case"review":handleReviewOrder(t);break;case"delete":A(t);break;case"start":q(t);break;case"evaluate":U(t);break;case"viewComment":N(t)}})(t.action,n)),a)}))),n:n.id,o:e.o((t=>{return a=n.id,void e.index.navigateTo({url:`/subPackages/order/detail?orderId=${a}`});var a}),n.id)});var i})),d:v.value&&w(n.value).length>0},v.value&&w(n.value).length>0?e.e({e:u.value},(u.value,{})):{}):{b:t._imports_3},{f:e.o(b,n.value),g:e.o(k,n.value),h:e.o(L,n.value),i:n.value}))),c:c.value,d:l.value,e:e.o(p)})}},i=e._export_sfc(s,[["__scopeId","data-v-58038295"]]);wx.createPage(i);

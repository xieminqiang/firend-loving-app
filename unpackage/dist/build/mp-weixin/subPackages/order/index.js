"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../stores/user.js"),o=require("../../stores/city.js"),n=require("../../api/order.js"),s={__name:"index",setup(s){a.useUserStore();const i=o.useCityStore(),r=e.ref("all"),l=e.ref(0),c=e.ref(!1),d=e.ref(!1),u=e.ref(!1),v=e.ref(!0),f=e.ref(1),x=e.ref(20),y=e.ref({}),g=e.ref({all:[],pending_payment:[],pending_service:[],in_service:[],completed:[],cancelled:[],refunded:[],refunding:[]});let h=null;e.onUnmounted((()=>{h&&clearTimeout(h)}));const p=e.ref([{label:"全部",value:"all",count:0},{label:"待付款",value:"pending_payment",count:0},{label:"待服务",value:"pending_service",count:0},{label:"进行中",value:"in_service",count:0},{label:"已完成",value:"completed",count:0}]);e.onLoad((e=>{if(console.log("订单页面接收到的参数:",e),e.status){console.log("设置订单状态为:",e.status),r.value=e.status;const t=p.value.findIndex((t=>t.value===e.status));-1!==t&&(l.value=t),f.value=1,v.value=!0,delete y.value[e.status]}else console.log("没有传递状态参数，使用默认状态: all"),r.value="all",l.value=0;console.log("onLoad中加载数据，当前状态:",r.value),_()})),e.watch(r,((e,t)=>{console.log("状态变化:",t,"->",e)}));const m=async e=>{const t=e.detail.current,a=p.value[t].value,o=r.value;l.value=t,r.value=a,h&&clearTimeout(h),o===a||y.value[a]||(h=setTimeout((async()=>{f.value=1,v.value=!0,g.value[a]=[],await _()}),300))},w=e=>g.value[e]||[],_=async()=>{if(!d.value){d.value=!0;try{const e={page:f.value,page_size:x.value,status_group:r.value},t=await n.getOrderList(e);if(console.log("response.data",t.data),0!==t.data.code)throw new Error(t.msg||"获取订单列表失败");{const{list:e,total:a}=t.data.data;1===f.value?(g.value[r.value]=e||[],T(a)):g.value[r.value].push(...e||[]),v.value=g.value[r.value].length<a,y.value[r.value]={list:[...g.value[r.value]],page:f.value,hasMore:v.value}}}catch(t){console.error("加载订单列表失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{d.value=!1}}},T=e=>{const t=p.value.find((e=>e.value===r.value));t&&(t.count=e||0)},b=async()=>{if(!c.value){c.value=!0,f.value=1,v.value=!0,delete y.value[r.value];try{await _(),await new Promise((e=>setTimeout(e,800)))}catch(e){console.error("刷新失败:",e)}finally{c.value=!1}}},L=()=>{c.value=!1},k=async()=>{if(!u.value&&v.value){u.value=!0,f.value++;try{await _()}catch(e){console.error("加载更多失败:",e),f.value--}finally{u.value=!1}}},S=e=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"}[e]||"status-default"),M=e=>1===e?"需付款：":2===e||3===e||4===e||5===e||6===e||11===e?"实付款：":"订单金额：",$=e=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"续钟",action:"extend",type:"primary"},{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:"再次预约",action:"rebook",type:"primary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]}[e]||[]),P=t=>{e.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"取消中..."});const a={order_id:t.id,cancel_reason:"用户取消"},o=await n.cancelOrder(a);if(0!==o.data.code)throw new Error(o.data.msg||"取消订单失败");e.index.showToast({title:"订单已取消",icon:"success"}),b()}catch(o){console.error("取消订单失败:",o),e.index.showToast({title:o.message||"取消订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},E=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"继续退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"用户申请退款"},o=await n.applyRefund(a);if(0!==o.data.code)throw new Error(o.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),b()}catch(o){console.error("申请退款失败:",o),e.index.showToast({title:o.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},q=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已出发，退款时将扣除来回程车费。",confirmText:"继续退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"部分退款，扣除来回程车费"},o=await n.applyRefundAfterDeparture(a);if(0!==o.data.code)throw new Error(o.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),b()}catch(o){console.error("申请退款失败:",o),e.index.showToast({title:o.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},j=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已到达，退款时将扣除友伴师来回程车费。",confirmText:"申请退款",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"申请中..."});const a={order_id:t.id,refund_reason:"部分退款，扣除友伴师来回程车费"},o=await n.applyRefundAfterDeparture(a);if(0!==o.data.code)throw new Error(o.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),b()}catch(o){console.error("申请退款失败:",o),e.index.showToast({title:o.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},I=async t=>{try{e.index.showLoading({title:"处理中..."});const a={order_id:t.id,payment_method:1},o=await n.orderParams(a);if(0!==o.data.code)throw new Error(o.data.msg||"获取支付参数失败");e.index.requestPayment({provider:"wxpay",...o.data.data.pay_params,success:t=>{console.log("支付成功",t),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout((()=>{b()}),1500)},fail:t=>{console.error("支付失败",JSON.stringify(t)),e.index.showToast({title:"支付失败",icon:"none"})}})}catch(a){console.error("支付失败:",a),e.index.showToast({title:a.message||"支付失败",icon:"none"})}finally{e.index.hideLoading()}},C=t=>{t.companion_id&&e.index.showModal({title:"联系友伴师",content:"是否拨打友伴师的电话？",confirmText:"拨打",cancelText:"取消",success:t=>{t.confirm&&e.index.makePhoneCall({phoneNumber:"13800138000"})}})},D=t=>{e.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"处理中..."});const a={order_id:t.id},o=await n.startService(a);if(0!==o.data.code)throw new Error(o.data.msg||"开始服务失败");e.index.showToast({title:"服务已开始",icon:"success"}),b()}catch(o){console.error("开始服务失败:",o),e.index.showToast({title:o.message||"开始服务失败",icon:"none"})}finally{e.index.hideLoading()}}})},O=t=>{e.index.navigateTo({url:`/subPackages/order/extend?orderId=${t.id}`})},R=t=>{if(t.companion_id){let a="/subPackages/friend/detail?id="+t.companion_id+"&city_code="+i.currentCityCode;e.index.navigateTo({url:a})}else e.index.showToast({title:"友伴信息不存在",icon:"none"})},U=t=>{e.index.navigateTo({url:`/subPackages/order/review?orderId=${t.id}`})},A=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"删除中..."});const a={order_id:t.id},o=await n.deleteOrder(a);if(0!==o.data.code)throw new Error(o.data.msg||"删除订单失败");g.value[r.value]=g.value[r.value].filter((e=>e.id!==t.id)),e.index.showToast({title:"订单已删除",icon:"success"})}catch(o){console.error("删除订单失败:",o),e.index.showToast({title:o.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},N=e=>{const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return(a,o)=>({a:e.f(p.value,((t,a,o)=>({a:e.t(t.label),b:a,c:l.value===a?1:"",d:e.o((e=>(async e=>{if(r.value===e)return;r.value=e;const t=p.value.findIndex((t=>t.value===e));if(-1!==t&&(l.value=t),y.value[e])g.value[e]=y.value[e].list,f.value=y.value[e].page,v.value=y.value[e].hasMore;else{f.value=1,v.value=!0,g.value[e]=[];try{await _()}catch(a){console.error("切换状态失败:",a)}}})(t.value)),a)}))),b:e.f(p.value,((o,n,s)=>e.e({a:0===w(o.value).length&&!d.value},0!==w(o.value).length||d.value?e.e({c:e.f(w(o.value),((o,n,s)=>{return e.e({a:e.t(N(o.created_at)),b:e.t((i=o.status,{1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"}[i]||"未知状态")),c:e.n(S(o.status)),d:a.$imgBaseUrl+o.service_image_url,e:e.t(o.service_name),f:e.t(o.unit_price),g:e.t(o.unit),h:e.t(o.quantity),i:e.t(M(o.status)),j:e.t(o.total_amount),k:4===o.status},4===o.status?{l:t._imports_1$5}:{},{m:e.f($(o.status),((t,a,n)=>e.e({a:e.t(t.text),b:"联系客服"===t.text},"联系客服"===t.text?{c:e.o((()=>{}),a)}:{},{d:a,e:e.n(t.type),f:e.o((e=>((e,t)=>{switch(e){case"cancel":P(t);break;case"refund":3===t.status?q(t):4===t.status?j(t):E(t);break;case"pay":I(t);break;case"contact":C(t);break;case"extend":O(t);break;case"rebook":R(t);break;case"review":U(t);break;case"delete":A(t);break;case"start":D(t)}})(t.action,o)),a)}))),n:o.id,o:e.o((t=>{return a=o.id,void e.index.navigateTo({url:`/subPackages/order/detail?orderId=${a}`});var a}),o.id)});var i})),d:v.value&&w(o.value).length>0},v.value&&w(o.value).length>0?e.e({e:u.value},(u.value,{})):{}):{b:t._imports_3},{f:e.o(b,o.value),g:e.o(L,o.value),h:e.o(k,o.value),i:o.value}))),c:c.value,d:l.value,e:e.o(m)})}},i=e._export_sfc(s,[["__scopeId","data-v-b80930ca"]]);wx.createPage(i);

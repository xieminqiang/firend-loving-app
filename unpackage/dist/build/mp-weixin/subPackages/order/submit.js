"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),a=require("../../api/order.js"),n=require("../../api/user.js");if(!Array){e.resolveComponent("uni-popup")()}Math;const t={__name:"submit",setup(t){const i=e.ref({}),l=e.ref(""),r=e.ref("taxi"),s=e.ref(1),u=e.ref(0),c=e.ref(0),d=e.ref(""),v=e.ref(!1),m=e.ref([]),_=e.ref(0),p=e.ref(null),f=e.ref(0),g=e.ref(!1),x=e.ref(null),h=e.ref("请选择地址"),w=e.ref(null),y=e.ref({}),b=e.ref({wx_open_id:"",nickname:""}),T=e.computed((()=>{var e,o;const a=((null==(o=null==(e=y.value)?void 0:e.price_info)?void 0:o.unit_price)*s.value||0)+u.value;return Number(a.toFixed(2))})),M=()=>{e.index.chooseLocation({success:async e=>{const o=e.address||e.name||"已选择位置";console.log("手动选择位置",e),h.value=o,w.value={latitude:e.latitude,longitude:e.longitude,address:o},await A(e.latitude,e.longitude)},fail:o=>{o.errMsg&&-1===o.errMsg.indexOf("cancel")&&(e.index.showToast({title:"获取位置失败",icon:"none"}),console.error("获取位置失败:",o.errMsg))}})},N=()=>{0!==m.value.length?(_.value=k(),v.value=!0,e.nextTick$1((()=>{g.value=!1,f.value=0,x.value.open()}))):e.index.showToast({title:"暂无可用时间",icon:"none"})},k=()=>{if(0===m.value.length)return 0;for(let e=0;e<m.value.length;e++){const o=m.value[e];if(((null==o?void 0:o.time_slots)||[]).some((e=>1===e.status)))return e}return 0},q=()=>{var e;return 0===m.value.length?[]:(null==(e=m.value[_.value])?void 0:e.time_slots)||[]},$=()=>{s.value++},j=()=>{var e,o;const a=(null==(o=null==(e=y.value)?void 0:e.price_info)?void 0:o.min_quantity)||1;s.value>a&&s.value--},A=async(o,n)=>{var t,l;try{const r={companion_id:Number(i.value.companion_id),user_latitude:o,user_longitude:n};console.log("计算距离请求参数:",r);const s=await a.calculateDistance(r);if(s.data&&0===s.data.code){const e=s.data.data;console.log("距离计算结果:",e),void 0!==e.distance&&(c.value=e.distance),void 0!==e.transport_fee&&(u.value=Number((2*e.transport_fee).toFixed(2)))}else console.error("计算距离失败:",null==(t=s.data)?void 0:t.msg),e.index.showToast({title:(null==(l=s.data)?void 0:l.msg)||"计算距离失败",icon:"none"})}catch(r){console.error("计算距离接口调用失败:",r),e.index.showToast({title:"计算距离失败，请重试",icon:"none"})}},I=async()=>{var o,t;if("请选择地址"===h.value)return void e.index.showToast({title:"请先选择服务地址",icon:"none"});if(!l.value)return void e.index.showToast({title:"请先选择服务时间",icon:"none"});if(!1===await(async()=>{const o=["vrMAJmeAOA0j3yRGX6AjNEJxqaJ2mvERTFlV89fK3GA","zovIGlvjM10gOUEZjOB-lOQwISsM0PLqfMtIJPbWf4Y"];try{console.log("开始请求订阅消息权限");const a=await new Promise(((a,n)=>{e.index.requestSubscribeMessage({tmplIds:o,success:e=>{console.log("订阅消息请求结果:",e),a(e)},fail:e=>{console.error("订阅消息请求失败:",e),n(e)}})}));let n=0,t=0,i=!0;return o.forEach((e=>{"accept"===a[e]?n++:"reject"===a[e]?(t++,i=!1):i=!1})),n>0&&(console.log("用户同意订阅消息"),e.index.showToast({title:"已开启订单提醒",icon:"success"})),t>0?(console.log("用户拒绝订阅消息"),new Promise((a=>{e.index.showModal({title:"订单提醒权限",content:"为了您能及时接收订单状态通知，是否去设置页面重新授权？",confirmText:"去设置",cancelText:"暂不开启",success:n=>{n.confirm?e.index.openSetting({success:n=>{n.authSetting["scope.subscribeMessage"]?e.index.requestSubscribeMessage({tmplIds:o,success:n=>{console.log("重新授权成功:",n);let t=0,i=!0;o.forEach((e=>{"accept"===n[e]?t++:i=!1})),t>0&&e.index.showToast({title:"已开启订单提醒",icon:"success"}),a(i)},fail:e=>{console.log("重新授权失败:",e),a(!1)}}):(e.index.showToast({title:"未开启订单提醒",icon:"none"}),a(!1))},fail:e=>{console.error("打开设置页面失败:",e),a(!1)}}):(e.index.showToast({title:"未开启订单提醒",icon:"none"}),a(!1))}})}))):0===n&&0===t?(console.log("用户未明确选择订阅消息"),e.index.showToast({title:"未开启订单提醒",icon:"none"}),!1):i}catch(a){return console.error("订阅消息请求异常:",a),e.index.showToast({title:"订阅消息请求失败",icon:"none"}),!1}})())return void e.index.showModal({title:"提示",content:"为了确保您能及时接收订单状态通知，请先开启订阅消息权限后再提交订单",showCancel:!1,confirmText:"我知道了"});const r=l.value.match(/(\d{4}-\d{2}-\d{2})\s+(.+)/);if(!r)return void e.index.showToast({title:"服务时间格式错误",icon:"none"});const u=r[1],c=r[2],v={companion_id:Number(i.value.companion_id),service_id:Number(i.value.service_id),level_order:Number(i.value.level_order),price_template_id:Number(i.value.price_template_id),quantity:s.value,service_address:h.value,service_date:u,service_time:c,remark:d.value,user_latitude:null==(o=w.value)?void 0:o.latitude,user_longitude:null==(t=w.value)?void 0:t.longitude};console.log("提交订单数据:",v),e.index.showLoading({title:"提交中..."});try{const o=await a.createOrderV2(v);if(0!==o.data.code)throw new Error(o.data.msg||"创建订单失败");console.log("订单创建成功:",o.data);try{const t={order_id:o.data.data.order_id,payment_method:1},l=await a.orderParams(t);if(0!==l.data.code)throw new Error(l.data.msg||"获取支付参数失败");e.index.requestPayment({provider:"wxpay",...l.data.data.pay_params,success:async a=>{var t,r;console.log("支付成功",a),e.index.showToast({title:"支付成功",icon:"success"});try{if(!b.value.wx_open_id)return void console.warn("友伴师微信openid为空，跳过订阅消息发送");const e={to_user:b.value.wx_open_id,template_id:"vrMAJmeAOA0j3yRGX6AjNCOvfgzlJp8T1wWLucyCwKc",page:`subPackages/partner/order/detail?orderId=${o.data.data.order_id}&companion_id=${i.value.companion_id}`,data:{phrase4:{value:"待接单"},thing3:{value:(null==(r=null==(t=y.value)?void 0:t.service)?void 0:r.name)||"服务"},character_string10:{value:u+" "+c},character_string1:{value:l.data.data.order_no},thing15:{value:h.value}}};await n.sendSubscribeMessage(e),console.log("订阅消息发送成功，发送给友伴师:",b.value.nickname)}catch(s){console.error("发送订阅消息失败:",s)}setTimeout((()=>{e.index.navigateBack()}),1500)},fail:o=>{console.error("支付失败",JSON.stringify(o)),e.index.showToast({title:"支付失败",icon:"none"})}})}catch(m){console.error("获取支付参数失败:",m),e.index.showToast({title:m.message||"获取支付参数失败",icon:"none"})}}catch(m){console.error("提交订单失败:",m),e.index.showToast({title:m.message||"提交订单失败",icon:"none"})}finally{e.index.hideLoading()}};return e.onMounted((()=>{const o=getCurrentPages(),t=o[o.length-1];i.value=t.options||{},console.log("订单提交页面参数:",i.value),(async()=>{var o;try{const{service_id:e,level_order:n,companion_id:t,price_template_id:l}=i.value;if(!(e&&n&&t&&l))return void console.warn("缺少必要的参数");const r=await a.getServiceInfo({service_id:Number(e),level_order:Number(n),companion_id:Number(t),price_template_id:Number(l)});if(console.log("response.data",r.data),0!==r.data.code)throw new Error(r.data.msg||"获取服务信息失败");{const e=r.data.data;y.value=e;const a=(null==(o=null==e?void 0:e.price_info)?void 0:o.min_quantity)||1;s.value=a}}catch(n){console.error("加载服务信息失败:",n),e.index.showToast({title:n.message||"加载服务信息失败",icon:"none"})}})(),(async()=>{var e;try{const{companion_id:o}=i.value;if(!o)return void console.warn("缺少友伴师ID参数");const a=await n.getCompanionWxOpenId({companion_id:Number(o)});if(console.log("友伴师微信信息:",a.data),a.data&&0===a.data.code){const e=a.data.data;b.value={wx_open_id:e.wx_open_id||"",nickname:e.nickname||""},console.log("友伴师微信openid:",e.wx_open_id)}else console.error("获取友伴师微信信息失败:",null==(e=a.data)?void 0:e.message)}catch(o){console.error("获取友伴师微信信息失败:",o)}})(),i.value.companion_id&&a.getCompanionAvailableSchedule(Number(i.value.companion_id)).then((e=>{console.log("友伴师可用时间安排:",e),e.data&&0===e.data.code&&(m.value=e.data.data.schedule||[],m.value.length>0&&(_.value=k()))})).catch((e=>{console.error("获取友伴师可用时间安排失败:",e)}))})),(a,n)=>{var t,w,b,k,A,P,O,E,S,C,J,F;return e.e({a:o._imports_0$12,b:e.t(h.value),c:"请选择地址"!==h.value?1:"",d:o._imports_0$13,e:e.o(M),f:e.t(l.value),g:o._imports_0$13,h:e.o(N),i:"taxi"===r.value},(r.value,{}),{j:"taxi"===r.value?1:"",k:e.o((e=>{return o="taxi",void(r.value=o);var o})),l:null==(t=y.value)?void 0:t.service},(null==(w=y.value)?void 0:w.service)?{m:a.$imgBaseUrl+(null==(k=null==(b=y.value)?void 0:b.service)?void 0:k.image_url),n:e.t(null==(P=null==(A=y.value)?void 0:A.service)?void 0:P.name),o:e.t(null==(E=null==(O=y.value)?void 0:O.price_info)?void 0:E.unit_price),p:e.t(null==(C=null==(S=y.value)?void 0:S.price_info)?void 0:C.unit),q:e.t(i.value.nickname),r:o._imports_2$3,s:s.value<=((null==(F=null==(J=y.value)?void 0:J.price_info)?void 0:F.min_quantity)||1)?1:"",t:e.o(j),v:e.t(s.value),w:o._imports_3$4,x:e.o($)}:{},{y:e.t(u.value.toFixed(2)),z:e.t(c.value),A:d.value,B:e.o((e=>d.value=e.detail.value)),C:e.t(T.value.toFixed(2)),D:e.o(I),E:e.f(m.value,((o,a,n)=>({a:e.t(o.day_name),b:e.t(o.date),c:a,d:_.value===a?1:"",e:e.o((o=>(o=>{_.value=o,p.value=null,g.value=!0,e.nextTick$1((()=>{const a=e.index.upx2px(140),n=e.index.getWindowInfo().windowWidth-e.index.upx2px(40),t=Math.floor(n/a*.8);if(o>2){const e=Math.max(0,o*a-t*a/3);f.value=e}else f.value=0;setTimeout((()=>{g.value=!1}),300)}))})(a)),a)}))),F:f.value,G:g.value,H:e.f(q(),((o,a,n)=>({a:e.t(o.time),b:a,c:1===o.status?1:"",d:2===o.status?1:"",e:p.value===o?1:"",f:e.o((e=>(e=>{if(1!==e.status)return;p.value=e;const o=m.value[_.value];l.value=`${o.day_name} ${o.date} ${e.time}`,x.value.close(),v.value=!1})(o)),a)}))),I:e.sr(x,"2effa122-0",{k:"timePickerPopup"}),J:e.o((e=>v.value=!1)),K:e.p({type:"bottom","mask-click":!0,round:"20"})})}}},i=e._export_sfc(t,[["__scopeId","data-v-2effa122"]]);wx.createPage(i);

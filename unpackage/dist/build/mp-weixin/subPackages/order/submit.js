"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),a=require("../../api/order.js");if(!Array){e.resolveComponent("uni-popup")()}Math;const t={__name:"submit",setup(t){const n=e.ref({}),l=e.ref(""),i=e.ref("taxi"),s=e.ref(1),r=e.ref(0),u=e.ref(0),c=e.ref(""),d=e.ref(!1),v=e.ref([]),m=e.ref(0),_=e.ref(null),p=e.ref(0),f=e.ref(!1),g=e.ref(null),x=e.ref("请选择地址"),h=e.ref(null),w=e.ref({}),y=e.computed((()=>{var e,o;const a=((null==(o=null==(e=w.value)?void 0:e.price_info)?void 0:o.unit_price)*s.value||0)+r.value;return Number(a.toFixed(2))})),b=()=>{e.index.chooseLocation({success:async e=>{const o=e.address||e.name||"已选择位置";console.log("手动选择位置",e),x.value=o,h.value={latitude:e.latitude,longitude:e.longitude,address:o},await k(e.latitude,e.longitude)},fail:o=>{o.errMsg&&-1===o.errMsg.indexOf("cancel")&&(e.index.showToast({title:"获取位置失败",icon:"none"}),console.error("获取位置失败:",o.errMsg))}})},T=()=>{0!==v.value.length?(m.value=M(),d.value=!0,e.nextTick$1((()=>{f.value=!1,p.value=0,g.value.open()}))):e.index.showToast({title:"暂无可用时间",icon:"none"})},M=()=>{if(0===v.value.length)return 0;for(let e=0;e<v.value.length;e++){const o=v.value[e];if(((null==o?void 0:o.time_slots)||[]).some((e=>1===e.status)))return e}return 0},N=()=>{var e;return 0===v.value.length?[]:(null==(e=v.value[m.value])?void 0:e.time_slots)||[]},q=()=>{s.value++},$=()=>{var e,o;const a=(null==(o=null==(e=w.value)?void 0:e.price_info)?void 0:o.min_quantity)||1;s.value>a&&s.value--},k=async(o,t)=>{var l,i;try{const s={companion_id:Number(n.value.companion_id),user_latitude:o,user_longitude:t};console.log("计算距离请求参数:",s);const c=await a.calculateDistance(s);if(c.data&&0===c.data.code){const e=c.data.data;console.log("距离计算结果:",e),void 0!==e.distance&&(u.value=e.distance),void 0!==e.transport_fee&&(r.value=Number((2*e.transport_fee).toFixed(2)))}else console.error("计算距离失败:",null==(l=c.data)?void 0:l.msg),e.index.showToast({title:(null==(i=c.data)?void 0:i.msg)||"计算距离失败",icon:"none"})}catch(s){console.error("计算距离接口调用失败:",s),e.index.showToast({title:"计算距离失败，请重试",icon:"none"})}},P=async()=>{var o,t;if("请选择地址"===x.value)return void e.index.showToast({title:"请先选择服务地址",icon:"none"});if(!l.value)return void e.index.showToast({title:"请先选择服务时间",icon:"none"});await(async()=>{const o=["zovIGlvjM10gOUEZjOB-lOQwISsM0PLqfMtIJPbWf4Y","vrMAJmeAOA0j3yRGX6AjNEJxqaJ2mvERTFlV89fK3GA"];try{console.log("开始请求订阅消息权限");const a=await new Promise(((a,t)=>{e.index.requestSubscribeMessage({tmplIds:o,success:e=>{console.log("订阅消息请求结果:",e),a(e)},fail:e=>{console.error("订阅消息请求失败:",e),t(e)}})}));let t=0,n=0,l=!0;return o.forEach((e=>{"accept"===a[e]?t++:"reject"===a[e]?(n++,l=!1):l=!1})),t>0&&(console.log("用户同意订阅消息"),e.index.showToast({title:"已开启订单提醒",icon:"success"})),n>0?(console.log("用户拒绝订阅消息"),new Promise((a=>{e.index.showModal({title:"订单提醒权限",content:"为了您能及时接收订单状态通知，是否去设置页面重新授权？",confirmText:"去设置",cancelText:"暂不开启",success:t=>{t.confirm?e.index.openSetting({success:t=>{t.authSetting["scope.subscribeMessage"]?e.index.requestSubscribeMessage({tmplIds:o,success:t=>{console.log("重新授权成功:",t);let n=0,l=!0;o.forEach((e=>{"accept"===t[e]?n++:l=!1})),n>0&&e.index.showToast({title:"已开启订单提醒",icon:"success"}),a(l)},fail:e=>{console.log("重新授权失败:",e),a(!1)}}):(e.index.showToast({title:"未开启订单提醒",icon:"none"}),a(!1))},fail:e=>{console.error("打开设置页面失败:",e),a(!1)}}):(e.index.showToast({title:"未开启订单提醒",icon:"none"}),a(!1))}})}))):0===t&&0===n?(console.log("用户未明确选择订阅消息"),e.index.showToast({title:"未开启订单提醒",icon:"none"}),!1):l}catch(a){return console.error("订阅消息请求异常:",a),e.index.showToast({title:"订阅消息请求失败",icon:"none"}),!1}})();const i=l.value.match(/(\d{4}-\d{2}-\d{2})\s+(.+)/);if(!i)return void e.index.showToast({title:"服务时间格式错误",icon:"none"});const r=i[1],u=i[2],d={companion_id:Number(n.value.companion_id),service_id:Number(n.value.service_id),level_order:Number(n.value.level_order),price_template_id:Number(n.value.price_template_id),quantity:s.value,service_address:x.value,service_date:r,service_time:u,remark:c.value,user_latitude:null==(o=h.value)?void 0:o.latitude,user_longitude:null==(t=h.value)?void 0:t.longitude};console.log("提交订单数据:",d),e.index.showLoading({title:"提交中..."});try{const o=await a.createOrderV2(d);if(0!==o.data.code)throw new Error(o.data.msg||"创建订单失败");console.log("订单创建成功:",o.data);try{const t={order_id:o.data.data.order_id,payment_method:1},n=await a.orderParams(t);if(0!==n.data.code)throw new Error(n.data.msg||"获取支付参数失败");e.index.requestPayment({provider:"wxpay",...n.data.data.pay_params,success:async o=>{console.log("支付成功",o),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)},fail:o=>{console.error("支付失败",JSON.stringify(o)),e.index.showToast({title:"支付失败",icon:"none"})}})}catch(v){console.error("获取支付参数失败:",v),e.index.showToast({title:v.message||"获取支付参数失败",icon:"none"})}}catch(v){console.error("提交订单失败:",v),e.index.showToast({title:v.message||"提交订单失败",icon:"none"})}finally{e.index.hideLoading()}};return e.onMounted((()=>{const o=getCurrentPages(),t=o[o.length-1];n.value=t.options||{},console.log("订单提交页面参数:",n.value),(async()=>{var o;try{const{service_id:e,level_order:t,companion_id:l,price_template_id:i}=n.value;if(!(e&&t&&l&&i))return void console.warn("缺少必要的参数");const r=await a.getServiceInfo({service_id:Number(e),level_order:Number(t),companion_id:Number(l),price_template_id:Number(i)});if(console.log("response.data",r.data),0!==r.data.code)throw new Error(r.data.msg||"获取服务信息失败");{const e=r.data.data;w.value=e;const a=(null==(o=null==e?void 0:e.price_info)?void 0:o.min_quantity)||1;s.value=a}}catch(t){console.error("加载服务信息失败:",t),e.index.showToast({title:t.message||"加载服务信息失败",icon:"none"})}})(),n.value.companion_id&&a.getCompanionAvailableSchedule(Number(n.value.companion_id)).then((e=>{console.log("友伴师可用时间安排:",e),e.data&&0===e.data.code&&(v.value=e.data.data.schedule||[],v.value.length>0&&(m.value=M()))})).catch((e=>{console.error("获取友伴师可用时间安排失败:",e)}))})),(a,t)=>{var h,M,k,j,E,I,A,S,O,F,J,B;return e.e({a:o._imports_0$11,b:e.t(x.value),c:"请选择地址"!==x.value?1:"",d:o._imports_0$12,e:e.o(b),f:e.t(l.value),g:o._imports_0$12,h:e.o(T),i:"taxi"===i.value},(i.value,{}),{j:"taxi"===i.value?1:"",k:e.o((e=>{return o="taxi",void(i.value=o);var o})),l:null==(h=w.value)?void 0:h.service},(null==(M=w.value)?void 0:M.service)?{m:a.$imgBaseUrl+(null==(j=null==(k=w.value)?void 0:k.service)?void 0:j.image_url),n:e.t(null==(I=null==(E=w.value)?void 0:E.service)?void 0:I.name),o:e.t(null==(S=null==(A=w.value)?void 0:A.price_info)?void 0:S.unit_price),p:e.t(null==(F=null==(O=w.value)?void 0:O.price_info)?void 0:F.unit),q:e.t(n.value.nickname),r:o._imports_2$3,s:s.value<=((null==(B=null==(J=w.value)?void 0:J.price_info)?void 0:B.min_quantity)||1)?1:"",t:e.o($),v:e.t(s.value),w:o._imports_3$4,x:e.o(q)}:{},{y:e.t(r.value.toFixed(2)),z:e.t(u.value),A:c.value,B:e.o((e=>c.value=e.detail.value)),C:e.t(y.value.toFixed(2)),D:e.o(P),E:e.f(v.value,((o,a,t)=>({a:e.t(o.day_name),b:e.t(o.date),c:a,d:m.value===a?1:"",e:e.o((o=>(o=>{m.value=o,_.value=null,f.value=!0,e.nextTick$1((()=>{const a=e.index.upx2px(140),t=e.index.getWindowInfo().windowWidth-e.index.upx2px(40),n=Math.floor(t/a*.8);if(o>2){const e=Math.max(0,o*a-n*a/3);p.value=e}else p.value=0;setTimeout((()=>{f.value=!1}),300)}))})(a)),a)}))),F:p.value,G:f.value,H:e.f(N(),((o,a,t)=>({a:e.t(o.time),b:a,c:1===o.status?1:"",d:2===o.status?1:"",e:_.value===o?1:"",f:e.o((e=>(e=>{if(1!==e.status)return;_.value=e;const o=v.value[m.value];l.value=`${o.day_name} ${o.date} ${e.time}`,g.value.close(),d.value=!1})(o)),a)}))),I:e.sr(g,"aa907ac1-0",{k:"timePickerPopup"}),J:e.o((e=>d.value=!1)),K:e.p({type:"bottom","mask-click":!0,round:"20"})})}}},n=e._export_sfc(t,[["__scopeId","data-v-aa907ac1"]]);wx.createPage(n);

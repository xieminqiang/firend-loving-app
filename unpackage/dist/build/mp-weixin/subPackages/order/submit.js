"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),o=require("../../api/order.js");if(!Array){e.resolveComponent("uni-popup")()}Math;const t={__name:"submit",setup(t){const l=e.ref({}),n=e.ref(""),i=e.ref("taxi"),r=e.ref(1),u=e.ref(0),s=e.ref(0),d=e.ref(""),v=e.ref(!1),c=e.ref([]),m=e.ref(0),_=e.ref(null),p=e.ref(0),f=e.ref(!1),g=e.ref(null),x=e.ref("请选择地址"),h=e.ref(null),w=e.ref({}),y=e.computed((()=>{var e,a;const o=((null==(a=null==(e=w.value)?void 0:e.price_info)?void 0:a.unit_price)*r.value||0)+u.value;return Number(o.toFixed(2))})),b=()=>{e.index.chooseLocation({success:async e=>{const a=e.address||e.name||"已选择位置";console.log("手动选择位置",e),x.value=a,h.value={latitude:e.latitude,longitude:e.longitude,address:a},await M(e.latitude,e.longitude)},fail:a=>{a.errMsg&&-1===a.errMsg.indexOf("cancel")&&(e.index.showToast({title:"获取位置失败",icon:"none"}),console.error("获取位置失败:",a.errMsg))}})},T=()=>{0!==c.value.length?(m.value=N(),v.value=!0,e.nextTick$1((()=>{f.value=!1,p.value=0,g.value.open()}))):e.index.showToast({title:"暂无可用时间",icon:"none"})},N=()=>{if(0===c.value.length)return 0;for(let e=0;e<c.value.length;e++){const a=c.value[e];if(((null==a?void 0:a.time_slots)||[]).some((e=>1===e.status)))return e}return 0},$=()=>{var e;return 0===c.value.length?[]:(null==(e=c.value[m.value])?void 0:e.time_slots)||[]},k=()=>{r.value++},q=()=>{var e,a;const o=(null==(a=null==(e=w.value)?void 0:e.price_info)?void 0:a.min_quantity)||1;r.value>o&&r.value--},M=async(a,t)=>{var n,i;try{const r={companion_id:Number(l.value.companion_id),user_latitude:a,user_longitude:t};console.log("计算距离请求参数:",r);const d=await o.calculateDistance(r);if(d.data&&0===d.data.code){const e=d.data.data;console.log("距离计算结果:",e),void 0!==e.distance&&(s.value=e.distance),void 0!==e.transport_fee&&(u.value=Number((2*e.transport_fee).toFixed(2)))}else console.error("计算距离失败:",null==(n=d.data)?void 0:n.msg),e.index.showToast({title:(null==(i=d.data)?void 0:i.msg)||"计算距离失败",icon:"none"})}catch(r){console.error("计算距离接口调用失败:",r),e.index.showToast({title:"计算距离失败，请重试",icon:"none"})}},P=async()=>{var a,t;if("请选择地址"===x.value)return void e.index.showToast({title:"请先选择服务地址",icon:"none"});if(!n.value)return void e.index.showToast({title:"请先选择服务时间",icon:"none"});const i=n.value.match(/(\d{4}-\d{2}-\d{2})\s+(.+)/);if(!i)return void e.index.showToast({title:"服务时间格式错误",icon:"none"});const u=i[1],s=i[2],v={companion_id:Number(l.value.companion_id),service_id:Number(l.value.service_id),level_order:Number(l.value.level_order),price_template_id:Number(l.value.price_template_id),quantity:r.value,service_address:x.value,service_date:u,service_time:s,remark:d.value,user_latitude:null==(a=h.value)?void 0:a.latitude,user_longitude:null==(t=h.value)?void 0:t.longitude};console.log("提交订单数据:",v),e.index.showLoading({title:"提交中..."});try{const a=await o.createOrderV2(v);if(0!==a.data.code)throw new Error(a.data.msg||"创建订单失败");console.log("订单创建成功:",a.data);try{const t={order_id:a.data.data.order_id,payment_method:1},l=await o.orderParams(t);if(0!==l.data.code)throw new Error(l.data.msg||"获取支付参数失败");e.index.requestPayment({provider:"wxpay",...l.data.data.pay_params,success:a=>{console.log("支付成功",a),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout((()=>{e.index.navigateTo({url:"/subPackages/order/index?refresh=true"})}),1500)},fail:a=>{console.error("支付失败",JSON.stringify(a)),e.index.showToast({title:"支付失败",icon:"none"})}})}catch(c){console.error("获取支付参数失败:",c),e.index.showToast({title:c.message||"获取支付参数失败",icon:"none"})}}catch(c){console.error("提交订单失败:",c),e.index.showToast({title:c.message||"提交订单失败",icon:"none"})}finally{e.index.hideLoading()}};return e.onMounted((()=>{const a=getCurrentPages(),t=a[a.length-1];l.value=t.options||{},console.log("订单提交页面参数:",l.value),(async()=>{var a;try{const{service_id:e,level_order:t,companion_id:n,price_template_id:i}=l.value;if(!(e&&t&&n&&i))return void console.warn("缺少必要的参数");const u=await o.getServiceInfo({service_id:Number(e),level_order:Number(t),companion_id:Number(n),price_template_id:Number(i)});if(console.log("response.data",u.data),0!==u.data.code)throw new Error(u.data.msg||"获取服务信息失败");{const e=u.data.data;w.value=e;const o=(null==(a=null==e?void 0:e.price_info)?void 0:a.min_quantity)||1;r.value=o}}catch(t){console.error("加载服务信息失败:",t),e.index.showToast({title:t.message||"加载服务信息失败",icon:"none"})}})(),l.value.companion_id&&o.getCompanionAvailableSchedule(Number(l.value.companion_id)).then((e=>{console.log("友伴师可用时间安排:",e),e.data&&0===e.data.code&&(c.value=e.data.data.schedule||[],c.value.length>0&&(m.value=N()))})).catch((e=>{console.error("获取友伴师可用时间安排失败:",e)}))})),(o,t)=>{var h,N,M,F,j,C,E,I,A,L,O,S;return e.e({a:a._imports_0$10,b:e.t(x.value),c:"请选择地址"!==x.value?1:"",d:a._imports_0$11,e:e.o(b),f:e.t(n.value),g:a._imports_0$11,h:e.o(T),i:"taxi"===i.value},(i.value,{}),{j:"taxi"===i.value?1:"",k:e.o((e=>{return a="taxi",void(i.value=a);var a})),l:null==(h=w.value)?void 0:h.service},(null==(N=w.value)?void 0:N.service)?{m:o.$imgBaseUrl+(null==(F=null==(M=w.value)?void 0:M.service)?void 0:F.image_url),n:e.t(null==(C=null==(j=w.value)?void 0:j.service)?void 0:C.name),o:e.t(null==(I=null==(E=w.value)?void 0:E.price_info)?void 0:I.unit_price),p:e.t(null==(L=null==(A=w.value)?void 0:A.price_info)?void 0:L.unit),q:e.t(l.value.nickname),r:a._imports_2$1,s:r.value<=((null==(S=null==(O=w.value)?void 0:O.price_info)?void 0:S.min_quantity)||1)?1:"",t:e.o(q),v:e.t(r.value),w:a._imports_3$3,x:e.o(k)}:{},{y:e.t(u.value.toFixed(2)),z:e.t(s.value),A:d.value,B:e.o((e=>d.value=e.detail.value)),C:e.t(y.value.toFixed(2)),D:e.o(P),E:e.f(c.value,((a,o,t)=>({a:e.t(a.day_name),b:e.t(a.date),c:o,d:m.value===o?1:"",e:e.o((a=>(a=>{m.value=a,_.value=null,f.value=!0,e.nextTick$1((()=>{const o=e.index.upx2px(140),t=e.index.getWindowInfo().windowWidth-e.index.upx2px(40),l=Math.floor(t/o*.8);if(a>2){const e=Math.max(0,a*o-l*o/3);p.value=e}else p.value=0;setTimeout((()=>{f.value=!1}),300)}))})(o)),o)}))),F:p.value,G:f.value,H:e.f($(),((a,o,t)=>({a:e.t(a.time),b:o,c:1===a.status?1:"",d:2===a.status?1:"",e:_.value===a?1:"",f:e.o((e=>(e=>{if(1!==e.status)return;_.value=e;const a=c.value[m.value];n.value=`${a.day_name} ${a.date} ${e.time}`,g.value.close(),v.value=!1})(a)),o)}))),I:e.sr(g,"e8537061-0",{k:"timePickerPopup"}),J:e.o((e=>v.value=!1)),K:e.p({type:"bottom","mask-click":!0,round:"20"})})}}},l=e._export_sfc(t,[["__scopeId","data-v-e8537061"]]);wx.createPage(l);

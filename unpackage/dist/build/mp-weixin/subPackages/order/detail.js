"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../api/order.js"),n=require("../../stores/city.js"),o=require("../../stores/user.js"),s={__name:"detail",setup(s){const i=o.useUserStore(),r=e.ref({}),d=e.ref(null),c=n.useCityStore(),l=e.ref([{title:"友伴接单",icon:"✓",status:"pending"},{title:"友伴出发",icon:"✓",status:"pending"},{title:"友伴到达",icon:"✓",status:"pending"},{title:"开始服务",icon:"✓",status:"pending"},{title:"服务完成",icon:"✓",status:"pending"}]);e.onLoad((t=>{if(!i.userInfo||0===Object.keys(i.userInfo).length||!i.token)return e.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{e.index.navigateTo({url:"/subPackages/login/index"})}),1500);t.orderId&&(d.value=t.orderId,u())}));const u=async()=>{try{e.index.showLoading({title:"加载中..."});const t=await a.getOrderDetail({order_id:Number(d.value)});if(console.log(t.data),0!==t.data.code)throw new Error(t.data.msg||"获取订单详情失败");r.value={...t.data.data.order,logs:t.data.data.logs||[]},m()}catch(t){console.error("加载订单详情失败:",t),e.index.showToast({title:t.message||"加载失败",icon:"none"})}finally{e.index.hideLoading()}},m=()=>{const e=r.value.logs||[];l.value.forEach((e=>{e.status="pending"}));e.find((e=>11===e.status))&&(l.value[0].status="completed");e.find((e=>3===e.status))&&(l.value[1].status="completed");e.find((e=>4===e.status))&&(l.value[2].status="completed");e.find((e=>5===e.status))&&(l.value[3].status="completed");e.find((e=>6===e.status))&&(l.value[4].status="completed")},x=e=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"}[e]||"status-default"),g=e=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:1===r.value.is_comment?"查看评价":"去评价",action:1===r.value.is_comment?"viewComment":"evaluate",type:"primary"},{text:"再次预约",action:"rebook",type:"secondary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]}[e]||[]),p=t=>{e.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"取消中..."});const n={order_id:t.id,cancel_reason:"用户取消"},o=await a.cancelOrder(n);if(0!==o.data.code)throw new Error(o.data.msg||"取消订单失败");e.index.showToast({title:"订单已取消",icon:"success"}),e.index.$emit("orderStatusChanged",{type:"cancel",orderId:t.id,status:7}),setTimeout((()=>{u()}),1500)}catch(o){console.error("取消订单失败:",o),e.index.showToast({title:o.message||"取消订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},v=e=>{3===e.status?f(e):4===e.status?h(e):y(e)},y=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"继续退款",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"用户申请退款"},o=await a.applyRefund(n);if(0!==o.data.code)throw new Error(o.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),setTimeout((()=>{u()}),1500)}catch(o){console.error("申请退款失败:",o),e.index.showToast({title:o.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},f=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已出发，退款时将扣除来回程车费。",confirmText:"继续退款",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"部分退款，扣除来回程车费"},o=await a.applyRefundAfterDeparture(n);if(0!==o.data.code)throw new Error(o.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),setTimeout((()=>{u()}),1500)}catch(o){console.error("申请退款失败:",o),e.index.showToast({title:o.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},h=t=>{e.index.showModal({title:"申请退款",content:"确定要申请退款吗？由于对方已到达，退款时将扣除友伴师来回程车费。",confirmText:"申请退款",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"申请中..."});const n={order_id:t.id,refund_reason:"部分退款，扣除友伴师来回程车费"},o=await a.applyRefundAfterDeparture(n);if(0!==o.data.code)throw new Error(o.data.msg||"申请退款失败");e.index.showToast({title:"退款申请已提交",icon:"success"}),setTimeout((()=>{u()}),1500)}catch(o){console.error("申请退款失败:",o),e.index.showToast({title:o.message||"申请退款失败",icon:"none"})}finally{e.index.hideLoading()}}})},w=async t=>{try{e.index.showLoading({title:"处理中..."});const n={order_id:t.id,payment_method:1},o=await a.orderParams(n);if(0!==o.data.code)throw new Error(o.data.msg||"获取支付参数失败");e.index.requestPayment({provider:"wxpay",...o.data.data.pay_params,success:t=>{console.log("支付成功",t),e.index.showToast({title:"支付成功",icon:"success"}),setTimeout((()=>{u()}),1500)},fail:t=>{console.error("支付失败",JSON.stringify(t)),e.index.showToast({title:"支付失败",icon:"none"})}})}catch(n){console.error("支付失败:",n),e.index.showToast({title:n.message||"支付失败",icon:"none"})}finally{e.index.hideLoading()}},_=t=>{e.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"处理中..."});const n={order_id:t.id},o=await a.startService(n);if(0!==o.data.code)throw new Error(o.data.msg||"开始服务失败");e.index.showToast({title:"服务已开始",icon:"success"}),e.index.$emit("orderStatusChanged",{type:"start",orderId:t.id,status:5}),setTimeout((()=>{u()}),1500)}catch(o){console.error("开始服务失败:",o),e.index.showToast({title:o.message||"开始服务失败",icon:"none"})}finally{e.index.hideLoading()}}})},T=t=>{e.index.navigateTo({url:`/subPackages/order/extend?orderId=${t.id}`})},k=t=>{if(t.companion_id){let a="/subPackages/py/detail?id="+t.companion_id+"&city_code="+c.currentCityCode;e.index.navigateTo({url:a})}else e.index.showToast({title:"友伴信息不存在",icon:"none"})},b=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate?orderId=${t.id}&serviceName=${encodeURIComponent(t.service_name)}&serviceImage=${encodeURIComponent(t.service_image_url)}`})},$=t=>{e.index.navigateTo({url:`/subPackages/order/evaluate-detail?orderId=${t.id}`})},S=t=>{e.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:async n=>{if(n.confirm)try{e.index.showLoading({title:"删除中..."});const n={order_id:t.id},o=await a.deleteOrder(n);if(0!==o.data.code)throw new Error(o.data.msg||"删除订单失败");e.index.showToast({title:"订单已删除",icon:"success"}),e.index.$emit("orderOrderDeleted",{orderId:t.id,status:t.status}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(o){console.error("删除订单失败:",o),e.index.showToast({title:o.message||"删除订单失败",icon:"none"})}finally{e.index.hideLoading()}}})},L=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},I=(e,t)=>{if(!e&&!t)return"待确认";let a="";if(e){const t=new Date(e);a+=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${["周日","周一","周二","周三","周四","周五","周六"][t.getDay()]}`}return t&&(a&&(a+=" "),a+=t),a||"待确认"};return(a,n)=>{var o,s,d,c,u;return e.e({a:e.t((u=r.value.status,{1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"}[u]||"未知状态")),b:e.n(x(r.value.status)),c:1==e.unref(i).switch},1==e.unref(i).switch?{d:e.f(l.value,((t,a,n)=>{return e.e({a:e.t(t.icon),b:e.t(t.title),c:a<l.value.length-1},a<l.value.length-1?{d:e.n((o=t.status,l.value[a+1].status,"completed"===o?"completed":"pending"))}:{},{e:a,f:e.n(t.status)});var o}))}:{},{e:a.$imgBaseUrl+r.value.service_image_url,f:e.t(r.value.service_name),g:e.t(r.value.unit_price),h:e.t(r.value.unit),i:e.t(r.value.quantity),j:e.t(r.value.total_amount),k:a.$imgBaseUrl+(null==(s=null==(o=r.value)?void 0:o.companion)?void 0:s.avatar),l:e.t(null==(c=null==(d=r.value)?void 0:d.companion)?void 0:c.nickname),m:e.t(r.value.service_address),n:e.t(I(r.value.service_date,r.value.service_time)),o:e.t(r.value.order_no),p:t._imports_0$5,q:e.o((t=>{var a;(a=r.value.order_no)?e.index.setClipboardData({data:a,success:()=>{e.index.showToast({title:"订单号已复制",icon:"success"})},fail:()=>{e.index.showToast({title:"复制失败",icon:"none"})}}):e.index.showToast({title:"订单号为空",icon:"none"})})),r:r.value.start_time},r.value.start_time?{s:e.t(L(r.value.start_time))}:{},{t:r.value.end_time},r.value.end_time?{v:e.t(L(r.value.end_time))}:{},{w:e.t(L(r.value.created_at)),x:r.value.payment_time},r.value.payment_time?{y:e.t(L(r.value.payment_time))}:{},{z:r.value.remark},r.value.remark?{A:e.t(r.value.remark)}:{},{B:e.f(g(r.value.status),((t,a,n)=>e.e({a:e.t(t.text),b:"联系客服"===t.text},"联系客服"===t.text?{c:e.o((()=>{}),a)}:{},{d:a,e:e.n(t.type),f:e.o((a=>((t,a)=>{switch(t){case"cancel":p(a);break;case"refund":v(a);break;case"pay":w(a);break;case"contact":console.log(a.companion),a.companion.phone&&e.index.showModal({title:"联系友伴师",content:"是否拨打友伴师的电话？",confirmText:"拨打",cancelText:"取消",success:t=>{t.confirm&&e.index.makePhoneCall({phoneNumber:a.companion.phone})}});break;case"extend":T(a);break;case"rebook":k(a);break;case"delete":S(a);break;case"start":_(a);break;case"evaluate":b(a);break;case"viewComment":$(a)}})(t.action,r.value)),a)})))})}}},i=e._export_sfc(s,[["__scopeId","data-v-04cd2be5"]]);wx.createPage(i);

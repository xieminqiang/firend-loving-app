"use strict";const t=require("../../common/vendor.js"),e=require("../../common/assets.js"),a=require("../../api/order.js"),n=require("../../stores/city.js"),s={__name:"detail",setup(s){const o=t.ref({}),i=t.ref(null),r=n.useCityStore(),c=t.ref([{title:"友伴接单",icon:"✓",status:"pending"},{title:"友伴出发",icon:"✓",status:"pending"},{title:"友伴到达",icon:"✓",status:"pending"},{title:"开始服务",icon:"✓",status:"pending"},{title:"服务完成",icon:"✓",status:"pending"}]);t.onLoad((t=>{t.orderId&&(i.value=t.orderId,d())}));const d=async()=>{try{t.index.showLoading({title:"加载中..."});const e=await a.getOrderDetail({order_id:Number(i.value)});if(console.log(e.data),0!==e.data.code)throw new Error(e.data.msg||"获取订单详情失败");o.value={...e.data.data.order,logs:e.data.data.logs||[]},l()}catch(e){console.error("加载订单详情失败:",e),t.index.showToast({title:e.message||"加载失败",icon:"none"})}finally{t.index.hideLoading()}},l=()=>{const t=o.value.logs||[];c.value.forEach((t=>{t.status="pending"}));t.find((t=>11===t.status))&&(c.value[0].status="completed");t.find((t=>3===t.status))&&(c.value[1].status="completed");t.find((t=>4===t.status))&&(c.value[2].status="completed");t.find((t=>5===t.status))&&(c.value[3].status="completed");t.find((t=>6===t.status))&&(c.value[4].status="completed")},u=t=>({1:"status-pending",2:"status-to-serve",3:"status-to-serve",4:"status-to-serve",5:"status-in-progress",6:"status-completed",7:"status-cancelled",8:"status-refunded",9:"status-refunding",10:"status-cancelled",11:"status-to-serve"}[t]||"status-default"),p=t=>({1:[{text:"取消订单",action:"cancel",type:"secondary"},{text:"立即支付",action:"pay",type:"primary"}],2:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],3:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}],4:[{text:"申请退款",action:"refund",type:"secondary"},{text:"开始服务",action:"start",type:"start"}],5:[{text:"续钟",action:"extend",type:"primary"},{text:"联系友伴",action:"contact",type:"secondary"}],6:[{text:"再次预约",action:"rebook",type:"primary"}],7:[{text:"删除订单",action:"delete",type:"secondary"}],8:[{text:"删除订单",action:"delete",type:"secondary"}],9:[{text:"联系客服",action:"contact",type:"primary"}],10:[{text:"删除订单",action:"delete",type:"secondary"}],11:[{text:"申请退款",action:"refund",type:"secondary"},{text:"联系友伴",action:"contact",type:"primary"}]}[t]||[]),m=e=>{t.index.showModal({title:"取消订单",content:"确定要取消这个订单吗？",confirmText:"确定取消",cancelText:"再想想",success:e=>{e.confirm&&t.index.showToast({title:"订单已取消",icon:"success"})}})},v=e=>{t.index.showModal({title:"申请退款",content:"确定要申请退款吗？",confirmText:"申请退款",cancelText:"取消",success:e=>{e.confirm&&t.index.showToast({title:"退款申请已提交",icon:"success"})}})},x=async e=>{try{t.index.showLoading({title:"处理中..."});const n={order_id:e.id,payment_method:1},s=await a.orderParams(n);if(0!==s.data.code)throw new Error(s.data.msg||"获取支付参数失败");t.index.requestPayment({provider:"wxpay",...s.data.data.pay_params,success:e=>{console.log("支付成功",e),t.index.showToast({title:"支付成功",icon:"success"}),setTimeout((()=>{d()}),1500)},fail:e=>{console.error("支付失败",JSON.stringify(e)),t.index.showToast({title:"支付失败",icon:"none"})}})}catch(n){console.error("支付失败:",n),t.index.showToast({title:n.message||"支付失败",icon:"none"})}finally{t.index.hideLoading()}},y=e=>{t.index.showModal({title:"开始服务",content:"确认友伴师已到达并开始服务吗？",confirmText:"开始服务",cancelText:"取消",success:e=>{e.confirm&&t.index.showToast({title:"服务已开始",icon:"success"})}})},g=e=>{t.index.navigateTo({url:`/subPackages/order/extend?orderId=${e.id}`})},f=e=>{if(e.companion_id){let a="/subPackages/friend/detail?id="+e.companion_id+"&city_code="+r.currentCityCode;t.index.navigateTo({url:a})}else t.index.showToast({title:"友伴信息不存在",icon:"none"})},_=e=>{t.index.showModal({title:"删除订单",content:"确定要删除这个订单吗？删除后不可恢复。",confirmText:"删除",cancelText:"取消",success:e=>{e.confirm&&t.index.showToast({title:"订单已删除",icon:"success"})}})},h=t=>{if(!t)return"";const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`},w=(t,e)=>{if(!t&&!e)return"待确认";let a="";if(t){const e=new Date(t);a+=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${["周日","周一","周二","周三","周四","周五","周六"][e.getDay()]}`}return e&&(a&&(a+=" "),a+=e),a||"待确认"};return(a,n)=>{var s,i,r,c,d;return t.e({a:t.t((d=o.value.status,{1:"待付款",2:"等待接单",3:"友伴已出发",4:"友伴已到达",5:"进行中",6:"已完成",7:"已取消",8:"已退款",9:"退款中",10:"超时取消",11:"已接单，等待出发"}[d]||"未知状态")),b:t.n(u(o.value.status)),c:a.$imgBaseUrl+o.value.service_image_url,d:t.t(o.value.service_name),e:t.t(o.value.unit_price),f:t.t(o.value.unit),g:t.t(o.value.quantity),h:t.t(o.value.total_amount),i:null==(i=null==(s=o.value)?void 0:s.companion)?void 0:i.avatar,j:t.t(null==(c=null==(r=o.value)?void 0:r.companion)?void 0:c.nickname),k:t.t(o.value.service_address),l:t.t(w(o.value.service_date,o.value.service_time)),m:t.t(o.value.order_no),n:e._imports_0$6,o:t.o((e=>{var a;(a=o.value.order_no)?t.index.setClipboardData({data:a,success:()=>{t.index.showToast({title:"订单号已复制",icon:"success"})},fail:()=>{t.index.showToast({title:"复制失败",icon:"none"})}}):t.index.showToast({title:"订单号为空",icon:"none"})})),p:o.value.start_time},o.value.start_time?{q:t.t(h(o.value.start_time))}:{},{r:o.value.end_time},o.value.end_time?{s:t.t(h(o.value.end_time))}:{},{t:t.t(h(o.value.created_at)),v:o.value.payment_time},o.value.payment_time?{w:t.t(h(o.value.payment_time))}:{},{x:o.value.remark},o.value.remark?{y:t.t(o.value.remark)}:{},{z:t.f(p(o.value.status),((e,a,n)=>t.e({a:t.t(e.text),b:"联系客服"===e.text},"联系客服"===e.text?{c:t.o((()=>{}),a)}:{},{d:a,e:t.n(e.type),f:t.o((a=>((e,a)=>{switch(e){case"cancel":m();break;case"refund":v();break;case"pay":x(a);break;case"contact":t.index.showToast({title:"联系功能暂不可用",icon:"none"});break;case"extend":g(a);break;case"rebook":f(a);break;case"delete":_();break;case"start":y()}})(e.action,o.value)),a)})))})}}},o=t._export_sfc(s,[["__scopeId","data-v-52be8047"]]);wx.createPage(o);

"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),t=require("../../api/discover.js"),a=require("../../api/file.js");if(!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u--textarea")+e.resolveComponent("u-action-sheet"))()}Math||((()=>"../../uni_modules/uview-plus/components/u-icon/u-icon.js")+(()=>"../../uni_modules/uview-plus/components/u--textarea/u--textarea.js")+(()=>"../../uni_modules/uview-plus/components/u-action-sheet/u-action-sheet.js"))();const i={__name:"index",setup(i){const{proxy:s}=e.getCurrentInstance(),l=e.ref([]),n=e.ref(116.397128),c=e.ref(39.916527),r=e.ref("");e.onLoad((()=>{console.log("发布页面加载完成"),u()}));const u=async()=>{try{const o=await t.getMomentsRequest();0===o.data.code?l.value=o.data.data.topic_list||[]:console.warn("获取动态请求数据失败:",o.data.msg)}catch(o){}finally{e.index.hideLoading()}};e.ref(!1);const d=e.reactive({imgList:[],content:"",status:1,location:"",location_desc:"",topics:[],object_keys:[]}),p=e.ref([]),m=e.ref(!1),v=[{name:"拍照",value:"camera"},{name:"从相册选择",value:"album"},{name:"拍摄视频",value:"video"}],f=()=>{m.value=!0},h=e=>{switch(m.value=!1,e.value){case"camera":g("camera");break;case"album":g("album");break;case"video":_()}},g=o=>{e.index.chooseImage({count:9-p.value.length,sourceType:[o],sizeType:["compressed"],success:e=>{y(e.tempFilePaths)},fail:o=>{console.error("选择图片失败:",o),e.index.showToast({title:"选择图片失败",icon:"none"})}})},_=()=>{e.index.chooseVideo({sourceType:["album","camera"],maxDuration:60,camera:"back",success:e=>{x(e)},fail:o=>{console.error("选择视频失败:",o),e.index.showToast({title:"选择视频失败",icon:"none"})}})},y=async o=>{for(const i of o){const o={type:"image",url:i,status:"uploading",filePath:i,fileName:i.split("/").pop()||"image.jpg"};e.index.showLoading({title:"上传中..."});try{const t=await a.uploadFile({filePath:i,name:o.fileName}),s=a.getUploadResult(t);if(e.index.hideLoading(),!s)throw new Error("上传结果解析失败");o.status="success",o.objectKey=s.objectKey,o.url=s.url,o.uploadedUrl=s.url,p.value.push(o),console.log("图片上传成功:",s)}catch(t){console.error("图片上传失败:",t),o.status="failed",o.errorMsg=t.message,e.index.showToast({title:"图片上传失败",icon:"none"})}}},x=async o=>{const t={type:"video",url:o.tempFilePath,cover:o.thumbTempFilePath,duration:o.duration,size:o.size,status:"uploading",filePath:o.tempFilePath,fileName:o.tempFilePath.split("/").pop()||"video.mp4"};e.index.showLoading({title:"上传中..."});try{const i=await a.uploadFile({filePath:o.tempFilePath,name:t.fileName}),s=a.getUploadResult(i);if(e.index.hideLoading(),!s)throw new Error("上传结果解析失败");t.status="success",t.objectKey=s.objectKey,t.url=s.url,t.uploadedUrl=s.url,t.cover=s.cover||o.thumbTempFilePath,p.value.push(t),console.log("视频上传成功:",s)}catch(i){console.error("视频上传失败:",i),t.status="failed",t.errorMsg=i.message,e.index.showToast({title:"视频上传失败",icon:"none"})}},w=o=>{const t=p.value[o];if("image"===t.type){const o=p.value.filter((e=>"image"===e.type)),a=o.map((e=>s.$imgBaseUrl+e.url)),i=o.findIndex((e=>e===t));e.index.previewImage({urls:a,current:i>=0?i:0,indicator:"number",loop:!0,show:!0,success:function(e){console.log("图片预览成功",e)},fail:function(e){console.error("图片预览失败",e)}})}else"video"===t.type&&console.log("视频播放:",t.url)},b=e.ref(""),j=e.ref(!1),T=e.computed((()=>b.value.trim().length>0)),P=e.computed((()=>d.topics.map((e=>e.topic_id)))),k=()=>{e.index.chooseLocation({success:e=>{const o=e.address||e.name||"已选择位置";console.log("手动选择位置",e),r.value=o,n.value=e.longitude,c.value=e.latitude},fail:o=>{o.errMsg&&-1===o.errMsg.indexOf("cancel")&&(e.index.showToast({title:"获取位置失败",icon:"none"}),console.error("获取位置失败:",o.errMsg))}})},L=async()=>{if(!T.value||j.value)return;j.value=!0;const o=p.value.filter((e=>"success"===e.status)).map((e=>"image"===e.type?{media_type:1,object_key:e.objectKey,url:e.uploadedUrl,file_name:e.fileName}:"video"===e.type?{media_type:2,object_key:e.objectKey,url:e.uploadedUrl,file_name:e.fileName,cover:e.cover,duration:e.duration,size:e.size}:void 0)).filter(Boolean),a=o.map((e=>e.object_key)).filter(Boolean),i=d.topics.map((e=>({topic_id:e.topic_id,topic_desc:e.topic_desc,topic_icon:e.topic_icon})));let s={content:b.value,status:1,location:`${n.value},${c.value}`,location_desc:r.value,topics:i,object_keys:a,media_list:o,image_count:o.filter((e=>1===e.media_type)).length,video_count:o.filter((e=>2===e.media_type)).length};console.log("发布参数:",s);try{e.index.showLoading({title:"发布中..."});const o=await t.pushMoments(s);0===o.data.code?(e.index.showToast({title:"发布成功",icon:"success",duration:2e3}),setTimeout((()=>{e.index.navigateBack({delta:1})}),2e3)):e.index.showToast({title:o.data.msg||"发布失败",icon:"none",duration:2e3})}catch(l){console.error("发布失败:",l),e.index.showToast({title:"发布失败，请重试",icon:"none",duration:2e3})}finally{e.index.hideLoading(),j.value=!1}},F=()=>{e.index.navigateBack({delta:1})};return(t,a)=>e.e({a:e.p({color:"#000",size:"24",name:"close"}),b:e.o(F),c:e.o((e=>b.value=e)),d:e.p({placeholder:"请输入内容",border:"bottom",modelValue:b.value}),e:e.f(d.topics,((o,t,a)=>({a:e.t(o.topic_desc),b:o.topic_id}))),f:e.f(p.value,((o,t,a)=>e.e({a:"video"===o.type},"video"===o.type?{b:e.unref(s).$imgBaseUrl+o.url,c:e.o((e=>w(t)),t)}:{d:e.unref(s).$imgBaseUrl+o.url,e:e.o((e=>w(t)),t)},{f:"61407704-2-"+a,g:e.o((o=>(o=>{e.index.showModal({title:"提示",content:"确定要删除这个文件吗？",success:e=>{e.confirm&&p.value.splice(o,1)}})})(t)),t),h:t,i:"video"===o.type?1:""}))),g:e.p({name:"close",color:"#fff",size:"16"}),h:p.value.length<9},p.value.length<9?{i:e.p({name:"plus",color:"#999",size:"32"}),j:e.o(f)}:{},{k:e.f(l.value,((o,t,a)=>({a:e.t(o.topic_desc),b:P.value.indexOf(o.topic_id)>-1?1:"",c:o.topic_id,d:e.o((e=>(e=>{let o=d.topics.indexOf(e);-1===o&&d.topics.push(e),-1!==o&&d.topics.splice(o,1)})(o)),o.topic_id)}))),l:o._imports_0$3,m:e.t(""===r.value?"不显示位置":r.value),n:e.o(k),o:e.o((e=>m.value=!1)),p:e.o(h),q:e.p({show:m.value,actions:v}),r:j.value},(j.value,{}),{s:!j.value},(j.value,{}),{t:j.value||!T.value?1:"",v:e.o(L)})}},s=e._export_sfc(i,[["__scopeId","data-v-61407704"]]);wx.createPage(s);

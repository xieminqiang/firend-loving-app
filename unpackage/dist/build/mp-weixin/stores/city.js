"use strict";const e=require("../common/vendor.js"),t=require("../api/home.js"),a=e.defineStore("city",(()=>{const a=e.ref([]),l=e.ref(0),o=e.ref(null),n=e.computed((()=>{var e;return a.value.length>0&&(null==(e=a.value[l.value])?void 0:e.name)||"选择区域"})),u=e.computed((()=>{var e;return a.value.length>0&&(null==(e=a.value[l.value])?void 0:e.code)||null})),i=(e,t,a,l)=>{const o=(a-e)*Math.PI/180,n=(l-t)*Math.PI/180,u=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))},s=()=>new Promise(((t,a)=>{e.index.getLocation({type:"wgs84",success:e=>{console.log("获取位置成功:",e),o.value={latitude:e.latitude,longitude:e.longitude},t(e)},fail:e=>{console.log("获取位置失败:",e),t(null)}})})),c=()=>{if(!o.value||0===a.value.length)return void(l.value=0);let e=0,t=1/0;a.value.forEach(((a,l)=>{if(a.latitude&&a.longitude){const n=i(o.value.latitude,o.value.longitude,a.latitude,a.longitude);n<t&&(t=n,e=l)}})),l.value=e,console.log(`选择最近的城市: ${a.value[e].name}, 距离: ${t.toFixed(2)}km`)},r=async()=>{try{const e=await t.getCityList();e.data&&0===e.data.code&&e.data.data?(a.value=e.data.data.map((e=>({name:e.name,code:e.city_code,latitude:parseFloat(e.lat)||null,longitude:parseFloat(e.lng)||null}))),console.log("原始城市数据:",e.data.data),console.log("处理后的城市数据:",a.value),a.value.length>0&&c(),console.log("城市列表加载成功:",a.value)):(console.warn("获取城市列表失败，使用默认城市列表"),a.value=[])}catch(e){console.error("获取城市列表失败:",e),a.value=[]}};return{cityList:a,cityIndex:l,userLocation:o,currentCity:n,currentCityCode:u,calculateDistance:i,getUserLocation:s,selectNearestCity:c,loadCityList:r,selectCity:async e=>{e>=0&&e<a.value.length&&(l.value=e,console.log(`手动选择城市: ${a.value[e].name}`))},selectCityByName:e=>{const t=a.value.findIndex((t=>t.name===e));-1!==t&&(l.value=t,console.log(`根据名称选择城市: ${e}`))},initCityData:async()=>{await s(),await r()}}}),{persist:{key:"city-store",storage:{getItem:t=>e.index.getStorageSync(t),setItem(t,a){e.index.setStorageSync(t,a)}}}});exports.useCityStore=a;

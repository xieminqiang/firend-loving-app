"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/home.js"),o=require("../../../stores/city.js");Math||(l+i)();const l=()=>"../../../components/common/CitySelector.js",i=()=>"../../../components/common/CityPicker.js",c={__name:"index",setup(l){const i=e.ref(0),c=e.ref(44);e.onMounted((async()=>{const a=e.index.getSystemInfoSync();i.value=a.statusBarHeight||0,c.value=44,await n.initCityData(),await g(u.value)}));const n=o.useCityStore();e.computed((()=>n.currentCity));const s=e.computed((()=>n.currentCityCode));e.computed((()=>n.cityList)),e.computed((()=>n.cityIndex));const u=e.ref("服务"),r=["服务","娱乐"];e.onUnmounted((()=>{y&&clearTimeout(y)}));const v=e.ref({"服务":[],"娱乐":[],"运动":[]}),d=e.ref({"服务":!1,"娱乐":!1,"运动":!1}),m=e.ref({"服务":!1,"娱乐":!1,"运动":!1}),g=async(e,a=!1)=>{if(!d.value[e]||m.value[e]||a){m.value[e]=!0,console.log(`开始加载${e}服务数据，当前城市代码:`,s.value,a?"(强制刷新)":"");try{const a={category:f(e),page_size:10,city_code:s.value};console.log(`${e}服务请求参数:`,a);const o=await t.getHotRecommendServices(a);o.data&&0===o.data.code&&o.data.data&&o.data.data.list?(v.value[e]=o.data.data.list.map((e=>({id:e.id,name:e.name,desc:e.description,tags:e.tags||[],img:e.image_url||"/static/images/service-default.png",min_price:e.min_price||0,unit:e.unit||"次",price_template_id:e.price_template_id}))),console.log(`${e}服务数据加载成功，共${v.value[e].length}条`)):(v.value[e]=[],console.log(`${e}服务数据为空`)),d.value[e]=!0}catch(o){console.error(`获取${e}服务数据失败:`,o),v.value[e]=[],d.value[e]=!0}finally{m.value[e]=!1}}else console.log(`${e}数据已缓存，跳过加载`)},f=e=>{switch(e){case"服务":return 1;case"娱乐":return 2;case"运动":return 3;default:return 0}},p=e.ref(0);let y=null;const _=async e=>{const a=e.detail.current,t=r[a],o=u.value;p.value=a,u.value=t,y&&clearTimeout(y),o===t||d.value[t]||(y=setTimeout((async()=>{await g(t)}),300))},h=e=>v.value[e]||[];const w=e.ref(!1),$=e.ref(!1),b=()=>{w.value=!1,$.value=!1},x=e.ref(!1);function j(e){n.cityIndex!==e&&(console.log(`手动选择城市: ${n.cityList[e].name}`),(async()=>{console.log("重新加载所有选项卡数据"),Object.keys(d.value).forEach((e=>{d.value[e]=!1})),await g(u.value)})())}return(t,o)=>({a:e.o((e=>x.value=!0)),b:i.value+"px",c:e.f(r,((a,t,o)=>e.e({a:e.t(a),b:u.value===a},(u.value,{}),{c:a,d:e.n({active:u.value===a}),e:e.o((e=>(async e=>{const a=u.value,t=e;u.value=t,p.value=r.indexOf(t),a===t||d.value[t]||await g(t)})(a)),a)}))),d:e.f(r,((o,l,i)=>e.e({a:m.value[o]},m.value[o]?{}:h(o).length>0?{c:e.f(h(o),((a,o,l)=>({a:t.$imgBaseUrl+a.img,b:e.t(a.name),c:e.f(a.tags,((a,t,o)=>({a:e.t(a),b:a}))),d:e.t(a.min_price||0),e:e.t(a.unit),f:a.id,g:e.o((t=>function(a){console.log("跳转到服务详情页, ID:",a);const t=h(u.value).find((e=>e.id===a));let o=`/subPackages/home/detail?id=${a}`;t&&t.price_template_id&&(o+=`&price_template_id=${t.price_template_id}`),console.log("跳转URL:",o),e.index.navigateTo({url:o})}(a.id)),a.id)})))}:d.value[o]&&0===h(o).length?{e:a._imports_3,f:e.t(o)}:{},{b:h(o).length>0,d:d.value[o]&&0===h(o).length,g:e.o((e=>(async e=>{if(!$.value&&e===u.value){$.value=!0,w.value=!0;try{0===n.cityList.length&&(console.log("城市列表为空，重新加载城市列表"),await n.loadCityList()),console.log(`下拉刷新${e}选项卡数据`),await g(e,!1),await new Promise((e=>setTimeout(e,800)))}catch(a){console.error("刷新失败:",a)}finally{w.value=!1,$.value=!1}}})(o)),o),h:e.o(b,o),i:o}))),e:w.value,f:p.value,g:e.o(_),h:e.o(j),i:e.o((e=>x.value=e)),j:e.p({visible:x.value})})}},n=e._export_sfc(c,[["__scopeId","data-v-a0d3b415"]]);wx.createPage(n);

"use strict";const e=require("../../../../common/vendor.js"),a=require("../../../../common/assets.js"),l=require("../../../../api/home.js"),o=require("../../../../stores/city.js"),t=require("../../../../stores/user.js");Math||(s+n)();const s=()=>"../../../../components/common/CitySelector.js",n=()=>"../../../../components/common/CityPicker.js",c={__name:"home",setup(s){const n=t.useUserStore(),c=e.ref(0),i=e.ref(44);e.onMounted((async()=>{console.log("home组件挂载完成");const a=e.index.getSystemInfoSync();c.value=a.statusBarHeight||0,i.value=44,await u.initCityData(),await $(v.value)}));const u=o.useCityStore();e.computed((()=>u.currentCity));const r=e.computed((()=>u.currentCityCode));e.computed((()=>u.cityList)),e.computed((()=>u.cityIndex));const v=e.ref("娱乐"),g=["服务","娱乐","运动"];e.onUnmounted((()=>{w&&clearTimeout(w)}));const d=e.ref({"服务":[],"娱乐":[],"运动":[]}),p=e.ref({"服务":!1,"娱乐":!1,"运动":!1}),m=e.ref({"服务":!1,"娱乐":!1,"运动":!1}),h=e.ref({"服务":{page:1,hasMore:!0},"娱乐":{page:1,hasMore:!0},"运动":{page:1,hasMore:!0}}),f=e.ref({"服务":!1,"娱乐":!1,"运动":!1}),$=async(e,a=!1)=>{if(!p.value[e]||m.value[e]||a){a&&(p.value[e]=!1,console.log(`强制刷新${e}，清除缓存状态`)),m.value[e]=!0,console.log(`开始加载${e}服务数据，当前城市代码:`,r.value,a?"(强制刷新)":"");try{const o={category:y(e),page_size:10,city_code:r.value,page:h.value[e].page};console.log(`${e}服务请求参数:`,o);const t=await l.getHotRecommendServices(o);if(t.data&&0===t.data.code&&t.data.data&&t.data.data.list){const l=t.data.data.list.map((e=>({id:e.id,name:e.name,desc:e.description,tags:e.tags||[],img:e.image_url||"/static/images/service-default.png",min_price:e.min_price||0,unit:e.unit||"次",price_template_id:e.price_template_id})));a?(console.log(`${e}强制刷新前页码: ${h.value[e].page}`),d.value[e]=l,h.value[e].page=1,h.value[e].hasMore=!0,console.log(`${e}服务数据强制刷新成功，共${l.length}条，重置后页码: ${h.value[e].page}`)):(d.value[e]=l,h.value[e].hasMore=10===l.length,console.log(`${e}服务数据初始加载成功，共${l.length}条`))}else a?(d.value[e]=[],h.value[e].page=1,h.value[e].hasMore=!0,console.log(`${e}服务数据强制刷新为空`)):console.log(`${e}服务数据为空，保留现有数据`);p.value[e]=!0}catch(o){console.error(`获取${e}服务数据失败:`,o),a?(d.value[e]=[],h.value[e].page=1,h.value[e].hasMore=!0,console.log(`${e}强制刷新失败，清空数据`)):console.log(`${e}数据加载失败，保留现有数据`),p.value[e]=!0}finally{m.value[e]=!1}}else console.log(`${e}数据已缓存，跳过加载`)},y=e=>{switch(e){case"服务":return 1;case"娱乐":return 2;case"运动":return 3;default:return 0}},_=e.ref(1);let w=null;const M=async e=>{const a=e.detail.current,l=g[a],o=v.value;_.value=a,v.value=l,w&&clearTimeout(w),o===l||p.value[l]||(w=setTimeout((async()=>{await $(l)}),300))},b=e=>d.value[e]||[];const j=e.ref(!1),C=e.ref(!1),x=()=>{j.value=!1,C.value=!1},S=async e=>{console.log(`上拉加载触发，当前tab: ${e}`),await(async e=>{if(!h.value[e].hasMore||f.value[e]||m.value[e])console.log(`${e}没有更多数据或正在加载中，跳过加载`);else{f.value[e]=!0,console.log(`开始加载更多${e}数据，当前页码: ${h.value[e].page}`);try{const a={category:y(e),page_size:10,city_code:r.value,page:h.value[e].page+1};console.log(`${e}加载更多请求参数:`,a);const o=await l.getHotRecommendServices(a);if(o.data&&0===o.data.code&&o.data.data&&o.data.data.list){const a=o.data.data.list.map((e=>({id:e.id,name:e.name,desc:e.description,tags:e.tags||[],img:e.image_url||"/static/images/service-default.png",min_price:e.min_price||0,unit:e.unit||"次",price_template_id:e.price_template_id}))),l=new Set(d.value[e].map((e=>e.id))),t=a.filter((e=>!l.has(e.id)));t.length>0?(d.value[e]=[...d.value[e],...t],h.value[e].page++,h.value[e].hasMore=10===a.length,console.log(`${e}加载更多成功，新增${t.length}条，当前页码: ${h.value[e].page}`)):(h.value[e].hasMore=!1,console.log(`${e}没有更多新数据`))}else h.value[e].hasMore=!1,console.log(`${e}加载更多返回空数据`)}catch(a){console.error(`加载更多${e}数据失败:`,a)}finally{f.value[e]=!1}}})(e)},T=e.ref(!1);function k(e){u.cityIndex!==e&&(console.log(`手动选择城市: ${u.cityList[e].name}`),(async()=>{console.log("重新加载所有选项卡数据"),Object.keys(p.value).forEach((e=>{p.value[e]=!1,h.value[e].page=1,h.value[e].hasMore=!0})),await $(v.value)})())}return(l,o)=>e.e({a:1===e.unref(n).switch},1===e.unref(n).switch?{b:e.o((e=>T.value=!0)),c:c.value+"px",d:e.f(g,((a,l,o)=>e.e({a:e.t(a),b:v.value===a},(v.value,{}),{c:a,d:e.n({active:v.value===a}),e:e.o((e=>(async e=>{const a=v.value,l=e;v.value=l,_.value=g.indexOf(l),a===l||p.value[l]||await $(l)})(a)),a)}))),e:e.f(g,((o,t,s)=>e.e({a:b(o).length>0},b(o).length>0?e.e({b:e.f(b(o),((a,o,t)=>({a:l.$imgBaseUrl+a.img,b:e.t(a.name),c:e.f(a.tags,((a,l,o)=>({a:e.t(a),b:a}))),d:e.t(a.min_price||0),e:e.t(a.unit),f:a.id,g:e.o((l=>function(a){console.log("跳转到服务详情页, ID:",a);const l=b(v.value).find((e=>e.id===a));let o=`/subPackages/home/detail?id=${a}`;l&&l.price_template_id&&(o+=`&price_template_id=${l.price_template_id}`),console.log("跳转URL:",o),e.index.navigateTo({url:o})}(a.id)),a.id)}))),c:h.value[o].hasMore},h.value[o].hasMore?e.e({d:f.value[o]},(f.value[o],{})):{}):p.value[o]&&0===b(o).length?{f:a._imports_3,g:e.t(o)}:(m.value[o]&&b(o).length,{}),{e:p.value[o]&&0===b(o).length,h:m.value[o]&&0===b(o).length,i:e.o((e=>(async e=>{if(console.log(`下拉刷新触发，当前tab: ${e}, 当前serviceTab: ${v.value}`),C.value||e!==v.value)console.log(`刷新被阻止: isRefreshing=${C.value}, tab不匹配=${e!==v.value}`);else{C.value=!0,j.value=!0;try{0===u.cityList.length&&(console.log("城市列表为空，重新加载城市列表"),await u.loadCityList()),console.log(`下拉刷新${e}选项卡数据，刷新前页码: ${h.value[e].page}`),h.value[e].page=1,console.log(`手动重置页码为1: ${h.value[e].page}`),await $(e,!0),console.log(`下拉刷新${e}选项卡数据完成，刷新后页码: ${h.value[e].page}`),1!==h.value[e].page&&(console.warn("页码重置失败，手动强制设置为1"),h.value[e].page=1),await new Promise((e=>setTimeout(e,800)))}catch(a){console.error("刷新失败:",a)}finally{j.value=!1,C.value=!1}}})(o)),o),j:e.o(x,o),k:e.o((e=>S(o)),o),l:o}))),f:j.value,g:_.value,h:e.o(M),i:e.o(k),j:e.o((e=>T.value=e)),k:e.p({visible:T.value})}:{})}},i=e._export_sfc(c,[["__scopeId","data-v-03842632"]]);wx.createComponent(i);

"use strict";const e=require("../../../../common/vendor.js"),a=require("../../../../common/assets.js"),o=require("../../../../api/home.js"),l=require("../../../../stores/city.js"),t=require("../../../../stores/user.js");if(!Array){e.resolveComponent("u-tabs")()}Math||(n+(()=>"../../../../uni_modules/uview-plus/components/u-tabs/u-tabs.js")+s)();const n=()=>"../../../../components/common/CitySelector.js",s=()=>"../../../../components/common/CityPicker.js",i={__name:"home",setup(n){const s=t.useUserStore(),i=e.ref(0),r=e.ref(44);e.onMounted((async()=>{console.log("home组件挂载完成");const a=e.index.getSystemInfoSync();i.value=a.statusBarHeight||0,r.value=44,await c.initCityData(),await y(g.value)}));const c=l.useCityStore();e.computed((()=>c.currentCity));const u=e.computed((()=>c.currentCityCode));e.computed((()=>c.cityList)),e.computed((()=>c.cityIndex));const g=e.ref("娱乐"),v=["服务","娱乐","运动"],d=e.computed((()=>v.map((e=>({name:e})))));e.onUnmounted((()=>{M&&clearTimeout(M)}));const p=e.ref({"服务":[],"娱乐":[],"运动":[]}),m=e.ref({"服务":!1,"娱乐":!1,"运动":!1}),h=e.ref({"服务":!1,"娱乐":!1,"运动":!1}),f=e.ref({"服务":{page:1,hasMore:!0},"娱乐":{page:1,hasMore:!0},"运动":{page:1,hasMore:!0}}),$=e.ref({"服务":!1,"娱乐":!1,"运动":!1}),y=async(e,a=!1)=>{if(e)if(f.value[e]||(console.log(`初始化 ${e} 的分页状态`),f.value[e]={page:1,hasMore:!0}),!m.value[e]||h.value[e]||a){a&&(m.value[e]=!1,console.log(`强制刷新${e}，清除缓存状态`)),h.value[e]=!0,console.log(`开始加载${e}服务数据，当前城市代码:`,u.value,a?"(强制刷新)":"");try{const l={category:_(e),page_size:10,city_code:u.value,page:f.value[e].page};console.log(`${e}服务请求参数:`,l);const t=await o.getHotRecommendServices(l);if(t.data&&0===t.data.code&&t.data.data&&t.data.data.list){const o=t.data.data.list.length,l=t.data.data.list.filter((e=>3!==e.id&&5!==e.id)).map((e=>({id:e.id,name:e.name,desc:e.description,tags:e.tags||[],img:e.image_url||"/static/images/service-default.png",min_price:e.min_price||0,unit:e.unit||"次",price_template_id:e.price_template_id})));console.log(`${e}服务数据过滤: 原始${o}条，过滤后${l.length}条`),a?(console.log(`${e}强制刷新前页码: ${f.value[e].page}`),p.value[e]=l,f.value[e].page=1,f.value[e].hasMore=!0,console.log(`${e}服务数据强制刷新成功，共${l.length}条，重置后页码: ${f.value[e].page}`)):(p.value[e]=l,f.value[e].hasMore=10===l.length,console.log(`${e}服务数据初始加载成功，共${l.length}条`))}else a?(p.value[e]=[],f.value[e].page=1,f.value[e].hasMore=!0,console.log(`${e}服务数据强制刷新为空`)):console.log(`${e}服务数据为空，保留现有数据`);m.value[e]=!0}catch(l){console.error(`获取${e}服务数据失败:`,l),a?(p.value[e]=[],f.value[e].page=1,f.value[e].hasMore=!0,console.log(`${e}强制刷新失败，清空数据`)):console.log(`${e}数据加载失败，保留现有数据`),m.value[e]=!0}finally{h.value[e]=!1}}else console.log(`${e}数据已缓存，跳过加载`);else console.error("loadSingleTabData: tab parameter is required")},_=e=>{switch(e){case"服务":return 1;case"娱乐":return 2;case"运动":return 3;default:return 0}},b=e.ref(1);let M=null;const w=async e=>{let a,o;if("object"==typeof e&&null!==e)a=e.index,o=e.name;else{if("number"!=typeof e)return void console.error("Invalid tab change item:",e);a=e,o=v[a]}a<0||a>=v.length?console.error("Invalid tab index:",a):o?(console.log("Tab changed to:",o,"index:",a),await(async e=>{const a=g.value,o=e;g.value=o,b.value=v.indexOf(o),a===o||m.value[o]||await y(o)})(o)):console.error("Tab not found for index:",a,"item:",e)},x=async e=>{const a=e.detail.current,o=v[a],l=g.value;b.value=a,g.value=o,M&&clearTimeout(M),l===o||m.value[o]||(M=setTimeout((async()=>{await y(o)}),300))},S=e=>p.value[e]||[];const j=e.ref(!1),C=e.ref(!1),T=()=>{j.value=!1,C.value=!1},q=async e=>{console.log(`上拉加载触发，当前tab: ${e}`),await(async e=>{if(e)if(f.value[e]||(console.log(`初始化 ${e} 的分页状态`),f.value[e]={page:1,hasMore:!0}),!f.value[e].hasMore||$.value[e]||h.value[e])console.log(`${e}没有更多数据或正在加载中，跳过加载`);else{$.value[e]=!0,console.log(`开始加载更多${e}数据，当前页码: ${f.value[e].page}`);try{const a={category:_(e),page_size:10,city_code:u.value,page:f.value[e].page+1};console.log(`${e}加载更多请求参数:`,a);const l=await o.getHotRecommendServices(a);if(l.data&&0===l.data.code&&l.data.data&&l.data.data.list){const a=l.data.data.list.length,o=l.data.data.list.filter((e=>3!==e.id&&5!==e.id)).map((e=>({id:e.id,name:e.name,desc:e.description,tags:e.tags||[],img:e.image_url||"/static/images/service-default.png",min_price:e.min_price||0,unit:e.unit||"次",price_template_id:e.price_template_id})));console.log(`${e}加载更多数据过滤: 原始${a}条，过滤后${o.length}条`);const t=new Set(p.value[e].map((e=>e.id))),n=o.filter((e=>!t.has(e.id)));n.length>0?(p.value[e]=[...p.value[e],...n],f.value[e].page++,f.value[e].hasMore=10===o.length,console.log(`${e}加载更多成功，新增${n.length}条，当前页码: ${f.value[e].page}`)):(f.value[e].hasMore=!1,console.log(`${e}没有更多新数据`))}else f.value[e].hasMore=!1,console.log(`${e}加载更多返回空数据`)}catch(a){console.error(`加载更多${e}数据失败:`,a)}finally{$.value[e]=!1}}else console.error("loadMoreData: tab parameter is required")})(e)},I=e.ref(!1);function k(e){c.cityIndex!==e&&(console.log(`手动选择城市: ${c.cityList[e].name}`),(async()=>{console.log("重新加载所有选项卡数据"),Object.keys(m.value).forEach((e=>{m.value[e]=!1,f.value[e]||(f.value[e]={page:1,hasMore:!0}),f.value[e].page=1,f.value[e].hasMore=!0})),await y(g.value)})())}return(o,l)=>e.e({a:1===e.unref(s).switch},1===e.unref(s).switch?{b:e.o((e=>I.value=!0)),c:i.value+"px",d:e.o(w),e:e.p({list:d.value,current:b.value,lineWidth:"20",lineHeight:"2",lineColor:"linear-gradient(90deg, rgba(115, 99, 255, 1) 0%, rgba(255, 105, 222, 1) 100%)",activeStyle:{color:"#7363FF",fontWeight:"500",fontSize:"28rpx"},inactiveStyle:{color:"#1A1A1A",fontWeight:"400",fontSize:"28rpx"},itemStyle:"padding: 16rpx 50rpx; height: auto; border-radius: 30rpx;"}),f:e.f(v,((l,t,n)=>e.e({a:S(l).length>0},S(l).length>0?e.e({b:e.f(S(l),((a,l,t)=>({a:o.$imgBaseUrl+a.img,b:e.t(a.name),c:e.f(a.tags,((a,o,l)=>({a:e.t(a),b:a}))),d:e.t(a.min_price||0),e:e.t(a.unit),f:a.id,g:e.o((o=>function(a){console.log("跳转到服务详情页, ID:",a);const o=S(g.value).find((e=>e.id===a));let l=`/subPackages/home/detail?id=${a}`;o&&o.price_template_id&&(l+=`&price_template_id=${o.price_template_id}`),console.log("跳转URL:",l),e.index.navigateTo({url:l})}(a.id)),a.id)}))),c:f.value[l].hasMore},f.value[l].hasMore?e.e({d:$.value[l]},($.value[l],{})):{}):m.value[l]&&0===S(l).length?{f:a._imports_3,g:e.t(l)}:(h.value[l]&&S(l).length,{}),{e:m.value[l]&&0===S(l).length,h:h.value[l]&&0===S(l).length,i:e.o((e=>(async e=>{if(console.log(`下拉刷新触发，当前tab: ${e}, 当前serviceTab: ${g.value}`),e)if(f.value[e]||(console.log(`初始化 ${e} 的分页状态`),f.value[e]={page:1,hasMore:!0}),C.value||e!==g.value)console.log(`刷新被阻止: isRefreshing=${C.value}, tab不匹配=${e!==g.value}`);else{C.value=!0,j.value=!0;try{0===c.cityList.length&&(console.log("城市列表为空，重新加载城市列表"),await c.loadCityList()),console.log(`下拉刷新${e}选项卡数据，刷新前页码: ${f.value[e].page}`),f.value[e].page=1,console.log(`手动重置页码为1: ${f.value[e].page}`),await y(e,!0),console.log(`下拉刷新${e}选项卡数据完成，刷新后页码: ${f.value[e].page}`),1!==f.value[e].page&&(console.warn("页码重置失败，手动强制设置为1"),f.value[e].page=1),await new Promise((e=>setTimeout(e,800)))}catch(a){console.error("刷新失败:",a)}finally{j.value=!1,C.value=!1}}else console.error("onRefresh: tab parameter is required")})(l)),l),j:e.o(T,l),k:e.o((e=>q(l)),l),l:l}))),g:j.value,h:b.value,i:e.o(x),j:e.o(k),k:e.o((e=>I.value=e)),l:e.p({visible:I.value})}:{})}},r=e._export_sfc(i,[["__scopeId","data-v-3b983f66"]]);wx.createComponent(r);

"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),s=require("../../../../stores/city.js"),l=require("../../../../stores/user.js"),a=require("../../../../api/discover.js");if(!Array){(e.resolveComponent("u-list-item")+e.resolveComponent("u-list")+e.resolveComponent("uni-transition"))()}const n=()=>"../../../../uni_modules/uview-plus/components/u-list-item/u-list-item.js",t=()=>"../../../../uni_modules/uview-plus/components/u-list/u-list.js",u=()=>"../../../../uni_modules/uni-transition/components/uni-transition/uni-transition.js";Math||(e.unref(i)+e.unref(c)+n+t+u)();const i=()=>"./cpns/square-nav.js",c=()=>"./cpns/square-item.js",r="https://sbx-server.oss-cn-shenzhen.aliyuncs.com/img/cum/squarebg.png",v={__name:"discover",emits:["playVideo"],setup(n,{expose:t,emit:u}){const i=u,c=e.ref(!1),v=s.useCityStore(),g=l.useUserStore(),d=e.ref(null),p=e.ref(!1),m=e.ref([]),f=e.ref(!1),y=e.ref(!0),h=e.ref({page:1,page_size:20}),b=e.ref(0),w=e.ref(0),j=e.ref(!1),_=e.ref(!1);e.computed((()=>c.value?{backgroundImage:`url(${r})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:{background:"#ffffff"}));e.ref([{name:"动态",value:1},{name:"喜欢的人",value:2}]),e.ref(0);const x=e.ref(!0),k=e.ref(1),T=e.ref(1),q=e.computed((()=>g.userInfo&&Object.keys(g.userInfo).length>0&&g.token)),I=async(o=1)=>{if(console.log("开始获取动态列表数据，参数:",{page:o,listType:T.value,loading:f.value}),!f.value)try{f.value=!0;const e={list_type:T.value,page:o,page_size:h.value.page_size};console.log("调用API参数:",e);const s=await a.getMomentsList(e);if(console.log("API响应:",s),s.data&&0===s.data.code){const e=s.data.data.moments_list||[];console.log("获取到的数据:",e),m.value=1===o?e:[...m.value,...e],y.value=e.length===h.value.page_size,y.value&&h.value.page++}else console.error("API返回错误:",s)}catch(s){console.error("获取动态列表失败:",s),e.index.showToast({icon:"none",title:"获取数据失败，请重试"})}finally{f.value=!1}},C=e=>{console.log("播放视频:",e),i("playVideo",e)},S=async e=>{console.log("打招呼:",e)},z=()=>!!q.value||(e.index.showModal({title:"提示",content:"请先登录后再查看动态",confirmText:"去登录",cancelText:"取消",success:o=>{o.confirm&&e.index.navigateTo({url:"/subPackages/login/index"})}}),!1),P=e=>{w.value=e.detail.scrollTop},A=()=>{y.value&&!f.value&&I(h.value.page)},L=o=>{b.value=w.value,e.nextTick$1((()=>{b.value=0}))},M=async()=>{console.log("刷新中~"),j.value||(z()?(j.value=!0,_.value=!0,await I(1),j.value=!1,_.value=!1):_.value=!1)},$=()=>{_.value="restore"},D=async()=>{console.log("discover组件初始化数据"),z()&&(j.value=!1,h.value.page=1,console.log("onShow0"),c.value=!1,e.index.getImageInfo({src:r,success:()=>{console.log("背景图片加载成功"),c.value=!0},fail:e=>{console.error("背景图片加载失败:",e)}}),console.log("onShow1"),new Promise((o=>{p.value=!0,e.index.getLocation({type:"gcj02",success:e=>{console.log("获取位置成功:",e),d.value={latitude:e.latitude,longitude:e.longitude},p.value=!1,o({latitude:e.latitude,longitude:e.longitude})},fail:e=>{console.log("获取位置失败:",e),d.value=null,p.value=!1,o(null)}})})),console.log("onShow2"),await I(1),console.log("discover组件显示，当前状态:",{isActive:x.value,listType:k.value,listTypeDesc:T.value,userLocation:d.value}))};e.onMounted((async()=>{console.log("discover组件挂载完成"),await D()}));const V=e.ref(!1);return t({showComponent:async()=>{console.log("discover组件被显示"),V.value=!0,await D()},hideComponent:()=>{console.log("discover组件被隐藏"),V.value=!1},initData:D}),(s,l)=>({a:e.f(m.value,((o,s,l)=>({a:e.o(S,s),b:e.o(C,s),c:"102a3b38-3-"+l+",102a3b38-2-"+l,d:e.p({item:o,listType:T.value,userLocation:d.value,cityStore:e.unref(v)}),e:s,f:"102a3b38-2-"+l+",102a3b38-1"}))),b:e.p({height:"100%"}),c:b.value,d:_.value,e:e.o(P),f:e.o(A),g:e.o(M),h:e.o($),i:o._imports_0$14,j:e.sr("ani","102a3b38-4"),k:e.p({"custom-class":"transition","mode-class":"slide-right",show:w.value>1e3}),l:w.value>1e3,m:e.o(L)})}};wx.createComponent(v);

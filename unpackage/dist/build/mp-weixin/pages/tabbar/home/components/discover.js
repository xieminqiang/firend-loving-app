"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),s=require("../../../../stores/city.js"),l=require("../../../../stores/user.js"),a=require("../../../../api/discover.js");if(!Array){(e.resolveComponent("u-list-item")+e.resolveComponent("u-list")+e.resolveComponent("uni-transition"))()}const n=()=>"../../../../uni_modules/uview-plus/components/u-list-item/u-list-item.js",u=()=>"../../../../uni_modules/uview-plus/components/u-list/u-list.js",t=()=>"../../../../uni_modules/uni-transition/components/uni-transition/uni-transition.js";Math||(e.unref(i)+e.unref(r)+n+u+t)();const i=()=>"./cpns/square-nav.js",r=()=>"./cpns/square-item.js",c="https://sbx-server.oss-cn-shenzhen.aliyuncs.com/img/cum/squarebg.png",v={__name:"discover",emits:["playVideo"],setup(n,{expose:u,emit:t}){const i=t,r=e.ref(!1),v=s.useCityStore(),g=l.useUserStore(),d=e.ref(null),p=e.ref(!1),m=e.ref([]),f=e.ref(!1),y=e.ref(!0),h=e.ref({page:1,page_size:20}),w=e.ref(0),b=e.ref(0),_=e.ref(!1),j=e.ref(!1);e.computed((()=>r.value?{backgroundImage:`url(${c})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:{background:"#ffffff"}));e.ref([{name:"动态",value:1},{name:"喜欢的人",value:2}]),e.ref(0);const x=e.ref(!0),k=e.ref(1),S=e.ref(1),q=e.computed((()=>g.userInfo&&Object.keys(g.userInfo).length>0&&g.token)),I=async(o=1)=>{if(console.log("开始获取动态列表数据，参数:",{page:o,listType:S.value,loading:f.value}),!f.value)try{f.value=!0;const e={list_type:S.value,page:o,page_size:h.value.page_size};console.log("调用API参数:",e);const s=await a.getMomentsList(e);if(console.log("API响应:",s),s.data&&0===s.data.code){const e=s.data.data.moments_list||[];console.log("获取到的数据:",e),m.value=1===o?e:[...m.value,...e],y.value=e.length===h.value.page_size,y.value&&h.value.page++}else console.error("API返回错误:",s)}catch(s){console.error("获取动态列表失败:",s),e.index.showToast({icon:"none",title:"获取数据失败，请重试"})}finally{f.value=!1}},T=e=>{console.log("播放视频:",e),i("playVideo",e)},C=async e=>{console.log("打招呼:",e)},z=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},P=e=>{b.value=e.detail.scrollTop},A=()=>{y.value&&!f.value&&I(h.value.page)},$=o=>{w.value=b.value,e.nextTick$1((()=>{w.value=0}))},L=async()=>{console.log("刷新中~"),_.value||(q.value?(_.value=!0,j.value=!0,await I(1),_.value=!1,j.value=!1):j.value=!1)},M=()=>{j.value="restore"},D=async()=>{console.log("discover组件初始化数据"),q.value&&(_.value=!1,h.value.page=1,console.log("onShow0"),r.value=!1,e.index.getImageInfo({src:c,success:()=>{console.log("背景图片加载成功"),r.value=!0},fail:e=>{console.error("背景图片加载失败:",e)}}),console.log("onShow1"),new Promise((o=>{p.value=!0,e.index.getLocation({type:"wgs84",success:e=>{console.log("获取位置成功:",e),d.value={latitude:e.latitude,longitude:e.longitude},p.value=!1,o({latitude:e.latitude,longitude:e.longitude})},fail:e=>{console.log("获取位置失败:",e),d.value=null,p.value=!1,o(null)}})})),console.log("onShow2"),await I(1),console.log("discover组件显示，当前状态:",{isActive:x.value,listType:k.value,listTypeDesc:S.value,userLocation:d.value}))},U=async e=>{console.log("discover组件收到登录成功事件:",e),await D()};e.onMounted((async()=>{console.log("discover组件挂载完成"),await D(),e.index.$on("loginSuccess",U)})),e.onUnmounted((()=>{e.index.$off("loginSuccess",U)}));const V=e.ref(!1);return u({showComponent:async()=>{console.log("discover组件被显示"),V.value=!0,await D()},hideComponent:()=>{console.log("discover组件被隐藏"),V.value=!1},initData:D}),(s,l)=>e.e({a:!q.value},q.value?{d:e.f(m.value,((o,s,l)=>({a:e.o(C,s),b:e.o(T,s),c:"102a3b38-3-"+l+",102a3b38-2-"+l,d:e.p({item:o,listType:S.value,userLocation:d.value,cityStore:e.unref(v)}),e:s,f:"102a3b38-2-"+l+",102a3b38-1"}))),e:e.p({height:"100%"}),f:w.value,g:j.value,h:e.o(P),i:e.o(A),j:e.o(L),k:e.o(M),l:o._imports_1$6,m:e.sr("ani","102a3b38-4"),n:e.p({"custom-class":"transition","mode-class":"slide-right",show:b.value>1e3}),o:b.value>1e3,p:e.o($)}:{b:o._imports_3,c:e.o(z)})}};wx.createComponent(v);

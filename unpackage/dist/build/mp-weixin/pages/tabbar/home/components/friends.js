"use strict";const e=require("../../../../common/vendor.js"),a=require("../../../../common/assets.js"),l=require("../../../../api/friends.js");require("../../../../config/http.js");const t=require("../../../../stores/level.js"),o=require("../../../../stores/city.js"),n=require("../../../../stores/user.js");if(!Array){e.resolveComponent("uni-popup")()}Math||(r+i+(()=>"../../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const r=()=>"../../../../components/common/CitySelector.js",i=()=>"../../../../components/common/CityPicker.js",u={__name:"friends",setup(r){const i=n.useUserStore(),u=e.computed((()=>i.userInfo&&Object.keys(i.userInfo).length>0));e.computed((()=>{if(u.value)return i.userInfo}));const s=e.ref(0);e.ref(null);const v=e.ref(0),c=e.ref(""),d=e.ref(!1),g=e.ref(!1),m=e.computed((()=>{var e;return(null==(e=f.userLocation)?void 0:e.latitude)||null})),p=e.computed((()=>{var e;return(null==(e=f.userLocation)?void 0:e.longitude)||null}));e.ref(!1);const f=o.useCityStore();e.computed((()=>f.cityList)),e.computed((()=>f.currentCity));const _=e.ref(""),h=e.ref("all"),y=e.ref("all"),b=e.ref("all"),w=e.ref("recommend"),k=e.ref(1),C=e.ref([]),x=e.ref(0),T=e.ref(1),S=e.ref(20),$=e.ref(!1),j=e.ref(!0),I=e.ref(!1),L=t.useLevelStore(),P=e.computed((function(){return C.value.map((function(e){const a=e.tags?e.tags.slice(0,3):[],l=e.tags&&e.tags.length>3?e.tags.length-3:0;return{...e,visibleTags:a,extraTags:l}}))})),q=e.computed((()=>({all:"性别",female:"女生",male:"男生"}[h.value]||"性别")));e.computed((()=>({all:"距离","1km":"1km内","3km":"3km内","5km":"5km内","10km":"10km内"}[y.value]||"距离")));const B=e.computed((()=>{if("all"===b.value)return"级别";const e=L.sortedServiceLevels.find((e=>e.level_order.toString()===b.value));return e?e.level_name:"级别"}));e.computed((()=>({distance:"距离",rating:"评分",new:"最新"}[w.value]||"排序")));const A=e.computed((function(){return{gender:"选择性别",distance:"选择距离",level:"选择级别",sort:"排序方式"}[_.value]||""})),U=e.computed((function(){return{gender:[{value:"all",label:"不限性别"},{value:"female",label:"女生",icon:"/static/icons/friend/female.png"},{value:"male",label:"男生",icon:"/static/icons/friend/male.png"}],level:[{value:"all",label:"不限级别"},...L.sortedServiceLevels.map((e=>({value:e.level_order.toString(),label:`${e.level_name}`,icon:e.icon_url||"/static/icons/friend/star.png"})))]}[_.value]||[]})),M=e=>({gender:h,distance:y,level:b,sort:w}[_.value].value===e),O=e=>{_.value=e},F=()=>{_.value=""},J=()=>{({gender:h,distance:y,level:b,sort:w})[_.value].value="all"},N=()=>{console.log("应用筛选:",{gender:h.value,distance:y.value,level:b.value,sort:w.value}),F(),Q(!0)},z=()=>{console.log("刷新推荐，清除筛选条件"),h.value="all",b.value="all",Q(!0)},D=e.ref(null),H=e.ref([]),R=e.ref(null),E=e.ref(0),G=()=>{D.value.close()},K=a=>{if(console.log("选择服务:",a),G(),!u.value)return e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void e.index.navigateTo({url:"/subPackages/login/index"});e.index.navigateTo({url:`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${R.value.id}&level_order=${k.value||""}&nickname=${R.value.name}`})},Q=async(a=!1)=>{var t;if(!$.value){$.value=!0;try{const o={page:a?1:T.value,page_size:S.value};f.currentCityCode&&(o.city_code=f.currentCityCode),c.value&&c.value.trim()&&(o.nickname=c.value.trim()),m.value&&p.value&&(o.latitude=m.value,o.longitude=p.value),"all"!==h.value&&(o.gender="female"===h.value?"女":"男"),"all"!==b.value&&(o.level_order=parseInt(b.value)),console.log("搜索参数:",o);const n=await l.searchCompanions(o);if(console.log("API完整响应:",n),n.data&&0===n.data.code){const e=n.data.data;if(e&&e.list){const l=e.list.length,t=e.list.filter((e=>15!==e.id)).map((e=>({id:e.id,name:e.nickname,gender:e.gender,age:e.age,height:e.height,weight:e.weight,distance:e.distance,tags:e.tags||[],services:(()=>{if("string"==typeof e.services)try{return JSON.parse(e.services)}catch(a){return console.error("解析services JSON失败:",a),[]}return e.services||[]})(),avatar:e.avatar,online:1===e.is_online,bookable:"Y"===e.can_accept_orders})));console.log(`友伴数据过滤: 原始${l}条，过滤后${t.length}条`),a?(C.value=t,T.value=1):(C.value=[...C.value,...t],T.value++),x.value=e.total||0,j.value=t.length===S.value,console.log("搜索成功，共获取",t.length,"条数据，总数:",x.value),t.length}else console.log("API返回数据为空"),a&&(C.value=[],x.value=0)}else{console.error("API返回错误:",n.data);const l=(null==(t=n.data)?void 0:t.message)||"搜索失败";e.index.showToast({title:l,icon:"none",duration:2e3}),a&&(C.value=[],x.value=0)}}catch(o){console.error("搜索伴友师失败:",o),console.error("错误详情:",o.response||o);let l="搜索失败，请重试";o.response&&o.response.data&&(l=o.response.data.message||l),e.index.showToast({title:l,icon:"none",duration:2e3}),a&&(C.value=[],x.value=0)}finally{$.value=!1,I.value=!0}}},W=()=>{!$.value&&j.value&&Q(!1)},Y=async()=>{d.value=!0,await Q(!0),await new Promise((e=>setTimeout(e,800))),d.value=!1},V=()=>{clearTimeout(X),X=setTimeout((()=>{Q(!0)}),500)};let X=null;e.watch((()=>f.currentCityCode),(async(e,a)=>{e&&e!==a&&(console.log("城市发生变化，自动刷新数据:",e),await Q(!0))}));const Z=async a=>{e.index.vibrateShort({type:"light"}),await Q(!0)};return e.onMounted((async()=>{const a=e.index.getSystemInfoSync();s.value=a.statusBarHeight;const l=e.index.getMenuButtonBoundingClientRect();l.value=l;const t=a.screenWidth,o=l.right;v.value=t-o+24,await L.fetchServiceLevels(),0===f.cityList.length?await f.initCityData():await f.getUserLocation(),await Q(!0)})),e.onUnmounted((()=>{X&&clearTimeout(X)})),(t,o)=>e.e({a:1===e.unref(i).switch},1===e.unref(i).switch?e.e({b:e.o((e=>g.value=!0)),c:a._imports_0$8,d:e.o([e=>c.value=e.detail.value,V]),e:c.value,f:v.value+"px",g:a._imports_1$4,h:e.o(z),i:e.t(q.value),j:a._imports_1$5,k:e.o((e=>O("gender"))),l:e.t(B.value),m:a._imports_1$5,n:e.o((e=>O("level"))),o:s.value+"px",p:$.value&&!I.value},$.value&&!I.value?{}:P.value.length>0?{r:e.f(P.value,((o,n,r)=>e.e({a:t.$imgBaseUrl+o.avatar,b:o.online},(o.online,{}),{c:e.t(o.name),d:"女"===o.gender},"女"===o.gender?{e:a._imports_3$2}:{f:a._imports_4},{g:e.t(o.age),h:e.t(o.height),i:e.t(o.weight),j:e.t(o.distance),k:e.f(o.visibleTags,((a,l,t)=>({a:e.t(a),b:l}))),l:o.extraTags>0},o.extraTags>0?{m:e.t(o.extraTags)}:{},{n:e.o((e=>(async e=>{R.value=e;try{const a={city_code:f.currentCityCode,application_id:e.id};m.value&&p.value&&(a.latitude=parseFloat(m.value),a.longitude=parseFloat(p.value));const t=await l.getCityServices(a);if(t.data&&0===t.data.code){const e=t.data.data;e&&e.services&&e.services.length>0?(H.value=e.services,k.value=e.level_order):H.value=[]}else H.value=[]}catch(a){console.error("获取服务信息失败:",a),H.value=[]}D.value.open()})(o)),o.id),o:o.id,p:e.o((a=>(a=>{let l="/subPackages/py/detail?id="+a+"&city_code="+f.currentCityCode;m.value&&p.value&&(l+="&latitude="+m.value+"&longitude="+p.value),e.index.navigateTo({url:l})})(o.id)),o.id)}))),s:a._imports_5}:I.value&&0===P.value.length?{v:a._imports_3}:{},{q:P.value.length>0,t:I.value&&0===P.value.length,w:e.o(W),x:d.value,y:e.o(Y),z:_.value},_.value?{A:e.t(A.value),B:a._imports_7,C:e.o(F),D:e.f(U.value,((l,t,o)=>e.e({a:l.icon},l.icon?{b:l.icon}:{},{c:e.t(l.label),d:M(l.value)},M(l.value)?{e:a._imports_8$1}:{},{f:l.value,g:e.n({selected:M(l.value)}),h:e.o((e=>{return a=l.value,void({gender:h,distance:y,level:b,sort:w}[_.value].value=a);var a}),l.value)}))),E:e.o(J),F:e.o(N),G:e.o((()=>{})),H:e.o(F)}:{},{I:e.o(Z),J:e.o((e=>g.value=e)),K:e.p({visible:g.value}),L:a._imports_7,M:e.o(G),N:H.value.length>0},H.value.length>0?{O:e.f(H.value,((a,l,o)=>({a:t.$imgBaseUrl+a.service_image_url,b:e.t(a.service_name),c:e.f(a.service_tags,((a,l,t)=>({a:e.t(a),b:a}))),d:e.t(a.price),e:e.t(a.unit||"小时"),f:e.o((e=>K(a)),a.title),g:a.title})))}:{P:a._imports_3},{Q:E.value,R:e.sr(D,"74906714-2",{k:"servicePopup"}),S:e.o(G),T:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})}):{})}},s=e._export_sfc(u,[["__scopeId","data-v-74906714"]]);wx.createComponent(s);

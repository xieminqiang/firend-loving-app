"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),n=require("../../../../api/user.js"),a=require("../../../../api/order.js"),s=require("../../../../stores/user.js"),t={__name:"profile",setup(t){const i=s.useUserStore(),r=e.ref(""),l=e.ref(0),c=e.ref(!1),u=e.ref(null),d=e.ref(""),g=e.computed((()=>i.userInfo&&Object.keys(i.userInfo).length>0)),v=e.computed((()=>{if(g.value)return i.userInfo})),p=e.ref({pending:0,inProgress:0}),_=e=>{console.log("收到登录成功事件:",e),x(),h()},m=()=>{console.log("收到退出登录事件"),p.value={pending:0,inProgress:0},u.value=null,d.value=""},f=e=>{console.log("收到申请状态变化事件:",e),$()};e.onMounted((()=>{const o=e.index.getSystemInfoSync();l.value=o.statusBarHeight||0,l.value=o.statusBarHeight||0;const n=e.index.getAccountInfoSync();r.value=n.miniProgram.version,x(),e.index.$on("loginSuccess",_),e.index.$on("logoutSuccess",m),e.index.$on("applicationStatusChanged",f)})),e.onShow((()=>{g.value&&h()})),e.onUnmounted((()=>{e.index.$off("loginSuccess",_),e.index.$off("logoutSuccess",m),e.index.$off("applicationStatusChanged",f)}));const x=async()=>{var e;if(console.log("开始加载用户数据 - isLoggedIn:",g.value),console.log("当前用户状态:",i.userInfo),g.value){try{console.log("用户已登录，开始请求用户信息");const o=await n.getUserInfo();if(console.log("用户信息请求成功:",o),o.data&&0===o.data.code){const e=o.data.data;console.log("解析用户数据:",e);const n={...e,access_token:i.userInfo.access_token||"",refresh_token:i.userInfo.refresh_token||""};i.setUserInfo(n)}else console.warn("获取用户信息失败:",(null==(e=o.data)?void 0:e.msg)||"未知错误")}catch(o){console.error("获取用户信息失败:",o)}await $(),await h()}else console.log("用户未登录，跳过获取用户信息")},$=async()=>{try{console.log("开始请求申请信息");const e=await n.getApplicatioInfo();console.log("申请信息请求成功:",e),e.data&&0===e.data.code&&(u.value=e.data.data)}catch(e){}},h=async()=>{try{console.log("开始请求订单数量统计");const e=await a.getOrderCount();if(console.log("订单数量统计请求成功:",e),e.data&&0===e.data.code){const o=e.data.data;console.log("待服务订单数:",o.pending_service_count),console.log("待付款订单数:",o.pending_payment_count),console.log("进行中订单数:",o.in_service_count),p.value={pending:o.pending_payment_count||0,pending_service:o.pending_service_count||0,inProgress:o.in_service_count||0}}}catch(e){console.error("获取订单数量失败:",e)}},y=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},P=()=>{g.value?e.index.navigateTo({url:"/subPackages/settings/pages/index/edit"}):e.index.showModal({title:"提示",content:"请先登录后再设置头像",confirmText:"去登录",cancelText:"取消",success:o=>{o.confirm&&e.index.navigateTo({url:"/subPackages/login/index"})}})},k=o=>{console.log("跳转到订单页面，状态:",o);const n=encodeURIComponent(o);e.index.navigateTo({url:`/subPackages/order/index?status=${n}`})},w=()=>{u.value&&"approved"===u.value.status?e.index.navigateTo({url:"/subPackages/partner/index"}):e.index.navigateTo({url:"/subPackages/friend/apply/index"})},I=()=>{e.index.navigateTo({url:"/subPackages/profile/customer-service/index"})},T=()=>{e.index.navigateTo({url:"/subPackages/settings/pages/index/index"})},S=async()=>{console.log("开始下拉刷新"),c.value=!0;try{await x(),await new Promise((e=>setTimeout(e,800)))}catch(o){console.error("刷新失败:",o),e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}finally{c.value=!1}},b=()=>{console.log("刷新动画结束"),c.value=!1};return(n,a)=>{return e.e({a:g.value},g.value?e.e({b:v.value.head_img},v.value.head_img?{c:n.$imgBaseUrl+v.value.head_img}:{d:e.t(v.value.nickname||"")},{e:e.t(v.value.nick_name||""),f:e.t((s=v.value.phone,(s?s.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"未绑定手机号")||"未绑定手机号")),g:e.o(P)}):{h:o._imports_0$15,i:o._imports_1$6,j:o._imports_2$4,k:e.o(y)},{l:l.value+"px",m:o._imports_0$13,n:e.o((e=>k("all"))),o:o._imports_4$1,p:p.value.pending>0},p.value.pending>0?{q:e.t(p.value.pending)}:{},{r:e.o((e=>k("pending_payment"))),s:o._imports_5$1,t:p.value.pending_service>0},p.value.pending_service>0?{v:e.t(p.value.pending_service)}:{},{w:e.o((e=>k("pending_service"))),x:o._imports_6,y:p.value.inProgress>0},p.value.inProgress>0?{z:e.t(p.value.inProgress)}:{},{A:e.o((e=>k("in_service"))),B:o._imports_7$1,C:e.o((e=>k("completed"))),D:1===e.unref(i).switch&&g.value},1===e.unref(i).switch&&g.value?e.e({E:o._imports_8$3,F:u.value&&"approved"===u.value.status},(u.value&&u.value.status,{}),{G:o._imports_0$13,H:e.o(w)}):{},{I:o._imports_8$2,J:o._imports_0$13,K:e.o((()=>{})),L:e.o(I),M:o._imports_9,N:o._imports_0$13,O:e.o(T),P:""!==r.value},""!==r.value?{Q:e.t(r.value)}:{},{R:c.value,S:e.o(S),T:e.o(b)});var s}}},i=e._export_sfc(t,[["__scopeId","data-v-d6e07834"]]);wx.createComponent(i);

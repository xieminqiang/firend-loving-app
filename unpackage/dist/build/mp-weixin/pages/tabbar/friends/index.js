"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),l=require("../../../api/friends.js");require("../../../config/http.js");const t=require("../../../stores/level.js"),n=require("../../../stores/city.js");if(!Array){e.resolveComponent("uni-popup")()}Math||(o+i+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o=()=>"../../../components/common/CitySelector.js",i=()=>"../../../components/common/CityPicker.js",r={__name:"index",setup(o){const i=e.ref(0);e.ref(null);const r=e.ref(0),u=e.ref(""),s=e.ref(!1),c=e.ref(!1),v=e.computed((()=>{var e;return(null==(e=m.userLocation)?void 0:e.latitude)||null})),d=e.computed((()=>{var e;return(null==(e=m.userLocation)?void 0:e.longitude)||null}));e.ref(!1);const m=n.useCityStore();e.computed((()=>m.cityList)),e.computed((()=>m.currentCity));const g=e.ref(""),p=e.ref("all"),f=e.ref("all"),_=e.ref("all"),h=e.ref("recommend"),y=e.ref(1),b=e.ref([]),k=e.ref(0),C=e.ref(1),w=e.ref(20),x=e.ref(!1),S=e.ref(!0),j=e.ref(!1),T=t.useLevelStore(),P=e.computed((function(){return b.value.map((function(e){const a=e.tags?e.tags.slice(0,3):[],l=e.tags&&e.tags.length>3?e.tags.length-3:0;return{...e,visibleTags:a,extraTags:l}}))}));e.computed((()=>({all:"性别",female:"女生",male:"男生"}[p.value]||"性别"))),e.computed((()=>({all:"距离","1km":"1km内","3km":"3km内","5km":"5km内","10km":"10km内"}[f.value]||"距离"))),e.computed((()=>{if("all"===_.value)return"级别";const e=T.sortedServiceLevels.find((e=>e.level_order.toString()===_.value));return e?e.level_name:"级别"})),e.computed((()=>({distance:"距离",rating:"评分",new:"最新"}[h.value]||"排序")));const $=e.computed((function(){return{gender:"选择性别",distance:"选择距离",level:"选择级别",sort:"排序方式"}[g.value]||""})),q=e.computed((function(){return{gender:[{value:"all",label:"不限性别"},{value:"female",label:"女生",icon:"/static/icons/friend/female.png"},{value:"male",label:"男生",icon:"/static/icons/friend/male.png"}],level:[{value:"all",label:"不限级别"},...T.sortedServiceLevels.map((e=>({value:e.level_order.toString(),label:`${e.level_name}`,icon:e.icon_url||"/static/icons/friend/star.png"})))],sort:[{value:"recommend",label:"推荐排序",icon:"/static/icons/friend/thumbs-up.png"},{value:"distance",label:"距离最近",icon:"/static/icons/friend/location.png"},{value:"rating",label:"评分最高",icon:"/static/icons/friend/star.png"},{value:"new",label:"最新加入",icon:"/static/icons/friend/bolt.png"}]}[g.value]||[]})),I=e=>({gender:p,distance:f,level:_,sort:h}[g.value].value===e),L=()=>{g.value=""},A=()=>{({gender:p,distance:f,level:_,sort:h})[g.value].value="all"},B=()=>{console.log("应用筛选:",{gender:p.value,distance:f.value,level:_.value,sort:h.value}),L(),H(!0)},F=e.ref(null),J=e.ref([]),M=e.ref(null),z=e.ref(0),D=()=>{F.value.close()},H=async(a=!1)=>{var t;if(!x.value){x.value=!0;try{const n={page:a?1:C.value,page_size:w.value};m.currentCityCode&&(n.city_code=m.currentCityCode),u.value&&u.value.trim()&&(n.nickname=u.value.trim()),v.value&&d.value&&(n.latitude=v.value,n.longitude=d.value),"all"!==p.value&&(n.gender="female"===p.value?"女":"男"),"all"!==_.value&&(n.level_order=parseInt(_.value)),console.log("搜索参数:",n);const o=await l.searchCompanions(n);if(console.log("API完整响应:",o),o.data&&0===o.data.code){const e=o.data.data;if(e&&e.list){const l=e.list.map((e=>({id:e.id,name:e.nickname,gender:e.gender,age:e.age,height:e.height,weight:e.weight,distance:e.distance,tags:e.tags||[],services:(()=>{if("string"==typeof e.services)try{return JSON.parse(e.services)}catch(a){return console.error("解析services JSON失败:",a),[]}return e.services||[]})(),avatar:e.avatar,online:1===e.is_online,bookable:"Y"===e.can_accept_orders})));a?(b.value=l,C.value=1):(b.value=[...b.value,...l],C.value++),k.value=e.total||0,S.value=l.length===w.value,console.log("搜索成功，共获取",l.length,"条数据，总数:",k.value),l.length}else console.log("API返回数据为空"),a&&(b.value=[],k.value=0)}else{console.error("API返回错误:",o.data);const l=(null==(t=o.data)?void 0:t.message)||"搜索失败";e.index.showToast({title:l,icon:"none",duration:2e3}),a&&(b.value=[],k.value=0)}}catch(n){console.error("搜索伴友师失败:",n),console.error("错误详情:",n.response||n);let l="搜索失败，请重试";n.response&&n.response.data&&(l=n.response.data.message||l),e.index.showToast({title:l,icon:"none",duration:2e3}),a&&(b.value=[],k.value=0)}finally{x.value=!1,j.value=!0}}},N=()=>{!x.value&&S.value&&H(!1)},O=async()=>{s.value=!0,await H(!0),await new Promise((e=>setTimeout(e,800))),s.value=!1},U=()=>{clearTimeout(E),E=setTimeout((()=>{H(!0)}),500)};let E=null;const G=async a=>{e.index.vibrateShort({type:"light"}),await H(!0)};return e.onMounted((async()=>{const a=e.index.getSystemInfoSync();i.value=a.statusBarHeight;const l=e.index.getMenuButtonBoundingClientRect();l.value=l;const t=a.screenWidth,n=l.right;r.value=t-n+24,await T.fetchServiceLevels(),await m.initCityData(),await H(!0)})),e.onUnmounted((()=>{E&&clearTimeout(E)})),(t,n)=>e.e({a:e.o((e=>c.value=!0)),b:a._imports_1,c:e.o([e=>u.value=e.detail.value,U]),d:u.value,e:r.value+"px",f:i.value+"px",g:x.value&&!j.value},x.value&&!j.value?{}:P.value.length>0?{i:e.f(P.value,((a,t,n)=>e.e({a:a.avatar,b:a.online},(a.online,{}),{c:e.t(a.name),d:e.t(a.distance),e:e.o((e=>(async e=>{M.value=e;try{const a={city_code:m.currentCityCode,application_id:e.id};v.value&&d.value&&(a.latitude=parseFloat(v.value),a.longitude=parseFloat(d.value));const t=await l.getCityServices(a);if(t.data&&0===t.data.code){const e=t.data.data;e&&e.services&&e.services.length>0?(J.value=e.services,y.value=e.level_order):J.value=[]}else J.value=[]}catch(a){console.error("获取服务信息失败:",a),J.value=[]}F.value.open()})(a)),a.id),f:a.id,g:e.o((l=>(a=>{let l="/subPackages/friend/detail?id="+a+"&city_code="+m.currentCityCode;v.value&&d.value&&(l+="&latitude="+v.value+"&longitude="+d.value),e.index.navigateTo({url:l})})(a.id)),a.id)}))),j:a._imports_2}:j.value&&0===P.value.length?{l:a._imports_3}:{},{h:P.value.length>0,k:j.value&&0===P.value.length,m:e.o(N),n:s.value,o:e.o(O),p:g.value},g.value?{q:e.t($.value),r:a._imports_4,s:e.o(L),t:e.f(q.value,((l,t,n)=>e.e({a:l.icon},l.icon?{b:l.icon}:{},{c:e.t(l.label),d:I(l.value)},I(l.value)?{e:a._imports_4$1}:{},{f:l.value,g:e.n({selected:I(l.value)}),h:e.o((e=>{return a=l.value,void({gender:p,distance:f,level:_,sort:h}[g.value].value=a);var a}),l.value)}))),v:e.o(A),w:e.o(B),x:e.o((()=>{})),y:e.o(L)}:{},{z:e.o(G),A:e.o((e=>c.value=e)),B:e.p({visible:c.value}),C:a._imports_4,D:e.o(D),E:J.value.length>0},J.value.length>0?{F:e.f(J.value,((a,l,n)=>({a:t.$imgBaseUrl+a.service_image_url,b:e.t(a.service_name),c:e.f(a.service_tags,((a,l,t)=>({a:e.t(a),b:a}))),d:e.t(a.price),e:e.t(a.unit||"小时"),f:e.o((l=>(a=>{console.log("选择服务:",a),D(),e.index.navigateTo({url:`/subPackages/order/submit?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${M.value.id}&level_order=${y.value||""}&nickname=${M.value.name}`})})(a)),a.title),g:a.title})))}:{G:a._imports_3},{H:z.value,I:e.sr(F,"d54c20bf-2",{k:"servicePopup"}),J:e.o(D),K:e.p({type:"bottom","mask-click":!0,round:"20","safe-area":!1})})}},u=e._export_sfc(r,[["__scopeId","data-v-d54c20bf"]]);wx.createPage(u);

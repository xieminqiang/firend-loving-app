"use strict";const e=require("../../../common/vendor.js"),o=require("../../../common/assets.js"),n=require("../../../stores/user.js"),s=require("../../../api/user.js"),a=require("../../../api/order.js"),t={__name:"index",setup(t){const i=n.useUserStore(),r=e.ref(0),l=e.ref(!1),c=e.ref(null),u=e.ref(""),d=e.computed((()=>i.userInfo&&Object.keys(i.userInfo).length>0)),g=e.computed((()=>{if(d.value)return i.userInfo})),_=e.ref({pending:0,inProgress:0}),v=e=>{console.log("收到登录成功事件:",e),f(),h()},p=()=>{console.log("收到退出登录事件"),_.value={pending:0,inProgress:0},c.value=null,u.value=""},m=e=>{console.log("收到申请状态变化事件:",e),x()};e.onMounted((()=>{const o=e.index.getSystemInfoSync();r.value=o.statusBarHeight||0,f(),e.index.$on("loginSuccess",v),e.index.$on("logoutSuccess",p),e.index.$on("applicationStatusChanged",m)})),e.onShow((()=>{d.value&&h()})),e.onUnmounted((()=>{e.index.$off("loginSuccess",v),e.index.$off("logoutSuccess",p),e.index.$off("applicationStatusChanged",m)}));const f=async()=>{var e;if(console.log("开始加载用户数据 - isLoggedIn:",d.value),console.log("当前用户状态:",i.userInfo),d.value){try{console.log("用户已登录，开始请求用户信息");const o=await s.getUserInfo();if(console.log("用户信息请求成功:",o),o.data&&0===o.data.code){const e=o.data.data;console.log("解析用户数据:",e);const n={...e,access_token:i.userInfo.access_token||"",refresh_token:i.userInfo.refresh_token||""};i.setUserInfo(n)}else console.warn("获取用户信息失败:",(null==(e=o.data)?void 0:e.msg)||"未知错误")}catch(o){console.error("获取用户信息失败:",o)}await x(),await h()}else console.log("用户未登录，跳过获取用户信息")},x=async()=>{try{console.log("开始请求申请信息");const e=await s.getApplicatioInfo();console.log("申请信息请求成功:",e),e.data&&0===e.data.code&&(c.value=e.data.data)}catch(e){}},h=async()=>{try{console.log("开始请求订单数量统计");const e=await a.getOrderCount();if(console.log("订单数量统计请求成功:",e),e.data&&0===e.data.code){const o=e.data.data;console.log("待服务订单数:",o.pending_service_count),console.log("待付款订单数:",o.pending_payment_count),console.log("进行中订单数:",o.in_service_count),_.value={pending:o.pending_payment_count||0,pending_service:o.pending_service_count||0,inProgress:o.in_service_count||0}}}catch(e){console.error("获取订单数量失败:",e)}},y=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},I=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},$=o=>{console.log("跳转到订单页面，状态:",o);const n=encodeURIComponent(o);e.index.navigateTo({url:`/subPackages/order/index?status=${n}`})},k=()=>{e.index.navigateTo({url:"/subPackages/profile/customer-service/index"})},w=()=>{e.index.navigateTo({url:"/subPackages/settings/pages/index/index"})},P=async()=>{console.log("开始下拉刷新"),l.value=!0;try{await f(),await new Promise((e=>setTimeout(e,800)))}catch(o){console.error("刷新失败:",o),e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}finally{l.value=!1}},S=()=>{console.log("刷新动画结束"),l.value=!1};return(n,s)=>{var a,t;return e.e({a:d.value},d.value?e.e({b:g.value.head_img},g.value.head_img?{c:n.$imgBaseUrl+g.value.head_img}:{d:e.t((null==(a=g.value.nickname)?void 0:a.charAt(0))||"用")},{e:e.t(g.value.nick_name||""),f:e.t((t=g.value.phone,(t?t.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"未绑定手机号")||"未绑定手机号")),g:e.o(I)}):{h:o._imports_0$1,i:o._imports_1$1,j:o._imports_2$1,k:e.o(y)},{l:r.value+"px",m:o._imports_0,n:e.o((e=>$("all"))),o:o._imports_4$2,p:_.value.pending>0},_.value.pending>0?{q:e.t(_.value.pending)}:{},{r:e.o((e=>$("pending_payment"))),s:o._imports_5,t:_.value.pending_service>0},_.value.pending_service>0?{v:e.t(_.value.pending_service)}:{},{w:e.o((e=>$("pending_service"))),x:o._imports_6,y:_.value.inProgress>0},_.value.inProgress>0?{z:e.t(_.value.inProgress)}:{},{A:e.o((e=>$("in_service"))),B:o._imports_7,C:e.o((e=>$("completed"))),D:o._imports_8,E:o._imports_0,F:e.o((()=>{})),G:e.o(k),H:o._imports_9,I:o._imports_0,J:e.o(w),K:l.value,L:e.o(P),M:e.o(S)})}}},i=e._export_sfc(t,[["__scopeId","data-v-e806e5a1"]]);wx.createPage(i);

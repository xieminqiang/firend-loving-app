"use strict";const e=require("../../../../common/vendor.js"),a=require("../../../../common/assets.js"),t=require("../../../../api/friends.js"),o=require("../../../../stores/city.js"),i=require("../../../../stores/user.js");Math||(n+c)();const n=()=>"../../../../components/common/CitySelector.js",c=()=>"../../../../components/common/CityPicker.js",l={__name:"home",setup(n,{expose:c}){i.useUserStore();const l=e.ref(0),r=e.ref(44);e.onMounted((async()=>{const a=e.index.getSystemInfoSync();l.value=a.statusBarHeight||0,r.value=44,await s.initCityData(),await _()}));const s=o.useCityStore();e.computed((()=>s.currentCity));const u=e.computed((()=>s.currentCityCode));e.computed((()=>s.cityList)),e.computed((()=>s.cityIndex));const v=e.ref([]),d=e.ref({}),g=e.ref(!1),m=e.ref(!1);e.onUnmounted((()=>{}));const _=async()=>{var e;try{m.value=!0,console.log("开始加载城市服务数据，当前城市代码:",u.value);const a={city_code:u.value,application_id:15};console.log("城市服务请求参数:",a);const o=await t.getCityServices(a);if(o.data&&0===o.data.code&&o.data.data){const e=o.data.data;console.log("城市服务数据:",e),e&&(d.value={avatar:e.avatar,nickname:e.nickname||"未知用户",verified:!0,age:e.age,weight:e.weight,height:e.height,distance:e.distance,tags:e.tags||[],level_order:e.level_order,levelIcon:"",gender:e.gender||"",application_id:e.application_id||15}),e.services&&e.services.length>0?(v.value=e.services,console.log("服务数据加载成功，共",v.value.length,"条")):(v.value=[],console.log("服务数据为空"))}else console.error("获取城市服务失败:",(null==(e=o.data)?void 0:e.message)||"未知错误"),v.value=[];g.value=!0}catch(a){console.error("获取城市服务异常:",a),v.value=[],g.value=!0}finally{m.value=!1}},p=e.ref(!1),y=e.ref(!1),f=async()=>{if(!y.value){y.value=!0,p.value=!0;try{0===s.cityList.length&&(console.log("城市列表为空，重新加载城市列表"),await s.loadCityList()),console.log("下拉刷新服务数据"),await _(),await new Promise((e=>setTimeout(e,800)))}catch(e){console.error("刷新失败:",e)}finally{p.value=!1,y.value=!1}}},h=()=>{p.value=!1,y.value=!1},C=e.ref(!1);function w(e){s.cityIndex!==e&&(console.log(`手动选择城市: ${s.cityList[e].name}`),_())}return c({refreshCurrentTab:async()=>{console.log("Home组件刷新方法被调用");try{return 0===s.cityList.length&&(console.log("城市列表为空，重新加载城市列表"),await s.loadCityList()),console.log("刷新服务数据"),await _(),!0}catch(e){throw console.error("Home组件刷新失败:",e),e}}}),(t,o)=>e.e({a:e.o((e=>C.value=!0)),b:l.value+"px",c:m.value},m.value?{}:v.value.length>0?{e:e.f(v.value,((a,o,i)=>({a:t.$imgBaseUrl+a.service_image_url,b:e.t(a.service_name),c:e.f(a.service_tags,((a,t,o)=>({a:e.t(a),b:a}))),d:e.t(a.price||0),e:e.t(a.unit||"小时"),f:a.service_id,g:e.o((t=>(a=>{console.log("跳转到服务详情页面，服务信息:",a),e.index.navigateTo({url:`/subPackages/friend/fr_detail?service_id=${a.service_id}&price_template_id=${a.price_template_id||""}&companion_id=${d.value.application_id||15}&level_order=${d.value.level_order||""}&nickname=${d.value.nickname||""}&service_name=${encodeURIComponent(a.service_name)}&service_image_url=${encodeURIComponent(a.service_image_url)}&price=${a.price||0}&unit=${a.unit||"小时"}&service_tags=${encodeURIComponent(JSON.stringify(a.service_tags||[]))}`})})(a)),a.service_id)})))}:g.value&&0===v.value.length?{g:a._imports_3}:{},{d:v.value.length>0,f:g.value&&0===v.value.length,h:e.o(f),i:e.o(h),j:e.o(w),k:e.o((e=>C.value=e)),l:e.p({visible:C.value})})}},r=e._export_sfc(l,[["__scopeId","data-v-323f0d65"]]);wx.createComponent(r);

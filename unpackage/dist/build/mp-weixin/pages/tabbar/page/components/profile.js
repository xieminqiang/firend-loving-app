"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),n=require("../../../../api/user.js"),s=require("../../../../api/order.js"),a=require("../../../../stores/user.js"),t={__name:"profile",setup(t,{expose:i}){const r=a.useUserStore(),c=e.ref(0),l=e.ref(!1),u=e.ref(null),d=e.ref(""),g=e.computed((()=>r.userInfo&&Object.keys(r.userInfo).length>0)),_=e.computed((()=>{if(g.value)return r.userInfo})),p=e.ref({pending:0,inProgress:0}),v=e=>{console.log("收到登录成功事件:",e),x(),$()},m=()=>{console.log("收到退出登录事件"),p.value={pending:0,inProgress:0},u.value=null,d.value=""},f=e=>{console.log("收到申请状态变化事件:",e),h()};e.onMounted((()=>{const o=e.index.getSystemInfoSync();c.value=o.statusBarHeight||0,x(),e.index.$on("loginSuccess",v),e.index.$on("logoutSuccess",m),e.index.$on("applicationStatusChanged",f)})),e.onShow((()=>{g.value&&$()})),e.onUnmounted((()=>{e.index.$off("loginSuccess",v),e.index.$off("logoutSuccess",m),e.index.$off("applicationStatusChanged",f)}));const x=async()=>{var e;if(console.log("开始加载用户数据 - isLoggedIn:",g.value),console.log("当前用户状态:",r.userInfo),g.value){try{console.log("用户已登录，开始请求用户信息");const o=await n.getUserInfo();if(console.log("用户信息请求成功:",o),o.data&&0===o.data.code){const e=o.data.data;console.log("解析用户数据:",e);const n={...e,access_token:r.userInfo.access_token||"",refresh_token:r.userInfo.refresh_token||""};r.setUserInfo(n)}else console.warn("获取用户信息失败:",(null==(e=o.data)?void 0:e.msg)||"未知错误")}catch(o){console.error("获取用户信息失败:",o)}await h(),await $()}else console.log("用户未登录，跳过获取用户信息")},h=async()=>{try{console.log("开始请求申请信息");const e=await n.getApplicatioInfo();console.log("申请信息请求成功:",e),e.data&&0===e.data.code&&(u.value=e.data.data)}catch(e){}},$=async()=>{try{console.log("开始请求订单数量统计");const e=await s.getOrderCount();if(console.log("订单数量统计请求成功:",e),e.data&&0===e.data.code){const o=e.data.data;console.log("待服务订单数:",o.pending_service_count),console.log("待付款订单数:",o.pending_payment_count),console.log("进行中订单数:",o.in_service_count),p.value={pending:o.pending_payment_count||0,pending_service:o.pending_service_count||0,inProgress:o.in_service_count||0}}}catch(e){console.error("获取订单数量失败:",e)}},y=()=>{e.index.navigateTo({url:"/subPackages/login/index"})},w=()=>{g.value?e.index.navigateTo({url:"/subPackages/settings/pages/index/edit"}):e.index.showModal({title:"提示",content:"请先登录后再设置头像",confirmText:"去登录",cancelText:"取消",success:o=>{o.confirm&&e.index.navigateTo({url:"/subPackages/login/index"})}})},P=o=>{console.log("跳转到订单页面，状态:",o);const n=encodeURIComponent(o);e.index.navigateTo({url:`/subPackages/order/index?status=${n}`})},k=()=>{e.index.navigateTo({url:"/subPackages/profile/customer-service/index"})},I=()=>{e.index.navigateTo({url:"/subPackages/settings/pages/index/index"})},T=async()=>{console.log("开始下拉刷新"),l.value=!0;try{await x(),await new Promise((e=>setTimeout(e,800)))}catch(o){console.error("刷新失败:",o),e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}finally{l.value=!1}},b=()=>{console.log("刷新动画结束"),l.value=!1};return i({refreshCurrentTab:async()=>{console.log("Profile组件刷新方法被调用");try{return await x(),!0}catch(e){throw console.error("Profile组件刷新失败:",e),e}}}),(n,s)=>{return e.e({a:g.value},g.value?e.e({b:_.value.head_img},_.value.head_img?{c:n.$imgBaseUrl+_.value.head_img}:{d:e.t(_.value.nickname||"")},{e:e.t(_.value.nick_name||""),f:e.t((a=_.value.phone,(a?a.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"未绑定手机号")||"未绑定手机号")),g:e.o(w)}):{h:o._imports_0$12,i:o._imports_1$6,j:o._imports_2$3,k:e.o(y)},{l:c.value+"px",m:o._imports_0$11,n:e.o((e=>P("all"))),o:o._imports_4$2,p:p.value.pending>0},p.value.pending>0?{q:e.t(p.value.pending)}:{},{r:e.o((e=>P("pending_payment"))),s:o._imports_5$2,t:p.value.pending_service>0},p.value.pending_service>0?{v:e.t(p.value.pending_service)}:{},{w:e.o((e=>P("pending_service"))),x:o._imports_6$1,y:p.value.inProgress>0},p.value.inProgress>0?{z:e.t(p.value.inProgress)}:{},{A:e.o((e=>P("in_service"))),B:o._imports_7,C:e.o((e=>P("completed"))),D:o._imports_8$1,E:o._imports_0$11,F:e.o((()=>{})),G:e.o(k),H:o._imports_9,I:o._imports_0$11,J:e.o(I),K:l.value,L:e.o(T),M:e.o(b)});var a}}},i=e._export_sfc(t,[["__scopeId","data-v-946968bc"]]);wx.createComponent(i);
